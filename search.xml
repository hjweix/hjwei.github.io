<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>SpringMVC中参数绑定常用注解</title>
      <link href="/posts/d804aaaf/"/>
      <url>/posts/d804aaaf/</url>
      
        <content type="html"><![CDATA[<blockquote><p>不积跬步，无以至千里。 不积小流，无以成江海。</p></blockquote><p>今天在写一个Ajax请求到Controller时被参数接收的问题耽误了很久。随后详细查了SpringMVC中Controller参数绑定注解，整理记录如下。</p><p>在写SpringMVC参数绑定注解前，先看看该如何使用Ajax请求。</p><a id="more"></a><h2 id="Ajax中Content-Type"><a href="#Ajax中Content-Type" class="headerlink" title="Ajax中Content-Type"></a>Ajax中Content-Type</h2><p>HTTP请求中使用 <code>Content-Type</code> 这个字段来表示报文主体的对象类型。下面是常用的 <code>Content-Type</code> </p><ul><li>application/x-www-form-urlencoded</li></ul><p>这是最常用的POST提交数据的方式。Ajax中不设置<code>Content-Type</code>则默认以这种方式提交数据。</p><p>数据格式以<code>key=value&amp;key2=value2</code> 的方式进行编码，作为一个FormData对象进行发送。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190610225224.png" alt="form表单提交"></p><ul><li><h5 id="multipart-form-data"><a href="#multipart-form-data" class="headerlink" title="multipart/form-data"></a>multipart/form-data</h5></li></ul><p>在使用表单进行上传文件时使用这种方式。这里不详细展开。</p><ul><li><h5 id="application-json"><a href="#application-json" class="headerlink" title="application/json"></a>application/json</h5></li></ul><p>这种方式现在很常用，它表示数据是序列化的JSON字符串。通常配合 JSON.stringify() 将一个对象转化成JSON字符串。</p><ul><li><h4 id="text-xml"><a href="#text-xml" class="headerlink" title="text/xml"></a>text/xml</h4></li></ul><p>表示数据是XML的格式。data中传递的数据需要符合XML格式。</p><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><p>在接收请求中的参数时我们经常使用以下注解，可以根据它们处理的Request不同部分分类：</p><ul><li>处理Request Uri (指Uri中的Variable，不包括拼接在URL中的 QueryString )<ul><li>@PathVariable</li></ul></li><li>处理Request Header<ul><li>@RequestHeader</li><li>@CookieValue</li></ul></li><li>处理Request Body<ul><li>@ReuqestParam</li><li>@RequestBody</li></ul></li><li>处理 Attribute 类型<ul><li>@SessionAttributes</li><li>@ModelAttribute</li></ul></li></ul><h3 id="PathVariable"><a href="#PathVariable" class="headerlink" title="@PathVariable"></a>@PathVariable</h3><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/&#123;userId&#125;/roles"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queryUserAndRoles</span><span class="params">(HttpServletRequest request, @PathVariable Long userId)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="RequestHeader"><a href="#RequestHeader" class="headerlink" title="@RequestHeader"></a>@RequestHeader</h3><p>从名字可以知道它是获取Request的Header部分字段。</p><p>示例：</p><p>一个Request Header:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /dwp/contract/rebuildpdf HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 20</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br></pre></td></tr></table></figure><p>在Controller中获取Request Header中的 <code>Host</code> 与 <code>Content-Length</code> 字段值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/dwp/contract/headerInfo"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">headerInfo</span><span class="params">(@RequestHeader(<span class="string">"Host"</span>)</span> String Host, @<span class="title">RequestHeader</span><span class="params">(<span class="string">"Content-Length"</span>)</span> String ContentLength) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="CookieValue"><a href="#CookieValue" class="headerlink" title="@CookieValue"></a>@CookieValue</h3><p>获取Request Header 中 Cookie 中的值。</p><p>示例：</p><p>有如下Cookie：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: _ga=GA1.1.54311297.1548073822; Webstorm-244b1d3=90a9034f-e9c9-4a89-86a7-aaef4addf18e; Idea-4ae3b438=0eb7fd0e-54c2-4672-960c-36b458508707; Webstorm-ead79411=ce4860a6-bbd1-487d-900b-3b8fd9825418; Hm_lvt_3a101c3aa7d1cde834d9d6b197500902=1557208148,1559381054; loginKey=cbe4e8d0-059e-4bd3-82f9-5360e570839a;</span><br></pre></td></tr></table></figure><p>在Controller中获取Cookie中的<code>loginKey</code>的值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/dwp/contract/rebuildpdf"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rebuildpdf</span><span class="params">(HttpServletRequest request, @CookieValue(<span class="string">"loginKey"</span>)</span> String cookieLoginKey)</span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="ReuqestParam"><a href="#ReuqestParam" class="headerlink" title="@ReuqestParam"></a>@ReuqestParam</h3><p>requestParam有两种情况：</p><p><strong>1、处理简单类型绑定</strong></p><p>可以处理使用<code>request.getParameter()</code>获取的String，或<code>Get</code>方式中的<code>queryString</code> ，和<code>POST</code> 方式中 body data的值</p><p>示例：</p><p>Ajax：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url:_basePath + <span class="string">'/dwp/contract/rebuildpdf?contractTempNumber='</span> + $(<span class="string">'#contractTempNumber'</span>).val(),</span><br><span class="line">    type: <span class="string">"GET"</span>,</span><br><span class="line">    dataType: <span class="string">"json"</span>,</span><br><span class="line">    contentType: <span class="string">"application/json"</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Controller:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/dwp/contract/rebuildpdf"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseData <span class="title">rebuildpdf</span><span class="params">(HttpServletRequest request,  @RequestParam String contractTempNumber)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>2、处理表单数据</strong></p><p>获取Request中的formData参数。因此Ajax请求时<code>Content-Type</code> 必须是 <code>application/x-www-form-urlencoded</code> ,data中传的是对象。</p><p>示例：</p><p>Ajax：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url:_basePath + <span class="string">'/dwp/contract/rebuildpdf'</span>,</span><br><span class="line">    type: <span class="string">"POST"</span>,</span><br><span class="line">    dataType: <span class="string">"json"</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        contractTempNumber: $(<span class="string">'#contractTempNumber'</span>).val()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Controller:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/dwp/contract/rebuildpdf"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rebuildpdf</span><span class="params">(HttpServletRequest request, @RequestParam String contractTempNumber)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="RequestBody"><a href="#RequestBody" class="headerlink" title="@RequestBody"></a>@RequestBody</h3><p>获取Request 的Body</p><p>示例：</p><p>Ajax：</p><p>使用<code>JSON.stringify</code> 把对象转化成JSON字符串</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    url:_basePath + <span class="string">'/dwp/contract/rebuildpdf'</span>,</span><br><span class="line">    type: <span class="string">"POST"</span>,</span><br><span class="line">    dataType: <span class="string">"json"</span>,</span><br><span class="line">    contentType: <span class="string">"application/json"</span>,</span><br><span class="line">    data: <span class="built_in">JSON</span>.stringify(&#123;<span class="attr">contractTempNumber</span>:  $(<span class="string">'#contractTempNumber'</span>).val()&#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Controller:</p><p>对象<code>DwpContracts</code>中有<code>contractTempNumber</code> 这个属性字段。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/dwp/contract/rebuildpdf"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rebuildpdf</span><span class="params">(HttpServletRequest request,  @RequestBody DwpContracts contract)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="SessionAttributes"><a href="#SessionAttributes" class="headerlink" title="@SessionAttributes"></a>@SessionAttributes</h3><p>该注解用来绑定HttpSession中的attribute对象的值，便于在方法中的参数里使用。该注解有value、types两个属性，可以通过名字和类型指定要使用的attribute 对象；</p><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/editPet.do"</span>)</span><br><span class="line"><span class="meta">@SessionAttributes</span>(<span class="string">"pet"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EditPetForm</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ModelAttribute"><a href="#ModelAttribute" class="headerlink" title="@ModelAttribute"></a>@ModelAttribute</h3><p>该注解有两个用法，一个是用于方法上，一个是用于参数上；</p><p>用于方法上时：  通常用来在处理@RequestMapping之前，为请求绑定需要从后台查询的model；</p><p>用于参数上时： 用来通过名称对应，把相应名称的值绑定到注解的参数bean上；要绑定的值来源于：</p><p>A） @SessionAttributes 启用的attribute 对象上；</p><p>B） @ModelAttribute 用于方法上时指定的model对象；</p><p>C） 上述两种情况都没有时，new一个需要绑定的bean对象，然后把request中按名称对应的方式把值绑定到bean中。</p><p>用到方法上@ModelAttribute的示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Add one attribute</span></span><br><span class="line"><span class="comment">// The return value of the method is added to the model under the name "account"</span></span><br><span class="line"><span class="comment">// You can customize the name via @ModelAttribute("myAccount")</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">addAccount</span><span class="params">(@RequestParam String number)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accountManager.findAccount(number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用在参数上的@ModelAttribute示例代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/owners/&#123;ownerId&#125;/pets/&#123;petId&#125;/edit"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">processSubmit</span><span class="params">(@ModelAttribute Pet pet)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先查询 @SessionAttributes有无绑定的Pet对象，若没有则查询@ModelAttribute方法层面上是否绑定了Pet对象，若没有则将URI template中的值按对应的名称绑定到Pet对象的各属性上。</p><p>参考：<a href="https://blog.csdn.net/walkerjong/article/details/7946109" target="_blank" rel="noopener">https://blog.csdn.net/walkerjong/article/details/7946109</a></p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringMVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DDD及开发模式对比</title>
      <link href="/posts/156e5ee9/"/>
      <url>/posts/156e5ee9/</url>
      
        <content type="html"><![CDATA[<blockquote><p>不积跬步，无以至千里。 不积小流，无以成江海。</p></blockquote><p>转载自：Jiangzhou.bo</p><p>本文总结常用开发模式，简述DDD领域驱动设计，基于DEMO整理出后台架构模式。</p><a id="more"></a><h2 id="分层模式"><a href="#分层模式" class="headerlink" title="分层模式"></a>分层模式</h2><p>从大的范围来分，软件可以分为两个层次：前端和后台。前端负责与用户进行交互，负责接收和校验用户输入，并向用户反馈输出，其业务操作是委托给后台来实现的。我们平常见到很多分层架构模式，核心目的都是分层、解耦。</p><h3 id="MVC模式"><a href="#MVC模式" class="headerlink" title="MVC模式"></a>MVC模式</h3><p>MVC(Model-View-Controller)，即数据模型-视图-控制器，MVC 是开发客户端最经典的设计模式。MVC这个概念最早出现在桌面客户端上面，是C/S里面的C，在Web开发中得以发扬光大，实际上，移动App中也几乎都是MVC模式的。</p><p>在客户端开发中，Controller管理用户输入、输出和图形界面。数据来自Model部分，Model实际上集中管理了业务数据，是通向后台系统的通道。这使对同一种业务数据展现多种图形界面成为了可能，Controller存在的目的则是确保M和V的同步，一旦M改变，V应该同步更新。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220318.png" alt="MVC模式"></p><p>后端最典型的MVC就是JSP + servlet + javabean的模式。当用户发出一个请求后，这个请求会被控制器Servlet接收到；Servlet将请求的数据转换成数据模型JavaBean，然后调用业务逻辑模型JavaBean的方法，并将业务逻辑模型返回的结果放到合适的地方，比如请求的属性里；最后，根据业务逻辑模型的返回结果，由控制器来选择合适的视图(JSP)，由视图把数据展现给用户。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220404.png" alt="典型的MVC模式"></p><p>在很多开源框架中也有MVC设计的体现，如Struts2、SpringMVC等。就单从SpringMVC框架来说，DispatcherServlet是前端控制器，是整个流程控制的中心，由它调用其它组件处理用户的请求，相当于MVC的Controller；Handler(即我们开发的Controller)是继DispatcherServlet前端控制器的后端控制器，Handler对具体的用户请求进行处理，并返回ViewModel；最后由ViewResolver负责将处理结果生成View视图。</p><p>在Javaweb开发中，MVC框架充当了UI层和业务逻辑层的适配器的作用，MVC框架实现了UI层和业务逻辑层最大程度的分离。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220452.png" alt="SpringMVC"></p><h3 id="三层架构"><a href="#三层架构" class="headerlink" title="三层架构"></a>三层架构</h3><p>现在开发中常用的分层模式就是三层架构，这也是比较传统的一种架构模式。通常意义上的三层架构就是将整个业务应用划分为：表现层（UI）、业务逻辑层（BLL）、数据访问层（DAL）。区分层次的目的即为了“高内聚，低耦合”。</p><p>表现层：负责与用户进行交互；业务逻辑层：主要是针对具体的问题的操作，也可以理解成对数据层的操作，对数据业务逻辑处理；数据访问层：直接操作数据库，针对数据的增、删、改、查等。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220646.png" alt="三层架构"></p><p>对应到开发中，即常用的 Controller – Service – Dao 三层。Controller层为控制层，用来接收用户的请求，不会涉及太多的业务处理操作，会做一些简单的数据校验，业务处理完毕返回数据模型或视图。Controller层中拥有某一个Service层的引用，但凡涉及到业务处理，就交给Service层来操作。Service一般持有某一个或几个Dao层的引用来对数据做处理。一般来说，Service层和Dao层中，都是直接存放的接口类，然后有一个包放所有接口的实现类，impl就是指每个接口对应的实现类。</p><p>联系这三层之间的就是实体对象，比如，使用一个DTO映射数据表，Dao层返回的数据对象(DO)、Service层处理的业务对象(BO)、Controller层返回给用户的展示对象(VO)、甚至远程接口数据对象(DTO)都由一个DTO对象完成，这种模式一般在中小型项目中用得比较多，毕竟分层过多会引入复杂性。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220729.png" alt="DTO"></p><h3 id="三层架构与MVC"><a href="#三层架构与MVC" class="headerlink" title="三层架构与MVC"></a>三层架构与MVC</h3><p>我们经常将三层架构与MVC混为一谈，但是它俩并不是一个概念。三层架构是一个分层式的软件体系架构设计，它可适用于任何一个项目。MVC是一个设计模式，它是根据项目的具体需求来决定是否适用于该项目。三层架构的着重点是“高内聚，低耦合”，MVC的目的则是实现Web系统的职能分工，即职责划分。但它们的总体目的是一样的，都是为了解耦。</p><p>三层架构的表现层即客户端，一般是基于MVC模式开发，使用诸如AngularJS、Vue、React等前端框架。数据交互使用JSON。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603220831.png" alt="SERVER-CLIENT"></p><h3 id="DDD-领域驱动设计"><a href="#DDD-领域驱动设计" class="headerlink" title="DDD 领域驱动设计"></a>DDD 领域驱动设计</h3><p><strong>DDD</strong>(Domain<br>Driven Design)，领域驱动设计，作为一种软件开发方法，它可以帮助我们设计高质量的软件模型。在正确实现的情况下，我们通过DDD完成的设计恰恰就是软件的工作方式。在实施DDD时，设计就是代码，代码就是设计。</p><p><strong>DDD中重要的概念</strong></p><p><strong>通用语言</strong>(UL)<strong>：</strong>通用语言是团队自己创建的公用语言，团队中同时包含领域专家和软件开发人员，可以看成业务顾问和技术顾问。我们使用通用语言来捕捉特定核心业务领域中的概念和术语，比如店铺运营、商场促销。</p><p><strong>限界上下文</strong>(BC)<strong>：</strong>限界上下文是一个显示的边界，领域模型便存在于这个边界之内。这个边界之内的每种领域术语、词组或句子就组成了通用语言，都有确定的上下文含义。但是，限界上下文并不只局限于容纳模型，它通常标定了一个系统、一个应用程序或者一种业务服务。限界上下文中可以包含模块、聚合、领域事件、领域服务等基础部件，限界上下文应该足够大，以能够表达它所对应的整套通用语言。</p><p>在使用Java时，限界上下文可以看成IDE中的一个工程项目；顶层包名通常表示界限上下文中顶层模块的名字。我们可能将一个限界上下文放在一个jar或者war文件中。对于大型模型，可以将松耦合的领域模型放在不同的jar文件中，这样我们可以按照版本号对领域模型进行单独部署，这其实就可以看成单独的组件、微服务了。</p><p>通用语言和限界上下文同时构成了DDD的两大支柱，并且他们是相辅相成的。限界上下文和通用语言存在一对一的关系。</p><p><strong>领域：</strong>Domain，即一个组织所做的事情以及其中包含的一切。当我们为某个组织开发软件时，所面对的便是这个组织的领域。一个领域被分为若干子域，几乎所有软件的领域都包含多个子域。</p><p><strong>子域：</strong>我们可以按照实际功能将领域中交织的模型划分成逻辑上相互分离的子域，从而在一定程度上减少系统的复杂性。子域不一定要包含很多功能，简单的子域可以以模块的形式存在。子域又分核心域、支撑子域、通用子域。</p><p><strong>核心域：</strong>是整个业务领域的一部分，也是业务成功的主要促成因素，系统核心竞争力的体现。从战略层面上讲，企业应该在核心域上胜人一筹。</p><p><strong>支撑子域：</strong>支撑子域专注于业务的某个方面。</p><p><strong>通用子域：</strong>通用子域被用于整个业务系统。像用户和权限就可以放到通用子域。</p><p><strong>领域模型：</strong>领域模型是关于某个特定业务领域的软件模型。通常，<strong>领域模型通过对象模型来实现，这些对象同时包含了数据和行为，并且表达了准确的业务含义。</strong>领域模型在限界上下文中完成开发，在开发一个领域模型时，我们关注的通常只是这个业务系统的某个方面。</p><p><strong>问题空间：</strong>在问题空间，我们思考的是业务所面临的挑战。问题空间是领域的一部分，对问题空间的开发将产生一个新的核心域，问题空间是核心域和其它子域的组合。</p><p><strong>解决方案空间：</strong>在解决方案空间，我们思考如何实现软件以解决问题空间的业务挑战。解决方案空间包括一个或多个界限上下文，即一组特定的软件模型。</p><p>上下文映射图：</p><p>由多个界限上下文和子域组成的表示当前单个领域或者多个领域之间的集成关系图。上下文映射图主要帮助我们从解决方案空间的角度看待问题。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603221125.png" alt="业务领域"></p><p><strong>贫血领域对象：</strong>指领域对象主要是些公共的getter/setter方法，几乎没有业务逻辑，主要就是用来容纳属性值的对象，比如我们之前使用的DTO。这种对象一般不叫领域对象，只是将关系型数据库中的模型映射到了对象上而已。反之，充血模型就是DDD中的领域模型。</p><p><strong>贫血症导致的失忆症：</strong>例如，有一个保存店铺的功能，saveStore(Store dto)，Store关联有合同、员工、经营证照等，现在的开发模式中，仅仅修改了店铺的名称或者备注属性，会调用这个保存店铺的方法；在新建店铺时，新增了合同关系、店铺员工，也会在saveStore里保存合同关系、店铺员工。这样一来，我们并没有正确的使用saveStore方法，他的职责范围过大，业务意图不明确了，方法的实现本身就增加了潜在的复杂性，时间久了，我们可能会被这段代码搞得一头雾水。说白了就是业务过于集中，不同模型之间耦合度过高，甚至分不清职责边界，导致后期无法维护。</p><h3 id="DDD架构"><a href="#DDD架构" class="headerlink" title="DDD架构"></a>DDD架构</h3><h4 id="DDD四层架构"><a href="#DDD四层架构" class="headerlink" title="DDD四层架构"></a>DDD四层架构</h4><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603221304.png" alt="DDD四层架构"></p><p>DDD系统所采用的传统分层架构，核心域位于领域层，上层为用户界面层和应用层，下层是基础设施层。分层架构的一个重要原则是：每层只能与位于其下方的层发生耦合。分层架构有严格分层架构和松散分层架构，严格分层架构中，某层只能与直接位于其下方的层发生耦合；松散分层架构则允许任意上层与任意下层发生耦合。由于用户界面层和应用服务通常需要与基础设施打交道，许多系统都是基于松散分层架构的。</p><p><strong>用户接口层：</strong>这里指的用户可以是另一个计算机系统，也可以是使用用户界面的人。它不应该包含领域或业务逻辑，如果用户界面使用了领域模型中的对象，那么此时的领域对象仅限于数据的渲染展现，可以使用展现模型对用户界面和领域对象进行解耦。</p><p><strong>应用服务：</strong>应用服务位于应用层中，用户界面和面向服务端点都会将操作委派给应用服务。应用服务是很轻量的，主要负责用例流的任务协调，本身并不处理业务逻辑，可以用于控制事务和安全认证，或者向其他系统发送基于事件的消息通知，还可以用于创建邮件以发送给用户等等。如果应用服务过于复杂，就要考虑领域逻辑是否已经渗透到应用服务中了。有时，应用服务被设计成将用户界面完全地隔离于领域模型，此时，应用服务中的方法签名中将只出现最基本的数据类型(int，long，double，String等)，有可能还有DTO。在不使用领域对象返回时，我们避免了依赖和耦合，此时我们可以使用DTO，并提供转换器，虽然会导致一定的内存耗费，但避免了领域对象与不同系统间的耦合。</p><p><strong>领域服务：</strong>领域服务表示一个无状态的操作，它用于实现特定于某个领域的任务。当某个操作不是实体(领域对象)的职责时，最好的方式就是使用领域服务，我们应该尽量避免在实体中使用资源库。要避免所有的业务逻辑都位于领域服务中，否则可能导致贫血领域模型。一般来说，我们不需要为领域服务设计独立的接口，直接使用实现类即可，如果确实针对不同的租户有不同的实现标准，可以使用独立接口。因为通常情况下，领域服务总是和领域密切相关，并且不会有技术性的实现，或者不会有多个实现，此时采用独立接口便只是一个风格上的问题。虽然独立接口对于解耦来说是有用处的，此时客户端只需要依赖于接口，而不需要知道具体实现。但是，如果我们使用了依赖注入或工厂，即便接口和实现类是合并在一起的，我们依然能达到这样的目的。</p><p><strong>基础设施层：</strong>在传统的分层架构中，基础设施层位于底层，持久化和消息机制便位于该层中，包括持久化、消息、邮件等。可以将基础设施层中所有的组件和框架看作是应用程序的底层服务，较高层与该层发生耦合以重用技术上的基础设施。</p><p>总的来说DDD就是从以数据库为中心过度到以领域模型为中心，将侧重点从效率改变为维护。从长远的角度看，以领域模型为中心的设计更加清晰，也是一种更忠实于领域抽象的实现，因而可维护性更高。</p><h4 id="六边形架构（端口与适配器）"><a href="#六边形架构（端口与适配器）" class="headerlink" title="六边形架构（端口与适配器）"></a>六边形架构（端口与适配器）</h4><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603221350.png" alt="六边形架构"></p><p>六边形架构也称为端口与适配器。对于每种外界类型，都有一个适配器与之对应。在这种架构中，不同的客户端通过“平等”的方式与系统交互。该架构中存在两个区域，分别是“外部区域”和“内部区域”。在外部区域中，不同的客户(系统、用户等)均可以提交输入；而内部的系统则处理数据相关。为了保证领域模型所在的应用程序的干净简洁和自治性，各种适配器作为防腐层在整个程序的最外层保护着当前的界限上下文不受外部入侵。</p><p>从图中可以看出，每种类型的客户都有他自己的适配器，该适配器用于将客户输入转为为程序内部API所能理解的输入。六边形的每条不同的边代表了不同类型的端口，可以将端口想成是HTTP，而将适配器想成Controller用来请求的类。新的客户只需要添加一个新的适配器将客户输入转化成能被系统API所理解的参数就行了。对于每种特定的输出，都有一个新建的适配器负责完成相应的转化功能。</p><h4 id="CQRS——命令和查询职责分离"><a href="#CQRS——命令和查询职责分离" class="headerlink" title="CQRS——命令和查询职责分离"></a>CQRS——命令和查询职责分离</h4><p>从资源库中查询所有需要显示的数据是困难的，特别是在需要显示来自不同聚合类型与实例的数据时。我们需要从不同的资源库获取聚合实例，然后再将这些实例数据组装成一个数据传输对象(DTO)。</p><p>CQRS强调一个方法要么是执行某种动作的命令，要么是返回数据的查询，而不能两者皆是。如果一个方法修改了对象的状态，该方法便是一个命令，它不应该返回数据，这样的方法应该声明为void。如果一个方法返回了数据，该方法便是一个查询，此时它不应该通过直接或间接的手段修改对象的状态，这样的方法应该以其返回的数据类型进行声明。</p><p>CQRS指导我们将领域模型中包含命令和查询的聚合拆分开，将那些纯粹的查询功能从命令功能中分离出来，最终分为命令模型和查询模型。</p><p>CQRS架构本身只是一个读写分离的思想，实现方式多种多样，比如数据存储不分离，仅仅只是代码层面读写分离，也是CQRS的体现；数据存储的读写分离，C端负责数据存储，Q端负责数据查询。这种架构方式有待深入研究。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190603221528.png" alt="CQRS"></p><h2 id="DDD总结"><a href="#DDD总结" class="headerlink" title="DDD总结"></a>DDD总结</h2><h4 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h4><p>在微服务架构实践中，人们大量地使用了DDD中的概念和技术：</p><ul><li><p>微服务中应该首先建立UL，然后再讨论领域模型。</p></li><li><p>一个微服务最大不要超过一个BC，否则微服务内会存在有歧义的领域概念。</p></li><li><p>一个微服务最小不要小于一个聚合，否则会引入分布式事务的复杂度。</p></li><li><p>微服务的划分过程类似于BC的划分过程，每个微服务都有一个领域模型。</p></li><li><p>微服务间的集成可以通过ACL。</p></li><li><p>微服务间最好采用Domain Event（领域事件）来进行交互，使得微服务可以保持松耦合。</p></li></ul><h4 id="DDD所带来的业务价值"><a href="#DDD所带来的业务价值" class="headerlink" title="DDD所带来的业务价值"></a>DDD所带来的业务价值</h4><ul><li><p>你获得了一个非常有用的领域模型</p></li><li><p>你的业务得到了更准确的定义和理解</p></li><li><p>领域专家可以为软件设计做出贡献</p></li><li><p>更好的用户体验</p></li><li><p>清晰的模型边界</p></li><li><p>更好的企业架构</p></li><li><p>敏捷、迭代式和持续建模</p></li><li><p>使用战略和战术工具</p></li></ul><h4 id="DDD所带来的挑战"><a href="#DDD所带来的挑战" class="headerlink" title="DDD所带来的挑战"></a>DDD所带来的挑战</h4><ul><li><p>为创建通用语言腾出时间和精力</p></li><li><p>持续地将领域专家引入项目</p></li><li><p>改变开发者对领域的思考方式</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开发模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React的组件</title>
      <link href="/posts/989a4a19/"/>
      <url>/posts/989a4a19/</url>
      
        <content type="html"><![CDATA[<p>React 以组件的形式来构建页面。把页面上的各个部分拆分成独立的组件，这些组件可以组合，嵌套，复用从而组成我们的页面。可以说 React 中一切皆组件。</p><a id="more"></a><h1 id="创建组件"><a href="#创建组件" class="headerlink" title="创建组件"></a>创建组件</h1><p>React 有三种创建组件的方式，我们可以按自己的需要选择使用那一种。</p><h2 id="无状态函数式组件"><a href="#无状态函数式组件" class="headerlink" title="无状态函数式组件"></a>无状态函数式组件</h2><p>React 中无状态组件是一种最简单的组件，它没有<code>state</code> 和各种生命周期函数</p><p>每个组件都可以通过一个<code>state</code>状态的改变从而产生变化</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>认识React</title>
      <link href="/posts/cf11c7d6/"/>
      <url>/posts/cf11c7d6/</url>
      
        <content type="html"><![CDATA[<p>在17年的时候就找资料学习了React，但许久不用，发现完全记不得了，这两天重新学习了React，加深了对React的一些理解，但目前也是浅尝辄止，只能说能够做一些基础的开发。通过学习笔记今后在工作中上手后慢慢加深学习吧。</p><a id="more"></a><h2 id="React-简介"><a href="#React-简介" class="headerlink" title="React 简介"></a>React 简介</h2><blockquote><p>React是FaceBook开源的一个用于构建用户界面的JavaScript库，已经应用于FaceBook及旗下的Instagram。 React专注于MVC框架中的V，即视图层。它引入了虚拟DOM的概念，提高了运行效率</p></blockquote><blockquote><p>React.js 不是一个框架，它只是一个库。它只提供 UI （view）层面的解决方案。在实际的项目当中，它并不能解决我们所有的问题，需要结合其它的库，例如 Redux、React-router 等来协助提供完整的解决方法。</p></blockquote><p>先写一个简历的例子来感受一下 React 的用法。</p><p>App.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component &#125; from &apos;react&apos;</span><br><span class="line">import ReactDOM from &apos;react-dom&apos;</span><br><span class="line"></span><br><span class="line">export default App extends Component&#123;</span><br><span class="line">    render()&#123;</span><br><span class="line">        return(&lt;div&gt;&lt;span className=&apos;title&apos;&gt;Hello World!&lt;/span&gt;&lt;/div&gt;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;App /&gt;,</span><br><span class="line">    document.getElementById(&apos;root&apos;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>在上面的代码中，头部<code>react</code>的包当中引入了<code>React</code>与组件父类<code>Component</code> ，只要是写React的组件，都必须要引入这两个东西。</p><p><code>ReactDOM</code> 可以帮助我们把 React 组件渲染到页面上去。</p><p><code>export default</code> 表示这个类为默认输出，并且在文件中只有一个，在其它模块引入它时不需要加 <code>{}</code></p><p>如果只使用 <code>export</code> 表示这个类可以被引用，一个文件中可以有多个，引入时需要加<code>{}</code>。</p><p>export 与 export default 均可用于导出常量、函数、文件、模块等</p><p>在上面的代码中，组件必须有一个<code>render</code> 方法。在<code>return</code>中我们可以像写 HTML 那样书写，但这里不是HTML，是JSX的语法。</p><p>##JSX 原理</p><p>JSX是 React.js 对 JavaScript 语法的扩展，使我们可以使用类似 HTML 的元素来描述JavaScript对象。编译的过程会把 JSX 的这种结构转换成 JavaScript 的对象结构。</p><p>如上述代码中的 JSX</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;<span class="xml"><span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">'title'</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>编译过后被转换成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">&quot;div&quot;,</span><br><span class="line">    &quot;null&quot;,</span><br><span class="line">    React.createElement(</span><br><span class="line">    &quot;span&quot;,</span><br><span class="line">        &#123; className : &apos;title&apos;&#125;,</span><br><span class="line">        &quot;Hello World!&quot;</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="React环境"><a href="#React环境" class="headerlink" title="React环境"></a>React环境</h2><p>React的开发环境我们可以直接使用官网推荐的 <code>create-react-app</code> 工具来创建 React 模板项目。我后面写的代码都是用这个创建模板项目来写的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g create-react-app  <span class="comment"># 安装</span></span><br><span class="line">create-react-app hello-react <span class="comment"># 创建项目hello-react</span></span><br></pre></td></tr></table></figure><p>也可以在 <strong>Idea</strong> 上直接创建<code>New -&gt; project -&gt; static Web -&gt; React App</code> ，在<code>create-react-app</code> 一栏选择到 <code>create-reate-app</code> 的包即可。</p><h2 id="细节规范"><a href="#细节规范" class="headerlink" title="细节规范"></a>细节规范</h2><p>在学习的过程上也发现了一些比较细节的 React 规范，如果不知道的话很容易出错。</p><ul><li>组件命名首字母必须大写，比如上面的App组件</li><li>所有组件类都必须有自己的 render 方法，用于输出组件</li><li>组件中的render方法中只能返回一个JSX对象。所有当我们需要返回多个标签时，在最外层必须用一个 div 或其它标签将其包装成一个整体。</li><li>样式的类名不能使用 <code>class</code> 因为它是 JavaScript 的关键字，因此规定使得 <code>className</code> 来表示。</li><li>在书写 CSS 样式时，所有属性都使用驼峰形式，去掉中间的 <code>-</code></li><li>在标签上写<code>style</code> 样式时使用 双大括号 ，这里的<code>style</code> 接收的是一个对象，因此最外层需要一个大括号，里面的大括号表示样式组合。</li></ul><h2 id="推荐学习"><a href="#推荐学习" class="headerlink" title="推荐学习"></a>推荐学习</h2><p>React 小书 ： <a href="http://huziketang.mangojuice.top/books/react/" target="_blank" rel="noopener">http://huziketang.mangojuice.top/books/react/</a></p><p>React在线编辑器 ：<a href="https://jsfiddle.net/reactjs/69z2wepo/" target="_blank" rel="noopener">https://jsfiddle.net/reactjs/69z2wepo/</a> </p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用docker-compose编排微服务</title>
      <link href="/posts/625295f9/"/>
      <url>/posts/625295f9/</url>
      
        <content type="html"><![CDATA[<p> 上篇 <a href="https://hjwjw.github.io/posts/719142df/" target="_blank" rel="noopener">使用Maven构建微服务的Docker镜像</a> 写了如何构建微服务的镜像及运行镜像。但往往我们整个微服务架构中会有几十个甚至几百个微服务，我们不可能都使用手动去启停，那样效率很低，维护量也很大。</p><a id="more"></a><p>因此我们需要一个自动化的工具帮助我们管理容器。本篇使用的是<code>docker-compose</code> 。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><blockquote><p> <code>Compose</code> 支持 Linux、macOS、Windows 10 三大平台.</p><p><code>Compose</code> 可以通过 Python 的包管理工具 <code>pip</code> 进行安装，也可以直接下载编译好的二进制文件使用，甚至能够直接在 Docker 容器中运行。</p></blockquote><p>我是Centos 7因此我使用的是二进制包的形式安装。使用如下命令进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/1.17.1/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><p>安装完成后检查<code>docker-compose</code>版本OK就好了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># docker-compose -v</span></span><br><span class="line">docker-compose version 1.23.1, build b02f1306</span><br></pre></td></tr></table></figure><h2 id="编排微服务"><a href="#编排微服务" class="headerlink" title="编排微服务"></a>编排微服务</h2><p>使用<code>docker-compose</code>编排微服务大致步骤如下：</p><p>1、编写各服务的<code>Dockerfile</code> </p><p>2、编写<code>docker-compose.yml</code> 定义组成应用程序的服务及各服务的依赖，网络配置等</p><p>3、运行<code>docker-compose up</code>命令，启动并运行整个项目</p><p>本例项目源码使用之前做过的项目，把Eureka，provider-user，consumer-movie进行编排。源码查看：<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-discovery-eureka" target="_blank" rel="noopener">microservice-discovery-eureka</a>、<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-simple-provider-user" target="_blank" rel="noopener">microservice-simple-provider-user</a>、<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-simple-consumer-movie" target="_blank" rel="noopener">microservice-simple-consumer-movie</a></p><p>目录结构如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">├─.idea</span><br><span class="line">│  ├─inspectionProfiles</span><br><span class="line">│  └─libraries</span><br><span class="line">├─microservice-discovery-eureka</span><br><span class="line">│  ├─src</span><br><span class="line">│  │  └─main</span><br><span class="line">│  │      ├─java</span><br><span class="line">│  │      │  └─com</span><br><span class="line">│  │      │      └─hjwzyy</span><br><span class="line">│  │      │          └─META-INF</span><br><span class="line">│  │      └─resources</span><br><span class="line">|  └─Dockerfile</span><br><span class="line">|  └─pom.xml</span><br><span class="line">├─microservice-simple-consumer-movie</span><br><span class="line">│  ├─src</span><br><span class="line">│  │  └─main</span><br><span class="line">│  │      ├─java</span><br><span class="line">│  │      │  └─com</span><br><span class="line">│  │      │      └─hjwzyy</span><br><span class="line">│  │      │          ├─contorllers</span><br><span class="line">│  │      │          └─pojo</span><br><span class="line">│  │      └─resources</span><br><span class="line">│  │          ├─static</span><br><span class="line">│  │          └─templates</span><br><span class="line">|  └─Dockerfile</span><br><span class="line">|  └─pom.xml</span><br><span class="line">├─microservice-simple-provider-user</span><br><span class="line">│  ├─src</span><br><span class="line">│  │  └─main</span><br><span class="line">│  │      ├─java</span><br><span class="line">│  │      │  └─com</span><br><span class="line">│  │      │      └─hjwzyy</span><br><span class="line">│  │      │          ├─contorllers</span><br><span class="line">│  │      │          ├─dao</span><br><span class="line">│  │      │          └─pojo</span><br><span class="line">│  │      └─resources</span><br><span class="line">|  └─Dockerfile</span><br><span class="line">|  └─pom.xml</span><br><span class="line">├─ docker-compose.yml</span><br><span class="line">├─ pom.xml</span><br></pre></td></tr></table></figure><hr><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>这三个微服务的Dockerfile文件如何编写可以参考前面的博客：<a href="https://hjwjw.gitee.io/posts/719142df/">使用Maven构建微服务的Docker镜像</a>  这里不再赘述。</p><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><p>docker-compose.yml 文件的编写是关键。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span><span class="comment"># docker-compose 版本</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">    eureka:</span><span class="comment"># 服务名</span></span><br><span class="line"><span class="attr">        build:</span></span><br><span class="line"><span class="attr">          context:</span> <span class="string">./microservice-discovery-eureka</span><span class="comment"># Dockerfile 文件所在路径</span></span><br><span class="line"><span class="attr">          dockerfile:</span> <span class="string">Dockerfile</span>   <span class="comment"># Dockerfile 文件名</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            JAR_FILE:</span> <span class="string">target/microservice-discovery-eureka-0.0.1-SNAPSHOT.jar</span>   <span class="comment"># 构建参数传递</span></span><br><span class="line"><span class="attr">        ports:</span>  <span class="comment"># 开放端口</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"8761:8761"</span></span><br><span class="line"><span class="attr">    microservice-simple-provider-user:</span></span><br><span class="line"><span class="attr">        build:</span></span><br><span class="line"><span class="attr">          context:</span> <span class="string">./microservice-simple-provider-user</span></span><br><span class="line"><span class="attr">          dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            JAR_FILE:</span> <span class="string">target/microservice-simple-provider-user-0.0.1-SNAPSHOT.jar</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"8010:8010"</span></span><br><span class="line"><span class="attr">    microservice-simple-consumer-movie:</span></span><br><span class="line"><span class="attr">        build:</span></span><br><span class="line"><span class="attr">          context:</span> <span class="string">./microservice-simple-consumer-movie</span></span><br><span class="line"><span class="attr">          dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="attr">            JAR_FILE:</span> <span class="string">target/microservice-simple-consumer-movie-0.0.1-SNAPSHOT.jar</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">"8011:8011"</span></span><br><span class="line"><span class="attr">        depends_on:</span><span class="comment"># 依赖</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">microservice-simple-provider-user</span></span><br></pre></td></tr></table></figure><p>以上是使用最简单的方式进行配置。</p><p><code>build</code>  : 使用 <code>build</code> 并指定<code>Dockerfile</code> ，docker-compose 会根据<code>Dockerfile</code> 构建镜像。这里使用了<code>args</code> 传入了<code>Dockerfile</code> 构建镜像时需要的参数，前面通过 maven 构建镜像时，这个参数是从<code>pom</code>文件中传入的。这里的构建不通过 maven ，因此需要单独在<code>docker-compose.yml</code> 中传入<code>args</code>，否则会由于缺少参数而构建镜像失败。</p><p><code>depends_on</code> : 表示这个服务依赖于某个服务，如microservice-simple-consumer-movie 是依赖 microservice-simple-provider-user 的，provider  启动了，consumer 才能访问到数据。因此如果配置了依赖的服务，<code>docker-compose</code> 会先启动被依赖的服务。</p><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>上面的步骤做完之后，就可以启动Docker-compse了。只需要简单的一条命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure><p>docker-compose 会根据<code>docker-compose.yml</code> 配置的内容进行镜像的构建并启动。</p><h3 id="docker-compose-配置"><a href="#docker-compose-配置" class="headerlink" title="docker-compose 配置"></a>docker-compose 配置</h3><p>Docker-compose 的具体用法 及 yml 文件的具体配置可以参考  : <a href="https://docker_practice.gitee.io/compose/compose_file.html" target="_blank" rel="noopener">https://docker_practice.gitee.io/compose/compose_file.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Maven构建微服务的Docker镜像</title>
      <link href="/posts/719142df/"/>
      <url>/posts/719142df/</url>
      
        <content type="html"><![CDATA[<p>在预习了Docker的知识后，开始对微服务进行Docker容器化改造。</p><a id="more"></a><p>本篇内容前提：</p><ul><li>已安装 Docker 的服务器环境</li><li>Docker 基础操作</li></ul><p>Docker 的基础学习笔记可以在本博客 Docker 分类中查看。</p><hr><p>我使用 Maven 来构建 Docker 镜像。Maven 有几个Docker 插件可以使用，这里使用的是 由<code>Spotify</code> 公司开发的 Maven 插件。</p><blockquote><p>插件名称：dockerfile-maven  地址：<a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener">https://github.com/spotify/dockerfile-maven</a></p></blockquote><p>在它前面还有一个”哥哥” <code>docker-maven-plugin</code>  这个插件已经不推荐使用了。<code>docker-maven-plugin</code>插件可以不使用<code>Dockerfile</code> 而直接在<code>pom.xml</code>中来构建镜像，但随着时间的推移<code>Spotify</code>公司也意识到这种方式可能导致很多不必要的混淆，使用<code>Dockerfile</code>构建镜像是最简单的方法，因此但这种方式不推荐,这个项目也不会再增加新功能，仅限错误修复。所以我一开始就学习的<code>dockerfile-maven</code> 插件。它会连接远程Docker，只要一个命令就能把本地的jar包打成Docker镜像，命令执行完毕后，服务器上就会有刚打包好的镜像，此时再执行该镜像即可。</p><p>下面使用<code>dockerfil-maven</code>来构建镜像，以前面的 <code>microservice-consumer-movie</code> 项目为例。</p><h2 id="添加属性"><a href="#添加属性" class="headerlink" title="添加属性"></a>添加属性</h2><p>在添加插件前先在<code>pom.xml</code>中添加一些属性，方便配置，在<code>pom</code>中添加如下<code>properties</code>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>hjwjw<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">docker.plugin.version</span>&gt;</span>1.4.9<span class="tag">&lt;/<span class="name">docker.plugin.version</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="添加插件"><a href="#添加插件" class="headerlink" title="添加插件"></a>添加插件</h2><p>在项目的pom.xml中添加<code>dockerfile-maven</code>插件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;docker.plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                 <span class="comment">&lt;!--&lt;goal&gt;push&lt;/goal&gt;--&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>插件配置说明</strong></p><ul><li>repository : 用于命名构建镜像的存储库，生成的镜像名如：<code>hjwjw/microservice-discovery-eureka</code>。</li><li>tag : 是标签名称，这里指定标签名为pom中的<code>${project.version}</code> ，这里即是：0.0.1-SNAPSHOT</li><li>buildArgs : 为构建参数，可以在构建里将参数传到Dockerfile中，<code>${project.build.finalName}</code> 表示打包后jar包的名称。这里是将jar的路径传递到Dockerfile中。</li><li>executions : 这里设置把插件的<code>goal</code> 绑定到某个<code>phase</code> 上，实现打包完成后自动构建镜像并推送，这里没有配置远程仓库因此不推送到远程仓库。</li></ul><blockquote><p>phase 和 goal 可以这样理解：maven 命令格式是：mvn phase:goal ,例如mvn package dockerfile:build .那么，package 和 dockerfile 都是 phase ,build则是 goal 。</p></blockquote><h2 id="添加Dockerfile"><a href="#添加Dockerfile" class="headerlink" title="添加Dockerfile"></a>添加Dockerfile</h2><p>在项目根目录添加<code>Dockerfile</code> 文件，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM livingobjects/jre8</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ARG JAR_FILE</span><br><span class="line">ADD <span class="variable">$&#123;JAR_FILE&#125;</span> app.jar</span><br><span class="line">RUN bash -c <span class="string">'touch /app.jar'</span></span><br><span class="line">EXPOSE 8010</span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>,<span class="string">"-Djava.security.egd=file:dev/./urandom"</span>,<span class="string">"-jar"</span>,<span class="string">"/app.jar"</span>]</span><br></pre></td></tr></table></figure><blockquote><p>livingobjects/jre8 是一个比较小的jre8的基础镜像，构建镜像时会快些。</p></blockquote><p>Dockerfile 的参数在 <a href="https://hjwjw.gitee.io/posts/1ef71e38/">Dockerfile实践</a> 中已经写过，可以在本博客搜索查看。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARG JAR_FILE</span><br><span class="line">ADD $&#123;JAR_FILE&#125; app.jar</span><br></pre></td></tr></table></figure><p>表示接收构建参数<code>JAR_FILE</code> 这个参数在前面的<code>pom.xml</code>中配置插件时已经添加。参数内容为jar 的的路径，<code>${JAR_FILE}</code>则是使用传递进来的参数。</p><h2 id="开启Docker远程"><a href="#开启Docker远程" class="headerlink" title="开启Docker远程"></a>开启Docker远程</h2><p>开启Docker远程方法可参考博客：<a href="https://hjwjw.gitee.io/posts/b035bcd6/#%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE">Docker安装配置</a></p><p>开启后在本机上配置一个环境变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_HOST=tcp://ip:2375</span><br></pre></td></tr></table></figure><p>IP 为Docker 所安装的服务器IP ，端口一般没有修改过默认会是<code>2375</code></p><p><code>dockerfile-maven</code> 插件就是通过在本机操作 Docker api 构建镜像的，因此本机上不需要安装Docker，能够访问到Docker服务器即可。</p><h2 id="构建image"><a href="#构建image" class="headerlink" title="构建image"></a>构建image</h2><p>前面的配置都完成后，在IDE的命令窗口只需要一个命令即可实现对项目的打包及构建镜像到Docker服务器。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure><p>执行命令过程如图：</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141324.png" alt="打包并构建image"></p><p>可以看到按Dockerfile一步步构建镜像了，执行完成后我们就可以在Docker服务器上查看新的image，如下：</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141342.png" alt="docker imges"></p><p>至此，Docker 构建微服务镜像完成。源码： <a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-consumer-movie" target="_blank" rel="noopener">microservice-customer-movie</a></p><p>镜像运行可以参考本博客分类：<a href="https://hjwjw.gitee.io/categories/Docker/">Docker</a></p><h2 id="镜像tag"><a href="#镜像tag" class="headerlink" title="镜像tag"></a>镜像tag</h2><p>在使用上面的方式生成镜像时，我们前面在<code>pom.xml</code> 中已经配置了构建时的<code>tag</code>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果不配置这个参数，默认生成的<code>tag</code> 是 <code>latest</code>。</p><p>有时我们想修改成自己的<code>tag</code> ，可以通过<code>dockerfile:tag</code> 修改，但需要先把 <code>pom.xml</code> 中指定的<code>tag</code> 配置去掉。在<code>pom.xml</code>中删除如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接着使用如下<code>maven</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dockerfile:tag -Ddockerfile.tag=config</span><br></pre></td></tr></table></figure><p>执行完成后Docker 服务器上会出现一个基于<code>hjwjw/microservice-consumer-movie:0.0.1-SNAPSHOT</code>镜像的<code>tag</code> 为<code>config</code> 的新镜像。</p><p>同样的，如果在<code>pom</code>中没有指定<code>tag</code>，在使用<code>dockerfile:build</code> 构建新镜像时也可以指定<code>tag</code>名：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dockerfile:build -Ddockerfile.tag=consumer</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微服务镜像 </tag>
            
            <tag> dockerfile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git常用操作集合</title>
      <link href="/posts/ad970cda/"/>
      <url>/posts/ad970cda/</url>
      
        <content type="html"><![CDATA[<p>记录一些常用的git 操作。 </p><a id="more"></a><h1 id="时光穿梭机"><a href="#时光穿梭机" class="headerlink" title="时光穿梭机"></a>时光穿梭机</h1><h2 id="查看修改内容"><a href="#查看修改内容" class="headerlink" title="查看修改内容"></a>查看修改内容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff filename</span><br></pre></td></tr></table></figure><p>查看filename修改内容</p><h2 id="回到过去-退回历史版本"><a href="#回到过去-退回历史版本" class="headerlink" title="回到过去(退回历史版本)"></a>回到过去(退回历史版本)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 139dcfaa558e3276b30b6b2e5cbbb9c00bbdca96</span><br></pre></td></tr></table></figure><p>退回到指定版本</p><h2 id="修改commit注释"><a href="#修改commit注释" class="headerlink" title="修改commit注释"></a>修改commit注释</h2><p>有时提交commit后发现注释没写对，如果这个commit 还未 push 上去，我们可以通过以下命令修改注释：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend</span><br></pre></td></tr></table></figure><p>执行命令后会出现一个vim 窗口进行修改。但只限于修改最近提交的一条commit 的注释。</p><h1 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a>分支操作</h1><h2 id="查看远程分支："><a href="#查看远程分支：" class="headerlink" title="查看远程分支："></a>查看远程分支：</h2><p>第一个带星号的是当前的分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git branch -a</span><br><span class="line"></span><br><span class="line"> *aisino-fssc-hx</span><br><span class="line">  master</span><br><span class="line">  remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">  remotes/origin/aisino-fssc-hx</span><br><span class="line">  remotes/origin/dev</span><br><span class="line">  remotes/origin/master</span><br></pre></td></tr></table></figure><h2 id="查看本地分支："><a href="#查看本地分支：" class="headerlink" title="查看本地分支："></a>查看本地分支：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line">*aisino-fssc-hx</span><br><span class="line"> master</span><br></pre></td></tr></table></figure><p>##新建本地分支：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git branch <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">查看</span><br><span class="line">git branch</span><br><span class="line">*aisino-fssc-hx</span><br><span class="line">master</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure></p><h2 id="分支推到远程分支："><a href="#分支推到远程分支：" class="headerlink" title="分支推到远程分支："></a>分支推到远程分支：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="切换分支到新建的Test："><a href="#切换分支到新建的Test：" class="headerlink" title="切换分支到新建的Test："></a>切换分支到新建的Test：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Switched to branch <span class="string">'test'</span></span><br></pre></td></tr></table></figure><h2 id="删除本地分支："><a href="#删除本地分支：" class="headerlink" title="删除本地分支："></a>删除本地分支：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git branch -d <span class="built_in">test</span></span><br><span class="line">Deleted branch <span class="built_in">test</span> (was 8b84db7).</span><br></pre></td></tr></table></figure><h2 id="删除远程分支："><a href="#删除远程分支：" class="headerlink" title="删除远程分支："></a>删除远程分支：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin --delete <span class="built_in">test</span></span><br><span class="line">To https://rdc.hand-china.com/gitlab/AISINO/aisino-fssc.git</span><br><span class="line"></span><br><span class="line">- [deleted]         <span class="built_in">test</span></span><br><span class="line">删除tag：</span><br><span class="line">git push origin --delete tag &lt;tagname&gt;</span><br></pre></td></tr></table></figure><h2 id="重命名本地分支："><a href="#重命名本地分支：" class="headerlink" title="重命名本地分支："></a>重命名本地分支：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m oldname newname</span><br></pre></td></tr></table></figure><h2 id="重命名远程分支："><a href="#重命名远程分支：" class="headerlink" title="重命名远程分支："></a>重命名远程分支：</h2><p>在git中重命名远程分支，其实就是先删除远程分支，然后重命名本地分支，再重新提交一个远程分支。<br>本地tag推送到远程：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push --tags</span><br></pre></td></tr></table></figure><p>获取远程tag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin tag &lt;tagname&gt;</span><br></pre></td></tr></table></figure><p>设置本地分支关联的远程分支（默认的push和pull的分支）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git branch --<span class="built_in">set</span>-upstream-to=origin/aisino-fssc-hx aisino-fssc-hx</span><br></pre></td></tr></table></figure><p>在远程新建分支，然后在本地克隆一个master分支，然后fetch</p><h2 id="更换远程分支"><a href="#更换远程分支" class="headerlink" title="更换远程分支"></a>更换远程分支</h2><p>方式一：修改远程分支地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote set-url origin URL</span><br></pre></td></tr></table></figure><p>URL 为新远程地址</p><p>方式二：先删除远程仓库地址，再添加新地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote rm origin</span><br><span class="line">git remote add origin URL</span><br></pre></td></tr></table></figure><p>URL 为新远程地址</p><p>查看远程地址</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure><h2 id="合并分支到主分支"><a href="#合并分支到主分支" class="headerlink" title="合并分支到主分支"></a>合并分支到主分支</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git  checkout master <span class="comment"># 从分支上切换到主分支，并pull主分支</span></span><br><span class="line">git  merge dev    <span class="comment"># 合并dev分支到主分支 </span></span><br><span class="line">git status    <span class="comment"># 查看状态</span></span><br><span class="line">git push origin master<span class="comment">#提交</span></span><br></pre></td></tr></table></figure><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="修改git提交账户"><a href="#修改git提交账户" class="headerlink" title="修改git提交账户"></a>修改git提交账户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此命令会列出所有GIT当时能找到的配置</span></span><br><span class="line">git config --list</span><br><span class="line"><span class="comment">#修改git提交的email</span></span><br><span class="line">git config --global user.email <span class="built_in">test</span>@test.com </span><br><span class="line"><span class="comment">#修改提交的git的user.name  </span></span><br><span class="line">git config --global user.name <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="查看git配置"><a href="#查看git配置" class="headerlink" title="查看git配置"></a>查看git配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --system --list#查看系统git配置</span><br><span class="line">git config --local --list#查看当前仓库git配置</span><br><span class="line">git config --global --list#查看当前用户git配置</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> TortoiseGit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TortoiseGit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git合并指定commits</title>
      <link href="/posts/a7518828/"/>
      <url>/posts/a7518828/</url>
      
        <content type="html"><![CDATA[<p>在使用 <code>git</code> 时我们可能会遇到这样的需求： 想要合并某个分支下的某个特定的 <code>commits</code></p><p>如我想把 <code>feature</code> 分支上的 <code>commit</code>  eef67189e9cc73f9bcb4af416ae8248f8e65dca4  合并到我的主分支中。这时我可以使用 <code>git cherry-pick</code> 命令来实现。</p><p>首先切换到主分支,然后使用命令加上指定<code>commit</code> 的Revision Number</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br><span class="line">git cherry-pick eef67189e9cc73f9bcb4af416ae8248f8e65dca4</span><br></pre></td></tr></table></figure><p>操作完后在<code>master</code> 分支上会出现一个新的<code>commit</code>。这样就可以实现我们上面的需求了。</p><p>有时可能不只需要合并一个<code>commit</code> 而是一系列相连的 <code>commits</code>，这时我们可以使用<code>rebase</code> 会更适合。</p><p>如我需要把<code>featrue</code> 分支的 <code>commit</code> 992e6c 到 dc40bb  合并到主分支.</p><p>首先需要基于<code>featrue</code> 创建一个新的分支，并指明最后一个<code>commit</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b newbranch dc40bb</span><br></pre></td></tr></table></figure><p>然后 <code>rebase</code> 这个新分支的<code>commit</code> 到 <code>master</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --onto master 992e6c^</span><br></pre></td></tr></table></figure><p><code>992e6c ^</code> 表示从哪个特定的<code>commit</code> 开始 。</p><p>这样就实现了我的第二个需求。</p>]]></content>
      
      
      <categories>
          
          <category> TortoiseGit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TortoiseGit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker错误集合</title>
      <link href="/posts/9d44b524/"/>
      <url>/posts/9d44b524/</url>
      
        <content type="html"><![CDATA[<p>本文收集我在使用Docker时遇到的一些错误及解决办法。</p><a id="more"></a><hr><blockquote><p>Could not acquire image ID or digest following build</p></blockquote><p>在使用Docker构建微服务镜像时出现的错误。第一天构建好好的，第二天就出现了这样的错误。通过百度这条错误的信息非常少，只在 <code>stackoverflow.com</code> 上找到一条，问题指向了<a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener"> dockerfile-maven</a> 插件，我确实使用了这个插件来，并通过远程的方式来构建我的微服务镜像。之前使用的是它的兄弟 <a href="https://github.com/spotify/docker-maven-plugin" target="_blank" rel="noopener">docker-maven-plugin </a>插件。在 <code>dockerfile-maven</code> 的 <a href="https://github.com/spotify/dockerfile-maven/issues/25#issuecomment-310667051" target="_blank" rel="noopener">issues</a> 中有人提到了这个错误，但解决方法是与 <code>.dockerignore</code> 有关，但在我的项目中并没有使用<code>.dockerignore</code> ，这就很尴尬了，除了这里网上再也找不出来这个错误解决方法了，使出终极大法重装 Doker ，这个错误就消失了，，</p><hr><blockquote><p>Exception caught: failed to create rwlayer: lstat /var/lib/docker/overlay2/87edaf82c30c5d40e74518162047eb095d0813c4dee1ba00ef026d1bb88bf100: no such file or directory</p></blockquote><p>我在使用Docker构建镜像是出现了空间不足的提示，通过 <code>df -h</code> 发现 <code>var</code>  目录已经100%了。于是在目录下通过<code>du -</code>sh 看这个目录下而到底是那个文件占了这么多空间。最后找到是 <code>/var/lib/docker/overlay2</code> 目录，打开里面都是一些类似一串数字字母命名的文件，我以为是缓存的文件，直接全部删除了，，后来才知道是一些存储驱动相关的文件。删除之后构建镜像就出现了上面的报错。解决方法是使用命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV microservice-config-server]<span class="comment"># docker system prune -a</span></span><br><span class="line">WARNING! This will remove:</span><br><span class="line">        - all stopped containers</span><br><span class="line">        - all networks not used by at least one container</span><br><span class="line">        - all images without at least one container associated to them</span><br><span class="line">        - all build cache</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br></pre></td></tr></table></figure><p>可以看到命令以上命令会删除很多数据，包括已经下载的镜像都会被删除。全部删除之后再重新构建镜像就可以了</p><hr>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的Registry管理</title>
      <link href="/posts/7b07bae5/"/>
      <url>/posts/7b07bae5/</url>
      
        <content type="html"><![CDATA[<p> 回顾之前的笔记，给Registry的定义是：</p><blockquote><p>Docker Registry 是一个集中存储与分发镜像的服务。构建完docker镜像后，就可在当前宿主机上运行。但如果想要在其它机器上运行这个镜像，就需要手动复制，此时可以借助Docker Registry来避免镜像的手动复制，其它人可以直接从 Registry 中将这个镜像 pull 到自己的本机中。</p></blockquote><a id="more"></a><p>Docker的架构图：</p><p><img src="https://ws1.sinaimg.cn/large/005RGBbLly1fvkr26xdi8j30ed0awac7.jpg" alt="Docker架构图"></p><p>Docker Registry可分为公有与私有。最常用的Docker Registry就是官方的Docker Hub，这也是默认的Docker Registry。国内仓库有：daocloud，时速去，aliyun等。</p><p>##　查找镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker search whalesay</span></span><br><span class="line">NAME                            DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">docker/whalesay                 An image <span class="keyword">for</span> use <span class="keyword">in</span> the Docker demo tutorial    644                                     </span><br><span class="line">mendlik/docker-whalesay         Docker whalesay image from training material…   7                                       [OK]</span><br><span class="line">nikovirtala/whalesay            Tiny Go web service to <span class="built_in">print</span> Moby Dock ASCII…   1                                       [OK]</span><br><span class="line">milanfort/whalesay              Modified docker/whalesay image that outputs …   1                                       </span><br><span class="line">swinton/whalesay                whalesay, innit                                 1</span><br></pre></td></tr></table></figure><p>上述命令在Docker Hub 仓库中查找 <code>whalesay</code> 镜像。下面列出了在仓库中查询到的所有镜像信息如名字，描述，星，是否官方等。一般官方的星是最多的。</p><h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker pull docker/whalesay</span></span><br></pre></td></tr></table></figure><p>执行命令 docker 会把指定的镜像拉取到我们本地，使用<code>docker images</code>  可以查看到是否获取到镜像。</p><p>可以运行一下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker run docker/whalesay cowsay Docker is cool! </span></span><br><span class="line"> _________________ </span><br><span class="line">&lt; Docker is cool! &gt;</span><br><span class="line"> ----------------- </span><br><span class="line">    \</span><br><span class="line">     \</span><br><span class="line">      \     </span><br><span class="line">                    <span class="comment">##        .            </span></span><br><span class="line">              <span class="comment">## ## ##       ==            </span></span><br><span class="line">           <span class="comment">## ## ## ##      ===            </span></span><br><span class="line">       /<span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span>___/ ===        </span><br><span class="line">  ~~~ &#123;~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~   </span><br><span class="line">       \______ o          __/            </span><br><span class="line">        \    \        __/             </span><br><span class="line">          \____\______/</span><br></pre></td></tr></table></figure><h2 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h2><p>这里就使用原先拉取下来的这个镜像做测试，更改其<code>tag</code>后 push 到仓库中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker tag docker/whalesay hjwjw/whalesay</span></span><br><span class="line">[root@HJWDEV bin]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-docker        latest              be221a20a4d7        6 weeks ago         4.41MB</span><br><span class="line">nginx-fun           latest              1d1aaf738af1        6 weeks ago         109MB</span><br><span class="line">ubuntu              latest              cd6d8154f1e1        2 months ago        84.1MB</span><br><span class="line">docker/whalesay     latest              6b362a9f73eb        3 years ago         247MB</span><br><span class="line">hjwjw/whalesay      latest              6b362a9f73eb        3 years ago         247MB</span><br></pre></td></tr></table></figure><p>可以看到产生了一个新的镜像 <code>hjwjw/whalesay</code></p><p> 在推送新镜像到仓库前需要登陆，登陆账号可以在 <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a> 上注册</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker login</span></span><br><span class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don<span class="string">'t have a Docker ID, head over to https://hub.docker.com to create one.</span></span><br><span class="line"><span class="string">Username:</span></span><br></pre></td></tr></table></figure><p>登陆成功后就可以进行推送了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV bin]<span class="comment"># docker push hjwjw/whalesay</span></span><br></pre></td></tr></table></figure><p>推送成功后可以登陆 Docker Hub 查看。其它人可以查询到并拉取到自己本地运行。</p><h2 id="私有仓库"><a href="#私有仓库" class="headerlink" title="私有仓库"></a>私有仓库</h2><p>上面说的都是在公有仓库，相比Docker Hub 私有仓库有以下优势：</p><ul><li>节省带宽，对于私有仓库已有的镜像无需再从Docker Hub 下载。</li><li>更加安全</li><li>便于内部镜像的统一管理</li></ul><p>下面使用<code>Docker Registry 2.0</code>搭建一个私有仓库并上传一个镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># docker run -d -p 5000:5000 --name registry2 registry:2</span></span><br></pre></td></tr></table></figure><p>上述命令启动一个Docker Registry 2.0 .</p><p>默认情况下，会将私有仓库镜像存放于容器内的<code>/tmp/registry</code>目录下，这样如果容器被删除，则存放于容器中的镜像也会丢失。<br>所以一般情况下会指定本地一个目录挂载到容器内的<code>/tmp/registry</code>下，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -d --name=my_registry -p 5000:5000 -v /opt/data/registry:/tmp/registry docker.io/registry:2.2</span></span><br><span class="line">9fe45329bda17f61da04e6e8d2faf124fb22665a25270421bb8979a419809446</span><br></pre></td></tr></table></figure><p>下面修改一个镜像的<code>tag</code> 并把它推送到我们的私有仓库中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># docker tag nginx-fun localhost:5000/hjwjw/nginx-fun</span></span><br></pre></td></tr></table></figure><p>因为Docker Hub 是默认的Docker Registry，所以我们需要修改镜像的 <code>tag</code> 才能推送到自己的私有仓库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># docker push localhost:5000/hjwjw/nginx-fun</span></span><br></pre></td></tr></table></figure><p>推送成功后我们可以通过这个命令去查看 Docker registry 2中是否存在刚刚推送的镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># curl -X GET http://127.0.0.1:5000/v2/_catalog</span></span><br><span class="line">&#123;<span class="string">"repositories"</span>:[<span class="string">"hjwjw/nginx-fun"</span>]&#125;</span><br></pre></td></tr></table></figure><p>也可以在浏览器中访问上述地址查看</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker Registry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的数据管理</title>
      <link href="/posts/c67fd481/"/>
      <url>/posts/c67fd481/</url>
      
        <content type="html"><![CDATA[<p>我们知道容器中的任何修改默认都是不会被保存的。想要保存容器运行时产生的数据，我们需要使用<code>Volume</code>数据卷技术来提供独立于容器外的持久化存储，它也可以提供容器与容器之前的共享数据。简单来说我感觉就是挂载，把本地磁盘中的某个目录挂载到容器中的某个目录，这样容器对这个目录的任何操作相当与操作我们本地的相应目录。</p><p>这里有三种方式使用<code>Volume</code>进行容器的持久存储。</p><a id="more"></a><h2 id="从容器挂载"><a href="#从容器挂载" class="headerlink" title="从容器挂载"></a>从容器挂载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run -d --name nginx-fun -v /usr/share/nginx/html nginx-fun</span></span><br></pre></td></tr></table></figure><p><code>--name</code>  指定容器名</p><p><code>-v</code> 需要挂载的目录</p><p>上述命令是创建一个名为nginx-fun容器并加载 <code>数据卷</code> 到容器的 <code>/usr/share/nginx/html</code> 目录。也就是把我们本地的某个目录挂载到容器中的 <code>/usr/share/nginx/html</code>  目录中，具体是我们本地的哪个目录不需要我们指定。这也是为了保证Docker的可移植性，因为不是每个宿主机上都有对应的目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker inspect nginx-fun</span></span><br></pre></td></tr></table></figure><p>通过上述命令我们可以知道使用的是本地的哪个目录，找到如下信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"388f5df2b08fa24b75358acdccf41ac987971b5c9edb02c693b4bfd8929a09fb"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/var/lib/docker/volumes/388f5df2b08fa24b75358acdccf41ac987971b5c9edb02c693b4bfd8929a09fb/_data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/usr/share/nginx/html"</span>,</span><br><span class="line">                <span class="string">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure><p>可以看到<code>Source</code> 指向的地址就是我们本地对应的目录，我们可以进入这个目录查看:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># cd /var/lib/docker/volumes/388f5df2b08fa24b75358acdccf41ac987971b5c9edb02c693b4bfd8929a09fb/_data</span></span><br><span class="line">[root@HJWDEV _data]<span class="comment"># ll</span></span><br><span class="line">总用量 8</span><br><span class="line">-rw-r--r--. 1 root root 494 9月  25 23:04 50x.html</span><br><span class="line">-rw-r--r--. 1 root root  54 9月  26 10:53 index.html</span><br></pre></td></tr></table></figure><p>可以看到目录中有两个文件，是nginx-fun容器中<code>/usr/share/nginx/html</code>目录的默认文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV _data]<span class="comment"># cat index.html</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Docker is Fun!&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@HJWDEV _data]<span class="comment"># vi index.html</span></span><br></pre></td></tr></table></figure><p>我们查看<code>index.html</code>中的默认内容并修改成如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Docker is Fun!&lt;/h2&gt;</span><br><span class="line">&lt;h3&gt;Docker is interesing&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>接着进入容器中的<code>/usr/share/nginx/html</code>目录，看文件是否被修改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV _data]<span class="comment"># docker exec -it nginx-fun /bin/bash</span></span><br><span class="line">root@15f556dcc7e5:/<span class="comment"># cd /usr/share/nginx/html</span></span><br><span class="line">root@15f556dcc7e5:/usr/share/nginx/html<span class="comment"># ls</span></span><br><span class="line">50x.html  index.html</span><br><span class="line">root@15f556dcc7e5:/usr/share/nginx/html<span class="comment"># cat index.html </span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;Docker is Fun!&lt;/h2&gt;</span><br><span class="line">&lt;h3&gt;Docker is interesing&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">root@15f556dcc7e5:/usr/share/nginx/html<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>可以看到容器中的文件也同步修改了。<strong>同样的如果容器中<code>/usr/share/nginx/html</code> 中的文件被修改了，宿主机中的对应目录文件也会跟着变动</strong>。</p><p>这种方式虽然实现了数据的持久存储，但要查询宿主机中挂载的目录比较麻烦，下面这种方式则可以直接指定宿主机中的需要挂载的目录。</p><h2 id="从宿主机挂载"><a href="#从宿主机挂载" class="headerlink" title="从宿主机挂载"></a>从宿主机挂载</h2><h3 id="挂载目录"><a href="#挂载目录" class="headerlink" title="挂载目录"></a>挂载目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># touch volume/index.html</span></span><br><span class="line">[root@HJWDEV docker]<span class="comment"># vi volume/index.html</span></span><br></pre></td></tr></table></figure><p>首页我们在<code>docker/volume</code> 目录新建一个<code>index.html</code>文件，写入以下内容:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this is volume</span><br></pre></td></tr></table></figure><p>接着启动一个nginx容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run -p 80:80 -d -v $PWD/volume:/usr/share/nginx/html nginx-fun</span></span><br></pre></td></tr></table></figure><p><code>$PWD</code>    表示当前目录路径</p><p>上面的命令把宿主机的<code>$PWD/volume</code> 目录挂载到容器中的 <code>/usr/share/nginx/html</code> 目录。<code>$PWD/volume</code>目录必须使用绝对路径且是存在的，不然会报错。</p><p>访问nginx的首页：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># curl http://localhost/</span></span><br><span class="line">this is volume</span><br></pre></td></tr></table></figure><p>可以看到输出的内容就是我们宿主机挂载目录中的<code>index.html</code>的内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># vi volume/index.htm</span></span><br></pre></td></tr></table></figure><p>我们重新修改一下宿主机挂载目录下的<code>index.html</code>文件，修改如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this is volume,is cool!</span><br></pre></td></tr></table></figure><p>我们直接进入容器内查看 <code>/usr/share/nginx/html</code>目录中的<code>index.html</code>是否同步被修改：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES</span><br><span class="line">a3aad9e00870        nginx-fun           <span class="string">"nginx -g 'daemon of…"</span>   13 minutes ago      Up 13 minutes       0.0.0.0:80-&gt;80/tcp   nostalgic_booth</span><br><span class="line">[root@HJWDEV docker]<span class="comment"># docker exec -it a3aad9e00870 /bin/bash</span></span><br><span class="line">root@a3aad9e00870:/<span class="comment"># cd /usr/share/nginx/html</span></span><br><span class="line">root@a3aad9e00870:/usr/share/nginx/html<span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line">root@a3aad9e00870:/usr/share/nginx/html<span class="comment"># cat index.html</span></span><br><span class="line">this is volume,is cool!</span><br></pre></td></tr></table></figure><p>可以看到容器中的文件也同步被修改了。</p><hr><h3 id="挂载文件"><a href="#挂载文件" class="headerlink" title="挂载文件"></a>挂载文件</h3><p>还有一种方式是把宿主机的一个文件挂载到容器中。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run --rm -it -v $PWD/volume/bash_history.txt:/root/.bash_history nginx-fun /bin/bash</span></span><br><span class="line">root@6b22a51db2ee:/<span class="comment"># cd /usr/share/nginx/html</span></span><br><span class="line">root@6b22a51db2ee:/usr/share/nginx/html<span class="comment"># ls</span></span><br><span class="line">50x.html  index.html</span><br><span class="line">root@6b22a51db2ee:/usr/share/nginx/html<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">[root@HJWDEV docker]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">[root@HJWDEV docker]<span class="comment"># cat volume/bash_history.txt </span></span><br><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html</span><br><span class="line">ls</span><br><span class="line">cat index.html</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p><code>--rm</code>     表示退出进程后自动删除容器，可以看到第5 行中<code>exit</code>后再 <code>docker ps</code> 显示没有运行的容器了</p><p><code>-it</code>        分配一个伪终端并打开交互模式</p><p>上述命令把宿主机中的<code>$PWD/volume/bash_history.txt</code> 文件挂载到容器中的 <code>/root/.bash_history</code> 文件。 <code>/root/.bash_history</code>  文件中记录的是容器内使用命令的历史记录，因此容器中使用过的命令同样也会写入宿主机的<code>$PWD/volume/bash_history.txt</code> 文件中。</p><h2 id="共享数据卷容器"><a href="#共享数据卷容器" class="headerlink" title="共享数据卷容器"></a>共享数据卷容器</h2><p>如果有一些持续更新的数据需要在容器之间共享，我们可以使用数据卷容器。<code>数据卷容器</code> 其实就是一个正常的容器，专门用来提供数据卷供其它容器挂载。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run -it -v /opt/dbdata --name dbdata ubuntu /bin/bash</span></span><br><span class="line">root@3842c0845e26:/<span class="comment"># cd /opt/dbdata</span></span><br><span class="line">root@3842c0845e26:/opt/dbdata<span class="comment"># touch db.properties</span></span><br><span class="line">root@3842c0845e26:/opt/dbdata<span class="comment"># exit</span></span><br></pre></td></tr></table></figure><p>通过上述命令我们创建一个数据卷容器，在容器的<code>/opt/dbdata</code> 目录创建一个新文件 <code>db.properties</code></p><p>通过 <code>docker inspect</code> 命令查看容器挂载的宿主机目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker inspect dbdata</span></span><br></pre></td></tr></table></figure><p>可以看到宿主机的目录如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/var/lib/docker/volumes/01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8/_data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/opt/dbdata"</span>,</span><br><span class="line">                <span class="string">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure><p>再创建一个名为<code>vol_a</code> 的容器并通过 <code>--volumes-from</code> 命令挂载 <code>dbdata</code> 容器 。进入<code>vol_a</code> 容器查看<code>/opt/dbdata</code> 目录可以看到存在  <code>dbdata</code> 容器中创建的文件，如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run -it --name vol_a --volumes-from dbdata ubuntu /bin/bash</span></span><br><span class="line">root@90f972394243:/<span class="comment"># cd /opt/dbdata/</span></span><br><span class="line">root@90f972394243:/opt/dbdata<span class="comment"># ls</span></span><br><span class="line">db.properties</span><br></pre></td></tr></table></figure><p>如挂载源有多个，可以使用多次<code>--volumes-from</code></p><p>这样即实现了容器间的数据共享。</p><h2 id="删除数据卷"><a href="#删除数据卷" class="headerlink" title="删除数据卷"></a>删除数据卷</h2><p>如果创建容器时挂载了volume，会在类似 <code>/var/lib/docker/volumes/01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8/_data</code> 目录下会生成相应的文件（路径，不同版本，不同操作系统会有所不同，具体可以用docker inspect查看容器具体信息），当删除容器时，宿主机上的挂载目录时不会删除的，并且目录名称是随机字符，不知意义，所以在删除容器时，需要妥善处理容器的volume。删除容器时一并删除volume有二种方法:</p><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker rm -v dbdata</span></span><br><span class="line">dbdata</span><br><span class="line">[root@HJWDEV docker]<span class="comment"># cd /var/lib/docker/volumes/01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8/_data</span></span><br><span class="line">[root@HJWDEV _data]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>使用<code>docker rm</code>  加 <code>-v</code> 参数 删除容器时会一并把 volume 删除，但这里发现目录还是存在，因为我们上面的<code>vol_a</code> 容器还在使用 <code>dbdata</code>  的挂载。所以需要把<code>vol_a</code> 也删除。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker rm -v vol_a</span></span><br><span class="line">vol_a</span><br><span class="line">[root@HJWDEV docker]<span class="comment"># cd /var/lib/docker/volumes/01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8/_data</span></span><br><span class="line">-bash: <span class="built_in">cd</span>: /var/lib/docker/volumes/01eb6e6a162ece43abc601783805d89a0a0e871cf7c612bad28e1858ae7606f8/_data: 没有那个文件或目录</span><br><span class="line">[root@HJWDEV docker]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>这样 <code>volume</code>  的目录也会被删除了。</p><h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm</span><br></pre></td></tr></table></figure><p>启动容器的时候加了 <code>-rm</code> 参数，这样在容器停止后自动删除容器以及容器所挂载的<code>volume</code>  。这种方式上<code>挂载文件</code> 这一节已经使用过。</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Volume </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java中执行bat或shell命令</title>
      <link href="/posts/c691c44f/"/>
      <url>/posts/c691c44f/</url>
      
        <content type="html"><![CDATA[<p>今天为了博客能实现自动部署，写了一个Java小程序调用cmd命令来实现自动部署hexo并备份博客。</p><a id="more"></a><p>java中提供了两种方式来调用exe或shell程序：</p><ol><li>使用<code>Runtime.getRuntime().exec()</code></li><li>使用<code>new ProcessBuilder().start()</code></li></ol><p>下面我在实际使用中的代码如下，这里使用的是<code>new ProcessBuilder().start()</code>的方式，调用cmd执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deployHexo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        String cmd = <span class="string">"cd "</span> + HEXO_DIR + <span class="string">" &amp;&amp; hexo clean &amp;&amp; hexo g &amp;&amp; hexo d"</span>;</span><br><span class="line">        List&lt;String&gt; cmds = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line"><span class="comment">//        cmds.add("sh");</span></span><br><span class="line">        cmds.add(<span class="string">"cmd.exe"</span>);</span><br><span class="line"><span class="comment">//        cmds.add("-c");</span></span><br><span class="line">        cmds.add(<span class="string">"/c"</span>);</span><br><span class="line">        cmds.add(cmd);</span><br><span class="line">        ProcessBuilder pb = <span class="keyword">new</span> ProcessBuilder(cmds);</span><br><span class="line">        <span class="comment">//重定向到标准输出</span></span><br><span class="line">        pb.redirectErrorStream(<span class="keyword">true</span>);</span><br><span class="line">        Process p = pb.start();</span><br><span class="line">        p.waitFor(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(p.getInputStream()));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String result = sb.toString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这个方法会在调用后返回命令行处理的输出结果。如果是在Linux平台中调用，则把上面的5 -8行的命令改成如下即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        cmds.add(<span class="string">"sh"</span>);</span><br><span class="line"><span class="comment">//        cmds.add("cmd.exe");</span></span><br><span class="line">        cmds.add(<span class="string">"-c"</span>);</span><br><span class="line"><span class="comment">//        cmds.add("/c");</span></span><br></pre></td></tr></table></figure><p>对<code>Runtime.getRuntime().exec()</code>方式的使用与上面的代码差别不大，将第4-10行替换成如下，另外可删除第12行即可：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] cmdArray =&#123;<span class="string">"cmd.exe"</span>,<span class="string">"/c"</span>,cmd&#125;;</span><br><span class="line">Process p = Runtime.getRuntime().exec(cmdArray);</span><br></pre></td></tr></table></figure><hr><p>我们使用这两种方式执行命令时，都会返回一个<code>Process</code> 并创建一个子线程。在Jdk文档中对它有下列描述：</p><blockquote><p>默认情况下，创建的子进程没有自己的终端或控制台。 其所有的标准<code>I/  O</code>（即标准输入，标准输出，标准错误）操作将被重定向到父进程，在那里他们可以经由使用所述方法获得的流进行访问<code>getOutputStream()</code>，<code>getInputStream()</code>和<code>getErrorStream()</code>。 父进程使用这些流将输入提供给子进程并从子进程获取输出。  因为一些本地平台只为标准输入和输出流提供有限的缓冲区大小，因此无法及时写入输入流或读取子进程的输出流可能导致子进程阻塞甚至死锁。</p></blockquote><p>我在使用过程中也遇到了进程阻塞的情况，因为缓冲区满了后，没有对缓冲区进行清空，数据也写不进才会阻塞卡住。因此我们在使用这两种方式执行命令操作时一定要对其子线程标准I/O进行处理。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我写博客的方式</title>
      <link href="/posts/9a5fac69/"/>
      <url>/posts/9a5fac69/</url>
      
        <content type="html"><![CDATA[<p>今天终于能舒服的写博客了</p><p>我的博客是使用Hexo静态部署，使用markdown写好文档后放到<code>_posts</code>文件夹里就可以直接部署了。但<code>_posts</code>目录里把所有文档都放在一起没有文件夹归类，因此我的思路是使用<code>Typora</code>写好笔记后存在本地指定目录，定时运行java小程序把目录里的文档全部复制到<code>_posts</code>里并调用<code>cmd</code>命令生成、发布hexo博客，最后把我的存放笔记的目录上传<code>gitee.com</code>中的仓库备份。</p><a id="more"></a><p>推荐使用<code>Typora</code>写markdown，所写即所见，很方便、很优雅。如图：</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507130513.png" alt="typora"></p><p>左侧使用目录的管理方式，可以很方便的在本地写文档。我不太喜欢博客网站中写，需要打开浏览器，访问网站等一系列操作，如断网还保存不了。</p><blockquote><p>这里分享一个使用Typora写hexo博客的小技巧，使用输入法的自定义短语生成文章头部的yaml样式,可自动生成时间 ，我们只需要填写标题，标签，分类即可。</p></blockquote><hr><p>如下图我写好的note按分类放在<code>F:/Markdown</code>目录，在这个目录下面还有一个。<code>java</code>文件与一个<code>bat</code>文件。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507130450.png" alt="本地目录"></p><p><code>java</code>文件的作用是把该目录中的所有<code>md</code>复制到<code>hexo</code>中的<code>_posts</code>中然后调用cmd命令进行生成、发布等操作，<code>bat</code>文件的作用主要是设置系统的定时任务调用<code>java</code>小程序，最后把<code>F:Markdown</code>中的文件上传<code>gitee.com</code>仓库备份。</p><p>代码比较简单，直接上代码了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeployBlog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEXO_DIR = <span class="string">"F:/Blog/source/_posts"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MARKDOWN_DIR = <span class="string">"F:/Markdown"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;File&gt; fileList = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Markdown目录中的所有md文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMarkdown</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.getName().indexOf(<span class="string">"md"</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                fileList.add(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.getName() != <span class="string">".git"</span>) &#123;</span><br><span class="line">                File[] files = file.listFiles();</span><br><span class="line">                <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">                        getMarkdown(f);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将获取到的文件复制到hexo的_posts目录(先清空_posts目录)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(HEXO_DIR);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (File f1 : file.listFiles()) &#123;</span><br><span class="line">            f1.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (File f2 : fileList) &#123;</span><br><span class="line">            File dest = <span class="keyword">new</span> File(file, f2.getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Files.copy(f2.toPath(), dest.toPath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行命令发布并部署</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">deployHexo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String cmd = <span class="string">"cd "</span> + HEXO_DIR + <span class="string">" &amp;&amp; hexo clean &amp;&amp; hexo g &amp;&amp; hexo d"</span>;</span><br><span class="line">        List&lt;String&gt; cmds = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line"><span class="comment">//        cmds.add("sh");</span></span><br><span class="line">        cmds.add(<span class="string">"cmd.exe"</span>);</span><br><span class="line"><span class="comment">//        cmds.add("-c");</span></span><br><span class="line">        cmds.add(<span class="string">"/c"</span>);</span><br><span class="line">        cmds.add(cmd);</span><br><span class="line">        System.out.println(<span class="string">"deploy..."</span>);</span><br><span class="line">        ProcessBuilder pb = <span class="keyword">new</span> ProcessBuilder(cmds);</span><br><span class="line">        <span class="comment">//重定向到标准输出</span></span><br><span class="line">        pb.redirectErrorStream(<span class="keyword">true</span>);</span><br><span class="line">        Process p = pb.start();</span><br><span class="line">        p.waitFor(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(p.getInputStream()));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String result = sb.toString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DeployBlog deployBlog = <span class="keyword">new</span> DeployBlog();</span><br><span class="line">        File file = <span class="keyword">new</span> File(MARKDOWN_DIR);</span><br><span class="line">        deployBlog.getMarkdown(file);</span><br><span class="line">        deployBlog.writeFile();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String cmdstr = deployBlog.deployHexo();</span><br><span class="line">            System.out.println(cmdstr);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"deploy success!"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于java中执行cmd命令可以搜索我博客中的文章：Java中执行bat或shell命令.md，其它文件操作比较简单就不多说了。最后使用一个bat完成java的调用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off </span><br><span class="line"><span class="built_in">echo</span> 正在更新博客...</span><br><span class="line">javac DeployBlog.java</span><br><span class="line">java DeployBlog</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 博客更新成功！访问hjwjw.github.io查看</span><br><span class="line"><span class="built_in">echo</span> ====================================</span><br><span class="line"><span class="built_in">echo</span> 正在备份笔记...</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"backup blog"</span></span><br><span class="line">git push</span><br><span class="line"><span class="built_in">echo</span> 备份成功！</span><br><span class="line">choice /T 5 /C ync /CS /D y /n</span><br></pre></td></tr></table></figure><p>bat文件内容也比较简单，最后一条是暂停5秒后才关闭窗口。</p><p>最后一步是设置windows定时任务，定时执行这个bat文件即可:joy:</p><hr><p>虽然方式算不上很高级，技术含量也不是很高，不过我感觉写博客已经很舒适了，使用自己喜欢的Markdown软件，自己的博客，本地写作，自动部署、自动备份。</p><p>写在最后：</p><p>写Markdown文档最头疼的就是图床了，这里推荐我在用的图床工具,点击直达github:<a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">PicGo</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerfile实践</title>
      <link href="/posts/1ef71e38/"/>
      <url>/posts/1ef71e38/</url>
      
        <content type="html"><![CDATA[<p>Dockerfile是用于构建Dcoker镜像的文件。在前面我们使用<code>docker commit</code>时也创建了一个新镜像，但使用Dockerfile构建新镜像是常用的方式。在编写好Dockerfile文件后，使用<code>docker build</code>命令即可构建一个新的镜像。Dockerfile文件的编写需要遵循一些规范。</p><a id="more"></a> <h2 id="Dockerfile的文件结构"><a href="#Dockerfile的文件结构" class="headerlink" title="Dockerfile的文件结构"></a>Dockerfile的文件结构</h2><p>Dockerfile的编写与脚本文件类似，注释使用<code>#</code>。</p><p>一般Dockerfile文件分成四个部分：基础镜像信息、维护者信息、镜像操作命令、容器启动时执行的命令</p><p>基本格式如下，分别对应上面的四个部分：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM ... </span><br><span class="line">MAINTAINER ...</span><br><span class="line">RUN ...</span><br><span class="line">CMD ...</span><br></pre></td></tr></table></figure><blockquote><p>第一条指令必须是<code>FROM</code>,如果在同一个Dockerfile文件中创建多个镜像时，可以使用多个<code>FROM</code>(每个镜像一次)</p></blockquote><h2 id="Dockerfile常用语法"><a href="#Dockerfile常用语法" class="headerlink" title="Dockerfile常用语法"></a>Dockerfile常用语法</h2><p>下面总结一些Dockerfile文件中常用的语法：</p><table><thead><tr><th>命令</th><th>用途</th></tr></thead><tbody><tr><td>FROM</td><td>base image(基础镜像)</td></tr><tr><td>RUN</td><td>执行命令</td></tr><tr><td>ADD</td><td>添加文件</td></tr><tr><td>ARG</td><td>设置构建参数</td></tr><tr><td>COPY</td><td>复制文件</td></tr><tr><td>CMD</td><td>执行命令</td></tr><tr><td>EXPOSE</td><td>暴露端口</td></tr><tr><td>WORKDIR</td><td>指定路径</td></tr><tr><td>MAINTAINER</td><td>维护者</td></tr><tr><td>ENV</td><td>设定环境变量</td></tr><tr><td>ENTRYPOINT</td><td>容器入口</td></tr><tr><td>USER</td><td>指定用户</td></tr><tr><td>VOLUME</td><td>mount point 指定挂载点</td></tr></tbody></table><h2 id="Dockerfile实践"><a href="#Dockerfile实践" class="headerlink" title="Dockerfile实践"></a>Dockerfile实践</h2><p>下面写一些小实例，通过编写Dockerfile来构建我们自己的镜像。</p><h3 id="创建Dockerfile"><a href="#创建Dockerfile" class="headerlink" title="创建Dockerfile"></a>创建Dockerfile</h3><p>在一个新目录下创建如下内容的Dockerfile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="comment"># 维护者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> hjw</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">'s/archive.ubuntu.com/mirrors.ustc.edu.cn/g'</span> /etc/apt/sources.list</span></span><br><span class="line"><span class="comment"># 执行更新命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></span><br><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get install -y nginx</span></span><br><span class="line"><span class="comment"># 将index.html复制到指定目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> index.html /var/www/html</span></span><br><span class="line"><span class="comment"># 容器入口命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/usr/sbin/nginx"</span>,<span class="string">"-g"</span>,<span class="string">"daemon off;"</span>]</span></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><blockquote><p>上面文件中<code>sed</code>命令主要是为了加速。替换apt-get的源地址，使用国内的镜像</p></blockquote><p>Dockerfile中写的命令作用可以看上面的注释。</p><p><code>ENTRYPOINT</code>的作用主要是指定容器入口即启动时执行的命令，后面为一个数组形式，展开后则是一条命令行。执行这条命令行的主要作用是将nginx在前台执行而不是作为守护进程执行。</p><p>另外再创建index.html文件，内容自定。</p><p>最终文件夹中的内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ubuntu-nginx]<span class="comment"># ll</span></span><br><span class="line">总用量 4</span><br><span class="line">-rw-r--r--. 1 root root  0 9月  26 16:06 Dockerfile</span><br><span class="line">-rw-r--r--. 1 root root 54 9月  26 10:53 index.html</span><br></pre></td></tr></table></figure><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><p>使用<code>docker build</code>命令来构建新的镜像，build 时Docker会在指定的目录中读取Dockerfile文件，并将该目录下的所有内容发送给Docker 服务端，由服务端来构建镜像。也可以通过<code>.dockerignore</code>文件（每一行添加一条匹配模式）来让 Docker 忽略路径下的目录和文件。镜像构建命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker build -t ubuntu-nginx ubuntu-nginx/.</span></span><br></pre></td></tr></table></figure><p><code>-t</code> 指定image标签，即镜像名称</p><p>最后为构建目录的路径，如果是在<code>ubuntu-nginx</code>目录下执行构建命令直接使用<code>.</code>即可。执行后Docker会按Dockerfile中的命令去构建我们的镜像。</p><p>执行成功后可以查看镜像是否生成：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu-nginx        latest              f6538f6564f6        15 minutes ago      186MB</span><br><span class="line">hello-docker        latest              be221a20a4d7        3 hours ago        4.41MB</span><br></pre></td></tr></table></figure><h3 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h3><p>运行<code>ubuntu-nginx</code>镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker run -d -p 80:80 ubuntu-nginx</span></span><br></pre></td></tr></table></figure><p><code>-p</code> 表示端口映射，把nginx的 80 端口映射到宿主机的 80 端口</p><p><code>-d</code> 表示允许该Container作为守护进程来执行</p><p>运行成功后访问 宿主机+80 端口，会显示index.html的内容。</p><h2 id="镜像分层"><a href="#镜像分层" class="headerlink" title="镜像分层"></a>镜像分层</h2><p>因为镜像包含操作系统完整的 <code>root</code> 文件系统，其体积往往是庞大的，因此在 Docker 设计时，就充分利用 <a href="https://en.wikipedia.org/wiki/Union_mount" target="_blank" rel="noopener">Union FS</a> 的技术，将其设计为分层存储的架构。所以严格来说，镜像并非是像一个 ISO 那样的打包文件，镜像只是一个虚拟的概念，其实际体现并非由一个文件组成，而是由一组文件系统组成，或者说，由多层文件系统联合组成。</p><p>镜像构建时，会一层层构建，前一层是后一层的基础。每一层构建完就不会再发生改变，后一层上的任何改变只发生在自己这一层。比如，删除前一层文件的操作，实际不是真的删除前一层的文件，而是仅在当前层标记为该文件已删除。在最终容器运行的时候，虽然不会看到这个文件，但是实际上该文件会一直跟随镜像。因此，在构建镜像的时候，需要额外小心，每一层尽量只包含该层需要添加的东西，任何额外的东西应该在该层构建结束前清理掉。</p><p>这种分层的方式可以让有相同内容的镜像共享某一层，可以减少存储压力。</p><p><img src="https://ws1.sinaimg.cn/large/005RGBbLly1fvo3zorhusj308d06zmxj.jpg" alt="镜像分层"></p><p>上图中下面的三层是只读层，Docker会把Dockerfile中的每一行都生成一层镜像，在image运行成一个容器时会生成一个容器层，即最上层，它是一个可读可写层。如果下面的层在容器运行中是需要被改动的，则该层会被复制到顶层，所以的改动都会在顶层进行。</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Dockerfile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker常用命令使用记录</title>
      <link href="/posts/eae2c9c8/"/>
      <url>/posts/eae2c9c8/</url>
      
        <content type="html"><![CDATA[<p>Docker常用命令使用记录 </p><a id="more"></a><h2 id="常用命令表"><a href="#常用命令表" class="headerlink" title="常用命令表"></a>常用命令表</h2><p>Docker 常用命令总结：</p><table><thead><tr><th style="text-align:left">命令</th><th>用途</th></tr></thead><tbody><tr><td style="text-align:left">docker pull</td><td>获取 image</td></tr><tr><td style="text-align:left">docker build</td><td>创建 image</td></tr><tr><td style="text-align:left">docker images</td><td>列出 image</td></tr><tr><td style="text-align:left">docker rmi</td><td>删除 image (-f 强制删除）</td></tr><tr><td style="text-align:left">docker run</td><td>运行 container</td></tr><tr><td style="text-align:left">doeker stop</td><td>停止一个 container</td></tr><tr><td style="text-align:left">docker ps</td><td>列出正在运行的 container</td></tr><tr><td style="text-align:left">docker rm</td><td>删除 container</td></tr><tr><td style="text-align:left">dockre container ls -a</td><td>列出所有的容器</td></tr><tr><td style="text-align:left">docker container start/restart/stop</td><td>启动/重新启动/停止 一个容器</td></tr><tr><td style="text-align:left">docker cp</td><td>在host和container之间拷贝文件</td></tr><tr><td style="text-align:left">docker commit</td><td>保存改动为新的 image</td></tr><tr><td style="text-align:left">docker  exec</td><td>进入某个容器</td></tr><tr><td style="text-align:left">docker system df</td><td>查看docker 磁盘使用空间</td></tr><tr><td style="text-align:left">docker system prune</td><td>清理磁盘。删除关闭的容器、无用的数据卷和网络，以及dangling镜像(即无tag的镜像)</td></tr></tbody></table><h2 id="命令示例"><a href="#命令示例" class="headerlink" title="命令示例"></a>命令示例</h2><p>部分命令具体使用示例。</p><hr><h3 id="运行一个nginx镜像"><a href="#运行一个nginx镜像" class="headerlink" title="运行一个nginx镜像"></a>运行一个nginx镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker run -p 8080:80 -d nginx</span></span><br></pre></td></tr></table></figure><p><code>-p</code> 表示端口映射，把nginx的 80 端口映射到宿主机的 8080 端口</p><p><code>-d</code> 表示允许该Container作为守护进程来执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker run --rm -it ubuntu /bin/bash</span></span><br><span class="line">root@3b5c1d1ce739:/<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><code>--rm</code> 告诉Docker一旦运行的进程退出就删除容器，这在进行测试的时候非常有用</p><p><code>-it</code> 表示使用分配一个伪终端并进行交互模式，这将进入到容器内部。但不要在生产环境中这样使用</p><p><code>/bin/bash</code> 要运行的命令，因为我们以交互模式启动，它将显示一个容器的提示符</p><hr><h3 id="列出所有容器"><a href="#列出所有容器" class="headerlink" title="列出所有容器"></a>列出所有容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker ps -a</span></span><br></pre></td></tr></table></figure><p>包含历史运行过的容器</p><hr><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker rm 81b27f371312</span></span><br></pre></td></tr></table></figure><p>表示删除指定的容器 <code>81b27f371312</code>为容器的 <code>CONTAINER ID</code>，在使用ps列出容器时可以看到。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker  rm $(docker ps -a -q)</span><br></pre></td></tr></table></figure><p>表示删除所有容器</p><h3 id="空间清理"><a href="#空间清理" class="headerlink" title="空间清理"></a>空间清理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker system prune</span><br><span class="line">WARNING! This will remove:</span><br><span class="line">        - all stopped containers</span><br><span class="line">        - all networks not used by at least one container</span><br><span class="line">        - all dangling images</span><br><span class="line">        - all dangling build cache</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br></pre></td></tr></table></figure><p>表示清理磁盘，删除关闭的容器、无用的数据卷和网络，以及dangling镜像(即无tag的镜像)，可以使用这个命令清理Docker 所占用的空间。</p><p><strong>参数:</strong></p><p><code>-a</code>  表示清除所有没有容器引用的镜像，慎用！</p><hr><h3 id="停止某个容器"><a href="#停止某个容器" class="headerlink" title="停止某个容器"></a>停止某个容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker stop 0af0575bb931</span></span><br></pre></td></tr></table></figure><p>停止容器 <code>0af0575bb931</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop $(docker ps -a -q)</span><br></pre></td></tr></table></figure><p>停止所有容器</p><hr><h3 id="启动一个容器"><a href="#启动一个容器" class="headerlink" title="启动一个容器"></a>启动一个容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV docker]<span class="comment"># docker container start a79bf9126f4c</span></span><br></pre></td></tr></table></figure><p>会以原来的方式启动这个容器</p><hr><h3 id="修改容器"><a href="#修改容器" class="headerlink" title="修改容器"></a>修改容器</h3><p>在<code>home</code>目录下新建一个index.html文件，并写入简单内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># touch index.html</span></span><br><span class="line">[root@HJWDEV home]<span class="comment"># vi index.html</span></span><br></pre></td></tr></table></figure><p>将<code>index.html</code>文件复制到 nginx 容器的指定目录下,则容器显示的首页会是我们上面写入的内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker cp index.html 0af0575bb931://usr/share/nginx/html</span></span><br></pre></td></tr></table></figure><p>在重新启动该容器后，这个更改失效，因为Dockers在容器内做的改动都是暂时的，如需要保存则使用提交命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV home]<span class="comment"># docker commit -m 'fun' 0af0575bb931 nginx-fun</span></span><br></pre></td></tr></table></figure><p>表示将<code>0af0575bb931</code>容器的改动进行提交 ，<code>-m</code>则表示提交时添加的注释，当我们进行提交时会生成一个新的image，这里指定新镜像的名称为<code>nginx-fun</code>，如不指定名称则为<none></none></p><p>提交完成后可以通过 <code>docker images</code> 命令查看是否生成了一个新的image，启动这个新image得到的内容则会是我们上面更改的<code>index.html</code>的内容</p><hr><h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx-fun /bin/bash</span><br><span class="line">root@15f556dcc7e5:/<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>只用 <code>-i</code> 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p><p>当 <code>-i</code> <code>-t</code> 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker安装配置</title>
      <link href="/posts/b035bcd6/"/>
      <url>/posts/b035bcd6/</url>
      
        <content type="html"><![CDATA[<p>官方建议把Docker安装在Linux操作系统上。当然，其它操作系统也可以安装使用。这里记录在Centos 7下Docker的安装与基本配置。<br><a id="more"></a></p><h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><ul><li>centos 7.x 以上</li><li>需要安装在64位平台上</li></ul><h2 id="清理非官方软件包"><a href="#清理非官方软件包" class="headerlink" title="清理非官方软件包"></a>清理非官方软件包</h2><p>Red Hat操作系统包含了一个旧版本的Docker软件包，该旧版本软件包的名称是<code>docker</code>。因此在我们安装新版本前先把旧版本删除，执行以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sodo yum -y remove docker</span><br></pre></td></tr></table></figure></p><h2 id="设置yum源"><a href="#设置yum源" class="headerlink" title="设置yum源"></a>设置yum源</h2><p>鉴于国内网络问题，所以把yum源设置为国内的源，速度会快很多。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h2 id="安装Docker-CE"><a href="#安装Docker-CE" class="headerlink" title="安装Docker CE"></a>安装Docker CE</h2><p>Docker从2017年3月开始分成两个版本，一个是社区免费版本Docker CE，一个是企业版Docker EE。这里我们是个人使用所以安装CE版本。<br>执行以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum makecache fast</span><br><span class="line">$ sudo yum install docker-ce</span><br></pre></td></tr></table></figure></p><h2 id="建立docker用户组"><a href="#建立docker用户组" class="headerlink" title="建立docker用户组"></a>建立docker用户组</h2><p>默认情况下，docker 命令会使用 Unix socket 与 Docker 引擎通讯。而只有 root 用户和 docker 组的用户才可以访问 Docker 引擎的 Unix socket。出于安全考虑，一般 Linux 系统上不会直接使用 root 用户。因此，更好地做法是将需要使用 docker 的用户加入 docker 用户组。<br>建立 docker 组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo groupadd docker</span><br></pre></td></tr></table></figure><p>将当前用户加入 docker 组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><p>退出当前终端并重新登录，进行如下测试。</p><h2 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure><h2 id="运行Hello-world"><a href="#运行Hello-world" class="headerlink" title="运行Hello-world"></a>运行Hello-world</h2><p>执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run hello-world</span><br></pre></td></tr></table></figure><p>如果能输出hello-world的内容即表示Docker安装成功</p><h2 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h2><p>同样是国内网络问题，我们在Docker官方仓库创建获取镜像时可能会很慢，因此可以使用国内同步的镜像仓库。</p><p>对于使用 <a href="https://www.freedesktop.org/wiki/Software/systemd/" target="_blank" rel="noopener">systemd</a> 的系统，请在 <code>/etc/docker/daemon.json</code> 中写入如下内容（如果文件不存在请新建该文件）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [</span><br><span class="line">    <span class="string">"https://registry.docker-cn.com"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改完成后重新启动Docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="开启远程访问"><a href="#开启远程访问" class="headerlink" title="开启远程访问"></a>开启远程访问</h2><p>不同系统或不同 Docker 版本开启方式不一样。我的系统为<code>Centos 7</code></p><p>我的Docker版本如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HJWDEV ~]<span class="comment"># docker --version</span></span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure><p>开启远程访问后，我们可以通过服务器上安装的 Docker 在本地构建 Docker 镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure><p>编辑<code>docker.service</code> 文件在 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>前加上如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock</span><br></pre></td></tr></table></figure><p>之后重启 Docker 即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>最后如果系统有防火墙还需要开启<code>2375</code>端口</p><p>添加端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent    （--permanent永久生效，没有此参数重启后失效）</span><br></pre></td></tr></table></figure><p>重新载入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的理解</title>
      <link href="/posts/f388013c/"/>
      <url>/posts/f388013c/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Build once，Run anywhere</p></blockquote><a id="more"></a><p>Docker 是一个开源的容器引擎，它助于更快地交付应用。Docker可将应用与基础设施层隔离，并且能将基础设施当作程序一样进行管理。使用Docker可以更快的打包，测试以及部署应用程序，并可以缩短从编写到部署运行代码的周期。</p><h2 id="DcoKer的架构"><a href="#DcoKer的架构" class="headerlink" title="DcoKer的架构"></a>DcoKer的架构</h2><ul><li>Docker daemon<blockquote><p>是一个运行在宿主机的后台进程，可通过Docker客户端与之通信。相当于Docker在你本机的后台。</p></blockquote></li><li>Client (Docker客户端)<blockquote><p>docker客户端是docker的用户界面，它可以接受用户的命令与配置标识，并与Docker deamon通信</p></blockquote></li><li>Image (Docker镜像)<blockquote><p>Docker镜像是一个只读模板，它包含创建Docker容器的说明。它和系统光盘有点像，所以使用Docker镜像可以运行Docker镜像中的程序。</p></blockquote></li><li>Container (容器)<blockquote><p>容器是可运行的实例。镜像和容器的关系有点类似于面向对你中，类和对象的关系。可通过Docker Api或者CLI命令来启停、移动、删除容器。</p></blockquote></li><li>Registry<blockquote><p>Docker Registry是一个集中存储与分发镜像的服务。构建完docker镜像后，就可在当前宿主机上运行。但如果想要在其它机器上运行这个镜像，就需要手动复制。此时可以借助Docker Registry来避免镜像的手动复制。<br><img src="https://ws1.sinaimg.cn/large/005RGBbLly1fvkr26xdi8j30ed0awac7.jpg" alt="Docker架构图"></p></blockquote></li></ul><p>Docker Registry可分为公有与私有。最常用的Docker Registry就是官方的Docker Hub，这也是默认的Docker Registry。</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Window下单机ELK搭建入门并与Spring Boot项目整合</title>
      <link href="/posts/6f31418d/"/>
      <url>/posts/6f31418d/</url>
      
        <content type="html"><![CDATA[<p>ELK是一款非常流行的日志分析系统，在微服务架构中，我们可以使用ELK来跟踪分析各个微服务的日志，从而来了解服务的运行情况。</p><a id="more"></a><p>ELK是由三个开源工具搭建而成一个系统，分别是：</p><ul><li><p><strong>ElasticSearch</strong>: ES是个开源分布式搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p></li><li><p><strong>Logstash</strong>：一个完全开源的工具，可以对日志进行收集、分析、并将其存储供以后使用。</p></li><li><p><strong>Kibana</strong>：一个开源和免费的工具，他Kibana可以为Logstash和ES提供的日志分析友好的Web界面，可以帮助您汇总、分析和搜索重要数据日志。</p></li></ul><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>Window 10</li><li>jdk 1.8</li><li>ElasticSearch-6.4</li><li>logstash-6.4</li><li>kibana-6.4-windows-x86_64</li></ul><h2 id="ELK安装"><a href="#ELK安装" class="headerlink" title="ELK安装"></a>ELK安装</h2><p>需要先安装jdk 1.8，其实只需要java运行环境即可，具体安装与环境变量配置过程这时不记录了</p><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><p>Window下的安装比较简单。在官网下载对应平台的安装包即可。</p><p>官网：<a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/downloads/elasticsearch</a></p><p>下载下来后是一个zip的压缩文件，直接解压到安装目录即可。</p><p>ES的启动也非常简单，打开<code>/bin</code>目录双击 <code>elasticsearch.bat</code> 即可。</p><p>当然我们也可以选择作为服务启动，在命令行模式下切换到ES的<code>/bin</code>执行 <code>Service install</code> 再通过<code>/bin</code>目录下的 <code>elasticsearch-service-mgr.exe</code>来管理与启动服务。这里我选的第一种，使用的时候直接打开就行了。</p><p>启动后直接访问：<a href="http://localhost:9200/" target="_blank" rel="noopener">http://localhost:9200/</a> 若出现如下页面表示ES已经启动成功了。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507114745.png" alt="ES启动成功"></p><h3 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h3><p>官网下载：<a href="https://www.elastic.co/downloads/logstash" target="_blank" rel="noopener">https://www.elastic.co/downloads/logstash</a></p><p>我下载的是ZIP格式的，将压缩包解压到安装目录即可。</p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>在其<code>/config</code>目录可以看到已有一些配置文件，我们可以按自己的要求来新建一个配置文件,在此目录新建一个<code>logstach-test.conf</code>内容如下 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input &#123; </span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">        type =&gt; &quot;test&quot;</span><br><span class="line">        codec =&gt; json_lines</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">output &#123; </span><br><span class="line">  elasticsearch &#123;  </span><br><span class="line">    hosts  =&gt; [&quot;localhost:9200&quot;]   </span><br><span class="line">    index =&gt; &quot;logstash-%&#123;type&#125;&quot;    </span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的配置比较简单，logstash主要是收集日志给ElasticSearch。因此 <code>input{}</code>中主要是配置logstash监听的端口，后面我们在项目中配置日志向这个端口传输，logstash就会收集。</p><p><code>output{}</code>则配置ElasticSearch的地址，logstash将收集的日志向ES的地址进行输出，<code>index</code> 可以指定索引名， <code>stdout</code>是标准输出，会将收集到的日志进行输出，方便我们调试。</p><hr><p><code>input</code>中 <code>codec =&gt; json_lines</code>是一个json解析器，接收json的数据。这个要装<code>logstash-codec-json_lines</code> 插件。在命令行中切换到Logstash的 <code>/bin</code>目录下，执行以下命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash-plugin install logstash-codec-json_lines</span><br></pre></td></tr></table></figure><p>####启动</p><p>命令行中切换到Logstash的 <code>/bin</code>目录下，执行以下命令，使用我们上面的配置文件启动Logstash</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash -f ../config/logstash-test.conf</span><br></pre></td></tr></table></figure><p>命令窗口中打印如下内容无报错并处于<strong>监听状态</strong>则启动成功：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2018-09-18T16:29:03,364][INFO ][logstash.agent] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br></pre></td></tr></table></figure><h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><p>官网下载：<a href="https://www.elastic.co/downloads/kibana" target="_blank" rel="noopener">https://www.elastic.co/downloads/kibana</a></p><p>这里下载的是Window版本，下载下来是一个压缩包，直接解压到指定的安装目录即可。</p><p>启动则直接在<code>/bin</code>目录双击<code>kibana.bat</code></p><h2 id="新建Spring-Boot项目"><a href="#新建Spring-Boot项目" class="headerlink" title="新建Spring Boot项目"></a>新建Spring Boot项目</h2><p>这里使用之前写的项目作测试，项目的构建请看:<a href="https://blog.csdn.net/FTDD_HW/article/details/80874370" target="_blank" rel="noopener">微服务简单实例–电影购票</a> 这里使用用户微服务(服务提供者)。需要稍微作修改为我们整合Logstash</p><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加logstas--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="修改Controller"><a href="#修改Controller" class="headerlink" title="修改Controller"></a>修改Controller</h4><p>为了方便测试我们在findId方法中添加一条日志：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">    User findOne = <span class="keyword">this</span>.userRepository.getOne(id);</span><br><span class="line">    logger.info(<span class="string">"找到用户 ： &#123;&#125;"</span>,findOne);</span><br><span class="line">    <span class="keyword">return</span> findOne;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="新建bootstrap-yml"><a href="#新建bootstrap-yml" class="headerlink" title="新建bootstrap.yml"></a>新建bootstrap.yml</h4><p>在application.yml同目录下新建bootstrap.yml，并将application.yml中的 以下内容移动到bootstrap.yml中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: microservice-simple-provider-user-trace-elk</span><br></pre></td></tr></table></figure><h4 id="配置logback-spring-xml"><a href="#配置logback-spring-xml" class="headerlink" title="配置logback-spring.xml"></a>配置logback-spring.xml</h4><p>在<code>resources</code>目录下新建<code>logback-spring.xml</code>文件添加以下内容:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">"context"</span> <span class="attr">name</span>=<span class="string">"springAppName"</span> <span class="attr">source</span>=<span class="string">"spring.application.name"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"LOGSTASH"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">destination</span>&gt;</span>localhost:5044<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.encoder.LogstashEncoder"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/base.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"LOGSTASH"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>在上面的XML配置中添加了 <code>&lt;destination&gt;localhost:5044&lt;/destination&gt;</code>指定了我们上面配置logstash的监听地址，这样项目的日志才能被收集。</p></blockquote><p>配置完成后可以启动项目，观察logstash窗口会有日志打印出来。</p><h2 id="可视化查看"><a href="#可视化查看" class="headerlink" title="可视化查看"></a>可视化查看</h2><p>分别启动Es，Logstash，用户微服务，Kibana。打开kibana的地址：<a href="http://localhost:5601" target="_blank" rel="noopener">http://localhost:5601</a> 默认是没有密码可以直接登陆的。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507124727.png" alt="Kibana启动界面"></p><h4 id="创建索引模式"><a href="#创建索引模式" class="headerlink" title="创建索引模式"></a>创建索引模式</h4><p>我这里使用了汉化，默认为英文。点击<code>发现</code>添加索引。索引名为Logstash配置方案中指定的<code>index</code>。所以可以看到Kibana为我们列出了可用或使用过的索引名。在索引模式的输入框中填入 <code>logstash-test</code>下一步即可。</p><blockquote><p>索引名称可以使用匹配规则，可以匹配多个索引。</p></blockquote><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125024.png" alt="创建索引"></p><p>下一步需要选择过滤字段，这里我们先选择时间戳，并点击创建索引模式。创建完成后出现如下<code>系统管理&gt;索引模式界面</code>界面即创建成功，这里列出了可用的过滤字段，并可以在些删除该索引模式。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125128.png" alt="索引创建成功"></p><h4 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h4><p>点击<code>发现</code>这里我们可以看到刚刚新建的索引模式的数据。为了测试效果我们访问项目：<a href="http://localhost:8000/1多刷新几次再次返回`发现`界面查看，可以看到项目的日志已经过来了。下方可以看到日志内容，柱形图可以看到时间点上日志统计，左边为可显示的字段。可以把左边的字段加到下方进入展示。" target="_blank" rel="noopener">http://localhost:8000/1多刷新几次再次返回`发现`界面查看，可以看到项目的日志已经过来了。下方可以看到日志内容，柱形图可以看到时间点上日志统计，左边为可显示的字段。可以把左边的字段加到下方进入展示。</a></p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125147.png" alt="查看数据"></p><h4 id="添加筛选器"><a href="#添加筛选器" class="headerlink" title="添加筛选器"></a>添加筛选器</h4><p>我们可以添加筛选器<code>message</code>筛选出我们打印的日志</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125205.png" alt="添加筛选器"></p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125220.png" alt="查找message"></p><h4 id="可视化分析"><a href="#可视化分析" class="headerlink" title="可视化分析"></a>可视化分析</h4><p>在可视化界面中，我们添加一些视图。</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125236.png" alt="可视化"></p><p>通过一些条件定制，最后把视图放到仪表盘查看</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507125252.png" alt="仪表盘"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上只是简单的记录了下ELK的搭建与基本使用，对于生产部署还需要做一些配置。在学习过程中找到一些资料分享：</p><ul><li><a href="http://www.code123.cc/docs/kibana-logstash/v3/index.html" target="_blank" rel="noopener">Kibana 3指南</a></li><li><a href="https://www.cnblogs.com/iiiiher/p/7929379.html" target="_blank" rel="noopener">logstash的最佳实战-项目实战</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 日志管理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elk </tag>
            
            <tag> 日志管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Sleuth配合Zipkin实现微服务的跟踪</title>
      <link href="/posts/6883841/"/>
      <url>/posts/6883841/</url>
      
        <content type="html"><![CDATA[<p>在微服务架构中可以使用Zipkin来追踪服务调用链路，可以知道各个服务的调用依赖关系。在Spring Cloud中，也提供了Spring Cloud Sleuth来方便集成Zipkin实现。</p><a id="more"></a><p>本文使用一个Zipkin Server，用户微服务，电影微服务来实现。完整实现的代码放在github中：</p><ul><li>Zipkin Server：<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-trace-zipkin-server-stream-mysql" target="_blank" rel="noopener">microservice-trace-zipkin-server-stream-mysql</a></li><li>用户微服务：<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-simple-provider-user-trace-zipkin-stream" target="_blank" rel="noopener">microservice-simple-provider-user-trace-zipkin-stream</a></li><li>电影微服务：<a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-simple-consumer-movie-trace-zipkin-stream" target="_blank" rel="noopener">microservice-simple-consumer-movie-trace-zipkin-stream</a></li></ul><h1 id="Zipkin-Server"><a href="#Zipkin-Server" class="headerlink" title="Zipkin Server"></a>Zipkin Server</h1><p>Zipkin可以不配置数据库，但跟踪的数据只存在内在中，不能长久保存，因此这里使用<code>mysql</code>存储跟踪数据。项目中还使用了rabbitMQ作为消息中间件进行数据收集，实现Zipkin与微服务的解耦。</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>新建一个Spring Boot项目，添加以下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.zipkin.java/zipkin-autoconfigure-storage-mysql --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-storage-mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入SpringCloud 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>Edgware.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="添加注解"><a href="#添加注解" class="headerlink" title="添加注解"></a>添加注解</h2><p>在启动类上添加注解：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableZipkinStreamServer</span><br></pre></td></tr></table></figure><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>配置文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-trace-zipkin-server-stream-mysql</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    schema:</span> <span class="attr">classpath:/mysql.sql</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://localhost:3306/zipkin</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br><span class="line"><span class="attr">zipkin:</span></span><br><span class="line"><span class="attr">  storage:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9411</span></span><br></pre></td></tr></table></figure><blockquote><p>mysql.sql文件可以在上面项目地址中找到,首先需要在Mysql数据库中新建<code>zipkin</code>数据库，在项目启动时会自动执行<code>mysql.sql</code>。</p></blockquote><p>RabbitMQ的安装与配置可以参考：<a href="https://blog.csdn.net/FTDD_HW/article/details/80082790" target="_blank" rel="noopener">RabbitMQ学习系列:一、RabbitMQ 的安装</a></p><h1 id="微服务整合Zipkin"><a href="#微服务整合Zipkin" class="headerlink" title="微服务整合Zipkin"></a>微服务整合Zipkin</h1><p>用户微服务与电影微服务作一样的修改。</p><p>##添加依赖</p><p>主要需要添加以下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h2><p>在配置文件中添加以下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-simple-consumer-movie-trace-zipkin</span></span><br><span class="line"><span class="attr">  zipkin:</span></span><br><span class="line"><span class="attr">    base-url:</span> <span class="attr">http://localhost:9411</span></span><br><span class="line"><span class="attr">  sleuth:</span></span><br><span class="line"><span class="attr">    sampler:</span></span><br><span class="line"><span class="attr">      percentage:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure><h1 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h1><p>完成两个微服务的整合修改后，首先启动rabbitmq,保证mysql可以连通。分别启动Zipkin Server，用户微服务，电影微服务。</p><p>为了能看到跟踪数据，我们先访问服务让其产生数据：<a href="http://localhost:8011/user/1" target="_blank" rel="noopener">http://localhost:8011/user/1</a></p><p>再方便Zipink Server地址查看：<a href="http://localhost:9411/zipkin/" target="_blank" rel="noopener">http://localhost:9411/zipkin/</a></p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141224.png" alt="Zipkin"></p><p>选择我们需要查看的时间点，点击 <code>Find Traces</code>我们就能看到跟踪数据了。</p><p>点击导航栏上的<code>Dependencies</code>可以查看服务依赖</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141244.png" alt="Dependencies"></p><p>这里我们可以看到服务的调用方向。</p><p>打开Mysql数据库也可以看到跟踪数据已经被存储了：</p><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141258.png" alt="mysql存储"></p><p>这样即使Zipkin被关闭，跟踪数据也不会丢失。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Zipkin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 关联本地与远程仓库的问题</title>
      <link href="/posts/2b219ebc/"/>
      <url>/posts/2b219ebc/</url>
      
        <content type="html"><![CDATA[<p>今天新建一个本地仓库在关联远程仓库时遇到的问题，作下记录。</p><a id="more"></a><p>[TOC]</p><h2 id="配置SSH-KEY"><a href="#配置SSH-KEY" class="headerlink" title="配置SSH KEY"></a>配置SSH KEY</h2><blockquote><p>本地仓库与远程仓库通过SSH协议，所以需要配置SSH KEY</p></blockquote><p>使用命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -keygen  -t rsa –C “youremail@example.com”</span><br></pre></td></tr></table></figure><p>运行后会在本地用户目录生成一个 <code>.ssh</code>目录，里面有<code>id_rsa</code>和<code>d_rsa.pub</code>两个文件，<code>d_rsa.pub</code>是公钥。在远程仓库中打开配置SSH的页面粘贴<code>d_rsa.pub</code>文件里面的内容即可。如果已经生成过可以直接使用。</p><!--more--><h2 id="关联空仓库"><a href="#关联空仓库" class="headerlink" title="关联空仓库"></a>关联空仓库</h2><p>在一个已经文件的文件夹里打开bash命令行窗口</p><p>使用命令初始化本地仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git init</span><br></pre></td></tr></table></figure><p>提交本地仓库内容到暂缓区<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br></pre></td></tr></table></figure></p><p>提交到本地仓库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git commit -m <span class="string">"first commit"</span></span><br></pre></td></tr></table></figure></p><p>新建一个远程<strong>空仓库</strong>，关联本地仓库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote add origin git仓库地址.git</span><br></pre></td></tr></table></figure></p><p>把本地仓库分支master内容推送到远程仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure><blockquote><p>第一次提交加 -u 表示该分支与远程仓库中的master分支关联，后面提交直接 git push 即可</p></blockquote><h2 id="关联非空仓库"><a href="#关联非空仓库" class="headerlink" title="关联非空仓库"></a>关联非空仓库</h2><p>如果你的远程仓库新建时已经添加了文件，并且本地仓库也不是空的，那么在本地仓库关联远程仓库后还是无法推送，需要先拉取远程仓库中的内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git pull origin master</span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">fatal: refusing to merge unrelated histories</span><br></pre></td></tr></table></figure><p>但我在操作时遇到了上面的错误 <code>fatal: refusing to merge unrelated histories</code>经过查找得知这个错误在2.9.0版本之后才出现，以前的版本可以正常使用，因此我们必需加一个可选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git pull origin master --allow-unrelated-histories</span><br></pre></td></tr></table></figure><p>通过这个选项允许我们把origin仓库的master分支同步到本地，命令执行后还会打开一个vim填写备注，vim使用自行Google。</p><p>与远程同步成功后我们再执行推送命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure><p>这样就可以成功把远程仓库与本地仓库关联了。</p>]]></content>
      
      
      <categories>
          
          <category> TortoiseGit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Zuul 微服务网关的构建</title>
      <link href="/posts/2d527b76/"/>
      <url>/posts/2d527b76/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p> 在学习完前面的知识后，微服务架构已经初具雏形。但还有一些问题：不同的微服务一般会有不同的网络地址，客户端在访问这些微服务时必须记住几十甚至几百个地址，这对于客户端方来说太复杂也难以维护。如下图：</p><a id="more"></a><p> <img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141101.png" alt="请求多个服务"><br> 因此，我们需要一个微服务网关，介于客户端与服务器之间的中间层，所有的外部请求都会先经过微服务网关。客户端只需要与网关交互，只知道一个网关地址即可，这样简化了开发还有以下优点：<br> 1、易于监控<br> 2、易于认证<br> 3、减少了客户端与各个微服务之间的交互次数<br> 如下图：<br> <img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141113.png" alt="微服务网关架构图"></p><p>在Spring Cloud中 Zuul是Netflix的基于JVM的路由器和服务器端负载均衡器。Zuul可以和Eureka、Ribbon、Hystrix、等组件配合使用。</p><h1 id="构建微服务网关"><a href="#构建微服务网关" class="headerlink" title="构建微服务网关"></a>构建微服务网关</h1><p>新建一个spring Boot项目microservice-gateway-zuul 。<br>Spring Boot :1.5.9.RELEASE<br>Spring Cloud:Edgware.RELEASE</p><h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="修改启动类"><a href="#修改启动类" class="headerlink" title="修改启动类"></a>修改启动类</h2><p>上面依赖中也加入了Eureka ，一般我们都会在启动类中添加上<br><code>@EnableDiscoveryClient</code> 注解，但在ZUUL 中我们只需要添加一个<br><code>@EnableZuulProxy</code>注解即可<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceGatewayZuulApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceGatewayZuulApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h2><p>这里先使用最简单的配置，即配置应用名、端口、注册Eureka即可。后面再慢慢优化配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: microservice-gateway-zuul</span><br><span class="line">server:</span><br><span class="line">  port: <span class="number">8040</span></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http:<span class="comment">//user:admin@localhost:8761/eureka</span></span><br></pre></td></tr></table></figure></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>完成配置后则可以分别启动Eureka、用户微服务、Config Server(如果使用了)、microservice-gateway-zuul 项目。这样一个简单的微服务网关就完成了。我们可以通过 microservice-gateway-zuul 的路径加 微服务应用名 来访问微服务。<br>如访问用户微服务：<code>http://localhost:8040/microservice-provider-user/1</code><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141128.png" alt="微服务网关测试"><br>这样所有的微服务都可以通过 Zuul 进行访问。<br>前面提到Zuul 可以配合Ribbon使用，我们不用加任何配置和依赖，即可以实现负载均衡，可以再启动一个用户微服务进行测试。</p><h1 id="优化配置"><a href="#优化配置" class="headerlink" title="优化配置"></a>优化配置</h1><p>上一节使用 Zuul 实现了最简单的微服务网关，在实际环境中需要对Zuul 进行优化配置。</p><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p><strong>1、转发</strong><br>在Zuul的配置中可以为各微服务添加路由映射，如添加配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-provider-user:</span> <span class="string">/user/**</span></span><br></pre></td></tr></table></figure></p><p>表示HTTP调用将 <code>/user</code> 转发到<code>microservice-provider-user</code>服务，于是我们访问用户微服务的地址可以简化为：<br><code>http://localhost:8040/user/1</code></p><blockquote><p>/user/* 表示匹配其下的一个级别的路径，/user/** 表示匹配其下多个级别的路径。</p></blockquote><p>另外 还有一种方式也可以实现：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    user:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">microservice-provider-user</span></span><br></pre></td></tr></table></figure></p><p>这种写法与上面的效果相同。<code>zuul.routes.user</code> 这里的 user 是只该路由名称，可以自己随意命名。<br><strong>2、正则表达式指定路由规则</strong><br>Zuul中可以写正则来指定路由规则，如微服务名命名规则为：微服务名+版本。通过添加以下正则规则 ，我们可以通过 版本 + 微服务名 来访问。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceGatewayZuulApplication</span> </span>&#123;</span><br><span class="line"><span class="comment">//正则表达式指定路由规则</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PatternServiceRouteMapper <span class="title">serviceRouteMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> PatternServiceRouteMapper(</span><br><span class="line"><span class="string">"(?&lt;name&gt;^.+)-(?&lt;version&gt;v.+$)"</span>,</span><br><span class="line"><span class="string">"$&#123;version&#125;/$&#123;name&#125;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceGatewayZuulApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>添加<code>PatternServiceRouteMapper</code>  传入两个参数，第一个为微服务的命名规则正则表达式，第二个是需要转化成什么形式的正则表达式。<br><code>(?&lt;name&gt;^.+)-(?&lt;version&gt;v.+$)</code>表示我们的微服务命名 为服务名+版本;<br><code>${version}/${name}</code> 表示访问路径转化成版本+服务名<br><strong>测试</strong><br>为了测试方便，把用户微服务的<code>spring.application.name</code> 更改为 <code>microservice-provider-user-v1</code> ,如果使用了Config Server 把git上的配置也记得更改。<br> 我们重启下Zuul，再次访问用户微服务会我发现原来的访问路径不行了。需要使用以下方式：<code>http://localhost:8040/v1/microservice-provider-user/1</code><br> <img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141141.png" alt="正则匹配"></p><p><strong>3、前缀</strong><br>添加如下配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  prefix:</span> <span class="string">/api</span></span><br></pre></td></tr></table></figure></p><p>访问Zuul 的<code>/api/microservice-provider-user/1</code>会被映射到 <code>/microservice-provider-user/1</code> 即添加了前缀。<br>添加配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  prefix:</span> <span class="string">/api</span></span><br><span class="line"><span class="attr">  strip-prefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>配置 <code>strip-prefix</code>后，访问Zuul 的<code>api/microservice-provider-user/1</code>会被转发到 <code>microservice-provider-user</code>的 <code>/api/1</code><br><code>strip-prefix</code>需与<code>prefix</code>配合使用。</p><p><strong>4、忽略微服务或路径</strong><br>在有些情况下我们不想微服务网关去代理某个微服务，或者想保护某个微服务下了敏感路径可以使用以下配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">    ignored-services:</span> <span class="string">microservice-config-server</span></span><br></pre></td></tr></table></figure></p><p><code>zuul.ignored-services</code> 表示忽略指定的微服务，则通过Zuul不能访问到该微服务。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">    ignored-patterns:</span> <span class="string">/**/getProfile/**</span></span><br></pre></td></tr></table></figure></p><p><code>zuul.ignored-patterns</code> 表示忽略所以包含 <code>/getProfile/</code>的路径，上一篇笔记中我们为用户微服务添加了 <code>/getProfile/</code> 现在可以测试已无法访问了，但其它路径则正常，这种方式常可以用来屏蔽 <code>/admin/</code>等比较敏感的路径。</p><h1 id="Zuul-过滤器"><a href="#Zuul-过滤器" class="headerlink" title="Zuul 过滤器"></a>Zuul 过滤器</h1><p>Zuul 过滤器是Zuul的核心组件，Zuul中已经实现了一些过滤器，同时我们也可以自己定义过滤器。在Zuul中定义过滤器很简单，只需要继承 <code>ZuulFilter</code> 类。</p><h2 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h2><p>在上面构建的 <code>microservice-gateway-zuul</code>中新建类 并继承 <code>ZuulFilter</code> 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤器的优先级,数字越大顺序越后</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否使用该过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"这里是通过ZuulFilter中打印出来的！"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>继承 <code>ZuulFilter</code>后实现它的四个方法，作用可看上面的注释。<br>过滤器类型有如下几种：</p><blockquote><p><code>PRE</code>：这种过滤器在请求被路由之前调用，可以利用这种过滤器实现身份认证，记录调用信息等。<br><code>ROUTING</code>：这种过滤器将请求路由到微服务。<br><code>POST</code>：这种过滤器在路由到微服务后执行。<br><code>ERROR</code>：在其他阶段发生错误时执行该过滤器。</p></blockquote><p>在启动类中添加Bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceGatewayZuulApplication</span> </span>&#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MyFilter <span class="title">myFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> MyFilter();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceGatewayZuulApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重新启动Zuul，随意访问一个微服务，可以在Zuul控制台看到打印了过滤器run方法中输出的内容：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141153.png" alt="过滤器输出内容"></p><h2 id="禁用过滤器"><a href="#禁用过滤器" class="headerlink" title="禁用过滤器"></a>禁用过滤器</h2><p>Zuul默认启用了一些过滤器，这些过滤器存放在<code>spring-cloud-netflix-core</code>包中的<code>com.netflix.zuul.filters</code>中，在发某些场景下，我们想禁用一些过滤器可以直接在配置文件中设置：<br><code>zuul.&lt;SimpleClassName&gt;.&lt;filterType&gt;.disable=true</code></p><p><code>SimpleClassName</code>:是指过滤器类名<br><code>filterType</code>:是过滤器类型<br>如禁用我们上面自定义过滤器可以这样写：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  MyFilter:</span></span><br><span class="line"><span class="attr">    pre:</span></span><br><span class="line"><span class="attr">      disable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>重启Zuul再次通过Zuul访问微服务，会发现Zuul的控制台不会再打印run方法中的内容，说明已经被禁用了。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微服务网站 </tag>
            
            <tag> Zuul </tag>
            
            <tag> API GateWay </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Config 同步刷新配置及加密解密</title>
      <link href="/posts/525fe2aa/"/>
      <url>/posts/525fe2aa/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>前面的文章为微服务架构引入了统一配置管理Spring cloud config，实现了各个微服务配置分布式管理。配置被修改后，我们不可能重新启动微服务，前面说到过Spring Cloud Config可以自动更新配置，本篇会对同步自动刷新配置进行学习记录。另外配置文件存储在GIT仓库中，很多场景下，对于某些敏感的配置内容(例如数据库账号，密码等)，应当加密存储。部分内容涉及上篇文章：<a href="https://blog.csdn.net/FTDD_HW/article/details/82053079" target="_blank" rel="noopener">微服务学习笔记–使用Spring Cloud Config 统一管理微服务配置</a></p><a id="more"></a><h1 id="同步刷新"><a href="#同步刷新" class="headerlink" title="同步刷新"></a>同步刷新</h1><p>在项目中加入actuator，就会有一个<code>/refresh</code>端点，当配置被修改后，只需要手动通过POST方式去访问这个端口，项目配置即可被刷新。但这种手动刷新的方式只能针对单个项目刷新，如果所有的微服务节点的配置都需要手动去刷新则工作量会很大。因此这里介绍的是同步刷新的方式，使用Spring Cloud Bus实现。之所以它能实现同步刷新，是因为Spring Cloud Bus 使用了轻量级的消息代理(如rabbitmq,kafka)，通过广播的方式让所以有被修改配置的微服务节点都能被刷新。</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>在上篇文章的Config Server，用户微服务，电影微服务三个项目中都引入以下依赖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><h2 id="添加RabbitMQ"><a href="#添加RabbitMQ" class="headerlink" title="添加RabbitMQ"></a>添加RabbitMQ</h2><p>1、RabbitMQ安装可以参考之前的文章：<a href="https://blog.csdn.net/FTDD_HW/article/details/80082790" target="_blank" rel="noopener">RabbitMQ学习系列:一、RabbitMQ 的安装</a><br>在三个项目的配置文件中添加rabbitmq配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq:</span><br><span class="line">  host: localhost</span><br><span class="line">  port: 5672</span><br><span class="line">  username: guest</span><br><span class="line">  password: guest</span><br></pre></td></tr></table></figure></p><h2 id="添加测试方法"><a href="#添加测试方法" class="headerlink" title="添加测试方法"></a>添加测试方法</h2><p>其实这样就改造完成了，为了方便测试，我们把git上存储的各个配置文件添加相应配置：</p><pre><code>profile: user-dev-v1.0</code></pre><p>在用户与电影微服务中的Controller中添加以下红框中的内容以获取上面添加的配置值：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140708.png" alt="添加内容"></p><blockquote><p><code>@RefreshScope</code> 添加该注解的类会在类更改时得到特殊处理</p></blockquote><p>通过这样改造，我们可以修改上面的属性，push到仓库，刷新后测试属性是否被更新来验证我们配置的Spring cloud bus 是否生效。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>首先我们访问用户与电影微服务的<code>getProfile</code>方法查看当前配置的<code>profile</code>值：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140721.png" alt="用户微服务profile"><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140735.png" alt="电影微服务Profile"><br>把<code>microservice-provider-user-dev.yml</code>与 <code>microservice-consumer-movie-dev.yml</code>中的profile配置值分别修改成：user-dev-v2.0    和 movie-dev-v2.0  并推送到git仓库。再次使用getProfile方法获取配置值发现没有变化。<br>通过POSTMAN访问Config Server的<code>/bus/refresh</code>  端口：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140750.png" alt="POSTMAN"><br>再次访问用户与电影微服务的<code>getProfile</code>方法：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140801.png" alt="这里写图片描述"><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140814.png" alt="这里写图片描述"><br>发现获取的配置值已经改变，说明我们刷新配置生效了。<br>这里我们是访问Config Server的 <code>/bus/refresh</code>端口，其实访问用户或电影微服务的<code>/bus/refresh</code>端口效果也是一样的，不过在实际环境中，微服务被迁移，网络地址可能会发生改变，因此把Config Server也加入到消息总线中，它的地址一般比较固定，它的配置更新状态可以广播到其它微服务节点中。</p><h2 id="设置自动刷新"><a href="#设置自动刷新" class="headerlink" title="设置自动刷新"></a>设置自动刷新</h2><p>前面其实还是使用手动通过POST方式去访问<code>/bus/refresh</code>端口进行刷新，但已经实现了同步刷新。关于自动刷新我们可以借助GIT仓库的WebHook配置，在PUSH时让GIT给指定网络地址发送一个POST请求。<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140825.png" alt="WebHooks"><br>由于这里是在本地进行学习测试，没有网络地址可以进行测试。</p><h1 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h1><p>Config Server 为配置内容的加密解密提供了两种方式。</p><h2 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h2><h3 id="安装JCE"><a href="#安装JCE" class="headerlink" title="安装JCE"></a>安装JCE</h3><p>使用JCE,下载地址：<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html</a><br>需要对应相应版本的JDK，上面地址是jdk8的。<br>下载后打开解压有两个jar文件，把它们替换JDK安装目录下：<br>%JAVA_HOME%\jre\lib\security<br> 在Config Server的配置文件中添加密钥：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encrypt:</span><br><span class="line">  key: wei</span><br></pre></td></tr></table></figure></p><blockquote><p>key 可以自己随意设置<br>需要<code>注意</code>的是，这个配置必须配置在bootstrap.yml中，因此在Config Server中我们需要新建bootstrap.yml并将配置写入。</p></blockquote><h3 id="存储加密内容"><a href="#存储加密内容" class="headerlink" title="存储加密内容"></a>存储加密内容</h3><p>做好上面的工作后，重新启动Config Server 项目，可能在控制到看到打印了以下端点：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140836.png" alt="加密解密端口"><br>这两个端点可以进行加密与解密。我们用POSTMAN把上面添加的<code>profile</code>配置值加密：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140847.png" alt="加密"><br>然后把返回的加密值写入配置文件中，以<code>{cipher}</code>开关，以让Config Server识别这是需要解密的内容。<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140950.png" alt="添加加密内容"><br>将修改后的配置文件push到git仓库，使用<code>/bus/refresh</code>刷新配置后访问用户微服务的<code>getProfile</code>方法以测试：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141015.png" alt="测试"><br>可以看到返回到Config Client的配置已经被自动解密了</p><h2 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>非对称加密相对与对称加密来说更安全。<br><strong>1、生成keyStore</strong><br>非对称加密可以使用JDK自带的keytool工具，打开cmd输入以下命令：</p><pre><code>keytool -genkeypair -alias config-server -keyalg RSA -keystore config-server.keystore</code></pre><p>按下图方式填写内容：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507141031.png" alt="生成keystore"><br>方便测试，上图我只输入了红框中的内容，其它地方直接回车即可。</p><p>运行完后会在当前运行路径下生成一个<code>config-server.keystore</code> 把这个文件移动到Config Server项目的 <code>\src\main\resources</code>目录下。<br><strong>2、添加配置</strong><br>在Config Server 的bootstrap.yml配置下添加以下内容：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">encrypt:</span></span><br><span class="line"><span class="attr">  key-store:</span></span><br><span class="line"><span class="attr">    location:</span> <span class="string">config-server.keystore</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">config-server</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">******</span></span><br><span class="line"><span class="attr">    secret:</span> <span class="string">******</span></span><br></pre></td></tr></table></figure></p><p>这里的<code>password</code>与<code>secret</code>分别是生成keystroe时第一次与第二次输入的密码。<code>location</code> 是指向config-server.keystore的放置路径。<br><strong>3、非对称加密测试</strong><br>配置好上面的内容后，重启Config Server ，和对称加密一样，通过POSTMAN生成加密内容，写到配置文件中PUSH到GIT仓库即可。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 刷新配置 </tag>
            
            <tag> 配置加密解密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Config 统一管理微服务配置</title>
      <link href="/posts/e60cfe17/"/>
      <url>/posts/e60cfe17/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>微服务架构中为了方便管理与更新各微服务的配置，在Spring Cloud中可以使用 Spring Cloud Config 来统一管理系统内各微服务的配置文件。使用Config统一管理后，可实现git分布式版本控制，不同环境不同配置，动态调整自动更新配置等功能。<br>Spring Cloud Config 包括Config Server 和 Config Client 两部分，Config Server用于管理配置，Config Client 则与各微服务集成负责向Config Server请求获取配置并进行缓存以提高性能。<br>Config Server默认使用Git存储配置内容，当然也可以使用SVN,本地文件系统或Vault存储配置。<br>下面把Config Server 、 Config Client 和 Eureka配合使用记录下来。</p><a id="more"></a><h1 id="编写Config-Server"><a href="#编写Config-Server" class="headerlink" title="编写Config Server"></a>编写Config Server</h1><p>在编写Config Server 前，我们需要使用Git作为后端存储。</p><h2 id="创建Git仓库"><a href="#创建Git仓库" class="headerlink" title="创建Git仓库"></a>创建Git仓库</h2><p>可以在github.com上创建一个仓库。先前面用到了电影与用户微服务的配置文件直接放到仓库中。配置文件命名使用规范：<code>服务名+环境</code> 。这里我创建的仓库如下图：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140217.png" alt="git仓库"><br>每个微服务的配置我这里按开发与生产环境分别部署两份。配置文件内容与前面做的demo配置一样，但开发与生产配置的端口号不同。<br>另外，方便测试版本控制，我给仓库新建了一个 config-label-v2.0 分支，将端口号进行修改以便区分。</p><h2 id="编写Config-Server-1"><a href="#编写Config-Server-1" class="headerlink" title="编写Config Server"></a>编写Config Server</h2><p>新建一个Spring Boot项目，<br><strong>1、引入依赖</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;Edgware.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">&lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br></pre></td></tr></table></figure></p><p><strong>2、添加注解</strong><br>在启动类上添加 <code>@EnableConfigServer</code> 声明这是一个Config Server<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceConfigServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceConfigServerApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>因为我们是配合Eureka使用，因此启动类上也需要添加 <code>@EnableDiscoveryClient</code> 注解 </p></blockquote><p><strong>3、编写配置</strong><br>编写application.yml ，并添加以下配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span>  <span class="string">microservice-config-server</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/hjwzyy/spring-cloud-edgware-configServer-demo</span></span><br><span class="line"><span class="attr">          username:</span> <span class="string">******@*******.com</span></span><br><span class="line"><span class="attr">          password:</span> <span class="string">*******</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://user:admin@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><p>至此 一个简单的Config Server就完成了。<br>下面我们来启动Config Server进行测试。<br>访问如下地址：<a href="http://localhost:8082/microservice-provider-user/dev" target="_blank" rel="noopener">http://localhost:8082/microservice-provider-user/dev</a> 如下图：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140417.png" alt="查看配置"><br>这里显示的是我们放在Git仓库里的用户微服务的开发环境配置文件，说明Config Server正常。<br>测试版本控制，访问如下地址：<a href="http://localhost:8082/microservice-provider-user/dev/config-label-v2.0" target="_blank" rel="noopener">http://localhost:8082/microservice-provider-user/dev/config-label-v2.0</a><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140532.png" alt="分支配置"><br>可以看到访问地址加上指定分支后显示的是指定分支下的配置文件。</p><pre><code>关于Config Server 获取git上的资源信息遵循如下规则：</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure><p>我们可以按以上规则去访问git上的配置文件</p><h1 id="编写Config-Client"><a href="#编写Config-Client" class="headerlink" title="编写Config Client"></a>编写Config Client</h1><p>前面我们写过，Config Client与微服务集成，因此在微服务中添加Config的依赖，稍微配置一下就可以了。<br>下面我将前面的用户微服务与电影微服务添加Config Client，整个用户与电影微服务的编写，服务注册这里不再贅述，可参考前文：</p><p><a href="https://blog.csdn.net/FTDD_HW/article/details/80874370" target="_blank" rel="noopener">微服务简单实例–电影购票</a></p><p><a href="https://blog.csdn.net/FTDD_HW/article/details/80922134" target="_blank" rel="noopener">微服务学习笔记 –使用Spring Cloud Eureka实现服务注册与发现</a></p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>向用户微服务添加以下依赖：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>电影微服务同上添加依赖。</p><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>因为用户微服务的配置已经放在了git上，所以项目的中的application.yml文件只需要配置一个端口即可，其它配置清除：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8005</span></span><br></pre></td></tr></table></figure></p><blockquote><p>git上的配置文件也可以配置端口，并且会以git上的配置文件为准</p></blockquote><p><strong>添加<code>bootstrap.yml</code>配置文件</strong> </p><blockquote><p>Spring Cloud 有一个“引导上下文”的概念，这里主应用程序的父上下文。引导上下文负责从配置服务器加载配置属性，以及解密外部配置文件中的属性。和主应用程序加载application.*(yml或priperties)中的属性不同，引导上下文加载bootstarap.*中的属性。配置在bootstrap.*中的属性有更高的优先级，因此默认情况下它们不能被本地配置覆盖。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-provider-user</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">      label:</span> <span class="string">master</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        serviceId:</span> <span class="string">microservice-config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://user:admin@localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>配置文件中加上服务注册配置，因为我们是与Eureka配合使用，Config Client需要先从Eureka中找到Config Server，再从Config Server中获取到对应的配置。而获取对应配置是依靠<code>spring.application.name</code> 与 <code>spring.cloud.config.profile</code>来找到对应配置文件的。还记得前面我们在Git仓库中建立的配置文件命名吗？都是以  <code>服务名+环境</code> 进行命名的。</p></blockquote><p> <code>spring.cloud.config.label</code> 则是指定分支为主分支 <code>master</code><br><code>spring.cloud.config.discovery.enabled</code> 表示使用服务发现组件中的Config Server，而不是自己指定的Config Serverr uri，默认为false<br><code>spring.cloud.config.discovery.serviceId</code>指定Config Server在服务发现中的serviceId，默认是configserver ，因此这里写的是前面编写的Config Server 的<code>spring.application.name</code></p><p><strong>电影微服务的配置同上</strong><br>至此，Config Client已经配置完成。</p><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>分别启动Eureka，Config Server，用户微服务与电影微服务。<br>在Eureka界面可以看到有三个注册的服务：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140552.png" alt="注册服务"><br>用户微服务与电影微服务启动的端口是git配置文件中设置的端口，访问各各微服务通过正常获取数据：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140607.png" alt="正常获取数据"><br>说明配置文件已经实现了通过Spring cloud Config 统一管理与获取。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Cloud Config </tag>
            
            <tag> 微服务配置管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hystrix实现微服务的容错处理与监控数据</title>
      <link href="/posts/31090589/"/>
      <url>/posts/31090589/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>在微服务架构中，如果服务提供者响应缓慢，那么服务消费者的请求就会被强制等待，或响应超时。在高负载场景下，如果不做任何处理，这类问题可能会导致服务消费者资源耗竭甚至整个系统的崩溃。</p><a id="more"></a><h1 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h1><p>Hystrix是一个实现了超时机制和断路器模式的工具类库。是由Netflix开源的，用于隔离访问系统、服务或者第三方库，防止级联失败，从而提升系统的可用性与容错性。<br>Hystrix主要通过以下几点实现延迟和容错：<br><strong>1、包裹请求：</strong> 使用HystrixCommand（或HystrixObservableCommand）包裹对依赖的调用逻辑，每个命令在独立线程中执行。这使用到了设计模式中的“命令模式”。<br><strong>2、跳闸机制：</strong> 当某服务的错误率超过一定阈值时，Hystrix可以自动或手动跳闸，停止请求该服务一段时间 。<br><strong>3、资源跳闸：</strong> Hystrix为每个依赖都维护了一个小型的线程池（或者信号量）。如果该线程池已满，发往该依赖的请求就被立即拒绝，而不是排除等候，从而加速失败判定。<br><strong>4、监控：</strong> Hystrix可以近乎实时地监控运行指标和配置的变化，例如成功、失败、超时、以及被拒绝的请求等。<br><strong>5、回退机制：</strong> 当请求失败、超时、被拒绝，或当断路器打开，执行回退逻辑。回退逻辑可由开发人员自行提供，例如返回一个缺省值。<br><strong>6、自我修复：</strong> 断路器打开一段时间后，会自动进行“半开”状态。断路器打开、关闭、半开的逻辑转换。</p><h1 id="整合Hystrix"><a href="#整合Hystrix" class="headerlink" title="整合Hystrix"></a>整合Hystrix</h1><p>在Spring Cloud 中整合Hystrix非常方便。我们以前面的服务消费者项目为例进行修改。</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="修改启动类"><a href="#修改启动类" class="headerlink" title="修改启动类"></a>修改启动类</h2><p>在启动类中添加注解 <code>@EnableHystrix</code> 或<code>@EnableCircuitBreaker</code>，为项目启用断路器支持。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceConsumerMovieRibbonApplication</span> </span>&#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceConsumerMovieRibbonApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(UserController.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"findByIdFallback"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"http://microservice-provider-user/"</span> + id,User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findByIdFallback</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(-<span class="number">1L</span>);</span><br><span class="line">        user.setName(<span class="string">"默认用户"</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/log-user-instance"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logUserinstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServiceInstance serviceInstance = <span class="keyword">this</span>.loadBalancerClient.choose(<span class="string">"microservice-provider-user"</span>);</span><br><span class="line">        UserController.LOGGER.info(<span class="string">"&#123;&#125;:&#123;&#125;:&#123;&#125;"</span>,serviceInstance.getServiceId(),serviceInstance.getHost(),serviceInstance.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在Controller中，我们为<code>findById</code>方法编写了一个回退方法<code>findByIdFallback</code>，在<code>findByIdFallback</code>方法中返回了一个默认用户，在<code>findById</code>中添加注解<code>@HystrixCommand</code>在<code>fallbackMethod</code>属性中指定它的回退方法即可。</p><h2 id="容错测试"><a href="#容错测试" class="headerlink" title="容错测试"></a>容错测试</h2><p>修改好上述内容后我们分别启动一个服务提供者，服务消费者与Eureka。访问服务消费者：<a href="http://localhost:8011/user/1" target="_blank" rel="noopener">http://localhost:8011/user/1</a> 可以正常得到数据。当我们把服务提供者关闭后再次访问，会发现返回了之前的默认用户:<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140023.png" alt="默认用户">。</p><h1 id="Hystrix监控"><a href="#Hystrix监控" class="headerlink" title="Hystrix监控"></a>Hystrix监控</h1><p>前面提到Hystrix除了可以实现容错处理，还有监控功能。<br>使用Hystrix的模块<code>hystrix-metrics-event-stream</code>，就可以将这些监控信息以文本的形式暴露给外部系统。<code>spring-cloud-starter-netflix-hystrix</code>已经包含了这个模块，我人只需要添加Actuator，就可以使用<code>/hystrix.stream</code>端口获得Hystrix监控信息。</p><h2 id="添加Actuator"><a href="#添加Actuator" class="headerlink" title="添加Actuator"></a>添加Actuator</h2><p>只需要在项目中添加Actuator依赖即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>重新启动项目，访问 <a href="http://localhost:8011/hystrix.stream会出现类似如下图的信息：" target="_blank" rel="noopener">http://localhost:8011/hystrix.stream会出现类似如下图的信息：</a><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140047.png" alt="监牢信息"></p><h2 id="可视化监控数据"><a href="#可视化监控数据" class="headerlink" title="可视化监控数据"></a>可视化监控数据</h2><p>上一节我们可以看到监控信息，但都是通过文字形式展示的，不能直观的显示系统状态。<br>我们可以使用Hystrix Dashboard，让监控数据图形化，可视化。<br>我们新建一个最简单的Spring Boot 项目</p><ul><li><p>添加以下依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li><p>启动类添加注解<br>在启动类上添加注解 <code>@EnableHystrixDashboard</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceHystrixDashboardApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceHystrixDashboardApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置文件<br>在配置文件中添加访问端口</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8030</span></span><br></pre></td></tr></table></figure></li><li><p>启动项目<br>启动新建的项目：<a href="http://localhost:8030/hystrix" target="_blank" rel="noopener">http://localhost:8030/hystrix</a> ，就可以看到Dashboard界面，在中间的地址栏中输入上一节中我们查看监控数据的地址<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140059.png" alt="Dashboard"><br>随意填写一个Title 点击按钮，Dashboard即可把<a href="http://localhost:8011/hystrix.stream" target="_blank" rel="noopener">http://localhost:8011/hystrix.stream</a> 的文本信息转化成可视化视图：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140113.png" alt="可视化监控"><br>关于显示的指标信息解释可以参考如下图：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140125.png" alt="指标解释"></p><h1 id="Turbine聚合监控数据"><a href="#Turbine聚合监控数据" class="headerlink" title="Turbine聚合监控数据"></a>Turbine聚合监控数据</h1><p>上一节我们把要监控的项目的 /hystrix.stream 地址填入Dashboard即可以可视化的监控项目状态。但在微服务中往往有若干个微服务，每个微服务又有多个实例，如果这样一个个监控非常不方便。这一节我们使用Turbine来聚合Hystrix监控数据。<br>首页我们把服务消费者项目复制一份，<code>修改应用名、端口与方法名</code>，模拟多个微服务的场景。<br>这里我把前面使用的服务消费者项目直接复制一份，在配置文件中修改<code>spring.application.name</code>为microservice-consumer-movie2,修改<code>server.port</code>为8031。在<code>Controller</code>中将原方法<code>findById</code> 名更改为<code>findById2</code>,回退方法名更改为<code>findByIdFallback2</code><br>然后新建一个Spring Boot项目<br><strong>1、依赖</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-turbine&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li></ul><p><strong>2、配置文件</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8031</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-hystrix-turbine</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">        defaultZone:</span> <span class="attr">http://user:admin@localhost:8761/eureka/</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">turbine:</span></span><br><span class="line"><span class="attr">  app-config:</span> <span class="string">microservice-consumer-movie,microservice-consumer-movie2</span></span><br><span class="line"><span class="attr">  cluster-name-expression:</span> <span class="string">"'default'"</span></span><br></pre></td></tr></table></figure></p><p>在配置文件中，把项目注册到Eureka，使用 <code>turbine.app-config</code> 属性添加需要聚合监控的项目名<br><strong>3、添加注解</strong><br>在启动类上添加注解 <code>@EnableTurbine</code></p><p><strong>4、聚合监控数据</strong><br>最后我们启动服务提供者，两个服务消费者，一个Eureka，上一节新建的Dashboard项目与刚新建的Turbine项目。<br>上一节中我们是把服务消费者的 <code>/hystrix.stream</code> 放入Dashboard中进行可视化，但Turbine项目已经聚合了两个服务消费者的监控数据，因为我们只需要把Turbine项目的地址放入Dashboard中即可。<br>Turbine项目聚合监控信息的地址为 <a href="http://localhost:8031/turbine.stream" target="_blank" rel="noopener">http://localhost:8031/turbine.stream</a><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140139.png" alt="tuebine聚合"><br>点击按钮后可展示如下图的可视化界面<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507140151.png" alt="聚合后的可视化界面"><br>可以看到两个服务消费者的方法都显示出来了，如果同名会显示成一个。<br>这样我们就完成了监控的聚合，更加方便的显示各各微服务的状态。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hystrix </tag>
            
            <tag> Turbine </tag>
            
            <tag> 微服务容错 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Feign实现声明式REST调用</title>
      <link href="/posts/f0c3ea98/"/>
      <url>/posts/f0c3ea98/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p>#<br>前面的文章中，服务消费者调用服务提供者的接口我们是使用RestTemplate实现的REST API调用的。但这种方式在参数比较多时会变得低效，难以维护。</p><a id="more"></a><h1 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h1><p>Feign是Netflix开发的声明式，模板化的HTTP客户端。它可以让我们更加便捷，优雅的调用HTTP API。Feign有自己的注解，在Spring Cloud中对Feign进行了增强，使其可以支持Spring MVC注解，并整合Ribbon与Eureka。</p><h1 id="整合Feign"><a href="#整合Feign" class="headerlink" title="整合Feign"></a>整合Feign</h1><p>前面的服务消费都使用RestTemplate来调用服务提供者，这里更改成使用Feign，使用声明式的RestFul API。</p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>配置其实无需修改<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8011</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-consumer-movie</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://user:admin@localhost:8761/eureka/</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><h2 id="创建Feign接口"><a href="#创建Feign接口" class="headerlink" title="创建Feign接口"></a>创建Feign接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-provider-user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@FeignClient</code> 注解中的<code>microservice-provider-user</code> 是服务提供者的主机名，用于创建Ribbon负载均衡器，与上篇文章中使用主机名是一样的。也可以使用URL属性指定请求的URL:</p><pre><code>@FeignClient(name = &quot;microservice-provider-user&quot;,url=&quot;http://localhost:8000/&quot;)</code></pre><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Controller 中去掉RestTemplate，定义 UserFeignClient 。我在测试中定义的 UserFeignClient 会提示 <code>Could not autowire. No beans of &#39;UserFeignClient&#39; type found.</code> 但运行并不影响。</p><h2 id="添加注解"><a href="#添加注解" class="headerlink" title="添加注解"></a>添加注解</h2><p>在启动类上注解 <code>@EnableFeignClients</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceSimpleConsumerMovieApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceSimpleConsumerMovieApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>完成上述修改后，就可以像之前一样去调用服务提供者了。<br>与上篇Ribbon一样，启动一个Eureka，一个或多个服务提供者(Feign自己集成了Ribbon)，启动修改完成后的服务消费者。<br>访问<a href="http://localhost:8011/user/1" target="_blank" rel="noopener">http://localhost:8011/user/1</a><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135844.png" alt="测试"></p><h1 id="自定义Feign配置"><a href="#自定义Feign配置" class="headerlink" title="自定义Feign配置"></a>自定义Feign配置</h1><p>按上一节整合Feign很简单，但有时候我们想自定义Feign的配置，如更改Feign使用的编码器，解码器，契约，拦截器等。<br>如服务提供者是需要Http Basic的认证才能调用的，那么服务消费者可以在Feign中自定义配置拦截器，添加 Http Basic 认证。</p><h2 id="编写配置类"><a href="#编写配置类" class="headerlink" title="编写配置类"></a>编写配置类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BasicAuthRequestInterceptor <span class="title">basicAuthRequestInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BasicAuthRequestInterceptor(<span class="string">"user"</span>,<span class="string">"123456"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用这个配置，只需要在Feign接口类<code>UserFeignClient</code>的<code>@FeignClient</code>注解中添加<code>configuration</code> 属性</p><pre><code>@FeignClient(name = &quot;microservice-provider-user&quot;,configuration=&quot;FooConfiguration.class&quot;)</code></pre><p>另外还需要把服务提供者加上Http Basic认证。<br>在服务提供都项目中添加security<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>在其配置文件中添加用户名与密码：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  basic:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure><h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>重新启动服务提供者与服务消费者<br>这里我们直接去访问服务提供者是需要进行认证的：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135930.png" alt="测试"><br>访问服务消费者，通过服务消费者去调用服务提供者，不会弹出认证窗口，因为服务消费者在Feign中已经配置了用户名与密码了。<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135950.png" alt="这里写图片描述"></p><h1 id="Feign服务间传送文件"><a href="#Feign服务间传送文件" class="headerlink" title="Feign服务间传送文件"></a>Feign服务间传送文件</h1><p>转 ：<a href="https://blog.csdn.net/qq_29534483/article/details/81330269" target="_blank" rel="noopener">Spring Cloud微服务【Finchley.RELEASE版本】(四)使用feign服务间传送文件</a></p><h1 id="Feign构造多参数请求"><a href="#Feign构造多参数请求" class="headerlink" title="Feign构造多参数请求"></a>Feign构造多参数请求</h1><h2 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h2><p>对于GET请求可以使用Map来构建。接口修改如下 :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-provider-user"</span>,configuration = FooConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">get</span><span class="params">(@RequestParam Map&lt;String,Object&gt; map)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>调用时构建一个Map传递到接口中</p><h2 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h2><p>post请求则简单得多，可以直接使用 <code>User</code> 实体类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-provider-user"</span>,configuration = FooConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">get</span><span class="params">(@RequestBody User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Feign </tag>
            
            <tag> 声明式REST API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ribbon实现负载均衡</title>
      <link href="/posts/d09d9c9a/"/>
      <url>/posts/d09d9c9a/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>为了实现微服务架构的高可用性，一般在生产环境中，各个微服务会部署多个实例。这里我们需要用到负载均衡，将服务消费者的请求分摊到多个服务提供者实例上。</p><a id="more"></a><h1 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h1><p>Ribbon 是Netflix发布的负载均衡器，它有助于控制HTTP和TCP客户端的行为。Ribbon配置好后，它可以根据如轮询，随机等负载均衡算法自动帮助服务消费去请求。在Spring Cloud中，Ribbon 与Eureka可以很好的配合 ，Ribbon向Eureka注册后可以自动从Eureka中获取服务提供者的地址列表，然后基于某种负载均衡算法去请求其中一个服务提供者实例。</p><h1 id="集成Ribbon"><a href="#集成Ribbon" class="headerlink" title="集成Ribbon"></a>集成Ribbon</h1><p>在Spring Cloud中使用Ribbon很简单，只需要做一点小修改。<br>将 <a href="https://blog.csdn.net/FTDD_HW/article/details/80874370" target="_blank" rel="noopener">微服务简单实例–电影购票</a> 中的服务消费者为基础进行修改。</p><p>##添加依赖<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>由于 Eureka已经包含了Ribbon 所以这里其实不需要添加上面这个依赖了。</p><h2 id="添加注解"><a href="#添加注解" class="headerlink" title="添加注解"></a>添加注解</h2><p>还需要为RestTemplate添加@LoadBalanced注解。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceConsumerMovieRibbonApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Bean</span> 是一个方法注解，作用是实例化一个Bean并使用该方法的名称命名。在本例中，添加<span class="doctag">@Bean</span>注解的restTemplate()方法，等价于RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@LoadBalanced</span> 可以为RestTemplate整合Ribbon 使其具备负载均衡的能力。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceConsumerMovieRibbonApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="修改Controller"><a href="#修改Controller" class="headerlink" title="修改Controller"></a>修改Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(UserController.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"http://microservice-provider-user/"</span> + id,User.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/log-user-instance"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logUserinstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServiceInstance serviceInstance = <span class="keyword">this</span>.loadBalancerClient.choose(<span class="string">"microservice-provider-user"</span>);</span><br><span class="line">        UserController.LOGGER.info(<span class="string">"&#123;&#125;:&#123;&#125;:&#123;&#125;"</span>,serviceInstance.getServiceId(),serviceInstance.getHost(),serviceInstance.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要把请求地址改成 <a href="http://microservice-provider-user/" target="_blank" rel="noopener">http://microservice-provider-user/</a> 。microservice-provider-user是用户微服务(服务提供者)的虚拟主机名。当Ribbon与Eureka配合使用时，会自动将虚拟主机名映射成微服务的网络地址。在新增的方法logUserinstance() 方法中使用LoadBalancerClient 的API更加直观的获取当前选择的用户微服务节点。<br><code>注意需要在服务提供者的配置文件中添加其虚拟主机名，并且命令不能使用 _ ：</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: microservice-provider-user</span><br></pre></td></tr></table></figure></p><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>我们启动前文中 <a href="https://blog.csdn.net/FTDD_HW/article/details/80922134" target="_blank" rel="noopener">微服务学习笔记 –使用Spring Cloud Eureka实现服务注册与发现</a> 的一个Eureka项目，启动多个服务提供者，因为是在本地做测试，需要把端口改成不一样的，避免端口占用。最后启动修改后的服务消费者。查看Eureka界面：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135708.png" alt="微信截图_20180806151100.png"><br>可以看到在Eureka上注册了三个服务提供者，分别使用了不同的端口号。另外还注册了集成Ribbon后的服务消费者。<br>访问localhost:8010/user/1 可以请求到数据<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135730.png" alt="微信截图_20180806155709.png"><br>多次请求后后台可以看到请求会随机分配给不同的服务提供者。<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135742.png" alt="微信截图_20180806155835.png"><br>可以通过访问 <a href="http://localhost:8010/log-user-instance" target="_blank" rel="noopener">http://localhost:8010/log-user-instance</a> 更加直观的查看负载均衡效果。<br>多次访问 <a href="http://localhost:8010/log-user-instance" target="_blank" rel="noopener">http://localhost:8010/log-user-instance</a> ，查看后台日志如下：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135756.png" alt="微信截图_20180806160158.png"></p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ribbon </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Centos 7离线安装Nginx 配置负载均衡集群</title>
      <link href="/posts/6a085911/"/>
      <url>/posts/6a085911/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><hr><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p> 项目中有三台应用服务器，系统为Centos 7 ，应用地址分别为:</p><a id="more"></a><ul><li>192.168.198.229:8080</li><li>192.168.198.230:8080</li><li>192.168.198.231:8080</li></ul><p>应用使用tomcat部署，目前没有域名，都是使用IP在局域网中单独访问。因为没有单独的服务器可以用来部署Nginx,所以Nginx部署在229服务器上。</p><!--more--><h3 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h3><p>在安装Nginx前，需要先安装好一些依赖包。<br><strong>gcc依赖包</strong></p><ul><li>gcc-4.8.5-16.el7.x86_64.rpm</li><li>glibc-devel-2.17-196.el7.x86_64.rpm</li><li>glibc-headers-2.17-196.el7.x86_64.rpm</li><li>kernel-headers-3.10.0-693.el7.x86_64.rpm</li></ul><p><strong>其它依赖包</strong></p><ul><li>pcre-devel-8.32-17.el7.x86_64.rpm</li><li>zlib-devel-1.2.7-17.el7.x86_64.rpm</li><li>openssl-fips-2.0.10.tar.gz</li></ul><p>因为无法使用yum，我下载好后通过ftp上传到服务器。依赖包下载传送门：<a href="https://centos.pkgs.org/" target="_blank" rel="noopener">https://centos.pkgs.org/</a><br>前四个为gcc安装包与相关依赖，最后一个openssl-fips如果使用rpm，还需要安装很多依赖包，因此使用压缩包安装更简单。<br><strong>gcc安装</strong><br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4no3ic8j30hh0aw0z0.jpg" alt="gcc安装"><br>gcc安装验证：<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nohch6j30hf06qt9d.jpg" alt="gcc验证"><br>​    </p><p><strong>其它依赖包安装</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@APP1 opt]# rpm -ivh pcre-devel-8.32-17.el7.x86_64.rpm </span><br><span class="line">警告：pcre-devel-8.32-17.el7.x86_64.rpm: 头V3 RSA/SHA256 Signature, 密钥 ID f4a80eb5: NOKEY</span><br><span class="line">准备中...                          ################################# [100%]</span><br><span class="line">正在升级/安装...</span><br><span class="line"></span><br><span class="line">[root@APP1 opt]# rpm -ivh zlib-devel-1.2.7-17.el7.x86_64.rpm </span><br><span class="line">警告：zlib-devel-1.2.7-17.el7.x86_64.rpm: 头V3 RSA/SHA256 Signature, 密钥 ID f4a80eb5: NOKEY</span><br><span class="line">准备中...                          ################################# [100%]</span><br><span class="line">正在升级/安装...</span><br><span class="line">   1:zlib-devel-1.2.7-17.el7          ################################# [100%]</span><br><span class="line">   </span><br><span class="line">[root@APP1 opt]# tar zxvf openssl-fips-2.0.10.tar.gz </span><br><span class="line">[root@APP1 opt]# cd openssl-fips-2.0.10/</span><br><span class="line">[root@APP1 openssl-fips-2.0.10]# ./config &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><h3 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h3><p>安装好上述依赖包后就可以安装Nginx了。安装如下：<br>使用tar将nginx-1.12.0.tar.gz 解压到 /usr/local/目录，编译安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@HMDMAPP1 opt]# tar -zxvf nginx-1.12.0.tar.gz -C /usr/local/</span><br><span class="line">[root@HMDMAPP1 opt]# cd /usr/local/nginx-1.12.0/</span><br><span class="line">[root@HMDMAPP1 nginx-1.12.0]# ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">[root@HMDMAPP1 nginx-1.12.0]# whereis nginx</span><br><span class="line">nginx: /usr/local/nginx</span><br></pre></td></tr></table></figure></p><h3 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h3><p>安装好后我们需要对Nginx进行配置。<br>配置文件路径为：/usr/local/nginx/sconf/nginx.conf<br>主要配置点：<br>1、<strong>upstream</strong><br>这里配置一组被代理的服务器地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream mysvr &#123;</span><br><span class="line">server 192.168.198.229:8080   weight=1 max_fails=3 fail_timeout=15;</span><br><span class="line">        server 192.168.198.230:8080   weight=1 max_fails=3 fail_timeout=15;</span><br><span class="line">        server 192.168.198.231:8080   weight=1 max_fails=3 fail_timeout=15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2、<strong>server</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80; #监听端口，与应用端口不同</span><br><span class="line">        server_name  192.168.198.229; #监听地址，一般是配置域名</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://mysvr; #请求转向upstream配置中mysvr定义的服务器列表</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>请求转向还有另外一种写法：<br>如果upstream 中的服务器列表地址前加了<code>http://</code> 则在server中的请求转向地址<code>mysvr</code>不需要加<code>http://</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">upstream mysvr&#123;</span><br><span class="line">server http://192.168.198.229:8080   weight=1 max_fails=3 fail_timeout=15;</span><br><span class="line">       ...</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">....</span><br><span class="line">location / &#123;</span><br><span class="line">            proxy_pass mysvr; #请求转向upstream配置中mysvr定义的服务器列表</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="启动Nginx"><a href="#启动Nginx" class="headerlink" title="启动Nginx"></a>启动Nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@HMDMAPP1 /]# cd /usr/local/nginx/sbin</span><br><span class="line">[root@HMDMAPP1 sbin]# ./nginx</span><br></pre></td></tr></table></figure><blockquote><p>Nginx常用命令<br> 查看进程: ps -aux |grep ‘nginx’<br> 重启nginx: ./nginx -s reopen<br> 停止nginx: ./nginx -s stop<br> 重新载入配置文件: ./nginx -s reload </p></blockquote><p>通过 192.168.198.229+应用地址 进行访问，我们可以在不同的服务器中的页面中添加标识来测试Nginx配置是否成功。下面访问test3.html页面不同刷新显示结果如下：<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4no9zl4j30en02lt8s.jpg" alt="这里写图片描述"><br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nod9avj30cy02mjrg.jpg" alt="这里写图片描述"><br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4no7o8zj30ee02n3yk.jpg" alt="这里写图片描述"><br>可以看到访问地址没有变化，但Nginx把请求分配到了不同的服务器上。</p><p>本文中使用到了依赖包与Nginx.conf完整配置文件下载：<a href="https://download.csdn.net/download/ftdd_hw/10578071" target="_blank" rel="noopener">https://download.csdn.net/download/ftdd_hw/10578071</a></p><p>推荐学习：<a href="https://blog.csdn.net/qq_29534483/article/details/81020755" target="_blank" rel="noopener">Nginx部署与配置</a></p>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx+tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下Oracle常用命令</title>
      <link href="/posts/5445b57/"/>
      <url>/posts/5445b57/</url>
      
        <content type="html"><![CDATA[<h3 id="Linux下安装Oracle-11g"><a href="#Linux下安装Oracle-11g" class="headerlink" title="Linux下安装Oracle 11g"></a>Linux下安装Oracle 11g</h3><p>传送门:<br><a href="http://www.oracle.com/ocom/groups/public/@otn/documents/webcontent/229016_zhs.htm" target="_blank" rel="noopener">http://www.oracle.com/ocom/groups/public/@otn/documents/webcontent/229016_zhs.htm</a></p><a id="more"></a><h3 id="登陆oracle"><a href="#登陆oracle" class="headerlink" title="登陆oracle"></a>登陆oracle</h3><pre><code>&gt;su - oracle&gt;sqlplus /nolog</code></pre><h3 id="管理员登陆"><a href="#管理员登陆" class="headerlink" title="管理员登陆"></a>管理员登陆</h3><pre><code>&gt;conn /as sysdba</code></pre><h3 id="用户登陆"><a href="#用户登陆" class="headerlink" title="用户登陆"></a>用户登陆</h3><pre><code>&gt;conn username/password</code></pre><h3 id="远程用户登陆"><a href="#远程用户登陆" class="headerlink" title="远程用户登陆"></a>远程用户登陆</h3><pre><code>&gt;conn username/password@ip:1521/ORCL</code></pre><h3 id="当前登陆用户"><a href="#当前登陆用户" class="headerlink" title="当前登陆用户"></a>当前登陆用户</h3><pre><code>&gt;show user;</code></pre><h3 id="执行SQL文件-适合大文件"><a href="#执行SQL文件-适合大文件" class="headerlink" title="执行SQL文件(适合大文件)"></a>执行SQL文件(适合大文件)</h3><pre><code>&gt;conn user/pwd&gt;@/路径/sql.sql;</code></pre><h3 id="存储查询结果"><a href="#存储查询结果" class="headerlink" title="存储查询结果"></a>存储查询结果</h3><pre><code>&gt;spool d:\1.txt&gt;select * from emp;&gt;spool off</code></pre>]]></content>
      
      
      <categories>
          
          <category> Oracle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Oracle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud Eureka实现服务注册与发现</title>
      <link href="/posts/7d66ca0d/"/>
      <url>/posts/7d66ca0d/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>服务发现组件是微服务架构中非常关键的一个组件。SpringCloud 提供的服务发现有多种，如Eureka，Consul和Zookeeper等。本篇介绍的是Eureka的使用。</p><a id="more"></a><h1 id="服务发现简介"><a href="#服务发现简介" class="headerlink" title="服务发现简介"></a>服务发现简介</h1><p>服务提供者，服务消费者，服务发现组件这三者之间的关系大致如下：</p><p><code>服务提供者与服务消费者都需要向服务发现组件进行注册，服务消费者从服务发现组件中获取服务提供者的信息(如名称、地址、端口等)。在服务发现组件注册的微服务需要通过心跳机制来保持连接状态并更新注册信息，当服务发现组件长时间无法与某个微服务实例进行通信时，会注销这个实例。这种机制使得即使服务提供者信息发生变化，服务消费者也无须修改配置文件。</code></p><p>由以上得知，服务发现组件应具备以下功能：</p><ul><li><p>服务注册表：用于记录各个微服务的注册信息，它还提供查询API与管理API。</p></li><li><p>服务注册与服务发现：服务注册是指微服务在启动是将自己的信息注册到服务发现组件的过程。服务发现是指查询可用的微服务列表及其网络地址的机制。</p></li><li><p>服务检查：服务发现组件应有一定的机制定时检测已注册的微服务，如长时间无法访问，就会从服务注册表中移除该实例。</p></li></ul><h1 id="Eureka原理"><a href="#Eureka原理" class="headerlink" title="Eureka原理"></a>Eureka原理</h1><p>以下是Eureka官方的架构图，比较详细的描述了Erueka集群的工作原理：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135017.png" alt="Eureka官方架构图"><br>我们可以把us-east-1c、us-east-1d与us-east-1e理解成独立的机房，而这整个图则是一个跨机房的Eureka集群。其中：</p><ul><li><p>Application Service 相当于前面说的服务提供者</p></li><li><p>Application Client 相当于前面的服务消费者</p></li><li><p>Make Remote Call 可以理解成调用RESTful API的行为</p></li></ul><p>由于图中所示，我们可以知道Eureka包含两个组件:Eureka Server 和 Eureka Client，它们的作用如下：</p><ul><li><p>Eureka Server提供服务发现的能力</p></li><li><p>Eureka Client 是一个java客户端，用于简化与Eureka Server的交互</p></li><li><p>微服务在启动后，会同期性（默认30s）地向Eureka Server 发送心跳来续约自己的“租期”</p></li><li><p>如果Eureka Server 在一定时间内（默认90s）没有接收到某个微服务的实例心跳，Eureka Server将会注销该实例</p></li><li><p>默认情况下，Eureka Server同时也是Eureka Client。多个Eureka Server 实例，互相之间通过复制的方式，来实现服务注册表中的数据同步</p></li><li><p>Eureka Client 会缓存服务注册表的信息，所以微服务无须每次请求都查询Eureka Server，从而降低了Eureka Server的压力。另外，即使Eureka Server 所以节点都挂了，服务消费者仍然可以使用缓存中的信息找到服务提供者并完成调用</p></li></ul><h1 id="Eureka-Server实现"><a href="#Eureka-Server实现" class="headerlink" title="Eureka Server实现"></a>Eureka Server实现</h1><p><strong>环境</strong></p><ul><li>Idea</li><li>Spring Boot ：1.5.9.RELEASE</li><li>Spring Cloud：Edgware.RELEASE</li><li>JDK ：1.8</li></ul><p><strong>引入依赖</strong><br>在Idea新建 一个Spring Boot项目，添加以下依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--引入Eureka依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入spring cloud的依赖 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>Edgware.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>编写启动类</strong><br>我们需要在启动类上加上 <code>@EnableEurekaServer</code> 注解，声明这是一个Eureka Server<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceDiscoveryEurekaApplication</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceDiscoveryEurekaApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>添加配置</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka/</span></span><br></pre></td></tr></table></figure></p><blockquote><p><code>eureka.client.register-with-eureka</code> 表示是否将自己注册到Eureka Server，默认为true,由于当前应用就是Eureka Server，所以设为false<br><code>eureka.client.fetch-registry</code> 表示是否从Eureka Server获取注册信息，默认为true,因为这是一个单点的Eureka Server，不需要同步其他的Eureka Server节点的数据，所以设定为false<br><code>eureka.client.serviceUrl.defaultZone</code> 设置与Eureka Server交互的地址，查询服务和注册服务都需要依赖这个地址，多个地址可以使用 <code>,</code> 分隔</p></blockquote><p>启动项目，访问<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> 即可看到Eureka Server的首页。可以看到界面展示了实例的状态，可用与不可用的Eureka节点，注册的服务实例列表，常用信息等，当然，目前还没有服务向这个Server注册过，下面记录实现服务注册。</p><h1 id="微服务注册"><a href="#微服务注册" class="headerlink" title="微服务注册"></a>微服务注册</h1><p>Eureka Server建好后，我们的微服务就可以向这个Eureka Server进行注册了。<br>我们把之前文章(<a href="https://blog.csdn.net/ftdd_hw/article/details/80874370" target="_blank" rel="noopener">微服务简单实例–电影购票</a>)中实现的服务提供者修改一下。<br><strong>添加依赖</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--注册Eureka Server--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>修改配置</strong><br>在之前项目配置的基础上添加以下配置<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-provider-user</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><blockquote><p><code>eureka.client.instance.prefer-ip-address</code>表示将自己的IP注册到Eureka Server<br><code>spring.application.name</code> 是指定一个应用名称<br><code>eureka.client.serviceUrl.defaultZone</code> 设置Eureka Server的地址，多个Eureka地址使用<code>,</code>分隔</p></blockquote><p><strong>修改启动类</strong><br>同样的，在微服务的启动类上加上一个注解 <code>@EnableDiscoveryClient</code> 表示这是一个Eureka Client。上面也说到Eureka 包含Server 与 Client两个组件，Client本身是一个JAVA客户端，把它集成到微服务中，简化了微服务与Eureka Server 的交互。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceSimpleProviderUserApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">SpringApplication.run(MicroserviceSimpleProviderUserApplication.class, args);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>完成以上修改后，启动服务提供者项目。刷新Eureka Server可以看到在 Instances currently registered with Eureka 栏目下出现了服务提供者的名称，地址，状态等信息。<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135439.png" alt="注册成功"><br>这样，一个微服务就注册到Eureka Server上了。另外如果是非JAVA服务注册到Eureka Server，可以使用Eureka的api进行注册。</p><h1 id="Erueka高可用部署"><a href="#Erueka高可用部署" class="headerlink" title="Erueka高可用部署"></a>Erueka高可用部署</h1><p>前面我们写了一个Eureka Server，并将一个微服务注册到了Eureka Server，在实际环境中，Eureka 需要是一个高可用的集群环境。这样Eureka Server 宕机时，其它的Eureka节点还是能够继续提供服务，虽然Eureka Client有缓存注册表信息，也可以提供服务查询，但缓存不及时更新也会影响之后的服务调用。<br>前面在编写Eureka  Server时配置了  <code>eureka.client.register-with-eureka=false</code> 和<code>eureka.client.fetch-registry=false</code>，现在在多节点的环境中，要实现Eureka实例之间相互注册彼此增量地同步信息，才能确保各节点数据一致，实现Eureka的高可用部署。所以下面的集群环境中，这两个配置应该为 <code>true</code> 或不配置默认为 <code>true</code> 。<br><strong>修改hosts</strong><br>因为是在本机实现多节点的Eureka Server集群，需要修改一下系统的hosts文件，添加以下配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1  peer1 peer2 peer3</span><br></pre></td></tr></table></figure><blockquote><p>如修改hosts无法保存，需要添加用户修改权限。<br>添加成功后可以ping peer1试试是否配置生效。</p></blockquote><p><strong>修改配置</strong><br>将上面编写的Eureka Server 项目的application.yml修改如下 :<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-discovery-eureka</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer1</span>                     <span class="comment"># 指定profile=peer1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer1</span>                   <span class="comment"># 指定当profile=peer1时，主机名是peer1</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer2:8762/eureka/,http://peer3:8763/eureka/</span>      <span class="comment"># 将自己注册到peer2和peer3这两个Eureka上面去</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer2</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer2</span></span><br><span class="line"><span class="attr">  prefer-ip-address:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer3:8763/eureka/</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer3</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8763</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer3</span></span><br><span class="line"><span class="attr">  prefer-ip-address:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer2:8762/eureka/</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><blockquote><p>YAML 文件可以由一或多个文档组成（即相对独立的组织结构组成），文档间使用<code>---</code>（三个横线）在每文档开始作为分隔符。同时，文档也可以使用<code>...</code>（三个点号）作为结束符（可选）。<br>所以这里的配置文件实际上是三个配置文件组成，<code>---</code>分隔符不可少，否则编译出错。也可以把这几段配置写在三个YAML文件中。</p></blockquote><p><strong>启动</strong><br>启动项目时通过给spring.profiles.active 传递不同的参数，以使用不同的配置。<br>在IDEA中我们可以在启动前配置参数：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135502.png" alt="这里写图片描述"><br>添加三个Spring Boot Application，并选择启动类，在Active Profiles中分别配置peer1,peer2,peer3参数后，分别启动。<br>在启动时，先启动成功的Eureka 可能会报以下错误：</p><p>​    2018-07-05 14:32:10.983 ERROR 13768 — [-target_peer2-8] c.n.e.cluster.ReplicationTaskProcessor   : Network level connection to peer peer2; retrying after delay<br>​    com.sun.jersey.api.client.ClientHandlerException: java.net.SocketTimeoutException: Read timed out</p><p>这是因为先启动成功的peer1根据配置会向peer2和peer3进行注册请求，而此时这两个应用可能还没启动好，所以出现上面的错误，三个应用启动成功后就正常了。<br>正常情况下如下图：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135520.png" alt="Eureka集群"><br>显示了注册到该Eureka的实例信息，Eureka各节点地址。<br>在下面可以看到显示了两个注册的节点，同时这两个节点是可用的。<br>我之前测试时出现不可用(<strong>unavailable-replicas</strong>)的节点，如下：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135537.png" alt="不可用Eureka"><br><strong>解决情况是将 <code>eureka.instance.prefer-ip-address</code> 设置为 <code>false</code> ，因为是在本地配置集群环境，IP是相同的，因此使用IP注册可能会导致节点不可识别，另外，三个应用的<code>spring.application.name</code>不一致也会出现 <em>unavailable-replicas</em> 的情况</strong></p><p><strong>服务注册到Erueka 集群</strong><br>前面我们将服务提供者注册到了一个单节点的Eureka Server ，在Eureka的集群环境中，只需要稍加修改即可。把服务提供者的 <code>eureka.client.serviceUrl.defaultZone</code>配置修改如下:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer2:8762/eureka/,http://peer3:8763/eureka/</span></span><br></pre></td></tr></table></figure><blockquote><p>其实可以继续使用localhost，因为是在本地测试。<br>另外，我们可以只写一个Eureka Server的地址，因为各Eureka Server节点之间会自动同步注册的实例信息，正常情况下这两种方式是一样。建议全部写上。</p></blockquote><p>启动服务提供者，刷新三个Eureka Server可以看到服务已经注册了:<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135606.png" alt="集群注册"></p><h1 id="Eureka用户认证"><a href="#Eureka用户认证" class="headerlink" title="Eureka用户认证"></a>Eureka用户认证</h1><p>在生产环境中Eureka Server需要登录才能访问，Eureka的用户认证可以使用Security实现。下面稍微修改一下Eureka Server<br><strong>添加依赖</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>添加配置</strong><br>添加以下配置在第一段中，作为三个Eureka Server的公共配置。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  basic:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span>                     <span class="comment">#开启HTTP basic的认证</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">user</span>                        <span class="comment">#配置登录账号证</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">admin</span>                   <span class="comment">#配置登录密码</span></span><br></pre></td></tr></table></figure></p><p><code>最后把Eureka以及服务提供者的配置文件中的 defaultZone 地址修改成如下格式：</code></p><pre><code>http://user:admin@peer1:8761/eureka/</code></pre><p>这样才能注册到需要认证的Eureka Server。</p><p>重新启动Eureka Server和服务提供者后，再次访问三个Eureka可以看到弹出了登录框，输入上面的账号与密码后登录后即可进行Eureka Server首页，服务已正常注册成功。</p><h1 id="Eureka自我保护模式"><a href="#Eureka自我保护模式" class="headerlink" title="Eureka自我保护模式"></a>Eureka自我保护模式</h1><p>在实现上面的练习过程中，打开Eureka可能会遇到如下情况：<br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135622.png" alt="Eureka自我保护模式"><br>这是Eureka开启自我保护模式时的警告。<br>前面说过Eureka Server在一定时间内没有接收到某个微服务实例心跳，Eureka Server将会注销该实例。但如果出现网络分区故障，微服务与Eureka Server之间无法正常通信，微服务其实是正常的，但由于无法接收到该微服务的通信，Eureka Server则会注销该服务。<br>为了避免这种情况的发生，Eureka Server 通过 自我保护模式 来解决这个问题。当Eureka Server在短时间内丢失过多客户端时，那么这个Eureka节点会进行自我保护模式。Eureka 会保护服务注册表中的信息，不再删除服务注册表中的数据，当网络故障恢复后，该Eureka节点会自动退出自我保护模式。<br>这种模式使得Eureka 集群更加健壮，稳定。<br>另外也可以选择禁用该模式，配置如下：</p><p>​    eureka.server.enable-self-preservation = false</p><h1 id="Eureka健康检查"><a href="#Eureka健康检查" class="headerlink" title="Eureka健康检查"></a>Eureka健康检查</h1><p>登录Eureka首页可以看到注册的微服务状态是 <code>UP</code><br><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/20190507135632.png" alt="微服务状态"><br>表示应用程序状态正常，应用的状态还有其它取值，如DOWN,OUT_OF_SERVICE,UNKNOWN等。只有标记为 <code>UP</code> 的微服务会被请求。<br>默认情况下，服务器端与客户端的心跳保持正常，应用程序状态就会显示<code>UP</code> 状态。但这个机制并不能完全反应微服务的状态，举个栗子，微服务与Eureka Server心跳正常，但微服务的数据源出现了问题（如数据库被关闭）。这个微服务其实无法正常工作，但Eureka Server认为该微服务为<code>UP</code>状态。<br>为了解决这个问题，我们可以把微服务的健康状态传播到Eureka Server，只需要在微服务中作如下配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    healthcheck:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>这样，当微服务健康状态出问题时，Eureka Server能够实时反应其它真实状态。</p><p>参考：<a href="http://cloud.spring.io/spring-cloud-netflix/single/spring-cloud-netflix.html" target="_blank" rel="noopener">官方API文档</a></p><p>以上，为《Spring Cloud与Docker微服务架构实战》第4章学习笔记。    </p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Eureka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot Actuator监控端点</title>
      <link href="/posts/297fa226/"/>
      <url>/posts/297fa226/</url>
      
        <content type="html"><![CDATA[<p>目录</p><p>[TOC]</p><p>微服务的这种架构虽然解决了单体应用的一些劣势，但它也面临一些挑战，比如对运维的要求更高了。一个微服务架构中可能有几十个上百个应用构成，要保证这些应用都正常运行，相互协调是比较麻烦的事情，因此我们需要一个组件来对这些应用进行监控和管理。<br><code>spring-boot-starter-actuator</code> 就是Spring Boot提供这个功能的模块。</p><a id="more"></a><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>运行环境：</p><blockquote><p>Spring Boot 2.0.3.RELEASE</p></blockquote><p><strong>1、引入依赖</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>2、启动应用</strong><br>重新启动应用访问 <code>http://localhost:8000/actuator/health</code> 会显示如下信息：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">status: "UP"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Actuator监控管理默认的访问路径是在 <code>/actuator</code> 下。在测试Spring  Boot 1.5.9版本时是直接访问端点路径，不需要加 <code>/actuator</code> </p><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>除了health端点外，Actuator还为我们提供了很多端点，有些可以直接访问，有些需要授权或通过配置才能访问。</p><h2 id="端点列表"><a href="#端点列表" class="headerlink" title="端点列表"></a>端点列表</h2><table><thead><tr><th style="text-align:right">端点</th><th style="text-align:right">描述</th></tr></thead><tbody><tr><td style="text-align:right"><code>actuator</code></td><td style="text-align:right">为其他端点提供基于超媒体的“发现页面”。要求Spring HATEOAS在类路径上</td></tr><tr><td style="text-align:right"><code>auditevents</code></td><td style="text-align:right">公开当前应用程序的审核事件信息</td></tr><tr><td style="text-align:right"><code>autoconfig</code></td><td style="text-align:right">显示自动配置报告，显示所有自动配置候选项以及它们“未被”应用的原因</td></tr><tr><td style="text-align:right"><code>beans</code></td><td style="text-align:right">显示应用程序中所有Spring bean的完整列表</td></tr><tr><td style="text-align:right"><code>configprops</code></td><td style="text-align:right">显示所有配置信息。</td></tr><tr><td style="text-align:right"><code>dump</code></td><td style="text-align:right">打印线程栈</td></tr><tr><td style="text-align:right"><code>env</code></td><td style="text-align:right">查看所以环境变量</td></tr><tr><td style="text-align:right"><code>health</code></td><td style="text-align:right">显示应用程序运行状况信息</td></tr><tr><td style="text-align:right"><code>info</code></td><td style="text-align:right">显示应用信息</td></tr><tr><td style="text-align:right"><code>loggers</code></td><td style="text-align:right">显示和修改应用程序中记录器的配置</td></tr><tr><td style="text-align:right"><code>liquibase</code></td><td style="text-align:right">显示已应用的任何Liquibase数据库迁移</td></tr><tr><td style="text-align:right"><code>metrics</code></td><td style="text-align:right">显示当前应用程序的“指标”信息</td></tr><tr><td style="text-align:right"><code>mappings</code></td><td style="text-align:right">显示所有@RequestMapping路径的整理列表</td></tr><tr><td style="text-align:right"><code>shutdown</code></td><td style="text-align:right">允许应用程序正常关闭（默认情况下不启用）</td></tr><tr><td style="text-align:right"><code>trace</code></td><td style="text-align:right">显示跟踪信息（默认情况下是最近的100个HTTP请求</td></tr></tbody></table><h2 id="Actuator配置"><a href="#Actuator配置" class="headerlink" title="Actuator配置"></a>Actuator配置</h2><p><strong>自定义默认路径</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">management.endpoints.web.base-path</span> <span class="string">=</span> <span class="string">/application</span></span><br></pre></td></tr></table></figure></p><blockquote><p>修改后访问端点的默认路径不再是 <code>/actuator</code> 而是 <code>/application</code></p></blockquote><p><strong>自定义访问端口号</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">management.server.port=</span> <span class="number">8012</span></span><br></pre></td></tr></table></figure></p><blockquote><p>修改后我们查看Actuator需要修改成8012端口进行访问，如<code>http://localhost:8012/actuator/health</code></p></blockquote><p><strong>关闭验证</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">management.security.enabled=</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><blockquote><p>默认情况下只开放了<code>health</code> 与 <code>info</code> 端口，关闭验证后，其它的也可以访问了，但不安全，最好添加 <code>security</code> 验证</p></blockquote><p><strong>控制端点是否开放</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">management.endpoints.web.exposure.include=</span> <span class="string">'info'</span></span><br></pre></td></tr></table></figure></p><blockquote><p>表示只暴露<code>info</code>端口，如添加其它端口使用 <code>,</code> 分隔，暴露所有端口使用 <code>*</code></p></blockquote><p><strong>端口属性配置</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">management.endpoint.端口名.属性=值</span></span><br></pre></td></tr></table></figure></p><blockquote><p>如 <code>management.endpoint.health.show-details= always</code> 表示显示 <code>health</code>端口的详细信息，大多数端口可以这样配置。</p></blockquote><h2 id="整合Spring-Security"><a href="#整合Spring-Security" class="headerlink" title="整合Spring Security"></a>整合Spring Security</h2><p>监控端点的很多信息住信比较隐私，不能让没有权限的人随意查看，因此可以添加Srping Security进行控制。<br><strong>添加依赖</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>配置Security</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    user:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure></p><blockquote><p>配置security后，访问端口需要进行登陆验证。</p></blockquote><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>另外还有其它的端口配置，还可以自定义端口等，这里不一一总结，以后需要时查查资料。贴上一个学习链接： <a href="http://blog.didispace.com/spring-boot-actuator-1/" target="_blank" rel="noopener">http://blog.didispace.com/spring-boot-actuator-1/</a></p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Actuator </tag>
            
            <tag> 微服务监控端口 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微服务简单实例--电影购票</title>
      <link href="/posts/5a5916f3/"/>
      <url>/posts/5a5916f3/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p>通过上一篇文章理解了微服务后我们通过一个简单的电影购票场景来实现微服务。</p><a id="more"></a><p>如图：<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4n62ckwj30g502qjre.jpg" alt="电影购票系统"><br>这个场景当中，用户微服务是一个服务提供者，电影微服务是一个服务消费者，之前我们也说到，每个微服务从开发，测试，构建，部署，都应当独立运行，即每个微服务是单独的子项目。下面来实现这个场景。</p><h1 id="一、编写服务提供者"><a href="#一、编写服务提供者" class="headerlink" title="一、编写服务提供者"></a>一、编写服务提供者</h1><p>新建一个Spring Boot （版本1.5.9.RELEASE) 项目，不知道如何在IDEA中新建的可以看这篇&gt;&gt;传送门：：<a href="https://blog.csdn.net/ftdd_hw/article/details/76889440" target="_blank" rel="noopener">Spring Boot 入门知识</a></p><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>项目使用H2作为数据库，使用jpa作为持久层框架。Spring Boot环境中H2数据库的基本配置可参考这篇&gt;&gt;传送门：<a href="https://blog.csdn.net/FTDD_HW/article/details/80696381" target="_blank" rel="noopener">Spring Boot环境下的 H2数据库基本配置</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入SpringCloud 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>Edgware.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>application.yml 文件配置如下 ：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line"><span class="attr">    generate-ddl:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    show-sql:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    hibernate:</span></span><br><span class="line"><span class="attr">      ddl_auto:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">  h2:</span></span><br><span class="line"><span class="attr">    console:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/h2-console</span>               <span class="comment">#h2 web控制台路径</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span>                   <span class="comment">#开启 Web Console</span></span><br><span class="line"><span class="attr">      settings:</span></span><br><span class="line"><span class="attr">        web-allow-others:</span> <span class="literal">true</span>        <span class="comment">#允许远程访问 Web Console</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    platform:</span> <span class="string">h2</span>                      <span class="comment">#指定数据源类型</span></span><br><span class="line"><span class="attr">    schema:</span> <span class="attr">classpath:schema.sql</span>      <span class="comment">#指定数据库的数据脚本</span></span><br><span class="line"><span class="attr">    data:</span> <span class="attr">classpath:data.sql</span>          <span class="comment">#指定数据库的数据脚本</span></span><br></pre></td></tr></table></figure><blockquote><p>spring.h2.console.path 指定了h2控制台的路径，可以通过localhost:8000/h2-console 去访问H2的控制台。<br>spring.datasource.schema 与 datasource.data 会在每次启动项目时都会被执行</p></blockquote><p><strong>schema.sql</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">user</span> <span class="keyword">if</span> <span class="keyword">exists</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span> (<span class="keyword">id</span> <span class="built_in">bigint</span> <span class="keyword">generated</span> <span class="keyword">by</span> <span class="keyword">default</span> <span class="keyword">as</span> <span class="keyword">identity</span>, username <span class="built_in">varchar</span>(<span class="number">40</span>), <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>), age <span class="built_in">int</span>(<span class="number">3</span>), balance <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>), primary <span class="keyword">key</span> (<span class="keyword">id</span>));</span><br></pre></td></tr></table></figure></p><p><strong>data.sql</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (<span class="keyword">id</span>, username, <span class="keyword">name</span>, age, balance) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">'account1'</span>, <span class="string">'张三'</span>, <span class="number">20</span>, <span class="number">100.00</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (<span class="keyword">id</span>, username, <span class="keyword">name</span>, age, balance) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">'account2'</span>, <span class="string">'李四'</span>, <span class="number">28</span>, <span class="number">180.00</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (<span class="keyword">id</span>, username, <span class="keyword">name</span>, age, balance) <span class="keyword">values</span> (<span class="number">3</span>, <span class="string">'account3'</span>, <span class="string">'王一'</span>, <span class="number">32</span>, <span class="number">280.00</span>);</span><br></pre></td></tr></table></figure></p><h2 id="pojo"><a href="#pojo" class="headerlink" title="pojo"></a>pojo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@JsonIgnoreProperties</span>(value=&#123;<span class="string">"hibernateLazyInitializer"</span>,<span class="string">"handler"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="keyword">private</span> Integer age;</span><br><span class="line">  <span class="meta">@Column</span></span><br><span class="line">  <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...get</span></span><br><span class="line"><span class="comment">//...set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>报错</strong><br>​<br>    com.fasterxml.jackson.databind.exc.InvalidDefinitionException: No serializer found for class org.hibernate.proxy.pojo.javassist.JavassistLazyInitializer and no properties discovered to create BeanSerializer<br>如果在运行时报以上错误，则需要添加注释：<br><strong>@JsonIgnoreProperties(value={“hibernateLazyInitializer”,”handler”})</strong></p><blockquote><p>这是因为 hibernate会给每个被管理的对象加上hibernateLazyInitializer属性，jsonplugin通过java的反射机制将pojo转换成json，会把hibernateLazyInitializer也拿出来操作,但是hibernateLazyInitializer无法由反射得到，就会抛异常了。</p></blockquote><h2 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        User findOne = <span class="keyword">this</span>.userRepository.getOne(id);</span><br><span class="line">        <span class="keyword">return</span> findOne;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>@GetMapping() 等同于 @RequestMapping(method = {RequestMethod.GET})</p></blockquote><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>运行项目，访问测试<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4n6a4wej30cm06rwen.jpg" alt="测试"></p><h1 id="二、编写服务消费者"><a href="#二、编写服务消费者" class="headerlink" title="二、编写服务消费者"></a>二、编写服务消费者</h1><p>消费者作为服务调用方，这里只使用最简单的方式来实现。</p><h2 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入SpringCloud 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>Edgware.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h2><p><strong>application.yml</strong><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8011</span></span><br><span class="line"><span class="attr">user:</span></span><br><span class="line"><span class="attr">    userServiceUrl:</span> <span class="attr">http://localhost:8000/</span></span><br></pre></td></tr></table></figure></p><blockquote><p>user.userServiceUrl ：把调用地址写入配置文件</p></blockquote><h2 id="pojo-1"><a href="#pojo-1" class="headerlink" title="pojo"></a>pojo</h2><p>这里与上面的服务提供者相同</p><h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><p>实例化RestTemplate<br>在启动类中添加以下方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;user.userServiceUrl&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userServiceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="keyword">this</span>.userServiceUrl + id,User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里使用 restTemplate 来调用服务<br>@Value(“${user.userServiceUrl}”) 从配置文件中取user.userServiceUrl值</p></blockquote><h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>启动项目进行测试<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4n66hlaj30dl06ndg2.jpg" alt="消费者测试"></p><h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>至此，一个简单的微服务完成！是不是觉得与我们平时写接口是差不多的，平时我们是在整个系统内部，各个功能模块之间进行接口调用，微服务则是把这些模块单独出来成为一个子系统，每个子系统提供接口给其它系统调用。<br><strong>在整个电影购票系统中</strong><br>使用单一职责原则：两个微服务只关注整个系统中单独，有界限的一部分。<br>满足服务自治原则：每个微服务具备独立的业务能力，依赖与运行环境。<br>使用了轻量级通信机制：消费者中使用了Rest 进行服务调用<br>微服务粒度：两个微服务都有明确的功能划分。</p><p>当然微服务不只是这么简单，还应该包括安全性，高可用性等，还需要集成其它的组件，后面会边学习边作记录。</p>]]></content>
      
      
      <categories>
          
          <category> 微服务 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微服务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot环境下的 H2数据库基本配置</title>
      <link href="/posts/41733482/"/>
      <url>/posts/41733482/</url>
      
        <content type="html"><![CDATA[<p><strong>目录</strong></p><p>[TOC]</p><p>#<br>H2是一个开源的、纯Java实现的关系数据库。</p><a id="more"></a><h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>1、它可以与应用程序打包一起发布，这样可以很方便存储少量的结构化数据。<br>2、还可以用于单元测试，启动速度快，而且可以关闭持久化功能，每一个用例执行完随即还原到初始状态<br>3、可以作为缓存，作为NoSQL的一个补充。</p><h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>1、纯Java编写，不受平台限制<br>2、只有一个Jar文件，适合作为嵌入式数据库使用<br>3、提供了一个完善的基于浏览器的Console应用<br>4、支持标准的sql和jdbc<br>5、支持内嵌模式，服务器模式和集群</p><h1 id="二、下载安装"><a href="#二、下载安装" class="headerlink" title="二、下载安装"></a>二、下载安装</h1><h2 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h2><pre><code>http://www.h2database.com/html/main.html</code></pre><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0mxjoj30n00cbdh1.jpg" alt="H2下载"><br>我们可以下载win安装包，也可以直接下载zip，解压即用。我使用的是ZIP的压缩包。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>前面我们说过H2是纯Java编写的，所以在安装H2之前需要配置Java环境，具体Java环境配置这里就不写了。<br>H2的ZIP安装方式很简单，直接把下载下来的ZIP解压到安装目录下就可以了。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nzyys7j30gu05qwet.jpg" alt="这里写图片描述"><br>启动H2 bin/h2.bat</p><h1 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h1><p>在Spring Boot环境中配置H2</p><h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><pre><code>&lt;dependency&gt;    &lt;groupId&gt;com.h2database&lt;/groupId&gt;    &lt;artifactId&gt;h2&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre><p>这里还引入了jpa 用来对H2进行操作</p><h2 id="服务器模式"><a href="#服务器模式" class="headerlink" title="服务器模式"></a>服务器模式</h2><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0a4uij30ej0a6t9b.jpg" alt="配置H2"><br>其中URL使用的形式表示这里使用的是H2的服务器模式。连接的是我们上面安装的本地的H2数据库，因此我们在启动程序前必须把本地的H2数据库先启动。<br>URL中指定了数据存放位置，如果数据库test不存在会自动创建。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o07b6wj30h706baah.jpg" alt="创建数据库"></p><blockquote><p>配置中指定两个SQL脚本，每次启动程序都会重新执行脚本对数据进行初始化，当然我们可以不指定。<br>schema.sql 创建了一个user表结构<br>data.sql 向user表插入了三条数据</p></blockquote><p><strong>查看Console</strong><br>在前面启动H2数据库的时候会自动弹出consol管理页，按程序中指定的URL进行连接即可查看到我们创建的数据<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0dnwgj30l40c8wf5.jpg" alt="这里写图片描述"><br>用户名 sa 是默认的用户，密码默认为空。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0364fj30nc0cpwfm.jpg" alt="这里写图片描述"><br>登入进Console后我们可以查看user表</p><p>在配置文件中配置了Web Console的路径，同样我们可以使用这个路径进行登入。</p><h2 id="内嵌模式"><a href="#内嵌模式" class="headerlink" title="内嵌模式"></a>内嵌模式</h2><p>H2最方便的是只需要一个jar包就可以使用了。前面我们引入H2依赖后其它就可以使用H2了，不需要连接我们本地安装的H2。<br>可以直接不指定URL<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0psowj30f008pgm3.jpg" alt="这里写图片描述"><br>或者修改一URL为：<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4o0h0m4j30d203wmxb.jpg" alt="这里写图片描述"><br>我们可以使用Web Console连接,连接的url为 </p><pre><code>jdbc:h2:mem:testdb</code></pre><blockquote><p>当我们没有指定URL的时候，默认的连接的数据库也是testdb 之前看教程说在把日志改成DEBUG可以看到连接的URL，但我试了还是没有找到，只只根据教程上的URL也连接，确定连接上了对应的数据库</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> H2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> H2 </tag>
            
            <tag> Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis 常用命令记录</title>
      <link href="/posts/4e556baf/"/>
      <url>/posts/4e556baf/</url>
      
        <content type="html"><![CDATA[<p>redis 常用命令记录</p><a id="more"></a><h3 id="打开redis命令窗口"><a href="#打开redis命令窗口" class="headerlink" title="打开redis命令窗口"></a>打开redis命令窗口</h3><pre><code>./redis-cli</code></pre><h3 id="清空当前redis数据库缓存FLUSHDB"><a href="#清空当前redis数据库缓存FLUSHDB" class="headerlink" title="清空当前redis数据库缓存FLUSHDB"></a>清空当前redis数据库缓存FLUSHDB</h3><pre><code>flushdb</code></pre><h3 id="清空整个redis缓存FLUSHALL"><a href="#清空整个redis缓存FLUSHALL" class="headerlink" title="清空整个redis缓存FLUSHALL"></a>清空整个redis缓存FLUSHALL</h3><pre><code>flushall</code></pre><h3 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h3><pre><code>vim  /etc/redis.conf#requirepass foobared去掉注释，foobared改为自己的密码，我在这里改为requirepass 123456然后保存，重启服务</code></pre><h3 id="登陆redis"><a href="#登陆redis" class="headerlink" title="登陆redis"></a>登陆redis</h3><pre><code>auth password</code></pre><h3 id="Jedis连接redis"><a href="#Jedis连接redis" class="headerlink" title="Jedis连接redis"></a>Jedis连接redis</h3><p><strong>java 代码方式</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接redis服务器，192.168.0.100:6379</span></span><br><span class="line"> jedis = <span class="keyword">new</span> Jedis(<span class="string">"ip"</span>, <span class="number">6379</span>);</span><br><span class="line"> <span class="comment">//权限认证</span></span><br><span class="line">jedis.auth(<span class="string">"password"</span>);</span><br></pre></td></tr></table></figure></p><p> <strong>配置文件方式</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">”jedisConnectionFactory”</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">”org.springframework.data.redis.connection.jedis.JedisConnectionFactory”</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">”hostName”</span> <span class="attr">value</span>=<span class="string">”$&#123;redis.host&#125;”</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">”port”</span> <span class="attr">value</span>=<span class="string">”$&#123;redis.port&#125;”</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">”password”</span> <span class="attr">value</span>=<span class="string">”$&#123;redis.pass&#125;”</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="关闭redis"><a href="#关闭redis" class="headerlink" title="关闭redis"></a>关闭redis</h3><pre><code>[root@iZ94jzcra1hZ bin]# pkill redis</code></pre><h3 id="后台开启redis："><a href="#后台开启redis：" class="headerlink" title="后台开启redis："></a>后台开启redis：</h3><pre><code>[root@iZ94jzcra1hZ bin]# redis-server &amp;加&amp;符号的作用是为了让此进程转换为后台进程，不占用shell的服务。</code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ学习系列 五 RabbitMQ整合Spring</title>
      <link href="/posts/d72bda77/"/>
      <url>/posts/d72bda77/</url>
      
        <content type="html"><![CDATA[<p>最后学习一下RabbitMQ如何整合Spring，毕竟现在大多是使用框架来做项目。这篇主要使用的方式是XML配置。</p><a id="more"></a><p>[TOC]</p><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>RabbitMQ整合Spring的学习中，搭了两个web项目，一个作为客户端，一个作为服务端，放在一个项目中也可以实现效果，但毕竟RabbitMQ也是在这种类似的环境中使用的。客户端会把info类型和error类型的日志发送给RabbitMQ，RabbitMQ根据所定义的路由与绑定的key分别把日志消息传递给不同的队列。<br>客户端项目结构:<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nmj04gj308x09cdg0.jpg" alt="rabbitmq整合Spring项目结构"></p><h1 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h1><h2 id="RabbitMQ配置文件"><a href="#RabbitMQ配置文件" class="headerlink" title="RabbitMQ配置文件"></a>RabbitMQ配置文件</h2><p><strong>config.properties</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># RabbitMQ config</span><br><span class="line">rabbitmq.host=localhost</span><br><span class="line">rabbitmq.username=guest</span><br><span class="line">rabbitmq.password=guest</span><br><span class="line">rabbitmq.port=5672</span><br></pre></td></tr></table></figure></p><blockquote><p>这里在我本机的RabbitMQ，如果是在远程主机上则要做相应修改。需要注意的是，我们访问RabbitMQ管理界面是使用的<strong>15672</strong>端口，但通过连接访问RabbitMQ是使用<strong>5672</strong>端口</p></blockquote><h2 id="XML配置"><a href="#XML配置" class="headerlink" title="XML配置"></a>XML配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">"http://www.springframework.org/schema/rabbit"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit-1.7.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd"</span>&gt;</span></span><br><span class="line">                           </span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.rabbitmq.spring"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath*:config.properties"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--连接工厂--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span> <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span> <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span> <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:connection-factory</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--RabbitAdmin主要用于创建队列和交换器以及绑定关系等。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"rabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--声明队列--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"rabbitmq_log_info"</span> <span class="attr">durable</span>=<span class="string">"true"</span> <span class="attr">auto-delete</span>=<span class="string">"false"</span>  /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"rabbitmq_log_error"</span> <span class="attr">durable</span>=<span class="string">"true"</span> <span class="attr">auto-delete</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--声明路由并绑定队列，指定routingKey--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:direct-exchange</span> <span class="attr">name</span>=<span class="string">"hap.log.exchange"</span>  <span class="attr">auto-delete</span>=<span class="string">"false"</span> <span class="attr">durable</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">"rabbitmq_log_info"</span> <span class="attr">key</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">"rabbitmq_log_error"</span> <span class="attr">key</span>=<span class="string">"error"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:binding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:direct-exchange</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--定义RabbitTemplate，用于发送与接收消息--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"rabbitTemplateLogInfo"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">routing-key</span>=<span class="string">"info"</span> <span class="attr">exchange</span>=<span class="string">"hap.log.exchange"</span> <span class="attr">message-converter</span>=<span class="string">"jsonMessageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"rabbitTemplateLogError"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">routing-key</span>=<span class="string">"error"</span> <span class="attr">exchange</span>=<span class="string">"hap.log.exchange"</span> <span class="attr">message-converter</span>=<span class="string">"jsonMessageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消息对象json转换类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jsonMessageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.amqp.support.converter.Jackson2JsonMessageConverter"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p> <strong>rabbit-admin</strong>  标签如不声明,则 rabbit:queue 与 rabbit:direct-exchange 标签中必须添加 auto-declare 属性为true ,表示如果队列或路由不存在则自动声明，如不声明rabbit-admin，也不添加auto-declare属性则启动时会报声明队列错误，或队列不存在。<br> <strong>rabbit:template</strong> 标签中的routing-key、exchange也可以不在XML中配置，在类中发送消息时可以作为参数代入。则XML中只需要配置一个rabbit:template标签即可</p></blockquote><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p><strong>Service接口</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISendMessageService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendInfoMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendErrorMessage</span><span class="params">(String message)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>Service实现类</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageService</span> <span class="keyword">implements</span> <span class="title">ISendMessageService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"rabbitTemplateLogInfo"</span>)</span><br><span class="line">    <span class="keyword">public</span> RabbitTemplate rabbitTemplateLogInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"rabbitTemplateLogError"</span>)</span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplateLogError;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendInfoMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Info发送消息中&gt;&gt;&gt;"</span> + message);</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplateLogInfo.convertAndSend(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendErrorMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Error发送消息中&gt;&gt;&gt;"</span> + message);</span><br><span class="line">        <span class="keyword">this</span>.rabbitTemplateLogError.convertAndSend(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>RabbitTemplate的convertAndSend方法中，如果XML中已经配置好了对应的exchange与routingKey则可以直接传入一个消息进行发送即可。如果没有可以在参数中加入Exchange 与 routingkey</p></blockquote><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/rabbitmqLog"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitmqController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"sendMessageService"</span>)</span><br><span class="line">    ISendMessageService service = <span class="keyword">new</span> SendMessageService();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/sendInfoLog"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendInfoMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        service.sendInfoMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/sendErrorLog"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendErrorMessage</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        service.sendErrorMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h1><p>因为这里只是做一个简单的示例，所以服务端只做了监听，没有做什么业务逻辑。</p><h2 id="RabbitMQ配置文件-1"><a href="#RabbitMQ配置文件-1" class="headerlink" title="RabbitMQ配置文件"></a>RabbitMQ配置文件</h2><p>这里与客户端是一样的</p><h2 id="XML配置-1"><a href="#XML配置-1" class="headerlink" title="XML配置"></a>XML配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:rabbit</span>=<span class="string">"http://www.springframework.org/schema/rabbit"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit-1.7.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.rabbitmq.spring"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath*:config.properties"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">host</span>=<span class="string">"$&#123;rabbitmq.host&#125;"</span> <span class="attr">username</span>=<span class="string">"$&#123;rabbitmq.username&#125;"</span> <span class="attr">password</span>=<span class="string">"$&#123;rabbitmq.password&#125;"</span> <span class="attr">port</span>=<span class="string">"$&#123;rabbitmq.port&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">rabbit:connection-factory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">id</span>=<span class="string">"rabbitAdmin"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"rabbitmq_log_info"</span> <span class="attr">durable</span>=<span class="string">"true"</span> <span class="attr">auto-delete</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"rabbitmq_log_error"</span> <span class="attr">durable</span>=<span class="string">"true"</span> <span class="attr">auto-delete</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">acknowledge</span>=<span class="string">"auto"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"messageRecevicer"</span> <span class="attr">queues</span>=<span class="string">"rabbitmq_log_info"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"messageRecevicer"</span> <span class="attr">queues</span>=<span class="string">"rabbitmq_log_error"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageRecevicer"</span> <span class="attr">class</span>=<span class="string">"com.rabbitmq.spring.listener.QueueListener"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消息对象json转换类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jsonMessageConverter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.amqp.support.converter.Jackson2JsonMessageConverter"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>服务端的XML与客户端不同的是多了监听配置与监听类的Bean，少了路由声明与队列绑定的配置。</p></blockquote><h2 id="监听类"><a href="#监听类" class="headerlink" title="监听类"></a>监听类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg = <span class="keyword">new</span> String(message.getBody(),<span class="string">"UTF-8"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"监听到 "</span>+ message.getMessageProperties().getConsumerQueue()+<span class="string">" 队列消息:"</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>最后我们分别启动客户端与服务端。客户端调用Controller向服务端发送消息 。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nmmad8j3116095my4.jpg" alt="测试"></p>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ学习系列 三 发布 订阅</title>
      <link href="/posts/5dabf99c/"/>
      <url>/posts/5dabf99c/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p>上一篇记录了一个简单的rabbitmq 发布接收队列消息，但没有使用路由。本篇写一写rabbitmq的路由的使用。</p><a id="more"></a><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>有几个概念介绍一下<br>1、生产者<br>​<br>​    生产者是发送消息的用户的应用程序</p><p>2、路由<br>​<br>​    处理生产者消息发到哪个队列</p><p>3、队列</p><pre><code>队列是存储消息的缓冲器</code></pre><p>4、消费者</p><pre><code>消费者是接收消息的用户的应用程序</code></pre><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nqtijnj30bq0483yk.jpg" alt="消息模型"></p><p>RabbitMQ中的消息传递模型的核心思想是生产者永远不会将任何消息直接发送到队列中。实际上，生产者通常甚至不知道消息是否会被传送到任何队列中。我们的消息实际上是从生产者传递到路由，路由会绑定队列并指定绑定的routingKey。根据routingkey匹配到这个路由上绑定的队列，并向队列发送消息，不能匹配上的队列则不会收到该消息。所以我们上一篇文章中虽然没有明确定义路由，实际上是使用是默认的路由。我们可以根据需求自己声明相应的路由。</p><h1 id="路由-Exchange"><a href="#路由-Exchange" class="headerlink" title="路由(Exchange)"></a>路由(Exchange)</h1><h3 id="声明方式"><a href="#声明方式" class="headerlink" title="声明方式"></a>声明方式</h3><pre><code>exchangeDeclare(String exchange, String type, boolean durable, boolean autoDelete, Map&lt;String, Object&gt; arguments)</code></pre><blockquote><p>exchange :路由名<br>type : 路由类型<br>durable: 是否持久化<br>autoDelete：是否自动删除<br>arguments: 其它参数</p></blockquote><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>1、Fanout<br>​    &gt; 广播。这个类型的路由会忽略routingKey。收到生产者消息后会直接发送给绑定在该路由上的所有队列</p><p>2、Direct</p><blockquote><p>单播。该类型的路由会根据routingKey去匹配队列，将消息发送给该路由上绑定的并且routingKey完全匹配上的队列</p></blockquote><p>3、Topic</p><blockquote><p>多播。该类型路由的routingKey可以使用通配符进行匹配。即 * 代表一个单词，# 代表多个单词。routingKey 的定义不能是任意字符，只能是由点号分隔的字符串，如: “ stock.usd.nyse ”，“ nyse.vmw ”，“ quick.orange.rabbit ”。<br>如下图<br>Q1队列的与路由绑定的routingKey 是<strong><strong>.orange.</strong></strong><br>Q2队列的与路由绑定的routingKey 是 <strong><strong>.</strong></strong>.rabbit  与 lazy.#<br>如果我们发送消息时指定的routingKey为:quick.orange.rabbit ，则消息会被路由发送到Q1与Q2两个队列中。<br>如果我们发送消息时指定的routingKey为:lazy.brown.fox ，则消息会被路由发送到Q2队列<br>如果指定的routingKey为 lazy.pink.rabbit，也会被发送到Q2，但只会发送一次，即使它匹配到了两个绑定的routingKey<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nqr0t8j30bs04rt8t.jpg" alt="示例"></p></blockquote><p>4、Headers</p><blockquote><p>这种类型的路由不处理路由键，而是根据发送消息的Headers属性进行匹配，在队列绑定交换机的时候会指定一组键对值;</p></blockquote><h3 id="绑定队列"><a href="#绑定队列" class="headerlink" title="绑定队列"></a>绑定队列</h3><pre><code>queueBind(String queue, String exchange, String routingKey)</code></pre><blockquote><p>前面我们说过 RabbitMQ中的消息传递模型的核心思想是生产者永远不会将任何消息直接发送到队列中。所以我们每个队列都需要绑定在一个路由上。从生产者发送到该路由的消息只会被传递到与路由绑定的队列上。绑定时还需要指定一个routingKey，路由根据发布消息时传递过来的routintKey来匹配到相应队列并传送消息到该队列中。<br>queue: 队列名<br>exchange: 路由名<br>routingKey: 队列与路由绑定的key</p></blockquote><h1 id="编写生产者"><a href="#编写生产者" class="headerlink" title="编写生产者"></a>编写生产者</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmitLogTopic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME=<span class="string">"topic_logs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line">        String message =<span class="string">"Hello World! This is error info!"</span>;</span><br><span class="line">        <span class="comment">/* 我们使用的是topic类型的路由，第二个参数为routingKey*/</span></span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME,<span class="string">"rabbit.log.error"</span>,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>发送消息时我们指定的routingKey为 rabbit.log.error 因为是topic类型的路由，所以需要用点分隔的形式写routingKey ，如果是Direct类型则不需要。</p></blockquote><h1 id="编写消费者"><a href="#编写消费者" class="headerlink" title="编写消费者"></a>编写消费者</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceivedLogsTopic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCHANGE_NAME=<span class="string">"topic_logs"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.TOPIC);</span><br><span class="line">        String queuesName = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">/*将队列绑定路由并定义topic类型路由的匹配规则*/</span></span><br><span class="line">        channel.queueBind(queuesName,EXCHANGE_NAME,<span class="string">"*.log.*"</span>);</span><br><span class="line"></span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                String message = <span class="keyword">new</span> String(body,<span class="string">"UTF-8"</span>);</span><br><span class="line">                System.out.println(<span class="string">"[x] recv:"</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        channel.basicConsume(queuesName,<span class="keyword">true</span>,consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这里队列绑定topic 类型路由时指定的匹配规则为 <strong><strong>.log.</strong></strong><br>前面生产者发送时的routingKey 为 rabbit.log.error 所以这条消息会被路由监听到。 如果我们将绑定的匹配规则修改为 log.# 并重新启动一个消费者B，通过生产者再次发送消息，则消费者B不会监听到这条消息，因为routingKey 无法匹配上，路由不会把这条消息传递给消费者B</p></blockquote><p> <strong>* 注意在测试时是需要先启动消费者，再启动生产者。因为如果没有消费者在线，消息会被rabbitMq丢弃处理 </strong></p>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ学习系列 二 “Hello World”</title>
      <link href="/posts/aca91396/"/>
      <url>/posts/aca91396/</url>
      
        <content type="html"><![CDATA[<p> 前面写了RabbitMQ的安装，这一篇记录一下 “Hello World” 的实现 。</p><a id="more"></a><p>[TOC]</p><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><blockquote><p>使用最简单的方式发布一个消息并接收<br>这里声明了一个hello队列，没有使用路由。</p></blockquote><h3 id="编写生产者"><a href="#编写生产者" class="headerlink" title="编写生产者"></a>编写生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME=<span class="string">"hello"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">/*创建连接工厂*/</span></span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">/*创建频道*/</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">/*声明一个队列*/</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        String message = <span class="string">"HJW,Hello World!"</span>;</span><br><span class="line">        <span class="comment">/*发布消息*/</span></span><br><span class="line">        channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="keyword">null</span>,message.getBytes());</span><br><span class="line"></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写消费者"><a href="#编写消费者" class="headerlink" title="编写消费者"></a>编写消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE_NAME =<span class="string">"hello"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">/*创建连接工厂*/</span></span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">/*设置Rabbitmq主机地址，用户名密码与端口。用户名密码与端口可不设置可以使用默认*/</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">"guest"</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        Connection connection = connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">/*通过连接创建频道*/</span></span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">/*声明一个队列 */</span></span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">/*创建一个消费者*/</span></span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException  </span>&#123;</span><br><span class="line">                String message = <span class="keyword">new</span> String(body,<span class="string">"UTF-8"</span>);</span><br><span class="line">                System.out.println(<span class="string">" Message is received: "</span> + message );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">/*订阅消息并消费*/</span></span><br><span class="line">        channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法介绍"><a href="#方法介绍" class="headerlink" title="方法介绍"></a>方法介绍</h3><p>1、队列声明</p><pre><code>queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)</code></pre><blockquote><p>queue:队列名称<br>durable:是否持久化<br>exclusive:是否为排它队列。即只有自己可见，对首次连接可见，连接断开自动删除<br>autoDelete:是否自动删除，在没有消费者的时候<br>arguments:其它参数</p></blockquote><p>2、发布消息</p><pre><code>basicPublish(String exchange, String routingKey, BasicProperties props, byte[] body)</code></pre><blockquote><p>exchange:路由名<br>routingKey:发布到哪个队列<br>props: 其它参数<br>body: 消息体</p></blockquote><p>3、订阅消息并消费</p><pre><code>basicConsume(String queue, boolean autoAck, Consumer callback)</code></pre><blockquote><p>queue:消息队列名<br>autoAck: 是否自动确认。消息被消息后需要向rabbitmq返回一个确认，rabbitmq才会把消息删除，也可以手动确认<br>callback: 消费者</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ学习系列 一 RabbitMQ 的安装</title>
      <link href="/posts/a7407de/"/>
      <url>/posts/a7407de/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p>之前项目上使用到了ActiveMQ，所以学习了下ActiveMQ ，使用JMS结合ActiveMQ发送消息或主题，大致了解了它的使用。听说RabbitMQ 才是主流，打算学习RabbitMQ。</p><a id="more"></a><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><blockquote><p>RabbitMQ是一个开源的AMQP实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持AJAX。用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。消息中间件主要用于组件之间的解耦。rabbitmq多应用于批量数据异步处理、并行任务串行化，高负载任务的负载均衡等 重量级，高并发，异步高可靠性场景。<br>AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。</p></blockquote><h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><p>RabitMQ是使用Erlang开发的，它的运行依赖Erlang。所以在使用前需要下载安装Erlang<br>Erlang 下载地址：<a href="http://www.erlang.org/downloads" target="_blank" rel="noopener">Erlang官方下载</a><br>RabbitMQ 下载地址：<a href="http://www.rabbitmq.com/install-windows-manual.html" target="_blank" rel="noopener">RabbitMQ 官方下载</a></p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="Erlang-安装"><a href="#Erlang-安装" class="headerlink" title="Erlang 安装"></a>Erlang 安装</h2><p>Window中 Erlang下载下来的安装程序是 otp_win64_20.3.exe ，直接双击安装即可。<br><strong>配置环境变量</strong><br>添加一个系统变量 ERLANG_HOME 并设置为 Erlang 的目录 ，比如我的安装目录为 ：D:\Program Files\erl9.3<br>在 Path 系统变量中加上 %ERLANG_HOME%\bin<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nbg9j8j30tk0fd0u9.jpg" alt="Erlang配置环境变量"><br><strong>验证</strong><br>在cmd命令下输入:erl<br>能够返回版本号则表示安装与配置环境变量成功<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nbcd4nj30ak04gq2w.jpg" alt="这里写图片描述"></p><h2 id="RabbitMQ-安装"><a href="#RabbitMQ-安装" class="headerlink" title="RabbitMQ 安装"></a>RabbitMQ 安装</h2><p>将下载下来的 rabbitmq-server-windows-3.7.4.zip 解压到指定的安装目录即可。<br><strong>配置环境变量</strong><br>添加 RABBITMQ_SERVER 并设置为RabbitMQ 解压到的目录，如我放置的目录为 ：D:\rabbitmq_server-3.7.4<br>在 Path 系统变量末尾添加 %RABBITMQ_SERVER%\sbin </p><p><strong>验证</strong><br>打开cmd窗口，输入: rabbitmq-service</p><pre><code>PS C:\WINDOWS\system32&gt; rabbitmq-service*********************Service control usage*********************rabbitmq-service help    - Display this helprabbitmq-service install - Install the RabbitMQ servicerabbitmq-service remove  - Remove the RabbitMQ serviceThe following actions can also be accomplished by usingWindows Services Management Console (services.msc):rabbitmq-service start   - Start the RabbitMQ servicerabbitmq-service stop    - Stop the RabbitMQ servicerabbitmq-service disable - Disable the RabbitMQ servicerabbitmq-service enable  - Enable the RabbitMQ service</code></pre><p>如有输出 以上 rabbitmq 命令的解释信息即表示安装成功。</p><p><strong>安装服务</strong><br>可以把RabbitMQ服务器作为服务运行，打开一个cmd窗口(管理员)，输入命令： rabbitmq-service install</p><pre><code>PS C:\WINDOWS\system32&gt; rabbitmq-service installD:\Program Files\erl9.3\erts-9.3\bin\erlsrv: Service RabbitMQ added to system.</code></pre><p>运行命令成功后我们可以查看一下服务是否已添加成功<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nbmabnj30ih07raap.jpg" alt="服务添加成功"></p><p><strong>启动RabbitMQ</strong><br>在cmd 窗口中输入命令:rabbitmq-service start</p><pre><code>PS C:\WINDOWS\system32&gt; rabbitmq-service startRabbitMQ 服务正在启动 .RabbitMQ 服务已经启动成功。</code></pre><p><strong>安装web管理插件</strong><br>RabbitMQ 可以通用一个Web界面来进行管理。在cmd命令窗口中输入命令:rabbitmq-plugins enable rabbitmq_management</p><pre><code>PS C:\WINDOWS\system32&gt; rabbitmq-plugins enable rabbitmq_managementEnabling plugins on node rabbit@hwacer-hp:rabbitmq_managementThe following plugins have been configured:  rabbitmq_management  rabbitmq_management_agent  rabbitmq_web_dispatchApplying plugin configuration to rabbit@hwacer-hp...The following plugins have been enabled:  rabbitmq_management  rabbitmq_management_agent  rabbitmq_web_dispatchset 3 plugins.Offline change; changes will take effect at broker restart.</code></pre><p>安装好后需要重启RabbitMQ，使用 stop 停止 再使用start 启动即可。<br>​<br>​    PS C:\WINDOWS\system32&gt; rabbitmq-service stop<br>​    RabbitMQ 服务正在停止………<br>​    RabbitMQ 服务已成功停止。<br>​<br>    PS C:\WINDOWS\system32&gt; rabbitmq-service start<br>    RabbitMQ 服务正在启动 .<br>    RabbitMQ 服务已经启动成功。</p><p>重启之后我们访问 <a href="http://localhost:15672/" target="_blank" rel="noopener">http://localhost:15672/</a>  登陆RabbitMQ 的web管理后台。默认用户密码为 guest/guest<br>重启之后可能需要过一会访问才能打开<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nbqbnej30zv061weo.jpg" alt="这里写图片描述"></p><p>至此，RabbitMQ 的一系列安装准备工作已经完成了，接下来要学习如何通过编码发送消息。</p>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>四 ActiveMQ消息持久化与配置</title>
      <link href="/posts/7cb7ab7d/"/>
      <url>/posts/7cb7ab7d/</url>
      
        <content type="html"><![CDATA[<p>四 ActiveMQ消息持久化与配置</p><a id="more"></a><h1 id="一、ActiveMQ-消息持久化"><a href="#一、ActiveMQ-消息持久化" class="headerlink" title="一、ActiveMQ 消息持久化"></a>一、ActiveMQ 消息持久化</h1><h3 id="1、新建数据库"><a href="#1、新建数据库" class="headerlink" title="1、新建数据库"></a>1、新建数据库</h3><p>首先我们先新建一个mysql数据库，并把所有权限赋给新建用户，用户需要在建表的权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> 创建数据库</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> misc</span><br><span class="line"><span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=UTF8;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> 创建用户和授权</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> misc.*</span><br><span class="line"><span class="keyword">TO</span> <span class="string">'misc_root'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span></span><br><span class="line"><span class="keyword">BY</span> <span class="string">'misc_root_pwd'</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">PRIVILEGES</span> <span class="keyword">ON</span> misc.*</span><br><span class="line"><span class="keyword">TO</span> <span class="string">'misc_root'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span></span><br><span class="line"><span class="keyword">BY</span> <span class="string">'misc_root_pwd'</span>;</span><br></pre></td></tr></table></figure><h3 id="2、配置数据源"><a href="#2、配置数据源" class="headerlink" title="2、配置数据源"></a>2、配置数据源</h3><p>在ActiveMQ目录中找到conf/activemq.xml 文件。<br>ActiveMQ默认使用的是kahadb 我们在xml中修改成使用mysql<br>在文件中找到：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">directory</span>=<span class="string">"$&#123;activemq.data&#125;/kahadb"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure><p>把它注释掉，添加mysql的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span> <span class="attr">dataSource</span>=<span class="string">"#MySQL-DS"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure></p><pre><code>在&lt;/broker&gt;后面添加数据源的配置</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- MySQL DataSource --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MySQL-DS"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:3306/misc?useUnicode=true&amp;amp;characterEncoding=UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"misc_root"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"misc_root_pwd"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolPreparedStatements"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里的ID对应的就是我们上面配置的ID。<br>最后，我们需要把mysql的jar包复制到ActiveMQ目录中的lib目录下，<br>接着重新启动ActiveMQ，这时它会自动在数据库中生成三张表<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nsbyyaj30cx042aa3.jpg" alt="数据表"></p><p>我们可以用上一篇文章写的代码做测试，发布的消息会被存储在mysql数据库中，被消费后会自动删除。</p><h1 id="二、ActiveMQ配置"><a href="#二、ActiveMQ配置" class="headerlink" title="二、ActiveMQ配置"></a>二、ActiveMQ配置</h1><p>在第二篇文章中，我人提到ActiveMQ管理页面的登陆用户与密码默认是admin/admin。这个默认的用户与密码在正式环境中肯定是需要修改的。</p><h3 id="1、ActiveMQ管理页面登陆配置"><a href="#1、ActiveMQ管理页面登陆配置" class="headerlink" title="1、ActiveMQ管理页面登陆配置"></a>1、ActiveMQ管理页面登陆配置</h3><p>我们找到ActiveMQ目录中的 conf/jetty-realm.properties<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nsk4vpj30qf0c63ze.jpg" alt="jetty-realm.properties"><br>可以看到配置了两个用户，admin与user。<br>配置的格式为:<br>​<br>​    用户名:密码,用户角色</p><p>这里我们修改一下admin用户的密码，重新启动ActiveMQ，打开管理员后台<a href="http://localhost:8161/admin" target="_blank" rel="noopener">http://localhost:8161/admin</a><br>弹出的登陆框中需要输入我们新设置的用户与密码才能登陆了。</p><h3 id="2、ActiveMQ连接开启密码认证"><a href="#2、ActiveMQ连接开启密码认证" class="headerlink" title="2、ActiveMQ连接开启密码认证"></a>2、ActiveMQ连接开启密码认证</h3><p><strong>第一步:</strong>找到 ActiveMQ目录中的conf/credentials.properties<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nsoazzj30nj0byt9l.jpg" alt="credentials.properties"><br>这里配置的是连接的用户与密码，我们可以把密码修改成123456。<br><strong>第二步：</strong>找到activemq/conf/activemq.xml<br>在systemUsage 后面添加一个插件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"$&#123;activemq.username&#125;"</span> <span class="attr">password</span>=<span class="string">"$&#123;activemq.password&#125;"</span> <span class="attr">groups</span>=<span class="string">"users,admins"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>位置如图:<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nsrzgoj30yk0c2jsn.jpg" alt="这里写图片描述"></p><p>最后重启ActiveMQ ，如果我们还用前面的代码去连接ActiveMQ 会提示用户或密码无效。我们需要修改代码中的连接工厂内容。<br>在实例化工厂时传入我们修改后的用户与密码</p><pre><code>//实例化连接工厂        connectionFactory = new ActiveMQConnectionFactory(&quot;system&quot;,&quot;123456&quot;,JMSProducer.URL);</code></pre><p>重新启动程序即可连接成功。<br>这样我们就实现了密码认证连接ActiveMQ。</p>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ActiveMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三 JMS发布 订阅模型--ActiveMQ简单应用</title>
      <link href="/posts/42a9c4a1/"/>
      <url>/posts/42a9c4a1/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><blockquote><p>上一篇文章 《<a href="https://blog.csdn.net/ftdd_hw/article/details/79921004" target="_blank" rel="noopener">二、JMS 点对点模型 – ActiveMQ简单实现</a>》 我们实现了JMS点对点模型的实例，本章对第二种 发布/订阅 模型来做一个简单的实例。</p></blockquote><p>其实发布/订阅 模型与点对点模型的实现方式基本一致，因此这里就不写完整的过程了。</p><a id="more"></a><h1 id="一、开发环境"><a href="#一、开发环境" class="headerlink" title="一、开发环境"></a>一、开发环境</h1><pre><code>与上篇文章相同</code></pre><h1 id="二、java项目"><a href="#二、java项目" class="headerlink" title="二、java项目"></a>二、java项目</h1><pre><code>与上篇文章相同</code></pre><h1 id="三、具体实现"><a href="#三、具体实现" class="headerlink" title="三、具体实现"></a>三、具体实现</h1><h3 id="1、编写发布者"><a href="#1、编写发布者" class="headerlink" title="1、编写发布者"></a>1、编写发布者</h3><p>发布者的代码与上篇文章基本相同，不同的是 使用session 创建是的主题，而不是队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnection;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> .</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span> JMS生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息的生产者类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/11 0011.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSProducer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认连接用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = ActiveMQConnection.DEFAULT_USER;</span><br><span class="line">    <span class="comment">//默认连接密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = ActiveMQConnection.DEFAULT_PASSWORD;</span><br><span class="line">    <span class="comment">//默认连接地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = ActiveMQConnection.DEFAULT_BROKER_URL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//连接工厂</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//会话</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">//目的地</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">//生产者</span></span><br><span class="line">        MessageProducer messageProducer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 编写生产者的步骤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实例化连接工厂</span></span><br><span class="line">            connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(JMSProducer.USERNAME,JMSProducer.PASSWORD,JMSProducer.URL);</span><br><span class="line">            <span class="comment">//使用连接工厂获取连接</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">//启动连接</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">//使用连接创建获取会话</span></span><br><span class="line">            session = connection.createSession(<span class="keyword">true</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">//与点对点唯一不同的地方</span></span><br><span class="line">            <span class="comment">//使用会话连接一个主题作为目的地，如果这个主题不存在将会被创建</span></span><br><span class="line">            destination = session.createTopic(<span class="string">"HelloWorld.Topic"</span>);</span><br><span class="line">            <span class="comment">//使用会话创建消息发布者</span></span><br><span class="line">            messageProducer = session.createProducer(destination);</span><br><span class="line">            <span class="comment">//发布主题</span></span><br><span class="line">            sendMessage(session,messageProducer);</span><br><span class="line">            session.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布者发布主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session  会话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageProducer   发布者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Session session,MessageProducer messageProducer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用会话创建一条文本消息,当然，消息的类型有很多，如文字，字节，对象等,可以通过session.create..方法来创建出来</span></span><br><span class="line">            TextMessage textMessage = session.createTextMessage(<span class="string">"你好，世界! by Topic"</span>);</span><br><span class="line">            <span class="comment">//通过消息发布者发出主题</span></span><br><span class="line">            messageProducer.send(textMessage);</span><br><span class="line">            System.out.println(<span class="string">"已发送主题消息:"</span>+textMessage.getText());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、编写订阅者"><a href="#2、编写订阅者" class="headerlink" title="2、编写订阅者"></a>2、编写订阅者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnection;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> .</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/11 0011.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认连接用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = ActiveMQConnection.DEFAULT_USER;</span><br><span class="line">    <span class="comment">//默认连接密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = ActiveMQConnection.DEFAULT_PASSWORD;</span><br><span class="line">    <span class="comment">//默认连接地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = ActiveMQConnection.DEFAULT_BROKER_URL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//连接工厂</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//会话</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">//目的地</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">//消息的消费者</span></span><br><span class="line">        MessageConsumer messageConsumer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息的消费者编写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实例化工厂</span></span><br><span class="line">            connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(JMSConsumer.USERNAME,JMSConsumer.PASSWORD,JMSConsumer.URL);</span><br><span class="line">            <span class="comment">//使用实例工厂获取连接</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">//启动连接</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">//使用连接获取会话</span></span><br><span class="line">            session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">//使用会话连接一个队列作为目的地，如果这个队列不存在将会被创建</span></span><br><span class="line"><span class="comment">//            destination  = session.createQueue("HelloWorld");</span></span><br><span class="line"><span class="comment">//使用会话创建一个主题，如果这个主题不存在将会被创建</span></span><br><span class="line">            Topic topic = session.createTopic(<span class="string">"HelloWorld.Topic"</span>);</span><br><span class="line">            <span class="comment">//使用会话创建一个订阅者</span></span><br><span class="line">            messageConsumer = session.createConsumer(topic);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *获取消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">/*同步实现*/</span></span><br><span class="line">            <span class="comment">//设置接收者接收消息的时间,为了便于测试,这里定为50s,接收到消息之前（或超时之前）将一直阻塞</span></span><br><span class="line">            <span class="comment">/*TextMessage textMessage = (TextMessage) messageConsumer.receive(50000);</span></span><br><span class="line"><span class="comment">            if (textMessage!=null)&#123;</span></span><br><span class="line"><span class="comment">                System.out.println("收到的消息是:" + textMessage.getText());</span></span><br><span class="line"><span class="comment">            &#125;else &#123;</span></span><br><span class="line"><span class="comment">                System.out.println("没有收到消息");</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            <span class="comment">/*异步实现*/</span></span><br><span class="line">            messageConsumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String text = ((TextMessage)message).getText();</span><br><span class="line">                        System.out.println(<span class="string">"收到的消息 :"</span> +text );</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*需要异步，则不关闭连接*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、关于持久订阅模式"><a href="#3、关于持久订阅模式" class="headerlink" title="3、关于持久订阅模式"></a>3、关于持久订阅模式</h3><p>在第一篇文章 《<a href="https://blog.csdn.net/ftdd_hw/article/details/79920145" target="_blank" rel="noopener">一、JMS概述</a>》中我们提到:</p><blockquote><p>发布/订阅模型还支持持久订阅的概念，在消息发布时，注册了主题的消费者不需要处于活动状态; 当消费者随后变得活跃时，它将收到消息。如果没有活动使用者注册主题，则该主题不会持有它收到的消息，除非它具有持久订阅的不活动消费者。</p></blockquote><p>主要是业务场景如下:</p><blockquote><p>A系统通过MQ推送数据到B系统。通过发布订阅的消息传送模型。由于涉及到的数据比较重要：比如是关于资金、交易、股票价格的信息。要保证B系统一定收到A系统发送的消息，考虑B系统会断电重启之类异常，故设置持久订阅模式。可以保证在B订阅A主题后，因为断电，订阅者状态变为不活动的。在B系统重启后，依然可以收到消息。</p></blockquote><p>实现持久订阅模式与普通的发布订阅模式一样，主要的不同是必须设置唯一的客户端ID和订阅者ID。</p><pre><code>1、在连接启动前设置设置客户端ID2、使用createDurableSubscriber 创建订阅者并指定订阅者ID</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置客户端ID</span></span><br><span class="line">connection.setClientID(<span class="string">"client1"</span>);</span><br><span class="line"><span class="comment">//使用会话创建一个订阅者，并指定订阅者ID为 sub1</span></span><br><span class="line">TopicSubscriber topicSubscriber = session.createDurableSubscriber(topic,<span class="string">"sub1"</span>);</span><br></pre></td></tr></table></figure><h1 id="四、运行"><a href="#四、运行" class="headerlink" title="四、运行"></a>四、运行</h1><h3 id="1、启动ActiveMQ"><a href="#1、启动ActiveMQ" class="headerlink" title="1、启动ActiveMQ"></a>1、启动ActiveMQ</h3><p>与上一篇文章相同</p><h3 id="2、运行程序"><a href="#2、运行程序" class="headerlink" title="2、运行程序"></a>2、运行程序</h3><p>首先我们运行一下发布者。发布成功后我们可以在ActiveMQ 的主题中看到我们创建出来的主题消息<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4ndbkulj30tn0fpjsk.jpg" alt="这里写图片描述"></p><p>我们再运行一下订阅者，会发现订阅者一直在待接收消息，并没有输出我们刚刚发布的主题消息。这是因为 发布/订阅 模型 的特点:发布端在发布消息时，如果没有订阅端在线，则不会保留消息，将会认为消息已经发送。</p><p>因此我们可以先运行订阅者的代码，启动一个订阅者。为了体现发布/订阅模式一对多的特点，我们再启动第二个订阅者。可以在ActiveMQ中看到在两个订阅者在线了。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nd6yf0j30t002g0sp.jpg" alt="这里写图片描述"></p><p>我们再启动发布者，发布一个消息。在线的两个订阅者就可以接收到我们刚刚发布的消息了。<br>我们再设想一下，其中一个订阅者断电下线了，如果再有消息发布，则待它再次上线时已经接收不到第二次发布的消息了。为了解决一个问题，我们可以使用持久订阅模式。<br>按照上面 <strong>持久订阅</strong>修改代码后重新启动两个订阅者，注意的时这两个订阅者的客户端ID与订阅者ID都必须唯一。<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nd2o4aj30e104jglz.jpg" alt="这里写图片描述"><br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4ndjg4rj30h504z3yx.jpg" alt="这里写图片描述"></p><p>启动发布者发布一个消息 ，可以看到两个订阅者分别都接收到了发布的消息。<br>这时我们关闭 订阅者 Client1 ，再发布一个消息。这时Client2接收到了。当我们启动订阅者 Client1后，它也能够收到第二次发布的消息<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4ndfdw2j30fp05ddg7.jpg" alt="这里写图片描述"></p><p>至此，我们实现了JMS发布/订阅模型，并使用了持久订阅模式关于持久订阅我们需要注意的是:</p><blockquote><p>很多情况下，持久化订阅非常有用，但有的时候并非如此。虽然使用持久还是非持久通常由业务决定。但是，我们还必须考虑消息消耗的存储容量。比如有一个持久订阅者长期处于不活动的状态，那么jms服务器就必须为这个订阅者存储数以千计、万计的无用信息，浪费JMS数据仓库的宝贵空间。因为，我们必须得考虑这个问题。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ActiveMQ </tag>
            
            <tag> JMS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二 JMS 点对点模型 -- ActiveMQ简单实现</title>
      <link href="/posts/762f8ad8/"/>
      <url>/posts/762f8ad8/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><p>本文我们使用ActiveMQ实现简单的点对点的消息模型。</p><a id="more"></a><h1 id="一、开发环境"><a href="#一、开发环境" class="headerlink" title="一、开发环境"></a>一、开发环境</h1><p>这里我使用的是 <em>apache-activemq-5.11.1</em> 可以去<a href="http://activemq.apache.org/download-archives.html" target="_blank" rel="noopener">官网下载</a> </p><ul><li>jdk1.8</li><li>idea</li></ul><h1 id="二、新建java项目"><a href="#二、新建java项目" class="headerlink" title="二、新建java项目"></a>二、新建java项目</h1><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nv9gsrj308c07w0sq.jpg" alt="这里写图片描述"></p><p>其中activemq-all-5.11.1.jar在下载下来的 <em>apache-activemq-5.11.1</em> 中就有，直接复制过来导入项目即可。</p><h1 id="三、具体实现"><a href="#三、具体实现" class="headerlink" title="三、具体实现"></a>三、具体实现</h1><p><strong>JMSProducer</strong>：消息的生产者<br><strong>JMSConsumer</strong>：消息的消费者</p><p><strong>大致步骤</strong>：<br>（1）创建连接工厂<br>（2）使用连接工厂创建一个连接<br>（3）启动连接<br>（4）使用连接创建一个会话<br>（5）使用会话创建一个队列/主题<br>（6）使用会话创建一个生产者/消费者<br>（7）使用会话创建一个消息/对象/集合/文件/字节<br>（8）使用生产者/消费者 发送/获取 消息</p><h3 id="1、编写生产者"><a href="#1、编写生产者" class="headerlink" title="1、编写生产者"></a>1、编写生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnection;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span> JMS生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 消息的生产者类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/11 0011.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSProducer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认连接用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = ActiveMQConnection.DEFAULT_USER;</span><br><span class="line">    <span class="comment">//默认连接密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = ActiveMQConnection.DEFAULT_PASSWORD;</span><br><span class="line">    <span class="comment">//默认连接地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = ActiveMQConnection.DEFAULT_BROKER_URL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//连接工厂</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//会话</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">//目的地</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">//生产者</span></span><br><span class="line">        MessageProducer messageProducer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 编写生产者的步骤</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实例化连接工厂</span></span><br><span class="line">            connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(JMSConsumer.USERNAME,JMSConsumer.PASSWORD,JMSConsumer.URL);</span><br><span class="line">            <span class="comment">//使用连接工厂获取连接</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">//启动连接</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">//使用连接创建获取会话</span></span><br><span class="line">            session = connection.createSession(<span class="keyword">true</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">//使用会话连接一个队列作为目的地，如果这个队列不存在将会被创建</span></span><br><span class="line">            destination = session.createQueue(<span class="string">"HelloWorld"</span>);</span><br><span class="line">            <span class="comment">//使用会话创建消息生产者</span></span><br><span class="line">            messageProducer = session.createProducer(destination);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发送消息</span></span><br><span class="line">            sendMessage(session,messageProducer);</span><br><span class="line"><span class="comment">//支持事务则必须提交</span></span><br><span class="line">            session.commit();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//关闭连接</span></span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产者发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session  会话</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageProducer   生产者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Session session,MessageProducer messageProducer)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用会话创建一条文本消息,当然，消息的类型有很多，如文字，字节，对象等,可以通过session.create..方法来创建出来</span></span><br><span class="line">            TextMessage textMessage = session.createTextMessage(<span class="string">"你好，世界!"</span>);</span><br><span class="line">            <span class="comment">//通过消息生产者发出消息</span></span><br><span class="line">            messageProducer.send(textMessage);</span><br><span class="line">            System.out.println(<span class="string">"已发送消息:"</span>+textMessage.getText());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="2、编写消费者"><a href="#2、编写消费者" class="headerlink" title="2、编写消费者"></a>2、编写消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnection;</span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> .</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/11 0011.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认连接用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = ActiveMQConnection.DEFAULT_USER;</span><br><span class="line">    <span class="comment">//默认连接密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = ActiveMQConnection.DEFAULT_PASSWORD;</span><br><span class="line">    <span class="comment">//默认连接地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL = ActiveMQConnection.DEFAULT_BROKER_URL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//连接工厂</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//会话</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">//目的地</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">//消息的消费者</span></span><br><span class="line">        MessageConsumer messageConsumer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息的消费者编写</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//实例化工厂</span></span><br><span class="line">            connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(JMSConsumer.USERNAME,JMSConsumer.PASSWORD,JMSConsumer.URL);</span><br><span class="line">            <span class="comment">//使用实例工厂获取连接</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">//启动连接</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">//使用连接获取会话</span></span><br><span class="line">            session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">//使用会话连接一个队列作为目的地，如果这个队列不存在将会被创建</span></span><br><span class="line">            destination  = session.createQueue(<span class="string">"HelloWorld"</span>);</span><br><span class="line">            <span class="comment">//使用会话获取消费者</span></span><br><span class="line">            messageConsumer = session.createConsumer(destination);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *获取消息</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">/*同步实现*/</span></span><br><span class="line">            <span class="comment">//设置接收者接收消息的时间,为了便于测试,这里定为50s,接收到消息之前（或超时之前）将一直阻塞</span></span><br><span class="line">            <span class="comment">/*TextMessage textMessage = (TextMessage) messageConsumer.receive(50000);</span></span><br><span class="line"><span class="comment">            if (textMessage!=null)&#123;</span></span><br><span class="line"><span class="comment">                System.out.println("收到的消息是:" + textMessage.getText());</span></span><br><span class="line"><span class="comment">            &#125;else &#123;</span></span><br><span class="line"><span class="comment">                System.out.println("没有收到消息");</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line">            <span class="comment">/*异步实现*/</span></span><br><span class="line">            messageConsumer.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        String text = ((TextMessage)message).getText();</span><br><span class="line">                        System.out.println(<span class="string">"收到的消息是:"</span> +text );</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、session与事务处理"><a href="#3、session与事务处理" class="headerlink" title="3、session与事务处理"></a>3、session与事务处理</h3><pre><code>session = connection.createSession(true,Session.AUTO_ACKNOWLEDGE);</code></pre><p><strong>第一个参数</strong></p><p> 要使用事务处理，必须通过作为第一个参数设置为<strong>true</strong>来创建一个事务处理会话</p><blockquote><p>事务处理允许您将整个系列的传入和传出消息分组在一起，并将它们视为原子单元。消息代理跟踪事务的各个消息的状态，但在您提交事务之前不会完成它们的传送。在发生故障时，您可以回滚事务，取消其所有消息并从头开始重新启动整个系列。<br>事务处理会话总是只有一个打开的事务，包含自会话创建或前一个事务完成以来发送或接收的所有消息。提交或回滚事务会结束该事务并自动开始另一个事务。</p></blockquote><hr><p>当交易中的所有消息都已成功交付时，您可以调用会话的commit方法来提交交易</p><pre><code>session.commit();</code></pre><p>所有会话的传入消息都会被确认，并且所有传出的消息都将被发送。交易被视为完成，并开始新的交易。</p><p>发送或接收操作失败时，会引发异常。虽然可以通过忽略或重试操作来处理异常，但建议您使用会话的rollback方法回退事务：</p><pre><code>session.rollback（）;</code></pre><p><strong>第二个参数</strong>：</p><blockquote><p>值可为Session.AUTO_ACKNOWLEDGE，Session.CLIENT_ACKNOWLEDGE，DUPS_OK_ACKNOWLEDGE其中一个。<br>Session.AUTO_ACKNOWLEDGE为自动确认，客户端发送和接收消息不需要做额外的工作。哪怕是接收端发生异常，也会被当作正常发送成功。<br>Session.CLIENT_ACKNOWLEDGE为客户端确认。客户端接收到消息后，必须调用javax.jms.Message的acknowledge方法。jms服务器才会当作发送成功，并删除消息。<br>DUPS_OK_ACKNOWLEDGE允许副本的确认模式。一旦接收方应用程序的方法调用从处理消息处返回，会话对象就会确认消息的接收；而且允许重复确认。</p></blockquote><h3 id="4、连接工厂-ConnectionFactory"><a href="#4、连接工厂-ConnectionFactory" class="headerlink" title="4、连接工厂 ConnectionFactory"></a>4、连接工厂 ConnectionFactory</h3><pre><code>connectionFactory = new ActiveMQConnectionFactory(JMSConsumer.USERNAME,JMSConsumer.PASSWORD,JMSConsumer.URL);</code></pre><p>activemq默认是不需要密码，生产消费者就可以连接的<br>实例化连接工厂时我们可以去掉用户名与密码，同样可以连接到ActiveMQ<br><strong>如果ActiveMQ是部署在你本地的，则默认的用户名为admin,默认密码也为admin,地址为:tcp://localhost:61616  我们可以直接从<em>ActiveMQConnection</em> 中 取得默认的用户名，密码与地址</strong></p><h3 id="5、关于同步与异步"><a href="#5、关于同步与异步" class="headerlink" title="5、关于同步与异步"></a>5、关于同步与异步</h3><ul><li><p>同步 </p><blockquote><p>订阅者或接收者调用receive方法来接收消息，receive方法在能够接收到消息之前（或超时之前）将一直阻塞 </p></blockquote></li><li><p>异步 </p><blockquote><p>订阅者或接收者可以注册为一个消息监听器。当消息到达之后，系统自动调用监听器的onMessage方法。上面消费者的代码中使用的是这种方法</p></blockquote></li></ul><h1 id="四、运行"><a href="#四、运行" class="headerlink" title="四、运行"></a>四、运行</h1><h3 id="1、启动ActiveMQ"><a href="#1、启动ActiveMQ" class="headerlink" title="1、启动ActiveMQ"></a>1、启动ActiveMQ</h3><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nv6mcrj30gm06274s.jpg" alt="ActiveMQ运行"></p><pre><code>如果你的64bit机器，则在这个目录下打开Activemq.bat 32bit机器可以执行 bin\win32\activemq.bat</code></pre><p>打开后出现以下窗口后，表示启动成功，这个窗口不能关闭<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nw0s3ej30rk0exdgn.jpg" alt="ActiveMQ打开窗口"></p><p>打开ActiveMQ的管理界面：<a href="http://127.0.0.1:8161/admin/" target="_blank" rel="noopener">http://127.0.0.1:8161/admin/</a><br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nvmomoj30o80bjwfb.jpg" alt="ActiveMQ管理页面"></p><p>分别点击队列与主题可以查看发送到ActiveMQ的队列消息或主题</p><h3 id="2、运行生产者"><a href="#2、运行生产者" class="headerlink" title="2、运行生产者"></a>2、运行生产者</h3><p>ActiveMQ 启动好后，我们就可以运行生产者向ActiveMQ发送消息了<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nv39yjj30o30600t6.jpg" alt="运行生产者"></p><p>运行结束后，我们查看一下ActiveMQ的队列<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nvd7v0j30ue0710ta.jpg" alt="查看队列"></p><p>表示ActiveMQ自动创建一个名为”HelloWorld“的队列，队列已经收到了一条消息，暂时没有消费者，我们也可以在ActiveMQ中对消息进行浏览删除等操作</p><h3 id="3、运行消费者"><a href="#3、运行消费者" class="headerlink" title="3、运行消费者"></a>3、运行消费者</h3><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nvtumsj30o1063t94.jpg" alt="这里写图片描述"><br>这里我们使用异步接收，生产者再次发送消息时同样可以接收到。<br>如果使用同步接收，在规定的时间超时后会程序停止，关闭连接。</p><p>看看ActiveMQ中的队列发生的变化：</p><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nvhh96j30ue079aai.jpg" alt="接收消息后"></p><p>可以看到待处理消息已为0，出队消息加1，有一个消费者在线。</p><p>官方文档参考: <a href="https://docs.oracle.com/cd/E26576_01/doc.312/e24945/toc.htm" target="_blank" rel="noopener">https://docs.oracle.com/cd/E26576_01/doc.312/e24945/toc.htm</a></p>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ActiveMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一 JMS概述</title>
      <link href="/posts/b7f40b7d/"/>
      <url>/posts/b7f40b7d/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h1 id="一、JMS概念"><a href="#一、JMS概念" class="headerlink" title="一、JMS概念"></a>一、JMS概念</h1><blockquote><p>摘要：The Java Message Service (JMS) API is a messaging standard that allows application components based on the Java Platform Enterprise Edition (Java EE) to create, send, receive, and read messages. It enables distributed communication that is loosely coupled, reliable, and asynchronous.</p><a id="more"></a></blockquote><blockquote><p>JMS（JAVA Message Service,java消息服务）API是一个消息服务的标准或者说是规范，允许应用程序组件基于JavaEE平台创建、发送、接收和读取消息。它使分布式通信耦合度更低，消息服务更加可靠以及异步性。jms是java的消息服务，JMS客户端之间可以通过JMS服务进行异步的消息传输</p></blockquote><blockquote><p>消息包括：消息头，消息扩展属性和消息休，其结构看起来与SOAP非常相似，但一般情况下，SOAP主要关注远程服务调用，而消息则专注于信息的交换。</p></blockquote><blockquote><p>消息分为：消息生产者，消息服务器和消息消费者。生产者与消费者之间是透明的，生产者在产生消息后，把消息发送到消息服务器，再由消息服务器发给消费者，因此它们构成了JMS的3点结构;<br>消息服务器再给消费者时，有2种模式:点到点(point to point )模式和发布/订阅(pbulish/subscribe) 模式,两种模式下面会详细介绍;</p></blockquote><h1 id="二、消息服务器"><a href="#二、消息服务器" class="headerlink" title="二、消息服务器"></a>二、消息服务器</h1><blockquote><p>消息服务器有很多:ActiveMQ,Jboss MQ,Open MQ,RabbitMQ ,ZeroMQ等等。<br>本文介绍的是开源的java实现的Apache ActiveMQ,后面我们会写到如何应用它与jms结合。</p></blockquote><p>看到一个对消息服务器作用的解释：</p><blockquote><p>消息队列的主要作用不是通讯，主要是用于解除子系统间的耦合，所以异构系统间的通讯实际并不是ActiveMQ发挥作用的场景，那反而是RPC发挥作用的时候。<br>消息队列更适合于需要更大流量和并发的大型系统场景，可以将消息队列视为一个可靠的通道，主交易过程在处理时，遇到需时较多同时又已经确定了条件的处理就丢到消息队列里进行后续处理，这样可以将主交易过程划分为一个一个可以异步处理的更小的处理过程，减少了主交易流程的处理时间，可以提供更快的响应速度和并发速度。例如，象淘宝这样的处理逻辑非常多的系统，在处理付款时，就可以将通知买家和卖家、记日志甚至记帐流程都放到消息队列里处理，整个主流程能够快速处理完成，继续处理下一个买家的请求。</p></blockquote><p>应用场景:<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4mafi9lj30k00dnt9n.jpg" alt="应用场景"></p><h1 id="三、消息模型"><a href="#三、消息模型" class="headerlink" title="三、消息模型"></a>三、消息模型</h1><h2 id="1、Point-to-Point-P2P-–-点对点模式"><a href="#1、Point-to-Point-P2P-–-点对点模式" class="headerlink" title="1、Point-to-Point(P2P) – 点对点模式"></a>1、Point-to-Point(P2P) – 点对点模式</h2><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4ma1cryj30dj0450tc.jpg" alt="这里写图片描述"></p><blockquote><p>每条消息都从消息生产者传递到单个消息使用者。生产者将消息传递给队列，稍后将其传递给为队列注册的其中一个消费者。任何数量的生产者和消费者都可以与同一个队列进行交互，但是每个消息都被保证传递给（并且被成功消费）一个消费者，而不会再消费。如果没有消费者注册队列，它将保存它收到的消息，并最终在消费者注册时传递消息。</p></blockquote><h2 id="2、Publish-Subscribe-Pub-Sub-–-发布订阅模型"><a href="#2、Publish-Subscribe-Pub-Sub-–-发布订阅模型" class="headerlink" title="2、Publish/Subscribe(Pub/Sub)  – 发布订阅模型"></a>2、Publish/Subscribe(Pub/Sub)  – 发布订阅模型</h2><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4macqaej30c606ldgm.jpg" alt="这里写图片描述"></p><blockquote><p>单个消息可以从生产者被传递到任何数量的消费者。生产者将消息发布到一个主题，然后将其发送给订阅了该主题的所有活动消费者。任何数量的生产者都可以将消息发布到给定主题，并且每条消息都可以传递给任意数量的订阅消费者。该模型还支持持久订阅的概念，在消息发布时，注册了主题的消费者不需要处于活动状态; 当消费者随后变得活跃时，它将收到消息。如果没有活动使用者注册主题，则该主题不会持有它收到的消息，除非它具有持久订阅的不活动消费者。</p></blockquote><h1 id="三、消息的消费"><a href="#三、消息的消费" class="headerlink" title="三、消息的消费"></a>三、消息的消费</h1><p>在JMS中，消息的产生和消息是异步的。对于消费来说，JMS的消息者可以通过两种方式来消费消息。<br>○ 同步 </p><blockquote><p>订阅者或接收者调用receive方法来接收消息，receive方法在能够接收到消息之前（或超时之前）将一直阻塞 </p></blockquote><p>○ 异步 </p><blockquote><p>订阅者或接收者可以注册为一个消息监听器。当消息到达之后，系统自动调用监听器的onMessage方法。</p></blockquote><h1 id="四、JMS编程模型"><a href="#四、JMS编程模型" class="headerlink" title="四、JMS编程模型"></a>四、JMS编程模型</h1><p>1、 ConnectionFactory</p><blockquote><p>创建Connection对象的工厂，针对两种不同的jms消息模型，分别有QueueConnectionFactory和TopicConnectionFactory两种。可以通过JNDI来查找ConnectionFactory对象。</p></blockquote><p>2、Destination</p><blockquote><p>Destination的意思是消息生产者的消息发送目标或者说消息消费者的消息来源。对于消息生产者来说，它的Destination是某个队列（Queue）或某个主题（Topic）;对于消息消费者来说，它的Destination也是某个队列或主题（即消息来源）。</p></blockquote><blockquote><p>所以，Destination实际上就是两种类型的对象：Queue、Topic可以通过JNDI来查找Destination。</p></blockquote><p>3、Connection</p><blockquote><p>Connection表示在客户端和JMS系统之间建立的链接（对TCP/IP socket的包装）。Connection可以产生一个或多个Session。跟ConnectionFactory一样，Connection也有两种类型：QueueConnection和TopicConnection。</p></blockquote><p>4、Session</p><blockquote><p>Session是我们操作消息的接口。可以通过session创建生产者、消费者、消息等。Session提供了事务的功能。当我们需要使用session发送/接收多个消息时，可以将这些发送/接收动作放到一个事务中。同样，也分QueueSession和TopicSession。</p></blockquote><p>5、消息的生产者</p><blockquote><p>消息生产者由Session创建，并用于将消息发送到Destination。同样，消息生产者分两种类型：QueueSender和TopicPublisher。可以调用消息生产者的方法（send或publish方法）发送消息。</p></blockquote><p>6、消息消费者</p><blockquote><p>消息消费者由Session创建，用于接收被发送到Destination的消息。两种类型：QueueReceiver和TopicSubscriber。可分别通过session的createReceiver(Queue)或createSubscriber(Topic)来创建。当然，也可以session的creatDurableSubscriber方法来创建持久化的订阅者。</p></blockquote><p>7、MessageListener</p><blockquote><p>消息监听器。如果注册了消息监听器，一旦消息到达，将自动调用监听器的onMessage方法。EJB中的MDB（Message-Driven Bean）就是一种MessageListener。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> MQ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ActiveMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA中VCS报错</title>
      <link href="/posts/c711627f/"/>
      <url>/posts/c711627f/</url>
      
        <content type="html"><![CDATA[<blockquote><p>放假回来打开IDEA 想跑一下项目，发现版本控制有出问题了。在Version control中查看 log 标签时一直闪，Event log 中报如下错误：</p></blockquote><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Fatal error, VCS Log re-created:PersistentEnumerator storage corrupted </span><br><span class="line">C:\Users\HJW\.IntelliJIdea2016.3\system\vcs-log\messages\97921a36.bb580880.0.values</span><br></pre></td></tr></table></figure><pre><code>翻译看好像是日志文件重复创建，造成了系统存储问题</code></pre><blockquote><p>想了下估计是放假前系统出问题恢复了一下系统才出现的问题。接着百度解决，发现没有一点头绪。最后无奈试试 删除它提示的路径下的messages 文件夹，果然就好了。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> TortoiseGit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识React</title>
      <link href="/posts/c4548fcf/"/>
      <url>/posts/c4548fcf/</url>
      
        <content type="html"><![CDATA[<blockquote><p>React是FaceBook开源的一个用于构建用户界面的JavaScript库，已经应用于FaceBook及旗下的Instagram。 React专注于MVC框架中的V，即视图层。它引入了虚拟DOM的概念，提高了运行效率。</p></blockquote><p>根据阮一峰老师的 React 入门实例教程 学习过程中作的笔记</p><p>React在线 编辑器 ：<a href="https://jsfiddle.net/reactjs/69z2wepo/" target="_blank" rel="noopener">https://jsfiddle.net/reactjs/69z2wepo/</a> </p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">    &lt;script  src=&quot;https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script  src=&quot;https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/babel-core/6.1.19/browser.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id=&quot;container&quot;&gt;</span><br><span class="line">        &lt;!-- This element&apos;s contents will be replaced with your component. --&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script type=&quot;text/babel&quot;&gt;</span><br><span class="line">        //创建一个组件</span><br><span class="line">        var Hello = React.createClass(&#123;</span><br><span class="line">         //添加样式对象,注意属性名在这里需要使用驼峰形式</span><br><span class="line">         /*也可以直接在html中添加样式类名：需要使用className 而不是class(Js中的关键字)*/</span><br><span class="line">             var styleObj = &#123;</span><br><span class="line">             color:#f00,</span><br><span class="line">             fontSize:100px</span><br><span class="line">             &#125;,</span><br><span class="line">             render: function() &#123;</span><br><span class="line">             //this.props 指在属性的集合</span><br><span class="line">             return &lt;div style=&#123;styleObj&#125;&gt;Hello &#123;this.props.name&#125;&lt;/div&gt;</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">         </span><br><span class="line">        //将 解析成DOM节点并插入到浏览器的DOM结构中。 附带一个属性：name</span><br><span class="line">        ReactDOM.render(</span><br><span class="line">            &lt;Hello name=&quot;World&quot; /&gt;,</span><br><span class="line">            document.getElementById(&apos;container&apos;)</span><br><span class="line">        ); </span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><ul><li>组件命名首字母需要大写，比如上面的Hello组件</li><li>所有组件类都必须有自己的 render 方法，用于输出组件</li><li>组件中的render方法中返回的HTML语言必须为一个标签。比如下面这段代码就会报错。因为它返回了两个顶层标签: <code>&lt;h1&gt;</code>和<code>&lt;p&gt;;</code>所以当有几个标签返回时， 我们必须用一个div 或其它标签将其包装成一个整体。</li></ul>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React的事件处理</title>
      <link href="/posts/999cf40c/"/>
      <url>/posts/999cf40c/</url>
      
        <content type="html"><![CDATA[<p>React的事件处理</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;container&quot;&gt;</span><br><span class="line">    &lt;!-- This element&apos;s contents will be replaced with your component. --&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"> </span><br><span class="line">&lt;sctipt type=&quot;text/jsx&quot; &gt;</span><br><span class="line">     var testClickComponent  = React.createClass(&#123;</span><br><span class="line">     handleClick:function(event)&#123;</span><br><span class="line">         var tipE = React.findDOMNode(this.refs.tip); //转化成真实的DOM节点</span><br><span class="line">               if(tipE.style.display === &quot;none&quot;)&#123;</span><br><span class="line">                    tipE.style.dispaly = &apos;inline&apos;;</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                   tipE.style.dispaly = &apos;none&apos;; </span><br><span class="line">               &#125;</span><br><span class="line">          event.stopPropagation();//停止向上冒泡</span><br><span class="line">          event.preventDefault(); //阻止事件默认行为</span><br><span class="line">     &#125;,</span><br><span class="line">     render:function()&#123;</span><br><span class="line">          return (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">               &lt;button onClick=&#123;this.handleClick&#125;&gt;显示/隐藏&lt;/button&gt;&lt;span ref=&quot;tip&quot;&gt;测试点击&lt;/span&gt; </span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">          )</span><br><span class="line">     &#125;</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">          var TestInpputComponent = React.createClass(&#123;</span><br><span class="line">          getInitialState:function()&#123;</span><br><span class="line">          return (</span><br><span class="line">               inputContent  : &apos; &apos;    </span><br><span class="line">              )     </span><br><span class="line">     &#125;,</span><br><span class="line">          handleChange:function(event)&#123;</span><br><span class="line">                 this.setState(&#123;</span><br><span class="line">               inputContent : event.target.value</span><br><span class="line">          &#125;);</span><br><span class="line">          </span><br><span class="line">          event.stopPropagation(); </span><br><span class="line">          event.preventDefault();  </span><br><span class="line">          </span><br><span class="line">     &#125;,</span><br><span class="line">          render:function()&#123;</span><br><span class="line">               return (</span><br><span class="line">                   &lt;div&gt; &lt;input type=&quot;text&quot; onChange=&#123;this.handleChange&#125;&gt; &lt;span&gt;&#123;this.state.inputContent&#125;&lt;/span&gt;</span><br><span class="line">               );</span><br><span class="line">          &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><!--more--><h4 id="代码解析："><a href="#代码解析：" class="headerlink" title="代码解析："></a>代码解析：</h4><blockquote><p>Ref:  可以使用ref 属性给组件起一个名字， 相当于建立一个索引。然后可以通过this.refs.组件的ref值 可以索引到这个组件。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React中的数据请求</title>
      <link href="/posts/1607ac93/"/>
      <url>/posts/1607ac93/</url>
      
        <content type="html"><![CDATA[<p>React中我们可以使用ajax来请求数据。</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">var UserGist = React.createClass(&#123;</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      username: &apos;&apos;,</span><br><span class="line">      lastGistUrl: &apos;&apos;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  componentDidMount: function() &#123;</span><br><span class="line">    $.get(this.props.source, function(result) &#123;</span><br><span class="line">      var lastGist = result[0];</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">          username: lastGist.owner.login,</span><br><span class="line">          lastGistUrl: lastGist.html_url</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;.bind(this));</span><br><span class="line">  &#125;,</span><br><span class="line">   componentWillUnmount: function() &#123;</span><br><span class="line">    this.serverRequest.abort();</span><br><span class="line">  &#125;,</span><br><span class="line">&lt;!--more--&gt;</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;this.state.username&#125;&apos;s last gist is</span><br><span class="line">        &lt;a href=&#123;this.state.lastGistUrl&#125;&gt;here&lt;/a&gt;.</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;UserGist source=&quot;https://api.github.com/users/octocat/gists&quot; /&gt;,</span><br><span class="line">  document.body</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>上述代码使用了JQuery来完成AJAX请求。React本身没有任何依赖，完全可以不用JQuery,而使用其它库。</p><p>通过props传入请求地址。在组件加载完成之后，通过AJAX请求到数据。并设置到state中，组件重新渲染显示。</p><p>当使用异步加载数据时，需要在组件卸载前使用<strong>componentWillUnmount</strong> 来取消未完成的请求。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React的生命周期</title>
      <link href="/posts/235e3713/"/>
      <url>/posts/235e3713/</url>
      
        <content type="html"><![CDATA[<p>React的生命周期</p><a id="more"></a><p><img src="https://raw.githubusercontent.com/hjwjw/hjwjw.github.io/master/img/Image.png" alt="react的生命周期"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/babel&quot;&gt;</span><br><span class="line">var Hello = React.createClass(&#123;</span><br><span class="line">  getInitialState:function()&#123;</span><br><span class="line">     //初始化state</span><br><span class="line">     alert(&quot;init&quot;);</span><br><span class="line">     return &#123;</span><br><span class="line">         opacity:1.0,</span><br><span class="line">         fontSize:20</span><br><span class="line">     &#125;</span><br><span class="line">&#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    return &lt;div style=&#123;&#123;opacity:this.state.opacity,fontSize:this.state.fontSize&#125;&#125;&gt;Hello &#123;this.props.name&#125;&lt;/div&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  componentWillMount:function()&#123;</span><br><span class="line">    //组件加载之前</span><br><span class="line">     </span><br><span class="line">  &#125;,</span><br><span class="line">  componentDidMount:function()&#123;</span><br><span class="line">    //组件加载之完成1秒后改变State的值：setState()</span><br><span class="line">    var _self =this;</span><br><span class="line">    this.timer = setInterval(function () &#123;</span><br><span class="line">            var opacity = this.state.opacity;</span><br><span class="line">            var fontSize = this.state.fontSize;</span><br><span class="line">            fontSize -=1;</span><br><span class="line">            opacity -= .05;</span><br><span class="line">            if (opacity &lt; 0.1) &#123;</span><br><span class="line">              opacity = 1.0;</span><br><span class="line">            &#125;</span><br><span class="line">            if (fontSize &lt;8) &#123;</span><br><span class="line">            fontSize = 20;</span><br><span class="line">            &#125;</span><br><span class="line">            this.setState(&#123;</span><br><span class="line">              opacity: opacity,</span><br><span class="line">              fontSize:fontSize </span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;.bind(this), 100);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">ReactDOM.render(</span><br><span class="line"> &lt;Hello name=&quot;World&quot; /&gt; ,</span><br><span class="line">  document.getElementById(&apos;container&apos;)</span><br><span class="line">);  </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><!--more--><blockquote><p>上述代码中：通过设置一个定时器，每100毫秒改变state，从而引发重新渲染。<br>注意Style样式的写法：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;opacity:this.state.opacity,fontSize:this.state.fontSize&#125;&#125;</span><br></pre></td></tr></table></figure><p>这是因为 React中组件样式是一个对象。所以第一重大括号是表示javaScript语法，第二重大括号表示样式对象;</p><blockquote><p>State 值的改变会导致组件进入updating 阶段,从而重新render。 但不是每次都会重新Render，React 会将之前的DOM 与改变后的Dom进行对比，如果确实DOM有被改变，React会修改被改变的部分DOM结构</p></blockquote><h3 id="State-与-Props-的区别-："><a href="#State-与-Props-的区别-：" class="headerlink" title="State 与 Props 的区别 ："></a>State 与 Props 的区别 ：</h3><ul><li><p>State  私属于组件自身的， 是可以变化的<br>Props  是组件调用方在调用组合的时候指定的，一旦指定会，在一般情况下是不会变化的</p></li><li><p>Props 专情， State 花心 </p></li></ul><h3 id="其它函数说明："><a href="#其它函数说明：" class="headerlink" title="其它函数说明："></a>其它函数说明：</h3><blockquote><p>componentWillReceiveProps(object nextProps)：已加载组件收到新的参数时调用<br>shouldComponentUpdate(object nextProps, object nextState)：组件判断是否重新渲染时调用</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React中的虚拟DOM</title>
      <link href="/posts/56469b54/"/>
      <url>/posts/56469b54/</url>
      
        <content type="html"><![CDATA[<p>React中的组件并不是真实的DOM 节点，而是位于内存中的一种数据结构。叫做”虚拟DOM”。<br>只有当它插入文档中才成为真实的DOM 。React的这种设计极大提高了网页的性能表现 。但我们有时需要从组件获得真实的DOM节点，我们可以使用 <strong>ref</strong> 属性<br><a id="more"></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var MyComponent = React.createClass(&#123;</span><br><span class="line">  handleClick: function() &#123;</span><br><span class="line">    this.refs.myTextInput.style.display=&apos;none&apos;;</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; ref=&quot;myTextInput&quot; /&gt;</span><br><span class="line">        &lt;input type=&quot;button&quot; value=&quot;Focus the text input&quot; onClick=&#123;this.handleClick&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;MyComponent /&gt;,</span><br><span class="line">  document.getElementById(&apos;example&apos;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>上述代码中定义了事件。 当点击buttom时会触发 handleClick事件，通过 定义在表单上的<strong>ref</strong>属性，使用 <strong>this.res.属性值</strong> 来获得组件的真实DOM进行操作。注意的是必须是在组件被插入到文档中后才能取到真实的DOM 节点,因此这里是网页显示后通过点击实现取得input的DOM 才进行操作的。</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React中的表单</title>
      <link href="/posts/9535cee6/"/>
      <url>/posts/9535cee6/</url>
      
        <content type="html"><![CDATA[<p>React中的表单</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var Input = React.createClass(&#123;</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return &#123;value: &apos;Hello!&apos;&#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  handleChange: function(event) &#123;</span><br><span class="line">    this.setState(&#123;value: event.target.value&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function () &#123;</span><br><span class="line">    var value = this.state.value;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;input type=&quot;text&quot; value=&#123;value&#125; onChange=&#123;this.handleChange&#125; /&gt;</span><br><span class="line">        &lt;p&gt;&#123;value&#125;&lt;/p&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;Input/&gt;, document.body);</span><br></pre></td></tr></table></figure><p>文本框中的值不能通过this.props.value来读取。而是要通过定义onChange事件的回调函数，通过event.target.value来读取用户的输入值 。textarea 元素，select元素 ，radio元素都需要这样。</p><p>代码执行效果：输入的同时，下文的文字也会一起变化<br><img src="leanote://file/getImage?fileId=58c6049e8181ad471a000001" alt="代码执行效果"></p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>组件的状态</title>
      <link href="/posts/abe7c3eb/"/>
      <url>/posts/abe7c3eb/</url>
      
        <content type="html"><![CDATA[<p>每个组件都有一个初始状态，然后用户互动，导致状态改变，从而触发重新渲染UI 。<br><a id="more"></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">var LikeButton = React.createClass(&#123;</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return &#123;liked: false&#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  handleClick: function(event) &#123;</span><br><span class="line">    this.setState(&#123;liked: !this.state.liked&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    var text = this.state.liked ? &apos;like&apos; : &apos;haven\&apos;t liked&apos;;</span><br><span class="line">    return (</span><br><span class="line">      &lt;p onClick=&#123;this.handleClick&#125;&gt;</span><br><span class="line">        You &#123;text&#125; this. Click to toggle.</span><br><span class="line">      &lt;/p&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;LikeButton /&gt;,</span><br><span class="line">  document.getElementById(&apos;example&apos;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>上面代码中，定义了LikeButtom组件。getInitialState用来定义一些初始状态，我们可以通过this.state来读取属性。this.setState 用来修改状态值 ，每次修改后重新调用 this.render方法，重新渲染组件。</p><p><strong>关于this.props与 this.state 的区别</strong></p><pre><code>它们都用来用于描述组件的特性this.props 表示哪些一旦定义就不再改变的特性this.state 用来定义那些随着用户互动而产生变化的特性</code></pre>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>组件的属性</title>
      <link href="/posts/8755e95b/"/>
      <url>/posts/8755e95b/</url>
      
        <content type="html"><![CDATA[<p>组件的属性可以接受任意值，字符串、对象、函数等等都可以</p><a id="more"></a><h2 id="一、Props的使用"><a href="#一、Props的使用" class="headerlink" title="一、Props的使用"></a>一、Props的使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var Hello = React.createClass(&#123;</span><br><span class="line">    render: function() &#123;</span><br><span class="line">    return &lt;div className=&quot;Hello&quot;&gt;Hello &#123;this.props.name&#125;&lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Hello name=&quot;World&quot; /&gt;,</span><br><span class="line">    document.getElementById(&apos;container&apos;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><!--more--><p>组件的用法与原生的 HTML 标签完全一致，可以任意加入属性，比如 <hellomessage name="John"> ，就是 HelloMessage 组件加入一个 name 属性，值为 John。组件的属性可以在组件类的 this.props 对象上获取，比如 name 属性就可以通过 this.props.name 读取。</hellomessage></p><p>有一个地方需要注意，就是 class 属性需要写成 className ，for 属性需要写成 htmlFor ，这是因为 class 和 for 是 JavaScript 的保留字</p><h2 id="二、Props-children-与-React-Childern"><a href="#二、Props-children-与-React-Childern" class="headerlink" title="二、Props.children 与 React.Childern"></a>二、Props.children 与 React.Childern</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">var NotesList = React.createClass(&#123;</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;ol&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        React.Children.map(this.props.children, function (child) &#123;</span><br><span class="line">          return &lt;li&gt;&#123;child&#125;&lt;/li&gt;;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      &lt;/ol&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;NotesList&gt;</span><br><span class="line">    &lt;span&gt;hello&lt;/span&gt;</span><br><span class="line">    &lt;span&gt;world&lt;/span&gt;</span><br><span class="line">  &lt;/NotesList&gt;,</span><br><span class="line">  document.body</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>在<strong>NotesList</strong>这个组件中，包含了两个<strong>span</strong>子节点。我们可以通过this.props.children 来读取。<br>this.props.children的值有三种可能：</p><pre><code>如果当前组件没有子节点，则它的值是 **undefined**;如果有一个子节点，则它的数据类型是 **Object** ;如果有多个子节点，则它的数据类型是 **array**</code></pre><p>React 也提供了一个方法 React.Childern 来处理this.props.children  。我们可以用React.Children.map来遍历子节点 </p><h2 id="三、PropsTypes"><a href="#三、PropsTypes" class="headerlink" title="三、PropsTypes"></a>三、PropsTypes</h2><p>PropsTypes属性可以用来验证组件实例的属性是否符合要求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/babel&quot;&gt;</span><br><span class="line"></span><br><span class="line">  var data = 123;</span><br><span class="line"></span><br><span class="line">  var MyTitle = React.createClass(&#123;</span><br><span class="line">    propTypes: &#123;</span><br><span class="line">      title: React.PropTypes.string.isRequired,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    render: function() &#123;</span><br><span class="line">      return &lt;h1&gt; &#123;this.props.title&#125; &lt;/h1&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;MyTitle title=&#123;data&#125; /&gt;,</span><br><span class="line">    document.getElementById(&apos;example&apos;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>Mytitle 组件中有一个title属性。PropsTypes告诉React 这个组件是必须的且是一个字符串。上面代码中我们给title设置了一个数值，在浏览器中页面可以正常显示出来，但是控制台中会报错：<br><code>Warning: Failed propType: Invalid prop `title` of type `number` supplied to `MyTitle`, expected `string`.</code></p><h2 id="四、getDefaultProps"><a href="#四、getDefaultProps" class="headerlink" title="四、getDefaultProps"></a>四、getDefaultProps</h2><p>getDefaultProps 可以用来设置组件默认的属性值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var MyTitle = React.createClass(&#123;</span><br><span class="line">  getDefaultProps : function () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      title : &apos;Hello World&apos;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  render: function() &#123;</span><br><span class="line">     return &lt;h1&gt; &#123;this.props.title&#125; &lt;/h1&gt;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;MyTitle /&gt;,</span><br><span class="line">  document.body</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>以上代码输出：<br>​    ​    Hello World</p>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux软件安装的方式</title>
      <link href="/posts/8603afa7/"/>
      <url>/posts/8603afa7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>wget不是安装方式 他是一种下载软件类似与迅雷   </p><a id="more"></a></blockquote><blockquote><p>如果要下载一个软件 我们可以直接 </p></blockquote><ul><li>wget 下载地址</li><li>ap-get是ubuntu下的一个软件安装方式，它是基于debain</li><li>yum是redhat、centos下的一个软件安装方式，它是基于Linux的</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>找不到PO类的错误</title>
      <link href="/posts/c684b94c/"/>
      <url>/posts/c684b94c/</url>
      
        <content type="html"><![CDATA[<p>在Service中不小心把mapper定义成的private ,然后就不明的出现找不到po类的情况，去掉就好了</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Activiti配置</title>
      <link href="/posts/14941ceb/"/>
      <url>/posts/14941ceb/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Activiti5由Alfresco软件在2010年5月17日发布的业务流程管理（BPM）框架，它是覆盖了业务流程管理、工作流、服务协作等领域的一个开源的、灵活的、易扩展的可执行流程语言框架。</p></blockquote><a id="more"></a><p>[TOC]</p><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><ul><li>JDK1.6或者更高版本</li><li>支持的数据库有：h2, mysql, oracle, postgres, mssql, db2等。</li><li>支持activiti5运行的jar包</li><li><p>开发环境为Eclipse3.7或者以上版本,MyEclipse为8.6版本</p><h1 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h1></li><li><p><a href="http://activiti.org/download.html" target="_blank" rel="noopener">Activiti下载</a></p></li><li><a href="http://pan.baidu.com/s/1qYgohFA" target="_blank" rel="noopener">流程设计器-Eclipse 插件-百度网盘下载</a>，密码：447q3 (插件安装教程:<a href="http://blog.csdn.net/qq_33547950/article/details/54926435" target="_blank" rel="noopener">http://blog.csdn.net/qq_33547950/article/details/54926435</a>)  </li></ul><h1 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h1><ul><li><p>导入JAR包</p><p>​    我们在Eclipse中新建一个java项目，将Activiti需要的jar包导入。Activiti需要的jar包可以在从官网下载下来的Activiti文件中找到。路径：activiti-5.22.0\wars  下的示例项目activiti-rest.war 将其解压后，其中lib文件夹下的jar包就是我们所需要的。但其中没有给我们提供mysql的jar包与单元测试junit的jar包，我们自己添加即可。</p></li><li><p>配置Activiti.cfg.xml</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:jee</span>=<span class="string">"http://www.springframework.org/schema/jee"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"processEngineConfiguration"</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 数据库连接配置  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcDriver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/activiti_demo?useUnicode=true&amp;amp;characterEncoding=utf8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUsername"</span> <span class="attr">value</span>=<span class="string">"root"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcPassword"</span> <span class="attr">value</span>=<span class="string">"tiger"</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 建表策略 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databaseSchemaUpdate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>初始化数据库。</p><p>需要写一个类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateTable</span> </span>&#123;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createDbByXML</span><span class="params">()</span></span>&#123;</span><br><span class="line">ProcessEngine processEngine = ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">"activiti.cfg.xml"</span>).buildProcessEngine();</span><br><span class="line">System.out.println(processEngine);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行方法后会自动在数据库中创建Activiti所需要的表。Activiti 5.12 有23张表，Activiti 5.22 有25张表。Activiti 6.0 有28张表。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Activiti核心Api介绍</title>
      <link href="/posts/6ccb89f6/"/>
      <url>/posts/6ccb89f6/</url>
      
        <content type="html"><![CDATA[<p>Activiti核心Api介绍<br><a id="more"></a></p><h2 id="Activiti-核心-Api-介绍"><a href="#Activiti-核心-Api-介绍" class="headerlink" title="Activiti 核心 Api 介绍"></a>Activiti 核心 Api 介绍</h2><h3 id="ProcessEngine"><a href="#ProcessEngine" class="headerlink" title="ProcessEngine"></a>ProcessEngine</h3><p>说明：</p><p>1)     在Activiti中最核心的类，其他的类都是由他而来。</p><p>2)     产生方式：     </p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg" alt="img"></p><p>在前面看到了两种创建ProcessEngine（流程引擎）的方式，而这里要简化很多，调用ProcessEngines的getDefaultProceeEngine方法时会自动加载classpath下名为activiti.cfg.xml文件。<br><!--more--><br>3)     可以产生RepositoryService</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg" alt="img"></p><p>4)     可以产生RuntimeService</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image006.jpg" alt="img"></p><p>5)     可以产生TaskService</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image007.png" alt="img"></p><p>各个Service的作用：</p><table><thead><tr><th><strong>RepositoryService</strong></th><th><strong>管理流程定义</strong></th></tr></thead><tbody><tr><td><strong>RuntimeService<em>**</em></strong></td><td><strong>执行管理，包括启动、推进、删除流程实例等操作</strong></td></tr><tr><td><strong>TaskService</strong></td><td><strong>任务管理</strong></td></tr><tr><td><strong>HistoryService</strong></td><td><strong>历史管理(**</strong>执行完的数据的管理)**</td></tr><tr><td><strong>IdentityService</strong></td><td><strong>组织机构管理</strong></td></tr><tr><td>FormService</td><td>一个可选服务，任务表单管理</td></tr><tr><td>ManagerService</td></tr></tbody></table><h3 id="RepositoryService"><a href="#RepositoryService" class="headerlink" title="RepositoryService"></a>RepositoryService</h3><p>是Activiti的仓库服务类。所谓的仓库指流程定义文档的两个文件：bpmn文件和流程图片。</p><p>1)     产生方式</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg" alt="img"></p><p>2)     可以产生DeploymentBuilder，用来定义流程部署的相关参数</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image009.jpg" alt="img"></p><p>3)     删除流程定义</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image011.jpg" alt="img"></p><h3 id="RuntimeService"><a href="#RuntimeService" class="headerlink" title="RuntimeService"></a>RuntimeService</h3><p>是activiti的流程执行服务类。可以从这个服务类中获取很多关于流程执行相关的信息。</p><h3 id="TaskService"><a href="#TaskService" class="headerlink" title="TaskService"></a>TaskService</h3><p>是activiti的任务服务类。可以从这个类中获取任务的信息。</p><h3 id="HistoryService"><a href="#HistoryService" class="headerlink" title="HistoryService"></a>HistoryService</h3><p>是activiti的查询历史信息的类。在一个流程执行完成后，这个对象为我们提供查询历史信息。</p><h3 id="ProcessDefinition"><a href="#ProcessDefinition" class="headerlink" title="ProcessDefinition"></a>ProcessDefinition</h3><p>流程定义类。可以从这里获得资源文件等。</p><h3 id="ProcessInstance"><a href="#ProcessInstance" class="headerlink" title="ProcessInstance"></a>ProcessInstance</h3><p>代表流程定义的执行实例。如范冰冰请了一天的假，她就必须发出一个流程实例的申请。一个流程实例包括了所有的运行节点。我们可以利用这个对象来了解当前流程实例的进度等信息。<strong>流程实例就表示一个流程从开始到结束的最大的流程分支</strong>，即一个流程中流程实例只有一个。</p><h3 id="Execution"><a href="#Execution" class="headerlink" title="Execution"></a>Execution</h3><p>​       Activiti用这个对象去描述流程执行的每一个节点。在没有并发的情况下，Execution就是同ProcessInstance。流程按照流程定义的规则执行一次的过程，就可以表示执行对象Execution。</p><p>​       如图为ProcessInstance的源代码：</p><p><img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image012.png" alt="img"></p><p>​    从源代码中可以看出ProcessInstance就是Execution。但在现实意义上有所区别：</p><p>​       <img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image014.jpg" alt="img"></p><p>​    在单线流程中，如上图的贷款流程，ProcessInstance与Execution是一致的。</p><p>​              <img src="file:///C:/Users/HJW/AppData/Local/Temp/msohtmlclip1/01/clip_image016.jpg" alt="img"></p><p>​    这个例子有一个特点：wire money(汇钱)和archive(存档)是并发执行的。   这个时候，总线路代表ProcessInstance，而分线路中每个活动代表Execution。</p><p><strong>总结：</strong></p><p><code>一个流程中，执行对象可以存在多个，但是流程实例只能有一个。</code></p><p><code>当流程按照规则只执行一次的时候，那么流程实例就是执行对象。</code></p>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kendo ui 使用问题记录</title>
      <link href="/posts/17163c3a/"/>
      <url>/posts/17163c3a/</url>
      
        <content type="html"><![CDATA[<h3 id="filed中使用日期格式化无效"><a href="#filed中使用日期格式化无效" class="headerlink" title="filed中使用日期格式化无效"></a>filed中使用日期格式化无效</h3><blockquote><p>需要指定该字段的类型，在DataSource 在进行数据类型指定</p></blockquote><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">schema: &#123;</span><br><span class="line">                data: &apos;rows&apos;,</span><br><span class="line">                total: &apos;total&apos;,</span><br><span class="line">                model: &#123;</span><br><span class="line">                    id: &quot;taskPaymentId&quot;,</span><br><span class="line">                    fields: &#123;</span><br><span class="line">                        docDate:&#123;type:&quot;date&quot;&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>在column的字段中再使用format: “{0: yyyy-MM-dd}”</p><h3 id="在Grid中使用了过滤，想把过滤条件传到服务器端"><a href="#在Grid中使用了过滤，想把过滤条件传到服务器端" class="headerlink" title="在Grid中使用了过滤，想把过滤条件传到服务器端"></a>在Grid中使用了过滤，想把过滤条件传到服务器端</h3><blockquote><p> 在dataSource 中添加参数：</p></blockquote><pre><code>serverFiltering: true</code></pre><blockquote><p>在transport 的parameterMap 中接收过滤条件</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">transport: &#123;</span><br><span class="line">               read: &#123;</span><br><span class="line">                   url: BaseUrl + &quot;query&quot;,</span><br><span class="line">                   type: &quot;POST&quot;,</span><br><span class="line">                   dataType: &quot;json&quot;</span><br><span class="line">               &#125;,</span><br><span class="line">               parameterMap : function(options, type) &#123;</span><br><span class="line">                   if (type === &quot;read&quot;) &#123;</span><br><span class="line">                   //判断是否有过滤条件</span><br><span class="line">                       if(options.filter)&#123;</span><br><span class="line">                           for (var i = 0; i &lt; options.filter.filters.length; i++) &#123;</span><br><span class="line">                               if (options.filter.filters[i].field == &apos;docDate&apos;) &#123;</span><br><span class="line">                                   var date = new Date(options.filter.filters[i].value);</span><br><span class="line">                                   var p = kendo.toString(date, &quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">                                   options.filter.filters[i].value = p;</span><br><span class="line">                               &#125;</span><br><span class="line">             viewModel.model.set(options.filter.filters[i].field,options.filter.filters[i].value);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       datas = viewModel.model.toJSON();</span><br><span class="line">                       return datas;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> KendoUI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kendoUi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GIT常见问题记录</title>
      <link href="/posts/43be2d09/"/>
      <url>/posts/43be2d09/</url>
      
        <content type="html"><![CDATA[<p>git pull遇到的问题</p><a id="more"></a><pre><code>early EOF index-pack failed</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/boostorg/boost.git</span><br><span class="line">Cloning into &apos;boost&apos;...</span><br><span class="line">remote: Counting objects: 183543, done.</span><br><span class="line">remote: Compressing objects: 100% (69361/69361), done.</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br><span class="line">fatal: early EOF</span><br><span class="line">fatal: index-pack failed</span><br></pre></td></tr></table></figure><p>我遇到这个应该是项目中有一些大文件，所以无法传输</p><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>在项目目录下，先使用 git config -l 查看一下git的配置，添加以下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --add core.compression -1</span><br></pre></td></tr></table></figure></p><blockquote><p>compression 是压缩的意思，从 clone 的终端输出就知道，服务器会压缩目标文件，然后传输到客户端，客户端再解压。取值为 [-1, 9]，-1 以 zlib 为默认压缩库，0 表示不进行压缩，1..9 是压缩速度与最终获得文件大小的不同程度的权衡，数字越大，压缩越慢，当然得到的文件会越小。</p></blockquote><h3 id="git-clone-遇到的问题"><a href="#git-clone-遇到的问题" class="headerlink" title="git clone 遇到的问题"></a>git clone 遇到的问题</h3><pre><code>同样是项目中文件过大，无法clone下来</code></pre><h3 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.postBuffer 524288000</span><br></pre></td></tr></table></figure><p>把git的postBuffer设置大一些就可以了</p>]]></content>
      
      
      <categories>
          
          <category> TortoiseGit </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kendoUi常用组件记录</title>
      <link href="/posts/3997b9a4/"/>
      <url>/posts/3997b9a4/</url>
      
        <content type="html"><![CDATA[<p>kendoUi常用组件记录</p><a id="more"></a><p>##tabstrip</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"tabstrip"</span> <span class="attr">style</span>=<span class="string">"height:100%"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"k-state-active"</span>&gt;</span></span><br><span class="line">      待支付</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      支付中</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      支付挂起</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      支付成功</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">      支付失败</span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"clear:both;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"unpaid"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"clear:both;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"paymenting"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"clear:both;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"payHangUp"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"clear:both;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"paySuccess"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"clear:both;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"payFailure"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tabstrip = $(<span class="string">"#tabstrip"</span>).kendoTabStrip(&#123;</span><br><span class="line">  height: <span class="string">'100%'</span>,</span><br><span class="line">  animation: <span class="literal">false</span></span><br><span class="line">&#125;).data(<span class="string">"kendoTabStrip"</span>);</span><br><span class="line">tabstrip.tabGroup.on(<span class="string">"click"</span>, <span class="string">".k-i-close"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  e.stopPropagation();</span><br><span class="line">  <span class="keyword">var</span> item = $(e.target).closest(<span class="string">".k-item"</span>);</span><br><span class="line">  <span class="keyword">var</span> index = item.index(),</span><br><span class="line">      prev = item.next().length == <span class="number">1</span> ? item.next() : item.prev();</span><br><span class="line">  tabstrip.remove(item.index());</span><br><span class="line">  tabstrip.select(prev)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>##列模板</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> columns = [</span><br><span class="line">  &#123;</span><br><span class="line">    field: <span class="string">"payNumber"</span>,</span><br><span class="line">    title: <span class="string">"单据编号"</span>,</span><br><span class="line">    width: <span class="number">120</span>,</span><br><span class="line">    attributes  : &#123;<span class="attr">style</span>: <span class="string">"text-align:center"</span>&#125;,</span><br><span class="line">    template : <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'&lt;a style="text-decoration : underline;color : blue;cursor:pointer" onclick="openPayBillDetail('</span>+e.taskPaymentId+<span class="string">')"&gt;'</span>+</span><br><span class="line">        e.payNumber</span><br><span class="line">        + <span class="string">'&lt;/a&gt;'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    field: <span class="string">"docDate"</span>,</span><br><span class="line">    title: <span class="string">"单据日期"</span>,</span><br><span class="line">    width: <span class="number">120</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="kendo-Window"><a href="#kendo-Window" class="headerlink" title="kendo Window"></a>kendo Window</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> payDetail =  $(<span class="string">'#payDetail'</span>).kendoWindow(&#123;</span><br><span class="line">  actions: [<span class="string">"Close"</span>],</span><br><span class="line">  width  : <span class="string">'95%'</span>,</span><br><span class="line">  height : <span class="string">'95%'</span>,</span><br><span class="line">  title  : <span class="string">'支付单明细'</span>,</span><br><span class="line">  visible: <span class="literal">false</span>,</span><br><span class="line">  iframe : <span class="literal">true</span>,</span><br><span class="line">  modal  : <span class="literal">true</span>,</span><br><span class="line">  content: <span class="string">'task_payment_detail.html?taskPaymentId='</span>+id,</span><br><span class="line">&#125;).data(<span class="string">"kendoWindow"</span>);</span><br><span class="line">payDetail.center().open();</span><br></pre></td></tr></table></figure><blockquote><p>modal  : true  是否在页面显示模态叠加，实现底层窗口不可点击<br>visible: false  指定窗口最初是否可见</p></blockquote><h2 id="kendo下拉列表"><a href="#kendo下拉列表" class="headerlink" title="kendo下拉列表"></a>kendo下拉列表</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> caIdData = [&#123;</span><br><span class="line">  caId:<span class="number">1</span>,</span><br><span class="line">  caIdName:<span class="string">"123"</span></span><br><span class="line">&#125;]</span><br><span class="line">$(<span class="string">'#ukeyNumber'</span>).kendoDropDownList(&#123;</span><br><span class="line">  dataTextField: <span class="string">"caId"</span>,</span><br><span class="line">  dataValueField: <span class="string">"caIdName"</span>,</span><br><span class="line">  dataSource: caIdData,</span><br><span class="line">  index:<span class="number">0</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//设置选择第几个</span></span><br><span class="line">$(<span class="string">"#ukeyNumber"</span>).data(<span class="string">"kendoDropDownList"</span>).select(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="获取grid选中数据"><a href="#获取grid选中数据" class="headerlink" title="获取grid选中数据"></a>获取grid选中数据</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> checked = $(<span class="string">'#unpaid'</span>).data(<span class="string">'kendoGrid'</span>).selectedDataItems()</span><br></pre></td></tr></table></figure><h2 id="刷新Grid"><a href="#刷新Grid" class="headerlink" title="刷新Grid"></a>刷新Grid</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">'#unpaid'</span>).data(<span class="string">'kendoGrid'</span>).dataSource.read();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> KendoUI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kendoUi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>oracle 生成自增序列</title>
      <link href="/posts/35a4f9ae/"/>
      <url>/posts/35a4f9ae/</url>
      
        <content type="html"><![CDATA[<p> oracle 生成自增序列</p><a id="more"></a>s<br><br>### 创建序列<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">SEQUENCE</span>  <span class="string">"HSSP_DEV"</span>.<span class="string">"HSS_TASK_PAY_BILL_S"</span>  <span class="keyword">MINVALUE</span> <span class="number">1</span> </span><br><span class="line">MAXVALUE <span class="number">9999999999999999999999999999</span> <span class="keyword">INCREMENT</span> <span class="keyword">BY</span> <span class="number">1</span> <span class="keyword">START</span> <span class="keyword">WITH</span> <span class="number">1</span> <span class="keyword">CACHE</span> <span class="number">20</span> <span class="keyword">NOORDER</span>  <span class="keyword">NOCYCLE</span> ;</span><br></pre></td></tr></table></figure><blockquote><p>HSS_TASK_PAY_BILL_S 为序列名 ，表示从1到 9999999999999999999999999999 步长为1进行递增</p></blockquote><h3 id="创建定时器"><a href="#创建定时器" class="headerlink" title="创建定时器"></a>创建定时器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">trigger</span> HSS_TASK_PAY_BILL_T</span><br><span class="line"><span class="keyword">before</span> <span class="keyword">insert</span> <span class="keyword">on</span> HSS_TASK_PAY_BILL</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">each</span> </span><br><span class="line"><span class="keyword">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">     <span class="keyword">select</span>  HSS_TASK_PAY_BILL_S.NEXTVAL <span class="keyword">into</span>:new.TASK_PAYMENT_ID <span class="keyword">from</span> dual;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><blockquote><p>HSS_TASK_PAY_BILL为表名 ，TASK_PAYMENT_ID为需要自增的字段</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Oracle </category>
          
      </categories>
      
      
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebService的简单实现</title>
      <link href="/posts/9c73294c/"/>
      <url>/posts/9c73294c/</url>
      
        <content type="html"><![CDATA[<p>WebService的简单实现</p><a id="more"></a><h1 id="建立Java项目实现服务"><a href="#建立Java项目实现服务" class="headerlink" title="建立Java项目实现服务"></a>建立Java项目实现服务</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.ws;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jws.WebMethod;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebService;</span><br><span class="line"><span class="keyword">import</span> javax.xml.ws.Endpoint;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebService  </span></span><br><span class="line"><span class="comment"> * 将JAVA类标记为实现Web Service。或者将JAVA接口标记定义为Web Service接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> HJW</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@WebService</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello"</span> + name;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebMethod() 指定该方法不公开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@WebMethod</span>(exclude = <span class="keyword">true</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sayHello2</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello2"</span> + name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * publish()参数说明</span></span><br><span class="line"><span class="comment"> * 1：服务器地址</span></span><br><span class="line"><span class="comment"> * 2：服务实现者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Endpoint.publish(<span class="string">"http://192.168.1.104:5678/hello"</span>, <span class="keyword">new</span> HelloService());</span><br><span class="line">System.out.println(<span class="string">"发布成功"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：<br>​    ​    类中必须至少有一个公布的方法，否则发布出错<br>​    </p><h1 id="访问wsdl说明文档"><a href="#访问wsdl说明文档" class="headerlink" title="访问wsdl说明文档"></a>访问wsdl说明文档</h1><p>链接：<a href="http://192.168.1.104:5678/hello?wsdl" target="_blank" rel="noopener">http://192.168.1.104:5678/hello?wsdl</a><br>​<br>​    192.168.1.104为本机IP地址。也可用localhost<br>​    必须指定端口号<br>​    不加?wsdl访问不到</p><h1 id="WSDL文档说明"><a href="#WSDL文档说明" class="headerlink" title="WSDL文档说明"></a>WSDL文档说明</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;service name=&quot;HelloServiceService&quot;&gt;</span><br><span class="line">    &lt;port name=&quot;HelloServicePort&quot; binding=&quot;tns:HelloServicePortBinding&quot;&gt;</span><br><span class="line">        &lt;soap:address location=&quot;http://192.168.1.104:5678/hello&quot;/&gt;</span><br><span class="line">    &lt;/port&gt;</span><br><span class="line">&lt;/service&gt;</span><br></pre></td></tr></table></figure><pre><code>&lt;service name=&quot;HelloServiceService&quot;&gt; 为服务名&lt;port name=&quot;HelloServicePort&quot;&gt;location 为服务地址</code></pre><p>作用：与下方的客户端调用联系<br><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nqb5cpj30hq0aon0s.jpg" alt="这里写图片描述"></p><h1 id="通过WSDL文档生成代码"><a href="#通过WSDL文档生成代码" class="headerlink" title="通过WSDL文档生成代码"></a>通过WSDL文档生成代码</h1><p>cmd 命令： wsimport -s . <a href="http://192.168.1.104:5678/hello?wsdl" target="_blank" rel="noopener">http://192.168.1.104:5678/hello?wsdl</a><br>生成与服务端包结构一样的java文件。可直接使用<br>如不想与服务端包结构一样，可在命令 . 后面加上:  -p 包结构</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.ws;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过wsimport 解析WSDL生成客户端代码调用WebService服务 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> HJW</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">HelloServiceService hss = <span class="keyword">new</span> HelloServiceService();</span><br><span class="line">HelloService hs = hss.getHelloServicePort();</span><br><span class="line">String str = hs.sayHello(<span class="string">"HJW"</span>);</span><br><span class="line">System.out.println(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现客户端的调用 </p>]]></content>
      
      
      <categories>
          
          <category> Webservice </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Webservice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebService原理</title>
      <link href="/posts/9fd8791d/"/>
      <url>/posts/9fd8791d/</url>
      
        <content type="html"><![CDATA[<p>WebService原理介绍</p><a id="more"></a><h2 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h2><pre><code>WebService就是应用程序之间的远程调用调用是跨语言的调用</code></pre><h2 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h2><h3 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h3><pre><code>扩展性标记语言。用于传输格式化的数据，是WEB服务的基础</code></pre><h3 id="WSDL"><a href="#WSDL" class="headerlink" title="WSDL"></a>WSDL</h3><pre><code>WEB服务描述语言。（WebService的使用说明书）通过XML的形式说明服务在什么地方--地址通过XML形式说明服务提供什么样的方法 -- 如何调用</code></pre><h3 id="SOAP"><a href="#SOAP" class="headerlink" title="SOAP"></a>SOAP</h3><pre><code>SOAP作为一个基于XML语言的协议用于网上传输数据SOAP =  在HTTP的基础上 + XML数据SOAP 是基于HTTP的。SOAP的组成 ：Envelope 必须的部分 。以XML的根元素出现;Headers -- 可选的;Body -- 必须的。在body部分包含要执行服务器的方法。和发送到服务器的数据。</code></pre>]]></content>
      
      
      <categories>
          
          <category> Webservice </category>
          
      </categories>
      
      
        <tags>
            
            <tag> web service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell中的重定向</title>
      <link href="/posts/73cfe2ae/"/>
      <url>/posts/73cfe2ae/</url>
      
        <content type="html"><![CDATA[<blockquote><p>这可能是命令行最酷的特性。它叫做 I/O 重定向。”I/O”代表输入/输出， 通过这个工具，你可以重定向命令的输入输出，命令的输入来自文件，而输出也存到文件。 也可以把多个命令连接起来组成一个强大的命令管道。为了展示这个工具，我们将叙述 以下命令：</p></blockquote><a id="more"></a><ul><li><p>cat － 连接文件</p></li><li><p>sort － 排序文本行</p></li><li><p>uniq － 报道或省略重复行</p></li><li><p>grep － 打印匹配行</p></li><li><p>wc － 打印文件中换行符，字，和字节个数</p></li><li><p>head － 输出文件第一部分</p></li><li><p>tail - 输出文件最后一部分</p></li><li><p>tee - 从标准输入读取数据，并同时写到标准输出和文件</p></li></ul><h1 id="标准输入、输出和错误"><a href="#标准输入、输出和错误" class="headerlink" title="标准输入、输出和错误"></a>标准输入、输出和错误</h1><h3 id="重定向标准输出"><a href="#重定向标准输出" class="headerlink" title="重定向标准输出"></a>重定向标准输出</h3><pre><code>[hjw@localhost ~]$ ls -l /home/hjw/ &gt;hjw.txt</code></pre><p>通过 &gt; 号我们可以把ls -l 生产的输出内容写入到hjw.txt文件中，由文件代替屏幕。如果hjw.txt不存在会自动创建这个文件。并且写入到文件都是从开头重写。如果/home/hjw/ 是一个不存在的目录，屏幕上会出现错误信息，并且hjw.txt文件内容会被清空(如果有内容的话)。</p><pre><code>[hjw@localhost ~]$ &gt; hjw.txt</code></pre><p>因此如果我们使用上面的命令，可以很方便的清空一个文件的内容。</p><p>如果我们想在文件末尾添加内容而不是开头重写，我们可以使用 &gt;&gt;</p><pre><code>[hjw@localhost ~]$ ls -l /usr/local &gt;&gt;hjw.txt</code></pre><p>这样使用后，输出内容会添加在hjw.txt末尾，而不是清空文件内容</p><h3 id="重定向标准错误"><a href="#重定向标准错误" class="headerlink" title="重定向标准错误"></a>重定向标准错误</h3><pre><code>[hjw@localhost ~]$ ls -l /home/hj/ 2&gt;hjw_error.txt</code></pre><p>这里的目录是一个不存在的目录，因此会出现错误，我们使用 2&gt; 可以把错误信息写入到 hjw_error.txt中，而不是直接显示到屏幕上</p><h3 id="重定向标准输出与错误到同一个文件"><a href="#重定向标准输出与错误到同一个文件" class="headerlink" title="重定向标准输出与错误到同一个文件"></a>重定向标准输出与错误到同一个文件</h3><pre><code>[hjw@localhost ~]$ ls -l /home/hj/ &gt;hjw.txt 2&gt;&amp;1</code></pre><p>这条命令表示标准输出写入到hjw.txt文件中，标准错误信息写入上一个描述符中，也就是hjw.txt中。所以他们的顺序也不能反过来</p><pre><code>[hjw@localhost ~]$ ls -l /home/hj/ &amp;&gt;hjw.txt </code></pre><p>这条命令与上一条相同，&amp;&gt; 是bash新版本中提供的</p><h3 id="处理不需要的输出"><a href="#处理不需要的输出" class="headerlink" title="处理不需要的输出"></a>处理不需要的输出</h3><pre><code>[hjw@localhost ~]$ ll /home/hj 2&gt; /dev/null</code></pre><p>有时我们不想要一个命令的输出结果，我们可以把它输出到 /dev/null 这个特殊的文件中。这个文件是系统设备，叫作 位存储桶，它可以接受输入，并不对输入作任何操作。我们可以用它来隐藏错误信息</p><h3 id="重定向标准输入"><a href="#重定向标准输入" class="headerlink" title="重定向标准输入"></a>重定向标准输入</h3><pre><code>[hjw@localhost ~]$ cat hjw.txt</code></pre><p>cat 命令可以用来读取一个或多个文件，然后复制它们到标准输出。这条命令会在屏幕上输出hjw.txt的内容。</p><pre><code>[hjw@localhost ~]$ cat </code></pre><p>只输入一个cat命令，我们可以回车直接输入内容。Ctrl + D结束输入。会发现我们之前输入的内容重复出现在屏幕上，因为cat 接收了标准输入并把内容复制到标准输出了</p><pre><code>[hjw@localhost ~]$ cat &gt;hjw2.txt</code></pre><p>我们可以使用Cat来创建一个文件。输入上述命令后回车输入文件内容，Ctrl+ D 结束输入后，我们浏览hjw2.txt ，之前在屏幕中输入的内容已经写入到了文件中。</p><pre><code>[hjw@localhost ~]$ cat &lt;hjw2.txt</code></pre><p>同样的，我们可以将标准输入源改成文件。回车后输出文件内容。</p><h3 id="管道线"><a href="#管道线" class="headerlink" title="管道线"></a>管道线</h3><pre><code>[hjw@localhost ~]$ ls -l /usr/bin | less</code></pre><p>使用管道操作符”|”（竖杠），一个命令的标准输出可以通过管道送至另一个命令的标准输入<br>这个表示将ls输出的内容使用less来浏览。<br>​    </p><h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><pre><code>[hjw@localhost ~]$ ls bin redis-3.2.9/ | sort | less</code></pre><p>把目录/bin 和/redis-3.2.9 中 的可执行程序都联合在一起，再把它们排序，然后浏览执行结果</p><h3 id="uniq-报道或忽略重复行"><a href="#uniq-报道或忽略重复行" class="headerlink" title="uniq - 报道或忽略重复行"></a>uniq - 报道或忽略重复行</h3><pre><code>[hjw@localhost ~]$ ls bin redis-3.2.9/ | sort | uniq | less</code></pre><h3 id="wc-－-打印行数、字数和字节数"><a href="#wc-－-打印行数、字数和字节数" class="headerlink" title="wc － 打印行数、字数和字节数"></a>wc － 打印行数、字数和字节数</h3><pre><code>[hjw@localhost ~]$ ls bin redis-3.2.9/ | sort | uniq | wc -l</code></pre><h3 id="grep-－-打印匹配行"><a href="#grep-－-打印匹配行" class="headerlink" title="grep － 打印匹配行"></a>grep － 打印匹配行</h3><p>grep 是个很强大的程序，用来找到文件中的匹配文本。这样使用 grep 命令：<br>​    [hjw@localhost ~]$ ls bin redis-3.2.9/ | grep conf</p><p>返回ls的结果中包含 conf的记录<br>​    grep -i     忽略大小写<br>​    grep -v     只打印不匹配的行</p><h3 id="head-tail-－-打印文件开头部分-结尾部分"><a href="#head-tail-－-打印文件开头部分-结尾部分" class="headerlink" title="head / tail － 打印文件开头部分/结尾部分"></a>head / tail － 打印文件开头部分/结尾部分</h3><p>有时我们不需要文件的所有内容，只需要开头或结尾的几行<br>​<br>​    [hjw@localhost ~]$ ls bin redis-3.2.9/ | tail</p><p>查看ls结果的结尾十行。head 与 tail 默认都是十行。可以自己指定显示几行<br>​<br>​    [hjw@localhost ~]$ ls bin redis-3.2.9/ | head -n 5<br>显示开头的前五行</p><pre><code>[hjw@localhost ~]$ head -n 2 hjw.txt</code></pre><p>显示hjw.txt文件的前2行</p><pre><code>[hjw@localhost ~]$ tail -f hjw.txt</code></pre><p>tail -f 可以监测文件的变动。执行命令后，如果hjw.txt有新内容添加时，会实时的显示在屏幕中<br>​    </p><h3 id="tee-－-从-Stdin-读取数据，并同时输出到-Stdout-和文件"><a href="#tee-－-从-Stdin-读取数据，并同时输出到-Stdout-和文件" class="headerlink" title="tee － 从 Stdin 读取数据，并同时输出到 Stdout 和文件"></a>tee － 从 Stdin 读取数据，并同时输出到 Stdout 和文件</h3><pre><code>[hjw@localhost ~]$ ls redis-3.2.9/ | tee ls.txt | grep conf</code></pre><p>tee 程序从标准输入读入数据，并且同时复制数据 到标准输出（允许数据继续随着管道线流动）和一个或多个文件。这里我们在过虑之前把 redis-3.2.9目录内容捕捉到ls.txt中</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell归档与备份</title>
      <link href="/posts/621227ea/"/>
      <url>/posts/621227ea/</url>
      
        <content type="html"><![CDATA[<p>将会介绍以下命令：</p><a id="more"></a><ul><li>gzip – 压缩或者展开文件</li><li>bzip2 – 块排序文件压缩器</li></ul><p>归档程序：</p><ul><li><p>tar – 磁带打包工具</p></li><li><p>zip – 打包和压缩文件</p></li></ul><p>还有文件同步程序：</p><ul><li>rsync – 同步远端文件和目录</li></ul><h2 id="压缩文件"><a href="#压缩文件" class="headerlink" title="压缩文件"></a>压缩文件</h2><pre><code>[hjw@localhost ~]$ less hjw.txt[hjw@localhost ~]$ ls -l hjw.txt-rw-rw-r--. 1 hjw hjw 1054 9月  25 19:45 hjw.txt[hjw@localhost ~]$ gzip hjw.txt[hjw@localhost ~]$ lsbin  bin.txt  hello.txt  hjw2.txt  hjw_error.txt  hjw.txt.gz  ls.txt  redis-3.2.9[hjw@localhost ~]$ ls -l hjw.txt*-rw-rw-r--. 1 hjw hjw 349 9月  25 19:45 hjw.txt.gz[hjw@localhost ~]$ gunzip hjw.txt.gz [hjw@localhost ~]$ lsbin  bin.txt  hello.txt  hjw2.txt  hjw_error.txt  hjw.txt  ls.txt  redis-3.2.9[hjw@localhost ~]$ less hjw.txt [hjw@localhost ~]$ ls -l hjw.txt -rw-rw-r--. 1 hjw hjw 1054 9月  25 19:45 hjw.txt</code></pre><p>hjw.txt文件中是一些目录列表，我们可以看到刚开始它的大小为1054，压缩后原文件被压缩文件替换了，大小也变小了。再解压原文件替换压缩文件，大小恢复原来的大小，文件内容不会变。并且他们的权限与时间戳也不会变化。</p><h3 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h3><p>还有一些可选参数：</p><pre><code>-c    把输出写入到标准输出，并且保留原始文件。也有可能用--stdout 和--to-stdout 选项来指定。-d    解压缩。正如 gunzip 命令一样。也可以用--decompress 或者--uncompress 选项来指定.-f    强制压缩，即使原始文件的压缩文件已经存在了，也要执行。也可以用--force 选项来指定。-h    显示用法信息。也可用--help 选项来指定。-l    列出每个被压缩文件的压缩数据。也可用--list 选项。-r    若命令的一个或多个参数是目录，则递归地压缩目录中的文件。也可用--recursive 选项来指定。-t    测试压缩文件的完整性。也可用--test 选项来指定。-v    显示压缩过程中的信息。也可用--verbose 选项来指定。-number    设置压缩指数。number 是一个在1（最快，最小压缩）到9（最慢，最大压缩）之间的整数。 数值1和9也可以各自用--fast 和--best 选项来表示。默认值是整数6。</code></pre><p>可以与管道配合来使用</p><pre><code>[hjw@localhost ~]$ ls -l | gzip &gt; hjw.txt.gz</code></pre><p>这里将ls的标准输出内容压缩到了hjw.txt.gz文件中<br>如果我们只想查看压缩文件的内容而不想解压它可以使用命令：</p><pre><code>[hjw@localhost ~]$ gunzip -c hjw.txt.gz | less或者是[hjw@localhost ~]$ zcat hjw.txt.gz  | less</code></pre><h2 id="归档文件"><a href="#归档文件" class="headerlink" title="归档文件"></a>归档文件</h2><h2 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h2><blockquote><p>我们经常看到扩展名为 .tar 或者 .tgz 的文件，它们各自表示“普通” 的 tar 包和被 gzip 程序压缩过的 tar 包。一个 tar 包可以由一组独立的文件，一个或者多个目录，或者 两者混合体组成。<br>语法：</p></blockquote><pre><code>tar mode[options] pathname...mode是它的模式，首先需要指定模式再加选项</code></pre><h3 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h3><pre><code>c    为文件和／或目录列表创建归档文件。x    抽取归档文件。r    追加具体的路径到归档文件的末尾。t    列出归档文件的内容。</code></pre><h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><p>-A或–catenate：新增文件到以存在的备份文件；<br>-B：设置区块大小；<br>-c或–create：建立新的备份文件；<br>-C 目录：这个选项用在解压缩，若要在特定目录解压缩，可以使用这个选项。<br>-d：记录文件的差别；<br>-x或–extract或–get：从备份文件中还原文件；<br>-t或–list：列出备份文件的内容；<br>-z或–gzip或–ungzip：通过gzip指令处理备份文件；<br>-Z或–compress或–uncompress：通过compress指令处理备份文件；<br>-f备份文件或–file=备份文件：指定备份文件；<br>-v或–verbose：显示指令执行过程；<br>-r：添加文件到已经压缩的文件；<br>-u：添加改变了和现有的文件到已经存在的压缩文件；<br>-j：支持bzip2解压文件；<br>-v：显示操作过程；<br>-l：文件系统边界设置；<br>-k：保留原有文件不覆盖；<br>-m：保留文件不被覆盖；<br>-w：确认压缩文件的正确性；<br>-p或–same-permissions：用原来的文件权限还原文件；<br>-P或–absolute-names：文件名使用绝对名称，不移除文件名称前的“/”号；<br>-N 日期格式 或 –newer=日期时间：只将较指定日期更新的文件保存到备份文件里；<br>–exclude=范本样式：排除符合范本样式的文件。</p><p>解压缩 </p><pre><code>tar -xvf /tmp/mdm_installer/apache-tomcat-9.0.0.M26.tar.gz -C /usr/local/</code></pre><p>打包与压缩</p><pre><code>仅打包，不压缩[hjw@localhost ~]$ tar -cvf hjw.tar hjw2.txt hjw_error.txt  打包后，以gzip压缩[hjw@localhost ~]$ tar -zcvf hjw.tar.gz hjw2.txt hjw_error.txt  查看打包压缩的内容[hjw@localhost ~]$ tar -ztvf hjw.tar.gz  从打包压缩的文件中解压单个文件出来[hjw@localhost ~]$ tar -zxvf hjw.tar.gz hjw2.txt   </code></pre><p>##同步文件和目录</p><blockquote><p>rsync 程序能同步本地与远端的目录，通过使用 rsync 远端更新协议，此协议 允许 rsync 快速地检测两个目录的差异，执行最小量的复制来达到目录间的同步。比起其它种类的复制程序， 这就使 rsync 命令非常快速和高效。<br>语法：</p></blockquote><pre><code>rsync 选项 源 目标</code></pre><p>其中源 与 目标是为下列三种选项之一：</p><ul><li>一个本地文件或目录</li><li>一个远端文件或目录，以[user@]host:path 的形式存在</li><li>一个远端 rsync 服务器，由 rsync://[user@]host[:port]/path 指定</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell进程管理</title>
      <link href="/posts/9b2cc92/"/>
      <url>/posts/9b2cc92/</url>
      
        <content type="html"><![CDATA[<p>进程是怎样工作的？</p><blockquote><p>当系统启动的时候，内核先把一些它自己的程序初始化为进程，然后运行一个叫做 init 的程序。init， 依次地，再运行一系列的称为 init 脚本的 shell 脚本（位于/etc），它们可以启动所有的系统服务。 其中许多系统服务以守护（daemon）程序的形式实现，守护程序仅在后台运行，没有任何用户接口。 这样，即使我们没有登录系统，至少系统也在忙于执行一些例行事务</p></blockquote><a id="more"></a><p>将介绍下面这些命令：</p><ul><li><p>ps – 报告当前进程快照</p></li><li><p>top – 显示任务</p></li><li><p>jobs – 列出活跃的任务</p></li><li><p>bg – 把一个任务放到后台执行</p></li><li><p>fg – 把一个任务放到前台执行</p></li><li><p>kill – 给一个进程发送信号</p></li><li><p>killall – 杀死指定名字的进程</p></li><li><p>shutdown – 关机或重启系统</p></li></ul><h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><pre><code>[hjw@localhost ~]$ ps</code></pre><p>单独ps命令会列出与当前终端会话相关的进程情况 </p><pre><code>[hjw@localhost ~]$ ps aux</code></pre><p>这个选项组合，能够显示属于每个用户的进程信息</p><pre><code>[hjw@localhost ~]$ top</code></pre><p>top可以动态的查看进程</p><pre><code>[hjw@localhost ~]$ kill pid</code></pre><p>杀死一个进程 (pid)</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell 展开</title>
      <link href="/posts/ec271926/"/>
      <url>/posts/ec271926/</url>
      
        <content type="html"><![CDATA[<p>shell 展开</p><a id="more"></a><h2 id="字符展开"><a href="#字符展开" class="headerlink" title="字符展开"></a>字符展开</h2><pre><code>[hjw@localhost bin]$ echo *</code></pre><p>输出~目录下的文件</p><!--more--><h2 id="路径名展开"><a href="#路径名展开" class="headerlink" title="路径名展开"></a>路径名展开</h2><pre><code>[hjw@localhost redis-3.2.9]$ echo r*</code></pre><p>命令会列出redis-3.2.9目录下的所有r开头的文件</p><h2 id="算术表达式展开"><a href="#算术表达式展开" class="headerlink" title="算术表达式展开"></a>算术表达式展开</h2><pre><code>[hjw@localhost ~]$ echo $((2+2))</code></pre><p>可以直接进行算术运算</p><h2 id="花括号展开"><a href="#花括号展开" class="headerlink" title="花括号展开"></a>花括号展开</h2><p>这个命令会根据花括号中的值来创建多个字符串</p><pre><code>[hjw@localhost ~]$ echo Front-{A,B，C}-Back输出结果:Front-A-Back Front-B，C-Back</code></pre><p>这个命令使用了 .. 符号<br>​    [hjw@localhost ~]$ echo Number_{1..5}<br>​    输出结果：<br>​    Number_1 Number_2 Number_3 Number_4 Number_5<br>​<br>还可以进行花括号嵌套</p><pre><code>[hjw@localhost ~]$ echo a{A{1,2},B{3,4},C}b输出结果:aA1b aA2b aB3b aB4b aCb</code></pre><p>利用这个特性，我们可以创建一系列规则相同的文件名</p><pre><code>[hjw@localhost ~]$ mkdir {2007..2009}-0{1..9}会创建如下规则的文件夹：2007-01  2007-05  2007-09  2008-04  2008-08  2009-03  2009-07 2007-02  2007-06  2008-01  2008-05  2008-09  2009-04  2009-08 2007-03  2007-07  2008-02  2008-06  2009-01  2009-05  2009-09</code></pre><h2 id="命令替换"><a href="#命令替换" class="headerlink" title="命令替换"></a>命令替换</h2><blockquote><p>命令替换允许我们把一个命令的输出作为一个展开模式来使用</p></blockquote><pre><code>[hjw@localhost ~]$ ls -l $(which cp)输出结果:-rwxr-xr-x. 1 root root 155168 11月  6 2016 /usr/bin/cp与下面这条命令相同：[hjw@localhost ~]$ ls -l /usr/bin/cp</code></pre><p>这样我们可以在不知道文件夹路径的情况下直接看到文件夹信息</p><h2 id="单双引号对比"><a href="#单双引号对比" class="headerlink" title="单双引号对比"></a>单双引号对比</h2><pre><code>[hjw@localhost ~]$ echo text ~/*2.txt {a,b} $(echo foo) $((2+2)) $USERtext /home/hjw/hjw2.txt a b foo 4 hjw[hjw@localhost ~]$ echo &quot;text ~/*2.txt {a,b} $(echo foo) $((2+2)) $USER&quot;text ~/*2.txt {a,b} foo 4 hjw[hjw@localhost ~]$ echo &apos;text ~/*2.txt {a,b} $(echo foo) $((2+2)) $USER&apos;text ~/*2.txt {a,b} $(echo foo) $((2+2)) $USER</code></pre><p>单引号会禁止所有展开</p><h2 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h2><pre><code>[hjw@localhost ~]$ echo &quot;The balance for user $USER is: \$5.00&quot;</code></pre><p>这里有选择的阻止上$5的展开。如果不使用 \ $5会被当作一个为空的变量</p><h1 id="常见转义字符"><a href="#常见转义字符" class="headerlink" title="常见转义字符"></a>常见转义字符</h1><pre><code>\a    响铃（”警告”－导致计算机嘟嘟响）\b    退格符\n    新的一行。在类 Unix 系统中，产生换行。\r    回车符\t    制表符</code></pre><p>echo 加上一个 e 参数就可以解析转义字符 </p><pre><code>[hjw@localhost ~]$ echo -e &quot;Time&apos;s up \a&quot;</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell基础命令</title>
      <link href="/posts/7976013b/"/>
      <url>/posts/7976013b/</url>
      
        <content type="html"><![CDATA[<p>shell基础命令</p><a id="more"></a><h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><ul><li>pwd — 打印出当前工作目录名</li><li>cd — 更改目录</li><li>ls — 列出目录内容</li></ul><hr><p><em>快捷键</em></p><pre><code>cd        更改工作目录到你的家目录 cd    -   更改工作目录到你的家目录cd    ~user_name  更改工作目录到你的家目录</code></pre><hr><ul><li>less filename     浏览文件</li><li>file filename     确定文件类型</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell基础</title>
      <link href="/posts/82c8cab7/"/>
      <url>/posts/82c8cab7/</url>
      
        <content type="html"><![CDATA[<h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello World !"</span></span><br></pre></td></tr></table></figure><blockquote><p>“#!” 是一个约定的标记，它告诉系统这个脚本需要什么解释器来执行，即使用哪一种Shell。echo命令用于向窗口输出文本。</p></blockquote><a id="more"></a><p>作为可执行程序</p><p>将上面的代码保存为test.sh，并 cd 到相应目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x ./test.sh  <span class="comment">#使脚本具有执行权限</span></span><br><span class="line">./test.sh  <span class="comment">#执行脚本</span></span><br></pre></td></tr></table></figure></p><p>定义变量： variableName=”value”<br>使用变量： your_name=”mozhiyan” echo $your_name</p><p>删除变量： unset variable_name<br>变量类型：局部变量、环境变量、shell变量<br>Shell特殊变量：Shell 0,#, ∗,@, ?,$和命令行参数<br>Shell替换：Shell变量替换，命令替换，转义字符<br>\ 反斜杠<br>\a 警报，响铃<br>\b 退格（删除键）<br>\f 换页(FF)，将当前位置移到下页开头<br>\n 换行<br>\r 回车<br>\t 水平制表符（tab键）<br>\v 垂直制表符 </p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell 脚本简介</title>
      <link href="/posts/941a552f/"/>
      <url>/posts/941a552f/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Unix/Linux上常见的Shell脚本解释器有bash、sh、csh、ksh等，习惯上把它们称作一种Shell。我们常说有多少种Shell，其实说的是Shell脚本解释器。</p></blockquote><a id="more"></a><h2 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h2><blockquote><p>bash是Linux标准默认的shell，本教程也基于bash讲解。bash由Brian Fox和Chet Ramey共同完成，是BourneAgain Shell的缩写，内部命令一共有40个。</p></blockquote><hr><p>Linux使用它作为默认的shell是因为它有诸如以下的特色：<br>可以使用类似DOS下面的doskey的功能，用方向键查阅和快速输入并修改命令。<br>自动通过查找匹配的方式给出以某字符串开头的命令。<br>包含了自身的帮助功能，你只要在提示符下面键入help就可以得到相关的帮助。</p><hr><h2 id="sh"><a href="#sh" class="headerlink" title="sh"></a>sh</h2><blockquote><p>sh 由Steve Bourne开发，是Bourne Shell的缩写，sh 是Unix 标准默认的shell。</p></blockquote><h2 id="ash"><a href="#ash" class="headerlink" title="ash"></a>ash</h2><blockquote><p>ash shell 是由Kenneth Almquist编写的，Linux中占用系统资源最少的一个小shell，它只包含24个内部命令，因而使用起来很不方便。</p></blockquote><h2 id="csh"><a href="#csh" class="headerlink" title="csh"></a>csh</h2><blockquote><p>csh 是Linux比较大的内核，它由以William Joy为代表的共计47位作者编成，共有52个内部命令。该shell其实是指向/bin/tcsh这样的一个shell，也就是说，csh其实就是tcsh。</p></blockquote><h2 id="ksh"><a href="#ksh" class="headerlink" title="ksh"></a>ksh</h2><blockquote><p>ksh 是Korn shell的缩写，由Eric Gisin编写，共有42条内部命令。该shell最大的优点是几乎和商业发行版的ksh完全兼容，这样就可以在不用花钱购买商业版本的情况下尝试商业版本的性能了。</p></blockquote><blockquote><p>注意：bash是 Bourne Again Shell 的缩写，是linux标准的默认shell ，它基于Bourne shell，吸收了C shell和Korn shell的一些特性。bash完全兼容sh，也就是说，用sh写的脚本可以不加修改的在bash中执行。</p></blockquote><blockquote><p>因为Shell似乎是各UNIX系统之间通用的功能，并且经过了POSIX的标准化。因此，Shell脚本只要“用心写”一次，即可应用到很多系统上。因此，之所以要使用Shell脚本是基于：</p><ul><li>简单性：Shell是一个高级语言；通过它，你可以简洁地表达复杂的操作。</li><li>可移植性：使用POSIX所定义的功能，可以做到脚本无须修改就可在不同的系统上执行。</li><li>开发容易：可以在短时间内完成一个功能强大又妤用的脚本。</li></ul></blockquote><blockquote><p>但是，考虑到Shell脚本的命令限制和效率问题，下列情况一般不使用Shell：</p></blockquote><pre><code>资源密集型的任务，尤其在需要考虑效率时（比如，排序，hash等等）。需要处理大任务的数学操作，尤其是浮点运算，精确运算，或者复杂的算术运算（这种情况一般使用C++或FORTRAN 来处理）。有跨平台（操作系统）移植需求（一般使用C 或Java）。复杂的应用，在必须使用结构化编程的时候（需要变量的类型检查，函数原型，等等）。对于影响系统全局性的关键任务应用。对于安全有很高要求的任务，比如你需要一个健壮的系统来防止入侵、破解、恶意破坏等等。项目由连串的依赖的各个部分组成。需要大规模的文件操作。需要多维数组的支持。需要数据结构的支持，比如链表或数等数据结构。需要产生或操作图形化界面 GUI。需要直接操作系统硬件。需要 I/O 或socket 接口。需要使用库或者遗留下来的老代码的接口。私人的、闭源的应用（shell 脚本把代码就放在文本文件中，全世界都能看到）。</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部分常用命令 二</title>
      <link href="/posts/83be29ff/"/>
      <url>/posts/83be29ff/</url>
      
        <content type="html"><![CDATA[<p>Linux部分常用命令 二</p><a id="more"></a><h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><pre><code>adduser &lt;用户名&gt;   添加用户passwd &lt;用户名&gt;    修改密码su &lt;用户名&gt;    登陆用户usermod redis –G redis  改变redis用户的群组到redis组</code></pre><!--more--><h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><pre><code>chmod u+w &lt;文件路径&gt;    给该文件赋予写权限chmod u-w &lt;文件路径&gt;    取消该文件的写权限chmod 755 -R &lt;文件路径&gt; 给文件及其下文件赋予755权限参数：    -R  遍历文件下的子文件及其文件夹都赋予该权限    755        第一个数字表示文件所有者的权限        第二个数字表示与文件所有者同属一个用户组的其他用户的权限        第三个数字表示其他用户组的权限        权限分为三种：读(r=4),写(w=2),执行(x=1)。综合起来还有可读可执行(rx=4+1=5)、可读可写(rw=4+2=6)、可读可写可执行(rwx=4+2+1=7)        所以，chmod 755 设置用户的权限为：        1、文件所有都可读可写可执行      --7        2、与文件所有者同属一个用户组的其他用户可读可执行       --5        3、其它用户组可读可执行        --5chown -R redis:redis &lt;文件路径&gt;         修改文件及其下子文件的所有者</code></pre><h2 id="系统"><a href="#系统" class="headerlink" title="系统"></a>系统</h2><pre><code>sudo systemctl daemon-reload                重新加载服务sudo systemctl enable redis                 设置redis服务开机自启动shutdown -h now                             立即关机shutdown -h 20:25                           系统在今天的 20:25 分会关机shutdown -r now                             立即重启添加端口firewall-cmd --zone=public --add-port=80/tcp --permanent    （--permanent永久生效，没有此参数重启后失效）重新载入firewall-cmd --reloadCentos7关闭防火墙systemctl stop firewalld.service查看防火墙状态firewall-cmd --state查看firewall-cmd --zone=public --query-port=80/tcp删除firewall-cmd --zone=public --remove-port=80/tcp --permanentdu -sh *                                查看当前目录的空间占用情况uname －a                                查看版本及内核信息cat /proc/version                         查看当前操作系统版本信息cat /etc/issue  或cat /etc/redhat-release（Linux查看版本当前操作系统发行版信息）cat /proc/cpuinfo （Linux查看cpu相关信息，包括型号、主频、内核信息等）</code></pre><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><pre><code>touch       新建文件tar -xvf &lt;文件路径&gt;  -C &lt;解压到的路径&gt;       文件解压命令 cat &lt;文件&gt;  直接输出文件内容到窗口中rmdir &lt;文件夹&gt; 删除文件夹(须为空文件夹)rmdir {b,c}     删除b,c两个空文件夹rm -rf &lt;文件夹&gt;        强制删除文件夹包括其子文件夹(慎用 ！！)-r 就是向下递归，不管有多少级目录，一并删除-f 就是直接强行删除，不作任何提示的意思cp -r &lt;文件或文件夹&gt;  &lt;复制到的路径&gt;   复制一个文件或目录到指定路径中find [查找路径] [查找条件] [处理动作] 查找某个文件find . -name &quot;filename*.*&quot;   .表示当前目录mkdir     创建一个目录mkdir -p     创建多级目录mkdir {a,b,c}     创建a,b,c三个目录查看文件或文件夹的磁盘使用空间du -h --max-depth=1 your_dest_dir</code></pre><h3 id="tail"><a href="#tail" class="headerlink" title="tail"></a>tail</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail [ -f ] [ -c Number | -n Number | -m Number | -b Number | -k Number ] [ File ]</span><br></pre></td></tr></table></figure><blockquote><p>参数解释：<br>-f 该参数用于监视File文件增长。<br>-c Number 从 Number 字节位置读取指定文件<br>-n Number 从 Number 行位置读取指定文件。<br>-m Number 从 Number 多字节字符位置读取指定文件，比方你的文件假设包括中文字，假设指定-c参数，可能导致截断，但使用-m则会避免该问题。<br>-b Number 从 Number 表示的512字节块位置读取指定文件。<br>-k Number 从 Number 表示的1KB块位置读取指定文件。<br>File 指定操作的目标文件名称<br>上述命令中，都涉及到number，假设不指定，默认显示10行。Number前面可使用正负号，表示该偏移从顶部还是从尾部開始计算。<br>tail可运行文件一般在/usr/bin/以下</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring-loaded实现热部署-开发环境</title>
      <link href="/posts/66217f64/"/>
      <url>/posts/66217f64/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Oracle提供的JDK其实已经自带一定程度的热加载功能，但是如果你修改了类名，方法名，或者添加了新类，新方法的话。Tomcat都需要重新启动来使得刚才的更改生效。而JRebel和spring-loaded都能有效地解决这个问题。其中springloaded是开源软件，可以免费使用。其主页：<a href="https://github.com/spring-projects/spring-loaded" target="_blank" rel="noopener">https://github.com/spring-projects/spring-loaded</a></p></blockquote><a id="more"></a><h2 id="获取jar包"><a href="#获取jar包" class="headerlink" title="获取jar包"></a>获取jar包</h2><blockquote><p>首先我们需要得到spring-loaded的jar包，上面的github链接中可以下载到。这里我用的是最新的springloaded-1.2.7.RELEASE.jar</p><p>存放位置：D:\springloaded-1.2.7.RELEASE.jar</p></blockquote><h2 id="IDE中部署"><a href="#IDE中部署" class="headerlink" title="IDE中部署"></a>IDE中部署</h2><blockquote><p>打开项目，在启动之前按以下进行配置</p></blockquote><h3 id="idea中"><a href="#idea中" class="headerlink" title="idea中"></a>idea中</h3><p>在启动Tomcat之前配置VM option。填写以下参数：<br>​<br>​    -javaagent:D:/springloaded-1.2.7.RELEASE.jar -noverify</p><p>其中参数中Springloaded的路径按实际填写</p><p><img src="http://i1.bvimg.com/608383/957314366cb70661s.png" alt="Markdown"></p><p>配置完成后可以启动项目了</p><hr><h3 id="eclipse中"><a href="#eclipse中" class="headerlink" title="eclipse中"></a>eclipse中</h3><p>右击项目-&gt;Run as-&gt;Run configurations… 在tomcat启动项添加VM参数<br>​<br>​    -javaagent:D:/springloaded-1.2.7.RELEASE.jar -noverify</p><p>其中参数中Springloaded的路径按实际填写</p><p><img src="http://i4.bvimg.com/608383/3e354d4709cf930cs.png" alt="Markdown"></p><p>配置完成后可以启动项目了</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote><p>为了解Springloaded 适用于哪些更改，下面来作几个测试</p></blockquote><hr><blockquote><p>我在上述启动的SSM项目中，在一个控制器里<strong>添加</strong>了以下方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试SpringLoaded</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello Spring Loaded!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>保存后通过浏览器访问失败，找不到/hello 这个路径。通过重启Tomcat后可以正常访问test方法</p><hr><blockquote><p><strong>继续添加test2()方法，不使用注解</strong>，为了在浏览器中方便测试，通过test()方法来访问test2()方法。（经过上面重启Tomcat后test方法可以访问）</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试SpringLoaded</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.test2();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">"Spring Loaded By Test2"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>浏览器输出</em></p><p>​    “Spring Loaded By Test2”</p><blockquote><p>说明我们添加的第二个方法test2()没有经过重启服务器就可以访问了，热部署生效</p></blockquote><hr><blockquote><p>我们继续 <strong>新建一个类</strong>，并在test()方法中去调用</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**新建类</span></span><br><span class="line"><span class="comment"> * Created by JiangWei.Huang</span></span><br><span class="line"><span class="comment"> * 2017/8/22 0022.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCtrl</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/hello3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"TestCtrl-test3"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**修改test方法调用新建的类TestCtr中的test3方法</span></span><br><span class="line"><span class="comment"> * 测试SpringLoaded</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">   TestCtrl testCtrl = <span class="keyword">new</span> TestCtrl();</span><br><span class="line">   <span class="keyword">return</span> testCtrl.test3();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>浏览器输出</strong></p><p>​    “TestCtrl-test3”</p><blockquote><p>说明我们新建的类，在不用重启的情况下也能够被调用到了，热部署生效</p><p>但值得注意的是，我们新建的类中，在类上与方法上都写了Spring注解，但这里是也不生效的。@RestController这个注解没有生效，/hello3这个路径也是访问不了的。需要重启服务器才生效</p><p>另外在Idea中修改后自动保存但不会自动重新编译，如果在Idea中修改后热部署没有生效，按ctrl+shift+f9重新编译。也可以设置Idea自动编译，设置如下图。</p><p><img src="http://i4.bvimg.com/608383/aee36cfab3a965e7s.png" alt="Markdown"></p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>经过上面的测试我们可以得出一些结论。像官方所说，可以实现以下的热更新</p><blockquote><p>Spring Loaded allows you to add/modify/delete methods/fields/constructors. The annotations on types/methods/fields/constructors can also be modified and it is possible to add/remove/change values in enum types.</p><p>Spring加载允许您添加/修改/删除/字段/方法构造函数。注释类型/方法/字段/构造函数，并且还可以在枚举类型中添加/删除/更改值。</p></blockquote><p>但是对于第三方像是Spring注解这些的修改，spring-loaded就无能为力了，必须求助于更加强大的，收费的JRebel了</p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springload </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>error double free or corruption</title>
      <link href="/posts/edbdc617/"/>
      <url>/posts/edbdc617/</url>
      
        <content type="html"><![CDATA[<blockquote><p>自己在虚拟机是捣鼓ubuntu。之前搭建了Java Web的运行环境。第二天发现环境正常，但apt-get update 或者wget url 时会报一大堆错误，好像是内存问题。在这记录一下，以免今后又遇到忘了。</p></blockquote><a id="more"></a><p>错误里有一句这样的话，可以试试下面的方法：</p><pre><code>error in &apos;appstreamcli&apos;:double free or corruption</code></pre><p>方法：<br>分别运行下面三个命令就正常了</p><pre><code>~    #:sudo pkill -KILL appstreamcli~    #:wget -P /tmp https://launchpad.net/ubuntu/+archive/primary/+files/appstream_0.9.4-1ubuntu1_amd64.debhttps://launchpad.net/ubuntu/+archive/primary/+files/libappstream3_0.9.4-1ubuntu1_amd64.deb ~    #:sudo dpkg -i /tmp/appstream_0.9.4-1ubuntu1_amd64.deb /tmpbappstream3_0.9.4-1ubuntu1_amd64.deb</code></pre><p>​    </p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 中Aop处理请求</title>
      <link href="/posts/681a0f1c/"/>
      <url>/posts/681a0f1c/</url>
      
        <content type="html"><![CDATA[<p> SpringBoot 中Aop处理请求</p><a id="more"></a><h2 id="配置AOP"><a href="#配置AOP" class="headerlink" title="配置AOP"></a>配置AOP</h2><ul><li><p>添加POM依赖</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li><p>新建类</p><blockquote><p>只需使用@Aspect注解。再加上@Component 表示此类为Spring管理组件</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpAspect</span> </span>&#123;</span><br><span class="line"><span class="comment">//日志管理</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(HttpAspect.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>配置切入点方法</p><blockquote><p>在上面新建的类中写如下方法，配置AOP的切入点。</p><p>public <em> com.hjw.controller.GrilController.</em>(..) 表示GrilController下的所有方法</p><p>public * com.hjw.controller.GrilController.addGril(..) 则表示GrilController 下的addGril()方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"execution(public * com.hjw.controller.GrilController.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span></span>&#123;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>配置AOP处理请求方法</p><ul><li><p>doBefore()</p><blockquote><p>在进入切点之前处理请求。获取请求的url,ip,类方法与参数等信息</p></blockquote></li><li><p>doAfter()</p><blockquote><p>在进入切点之后执行日志打印操作</p></blockquote></li><li><p>doAfterReturn()</p><blockquote><p>获取切点方法返回的值，并通过日志打印出来</p></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span>(<span class="string">"log()"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">(JoinPoint joinPoint)</span></span>&#123;</span><br><span class="line">       <span class="comment">//获取请求信息</span></span><br><span class="line">       ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">       HttpServletRequest request = attributes.getRequest();</span><br><span class="line">       <span class="comment">//获取URL</span></span><br><span class="line">       logger.info(<span class="string">"url=&#123;&#125;"</span>,request.getRequestURL());</span><br><span class="line">       <span class="comment">//获取IP</span></span><br><span class="line">       logger.info(<span class="string">"ip=&#123;&#125;"</span>,request.getRemoteAddr());</span><br><span class="line">       <span class="comment">//获取类方法</span></span><br><span class="line">       logger.info(<span class="string">"class_method=&#123;&#125;"</span>, joinPoint.getSignature().getDeclaringTypeName() +<span class="string">"."</span>+ joinPoint.getSignature().getName());</span><br><span class="line">       <span class="comment">//获取参数</span></span><br><span class="line">       logger.info(<span class="string">"args=&#123;&#125;"</span>,joinPoint.getArgs());</span><br><span class="line">       logger.info(<span class="string">"添加数据之前"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@After</span>(<span class="string">"log()"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfter</span><span class="params">()</span></span>&#123;</span><br><span class="line">       logger.info(<span class="string">"添加数据之后"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@AfterReturning</span>(returning = <span class="string">"object"</span>,pointcut = <span class="string">"log()"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterReturn</span><span class="params">(Object object)</span></span>&#123;</span><br><span class="line">       logger.info(<span class="string">"return=&#123;&#125;"</span>, object.toString());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 事务管理</title>
      <link href="/posts/32c6c859/"/>
      <url>/posts/32c6c859/</url>
      
        <content type="html"><![CDATA[<p>SpringBoot 事务管理</p><a id="more"></a><h1 id="SpringBoot-事务管理"><a href="#SpringBoot-事务管理" class="headerlink" title="SpringBoot 事务管理"></a>SpringBoot 事务管理</h1><p>在需要事务处理的方法上加上注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br></pre></td></tr></table></figure><blockquote><p>一般在增册改操作时需要事务管理</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 数据库操作 下</title>
      <link href="/posts/d4c653e4/"/>
      <url>/posts/d4c653e4/</url>
      
        <content type="html"><![CDATA[<p>SpringBoot 数据库操作 下</p><a id="more"></a><h2 id="新建DTO接口"><a href="#新建DTO接口" class="headerlink" title="新建DTO接口"></a>新建DTO接口</h2><blockquote><p>新建DTO接口并继承JpaRepository。 指定操作的类与ID的类型</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GrilDto</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Gril</span>,<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义方法。</span></span><br><span class="line"><span class="comment">     * 通过年龄字段来查询</span></span><br><span class="line"><span class="comment">     * 方法名只能按一定的格式来写才能被识别执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> age</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Gril&gt; <span class="title">findByAge</span><span class="params">(Integer age)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="表的CURD"><a href="#表的CURD" class="headerlink" title="表的CURD"></a>表的CURD</h2><blockquote><p>我们先新建一个GrilController .在控制器中自动注入Dto接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrilController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GrilDto grilDto;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找所有数据</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/grilList"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Gril&gt; <span class="title">girlList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  grilDto.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加一条数据</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/addGril"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Gril <span class="title">addGril</span><span class="params">(String cupSize,Integer age)</span></span>&#123;</span><br><span class="line">        Gril gril = <span class="keyword">new</span> Gril();</span><br><span class="line">        gril.setCupSize(cupSize);</span><br><span class="line">        gril.setAge(age);</span><br><span class="line">        <span class="keyword">return</span>  grilDto.save(gril);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过ID查询一条数据</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/getGril/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Gril <span class="title">getGrilById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> grilDto.findOne(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新一条数据</span></span><br><span class="line">    <span class="meta">@PutMapping</span>(value = <span class="string">"/updateGril/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Gril <span class="title">updateGril</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id, String cupSize, Integer age)</span>&#123;</span><br><span class="line"></span><br><span class="line">        Gril gril = <span class="keyword">new</span> Gril();</span><br><span class="line">        gril.setId(id);</span><br><span class="line">        gril.setAge(age);</span><br><span class="line">        gril.setCupSize(cupSize);</span><br><span class="line">        <span class="keyword">return</span> grilDto.save(gril);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除一条数据</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(value = <span class="string">"/delGril/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delGril</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">        grilDto.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据年龄来查找</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getGrilByAge/&#123;age&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Gril&gt; <span class="title">getGrilByAge</span><span class="params">(@PathVariable(<span class="string">"age"</span>)</span> Integer age)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> grilDto.findByAge(age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 数据库操作 上</title>
      <link href="/posts/a3c16372/"/>
      <url>/posts/a3c16372/</url>
      
        <content type="html"><![CDATA[<p>SpringBoot 数据库操作 上</p><a id="more"></a><h2 id="添加组件"><a href="#添加组件" class="headerlink" title="添加组件"></a>添加组件</h2><blockquote><p>在pom.xml中添加数据库操作需要的组件</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>添加以下配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line"><span class="attr">  driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">  url:</span> <span class="attr">jdbc:mysql://127.0.0.1:3306/dbgril</span></span><br><span class="line"><span class="attr">  username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  password:</span> <span class="string">tiger</span></span><br><span class="line"><span class="attr">jpa:</span></span><br><span class="line"><span class="attr">  hibernate:</span></span><br><span class="line"><span class="attr">    ddl-auto:</span> <span class="string">create</span></span><br><span class="line"><span class="attr">  show-sql:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><hr><p><strong>ddl-auto</strong>属性值</p><ul><li><p>create </p><pre><code>先删除已存在的同名表，再创建表</code></pre></li><li><p>update</p><pre><code>更新表，不会删除</code></pre></li><li><p>create-drop</p><pre><code>应用停来时删除表</code></pre></li><li><p>nono</p><pre><code>什么都不做</code></pre></li><li><p>validate</p><pre><code>验证类的属性与表结构是否一致，如不一致则报错</code></pre></li></ul><hr><h2 id="新建类"><a href="#新建类" class="headerlink" title="新建类"></a>新建类</h2><blockquote><p>新建一个类，使用注解进行配置后，会根据类结构在数据库中生成一个表</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gril</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>  <span class="comment">//表示ID自增</span></span><br><span class="line">    <span class="keyword">private</span>  Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cupSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//添加空的构造函数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//添加getter与setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>最后启动项目后，数据库中会自动生成一个与类结构相同的表</p></blockquote><blockquote><p>如果类名是驼峰原则，生成的表名则变为下划线，变量名也一样</p></blockquote><blockquote><p>@Entity(name=”gril_123_”)  来指定不同的表名</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 表单验证</title>
      <link href="/posts/18acbe2d/"/>
      <url>/posts/18acbe2d/</url>
      
        <content type="html"><![CDATA[<p>SpringBoot 表单验证</p><a id="more"></a><h1 id="SpringBoot-表单验证"><a href="#SpringBoot-表单验证" class="headerlink" title="SpringBoot 表单验证"></a>SpringBoot 表单验证</h1><ul><li>在实体类中使用注解进行校验。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gril</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>  <span class="comment">//表示ID自增</span></span><br><span class="line">    <span class="keyword">private</span>  Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cupSize;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">18</span>,message = <span class="string">"年龄必须大于18岁"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Gril</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//getter与setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在需要校验的属性上添加校验条件，如上中@Min 表示属性值最小为18，如不符合则抛出错误信息message</p></blockquote><ul><li>在控制器中使用校验</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加一条数据</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/addGril"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Gril <span class="title">addGril</span><span class="params">(@Valid Gril gril, BindingResult bindingResult)</span></span>&#123;</span><br><span class="line">  <span class="comment">//判断是否有错误 ，有错误则将错误输出到屏幕并停止程序运行</span></span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        System.out.println(bindingResult.getFieldError().getDefaultMessage());</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gril.setCupSize(gril.getCupSize());</span><br><span class="line">    gril.setAge(gril.getAge());</span><br><span class="line">    <span class="keyword">return</span>  grilDto.save(gril);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>把需要校验的对象添加 @Valid .BindingResult 用来接收校验不成功时的错误信息</p></blockquote><blockquote><p>bindingResult.getFieldError().getDefaultMessage() 获取实体类中配置的message属性值</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 入门知识</title>
      <link href="/posts/6ce21700/"/>
      <url>/posts/6ce21700/</url>
      
        <content type="html"><![CDATA[<p>Spring Boot 入门知识</p><a id="more"></a><h2 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h2><ul><li>通过idea 中新建Spring Initializr来新建，如提示无法连接 <a href="https://start.spring.io" target="_blank" rel="noopener">https://start.spring.io</a> ，将https改成http即可。</li><li>填写项目基本的信息</li><li>选择SpringBoot的版本与SpringBoot的组件</li><li>第一交新建SpringBoot需要下载</li></ul><h2 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h2><ol><li>直接在项目生成时自动创建的类中右击“run”</li><li>通过命令行，进入项目目录执行命令：mvn spring-boot:run</li><li>通过命令行。mvn install 编译项目，cd target 进入target文件夹执行：java -jar [target中生成的.jar文件] </li></ol><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件默认为resources目录下 的application.properties。我们在这个文件中添加两项配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#将服务器端口号改成8081</span><br><span class="line">server.port= 8081</span><br><span class="line">#设置url前缀为 /boot </span><br><span class="line">server.context-path= /boot</span><br></pre></td></tr></table></figure><p>此时我们启动项目发现原来的地址访问不了了。我们将端口改成8081，路径改成 /boot/hello就可以访问了</p><p><strong>推荐</strong></p><p>推荐将配置文件改成 application.yml 配置写起来会更简洁，如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">  context-path:</span> <span class="string">/boot</span></span><br></pre></td></tr></table></figure><p><em>需要注意的是 .yml 配置时冒号后必须有一个空格才能被识别</em></p><h3 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h3><ul><li>配置属性注入</li></ul><blockquote><p>可以在配置文件中指定值，在类中通过注解@Value 定义变量，SpringBoot会帮我们自动把配置中的值注入到变量中</p></blockquote><p><em>配置</em>    </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  context-path:</span> <span class="string">/boot</span></span><br><span class="line"><span class="attr">cupSize:</span> <span class="string">C</span></span><br></pre></td></tr></table></figure><p><em>类</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cupSize&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String cupSize;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/hello"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">myHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> cupSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>输出</em><br>​<br>​        C</p><ul><li>在配置中再使用当前配置</li></ul><p><em>配置</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  context-path:</span> <span class="string">/boot</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cupSize:</span> <span class="string">C</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">18</span></span><br><span class="line"><span class="attr">context:</span> <span class="string">"cupSize: $&#123;cupSize&#125;, age: $&#123;age&#125;"</span></span><br></pre></td></tr></table></figure><p><em>类</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cupSize&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String cupSize;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;age&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;context&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/hello"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">myHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><em>输出</em></p><pre><code>cupSize: C, age: 18</code></pre>]]></content>
      
      
      <categories>
          
          <category> Spring Boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SAP系统与ABAP 学习笔记</title>
      <link href="/posts/60b4a024/"/>
      <url>/posts/60b4a024/</url>
      
        <content type="html"><![CDATA[<p>SAP系统与ABAP 学习笔记</p><a id="more"></a><p>sap登陆</p><pre><code>集团：700用户名 ：密码：</code></pre><p>常用TCODE(事务代码)</p><p>SE11</p><pre><code>ABAP字典：初始屏幕</code></pre><p>SE37</p><pre><code>函数构建器：初始屏幕</code></pre><p>SE38</p><pre><code>ABAP编辑器：初始屏幕</code></pre><p>SE80</p><pre><code>ABAP工作台</code></pre><p>SU3</p><pre><code>维护用户参数文件</code></pre><p>/n</p><pre><code>退回系统首页</code></pre><p>数据库表查询<br>​<br>输入TCONDE SE11进入数据加查询，选中数据库表单选框，点击右边的按钮查找表。在弹出的查找表对话框中输入表名或者使用  *  号模糊查询，查找到表后点击绿色勾号。在初始屏幕点击显示即可。如果不是第一次查询，在点击查找表时会首先弹出上一个选择对象列表，点击信息系统可以重新查找表</p><p>ABAP工作台中创建一个程序</p><ul><li><p>创建包</p><p>  在资源浏览器中选择包，再下一个输入框中输入包名，回车。会提示包不存在是否创建，选择“是”。在创建包窗口中输入“简短描述”后继续。在请求窗口中新建一个请求，打开新建请求窗口，输入“简短描述” 后保存。返回请求窗口继续后即可创建包。</p></li><li><p>创建程序<br>在包上右击“创建” 程序，输入程序名称即可</p></li><li><p>运行程序</p><p>  <em>&amp;———————————————————————</em><br>  <em>&amp; Report ZABAP001  </em>&amp;———————————————————————<em>  </em>&amp;<br>  <em>&amp;———————————————————————</em><br>  REPORT ZABAP001.<br>  Write ‘hello world’.</p></li></ul><p>向屏幕输出一个hello world</p><p>首页激活程序，点击工具栏上的 “激活” 按钮，如没有错误再点击 “直接处理” 按钮来运行程序。屏幕会输出hello world</p><p><img src="http://i1.bvimg.com/1949/0a0b502cbae7628b.png" alt="Markdown"></p>]]></content>
      
      
      <categories>
          
          <category> SAP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sap </tag>
            
            <tag> abap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Groovy 入门学习小结</title>
      <link href="/posts/250a2363/"/>
      <url>/posts/250a2363/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Groovy 是 JVM 的一个替代语言，替代 是指可以用 Groovy 在 Java 平台上进行 Java 编程，使用方式基本与使用 Java 代码的方式相同。在编写新应用程序时，Groovy 代码能够与 Java 代码很好地结合，也能用于扩展现有代码。目前的 Groovy 版本是 1.5.4，在 Java 1.4 和 Java 5 平台上都能使用，也能在 Java 6 上使用。<br>Groovy 的一个好处是，它的语法与 Java 语言的语法很相似。可以将它想像成 Java 语言的一种更加简单、表达能力更强的变体。</p></blockquote><a id="more"></a><h1 id="认识-Groovy"><a href="#认识-Groovy" class="headerlink" title="认识 Groovy"></a>认识 Groovy</h1><h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><pre><code>在Eclipse中安装Groovy 的插件。安装的Url 为：http://dist.codehaus.org/groovy/distributions/update/</code></pre><hr><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><blockquote><p>在学习之前做一个简单的Hello World</p></blockquote><ul><li><p>在Eclipse 中新建项目。</p><pre><code>new &gt; other &gt;Groovy &gt; Groovy Project </code></pre><p>  ​    Eclipse 自动帮我们把Groovy需要的jar包添加上了。</p></li><li><p>在src 上建一个类</p><pre><code>New &gt; other &gt; Groovy &gt; Groovy Class</code></pre><p>  ​    勾选添加 main 方法</p></li><li><p>在main 中打印hello world, 类如下：</p></li></ul><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> groovyTest</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> main(args) &#123;</span><br><span class="line">System.out.print(<span class="string">"Hello World"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>运行</p><pre><code>右击选择 run as &gt; Groovy Script 可以看到控制台打印了Hello World</code></pre></li></ul><hr><h2 id="Groovy与Java"><a href="#Groovy与Java" class="headerlink" title="Groovy与Java"></a>Groovy与Java</h2><blockquote><p>前面说到Groovy与java 很相似，有多相似可以从Hello World中看出，语法没有一点差别。但是Groovy也有它自己的特点。它可以基本兼容java的语法，也有自己的一套语法，写起来会比Java更加简洁方便。可以将上面的Hello World改成如下：</p></blockquote><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> groovyTest</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> &#123;</span></span><br><span class="line"><span class="keyword">static</span> main(args) &#123;</span><br><span class="line">println (<span class="string">"Hello World"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>输出语句变得更简洁了，运行起来与之前结果一样。<br>甚至还能更简洁一点：</p></blockquote><pre><code>println (&quot;Hello World&quot;)</code></pre><blockquote><p>只需要一句就可以实现一个Hello World</p></blockquote><hr><p><strong>总结：</strong></p><ul><li>Groovy 属于脚本语言。脚本语言的一个特点就是能够在运行时进行解释。</li><li>并且它支持松散的 Java 语法, 允许省略分号和修改符除非另行指定，Groovy 的所有内容都为 public。</li><li>Groovy 允许定义简单脚本，同时无需定义正规的 class 对象。</li><li>Groovy 语法还允许省略变量类型。</li><li>并且Groovy也可以在JVM中直接运行，是Java 强有力的补充。</li></ul><hr><h1 id="语法简介"><a href="#语法简介" class="headerlink" title="语法简介"></a>语法简介</h1><h2 id="定义方式"><a href="#定义方式" class="headerlink" title="定义方式"></a>定义方式</h2><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><pre><code>Groovy 中定义变量不需要类型，Groovy 会根据对象的值来判断它的类型，这点与JavaScript 有点类似。也可以统一用 def 来代替类型。例：def value = “Hello World”</code></pre><hr><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><pre><code>定义方法时也不需要加 public 。 在Groovy中默认的修饰符就是public 。可以看到上面的Hello World程序上 main 方法前也没有Public</code></pre><hr><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><pre><code>字符串的使用也比较简单。可以这样定义：def str = “hello”</code></pre><hr><h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><pre><code>def var=&quot;hello &quot;+   &quot;world&quot;+   &quot;,groovy!&quot;   def repeat(val){        for(i = 0; i &lt; 5; i++){         println val        }   }   repeat(var)</code></pre><blockquote><p>上面这段代码是一个简单的循环。其中我们可以把For循环改得更简洁一些：<br>for(i in 0..4){}<br>效果与原先相同</p></blockquote><hr><h2 id="Groovy-集合"><a href="#Groovy-集合" class="headerlink" title="Groovy 集合"></a>Groovy 集合</h2><blockquote><p>Groovy支持很多集合， 并且都是标准的Java对象，每个集合都是java.util.Collection 或 java.util.Map 的实例。<br>如： def coll = [“Groovy”, “Java”, “Ruby”]<br>这很像java中的数组，但实际上在Groovy中它一个Collection。向这个集合中添加元素有三种方式：</p></blockquote><pre><code>coll.add(&quot;Python&quot;)coll &lt;&lt; &quot;Smalltalk&quot;coll[5] = &quot;Perl&quot;</code></pre><ul><li>*. 标记的使用</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">coll = coll*.toUpperCase()</span><br><span class="line">println coll</span><br><span class="line"></span><br><span class="line">//输出：[GROOVY, JAVA, RUBY, PYTHON, SMALLTALK, PERL]</span><br></pre></td></tr></table></figure><blockquote><p>使用 *.标记。会对数组中的每一个值都调用toUpperCase()。方便的实现了对数组中的字符串转成大写</p></blockquote><hr><h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><blockquote><p>Groovy中的映射写起来很简单，感觉有点像json。如下：</p></blockquote><pre><code>Def  hash = [name:&quot;Andy&quot;, &quot;VPN-#&quot;:45]</code></pre><blockquote><p>Groovy 会自动处理成一个Map .上面定义中的键值不一定是String ，像上面的name 会自动转成一个String<br>Groovy 对 Map 的存取操作可以用 put 与 get<br>但更具Groovy特色的Map 使用方式时直接用 . 号，如：</p></blockquote><pre><code>Hash.name  //直接取得name 的值Hash.pwd = “123”  //直接向hash 中添加一个键对值</code></pre><hr><h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><blockquote><p>闭包是用{符号括起来的代码块，它可以被单独运行或调用，也可以被命名。类似‘匿名类’或内联函数的概念。<br>闭包中最常见的应用是对集合进行迭代，下面定义了3个闭包对map进行了迭代：</p></blockquote><pre><code>map.each({key,value-&gt;    //key,value两个参数用于接受每个元素的键/值println &quot;$key:$value&quot;})map.each{println it}     //it是一个关键字，代表map集合的每个元素map.each({ println it.getKey()+&quot;--&gt;&quot;+it.getValue()})</code></pre><blockquote><p>除了用于迭代之外，闭包也可以单独定义：</p></blockquote><pre><code>def say={word-&gt;       println &quot;Hi,$word!&quot;   }</code></pre><p><em>调用：</em></p><pre><code>say(&apos;groovy&apos;)   say.call(&apos;groovy&amp;grails&apos;)</code></pre><p><em>输出：</em></p><pre><code>Hi,groovy!Hi,groovy&amp;grails!</code></pre><hr><p>##类定义</p><blockquote><p>Groovy中的类与java中的类一样。但因为Groovy 的特色我们可以少写很多代码。</p></blockquote><ul><li><p>不需要public 修饰符</p><blockquote><p>前面说到Groovy中默认的就是public </p></blockquote></li><li><p>不需要变量类型说明</p><blockquote><p>前面也说到了</p></blockquote></li><li><p>不需要getter() 与setter()方法    </p><blockquote><p>Groovy默认生成了标准的getter ，setter方法</p></blockquote></li><li><p>不需要构造函数</p><blockquote><p>不在需要程序员声明任何构造函数，因为groovy自动提供了足够你使用的构造函数</p></blockquote></li><li><p>不需要return </p><blockquote><p>在 Groovy 中可以省略 return 语句。Groovy 默认返回方法的最后一行。</p></blockquote></li><li><p>不需要括号 ()</p><blockquote><p>Groovy中方法调用可以省略()号（构造函数除外）</p></blockquote></li></ul><hr><p>感觉Groovy 和java差不多，比java写起来轻松一些，对于java开发来说，顺手学一门Groovy是很容易的事，对工作中也有很大的作用。</p><hr>]]></content>
      
      
      <categories>
          
          <category> Groovy </category>
          
      </categories>
      
      
        <tags>
            
            <tag> groovy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kendoGrid 自定义列命令</title>
      <link href="/posts/7aab7fa2/"/>
      <url>/posts/7aab7fa2/</url>
      
        <content type="html"><![CDATA[<h3 id="kendoGrid-自定义列命令"><a href="#kendoGrid-自定义列命令" class="headerlink" title="kendoGrid 自定义列命令"></a>kendoGrid 自定义列命令</h3><p>kendoGrid 中有时我们需要在表中加一列来放置一些操作按钮，这里我们可以使用kendoGrid 中 columns  下使用 command命令来定义</p><a id="more"></a><pre><code>columns: [{            field: &quot;taskId&quot;,            title: &quot;任务ID&quot;        }, {            field: &quot;taskName&quot;,            title: &quot;审批环节&quot;        }, {            field: &quot;procDefId&quot;,            title: &quot;流程定义ID&quot;        },{            field: &quot;assignee&quot;,            title: &quot;当前处理人   &quot;        },{            command : [                {                    text:&quot;审批&quot;,//名称                    click:function (e) {                        // e.target 是表示按钮的DOM元素                        var tr = $(e.target).closest(&quot;tr&quot;); // 得到当前表格的行 (tr)                        // 将数据绑定到当前表行。我们则可以通过data来取到这一行的数据了                        var data = this.dataItem(tr);                        console.log(&quot;事件&quot;);                        console.log(data.taskId);                    }                }            ],            title : &quot;操作&quot;, //表头名称            width : &quot;150px&quot; //列宽        }]</code></pre><p>这里的审批将会显示成一个按钮的形式，当我们点击这个按钮时会触发我们绑定的事件。</p>]]></content>
      
      
      <categories>
          
          <category> KendoUI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kendoUi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS中如何用EL表达式</title>
      <link href="/posts/b9025ac1/"/>
      <url>/posts/b9025ac1/</url>
      
        <content type="html"><![CDATA[<p>首先，我们有2种情况：</p><a id="more"></a><ul><li>在JSP页面中写JS<br>举例一看就知道：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="string">"$&#123;msg&#125;"</span>.length&amp;gt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">alert(<span class="string">"$&#123;msg&#125;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>只需要加双引号就行</p><ul><li>外部的JS文件引用</li></ul><p>因为EL表达式在JSP里才有效。所有可以先在JSP页面中写一个JS定义一个变量按上面的那种方法来接收EL表达式的值。然后在外部的JS中直接用这个变量 就行了</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jsp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>六 Activiti5 数据库表简要分析</title>
      <link href="/posts/7b2ef2b/"/>
      <url>/posts/7b2ef2b/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Activiti 将工作流程信息都存储在数据库表中，因此需要了解这些表的作用，能更好的帮助我们理解Activiti的工作方式。</p></blockquote><a id="more"></a><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nov6fpj305i0ez74e.jpg" alt="这里写图片描述"></p><hr><p>*<em>ACT_RE_</em>: ‘RE’表示repository。 这个前缀的表包含了流程定义和流程静态资源 （图片，规则，等等）。</p><hr><p>ACT_RU_* : ‘RU’表示runtime。 这些运行时的表，包含流程实例，任务，变量，异步任务，等运行中的数据。 Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。 这样运行时表可以一直很小速度很快。</p><hr><p>ACT_ID_*: ‘ID’表示identity。 这些表包含身份信息，比如用户，组等等。</p><hr><p>ACT_HI_*: ‘HI’表示history。 这些表包含历史数据，比如历史流程实例， 变量，任务等等。</p><hr><p>ACT_GE_*: ‘GE’表示general。通用数据， 用于不同场景下，如存放资源文件。</p><hr>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>五 Activiti5 任务管理</title>
      <link href="/posts/4104c51a/"/>
      <url>/posts/4104c51a/</url>
      
        <content type="html"><![CDATA[<h3 id="办理任务"><a href="#办理任务" class="headerlink" title="办理任务"></a>办理任务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; variables = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">variables.put(<span class="string">"user"</span>, <span class="string">"admin"</span>);</span><br><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">processEngine.getTaskService()</span><br><span class="line">        .complete(<span class="string">"22505"</span>,variables);</span><br></pre></td></tr></table></figure><blockquote><p>Complete()中传入任务的ID，并传入下一个执行人参数</p></blockquote><a id="more"></a><h3 id="查看任务列表"><a href="#查看任务列表" class="headerlink" title="查看任务列表"></a>查看任务列表</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">List&lt;Task&gt; tasks = processEngine.getTaskService()</span><br><span class="line">        .createTaskQuery()</span><br><span class="line">        .taskAssignee(userName).list();</span><br></pre></td></tr></table></figure><blockquote><p>可以查看指定用户的所有任务</p></blockquote><h3 id="查看指定任务信息"><a href="#查看指定任务信息" class="headerlink" title="查看指定任务信息"></a>查看指定任务信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Task t = processEngine.getTaskService()</span><br><span class="line">        .createTaskQuery()</span><br><span class="line">        .taskId(taskId)</span><br><span class="line">        .singleResult();</span><br></pre></td></tr></table></figure><blockquote><p>通过任务ID查找到指定的任务。还需要添加一个singleResult(),表示返回单个结果</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三 Activiti5 流程管理</title>
      <link href="/posts/abd3d7ab/"/>
      <url>/posts/abd3d7ab/</url>
      
        <content type="html"><![CDATA[<h3 id="流程部署"><a href="#流程部署" class="headerlink" title="流程部署"></a>流程部署</h3><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//得到一个默认的流程引擎</span></span><br><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">Deployment deployment = processEngine.getRepositoryService()</span><br><span class="line">        .createDeployment()</span><br><span class="line">        .addClasspathResource(<span class="string">"WeChat.bpmn"</span>)</span><br><span class="line">        .addClasspathResource(<span class="string">"WeChat.png"</span>)</span><br><span class="line">        .deploy();</span><br></pre></td></tr></table></figure><blockquote><p>WeChat.bpmn 为我们设计好的流程图<br>流程部署有三种方式，请查看这篇《Activiti 部署的三种方式与部署查询流程查询源码》：<a href="http://blog.csdn.net/FTDD_HW/article/details/76551954" target="_blank" rel="noopener">http://blog.csdn.net/FTDD_HW/article/details/76551954</a></p></blockquote><h3 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">processEngine.getRuntimeService()</span><br><span class="line">        .startProcessInstanceByKey(pdkey,variables);</span><br></pre></td></tr></table></figure><blockquote><p>启动时我们可以根据key 来启动，也可以根据ID来启动。还可以带一些参数进行。Variables为一个Map集合.如果我们在流程中定义了变量，在启动前则需要将变量通过Map传递进行。</p></blockquote><h3 id="查看所有流程部署"><a href="#查看所有流程部署" class="headerlink" title="查看所有流程部署"></a>查看所有流程部署</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;ProcessDefinition&gt; processDefinition = processEngine.getRepositoryService()</span><br><span class="line">        .createProcessDefinitionQuery()</span><br><span class="line">        .list();</span><br></pre></td></tr></table></figure><blockquote><p>我们需要一个list()来将结果转化成一个List集合，方便我们取值。</p></blockquote><h3 id="查看流程是否结束"><a href="#查看流程是否结束" class="headerlink" title="/查看流程是否结束"></a>/查看流程是否结束</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ProcessEngine processEngine = ProcessEngines.getDefaultProcessEngine();</span><br><span class="line">ProcessInstance pi = processEngine.getRuntimeService()</span><br><span class="line">        .createProcessInstanceQuery()</span><br><span class="line">        .processInstanceId(<span class="string">"130001"</span>)</span><br><span class="line">        .singleResult();</span><br></pre></td></tr></table></figure><blockquote><p>如果PI 的值为 null 则流程已经结果了</p></blockquote><h3 id="删除流程部署"><a href="#删除流程部署" class="headerlink" title="删除流程部署"></a>删除流程部署</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// processEngine.getRepositoryService()</span></span><br><span class="line"><span class="comment">// .deleteDeployment("1");//用该API只能删除流程定义的内容和部署的内容</span></span><br><span class="line">processEngine.getRepositoryService()</span><br><span class="line">        .deleteDeployment(<span class="string">"55001"</span>, <span class="keyword">true</span>);<span class="comment">//删除了关于deploymentID为1的所有的数据，包括：流程定义、流程部署、任务等信息</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小程序开发的中遇到的坑</title>
      <link href="/posts/605dbeac/"/>
      <url>/posts/605dbeac/</url>
      
        <content type="html"><![CDATA[<p>小程序开发的中遇到的坑</p><a id="more"></a><p>#text组件</p><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nznibjj30on075q73.jpg" alt="这里写图片描述"></p><p>#wx:for<br>     是作用在wx:for所在的标签上开始的，循环内容包括该标签</p><p>#push<br>空数组push进数据之后，还需要用setData写入数据，不然原数据没变</p><p>#函数执行顺序<br>在page中各函数与语句执行的顺序不是从上到下，可能是同时。。<br>​     有时会出现已经设置数据了，但后面用的时候发现没有数据，可能的原因就是用数据在设置数据之前执行了，因此还没有数据。最好了设置数据后<br>紧接着用数据</p>]]></content>
      
      
      <categories>
          
          <category> 微信小程序 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 微信小程序 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一 Activiti5 配置</title>
      <link href="/posts/fc49410c/"/>
      <url>/posts/fc49410c/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Activiti5由Alfresco软件在2010年5月17日发布的业务流程管理（BPM）框架，它是覆盖了业务流程管理、工作流、服务协作等领域的一个开源的、灵活的、易扩展的可执行流程语言框架。</p></blockquote><a id="more"></a><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><ul><li>JDK1.6或者更高版本</li><li>支持的数据库有：h2, mysql, oracle, postgres, mssql, db2等。</li><li>支持activiti5运行的jar包</li><li>开发环境为Eclipse3.7或者以上版本,MyEclipse为8.6版本</li></ul><h1 id="资源下载"><a href="#资源下载" class="headerlink" title="资源下载"></a>资源下载</h1><ul><li><a href="http://activiti.org/download.html" target="_blank" rel="noopener">Activiti下载</a></li><li><a href="http://pan.baidu.com/s/1qYgohFA" target="_blank" rel="noopener">流程设计器-Eclipse 插件-百度网盘下载</a>，密码：447q3 (插件安装教程:<a href="http://blog.csdn.net/qq_33547950/article/details/54926435" target="_blank" rel="noopener">http://blog.csdn.net/qq_33547950/article/details/54926435</a>)  </li></ul><h1 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h1><ul><li><p>导入JAR包</p><ul><li><p>手动导入</p><p>我们在Eclipse中新建一个java项目，将Activiti需要的jar包导入。Activiti需要的jar包可以在从官网下载下来的Activiti文件中找到。路径：activiti-5.22.0\wars  下的示例项目activiti-rest.war 将其解压后，其中lib文件夹下的jar包就是我们所需要的。但其中没有给我们提供mysql的jar包与单元测试junit的jar包，我们自己添加即可。</p></li><li><p>Maven 依赖配置</p><p><strong>pom文件</strong></p><p>其中activiti支持与Spring的一些核心包是必须的，其它的按自己项目来增删即可。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--activiti --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activiti.version</span>&gt;</span>5.22.0<span class="tag">&lt;/<span class="name">activiti.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- spring版本号 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>4.0.2.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mybatis版本号 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis.version</span>&gt;</span>3.2.6<span class="tag">&lt;/<span class="name">mybatis.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- log4j日志文件管理包版本 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.7.7<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 映入JSON --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jackson-mapper-asl.version</span>&gt;</span>1.9.13<span class="tag">&lt;/<span class="name">jackson-mapper-asl.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.json-lib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>jdk15<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet.jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加jtl支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加Spring支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加日志支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加mybatis支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- jdbc驱动包  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.37<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- apache公共包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-logging&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.4&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.3.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- 添加Activiti支持 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.activiti&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;5.22.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.activiti&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;activiti-bpmn-model&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;5.22.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- spring整合activiti插件 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.activiti&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;activiti-spring&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;5.22.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 导入dbcp的jar包，用来在applicationContext.xml中配置数据库 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;commons-dbcp&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;commons-dbcp&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.2.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- 格式化对象，方便输出日志 --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.1.41&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;$&#123;slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- log end --&gt;</span><br><span class="line">&lt;!--映入json--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.codehaus.jackson&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jackson-mapper-asl&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;$&#123;jackson-mapper-asl.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.8.4&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.8.4&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;2.8.4&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line">​</span><br></pre></td></tr></table></figure><p>​<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 配置Activiti.cfg.xml</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</span><br><span class="line">  xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span><br><span class="line">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd</span><br><span class="line">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd</span><br><span class="line">       http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.0.xsd</span><br><span class="line">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd&quot;&gt;</span><br><span class="line">&lt;bean id=&quot;processEngineConfiguration&quot;</span><br><span class="line">class=&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;&gt;</span><br><span class="line">&lt;!-- 数据库连接配置  --&gt;</span><br><span class="line">&lt;property name=&quot;jdbcDriver&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;</span><br><span class="line">&lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://localhost:3306/activiti_demo?useUnicode=true&amp;amp;characterEncoding=utf8&quot; /&gt;</span><br><span class="line">&lt;property name=&quot;jdbcUsername&quot; value=&quot;root&quot; /&gt;</span><br><span class="line">&lt;property name=&quot;jdbcPassword&quot; value=&quot;tiger&quot; /&gt;</span><br><span class="line">&lt;!-- 建表策略 --&gt;</span><br><span class="line">&lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p><ul><li>初始化数据库。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要写一个类如下：</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateTable</span> </span>&#123;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createDbByXML</span><span class="params">()</span></span>&#123;</span><br><span class="line">ProcessEngine processEngine = ProcessEngineConfiguration.createProcessEngineConfigurationFromResource(<span class="string">"activiti.cfg.xml"</span>).buildProcessEngine();</span><br><span class="line">System.out.println(processEngine);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行方法后会自动在数据库中创建Activiti所需要的表。Activiti 5.12 有23张表，Activiti 5.22 有25张表。Activiti 6.0 有28张表。</p><p>​    </p>]]></content>
      
      
      <categories>
          
          <category> Activiti </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Activiti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部分常用命令</title>
      <link href="/posts/451b41a8/"/>
      <url>/posts/451b41a8/</url>
      
        <content type="html"><![CDATA[<p>最近在阿里云是买了个ECS服务器，装的Linux系统，自己搭建了一个java web 环境，其中通过百度学习了一些linux下的常用命令，记一下；</p><a id="more"></a><hr><p>查看某个端口的占用情况</p><pre><code>netstat -apn|grep 端口      </code></pre><hr><p>查看tomcat的进程占用情况</p><pre><code>ps -aux|grep tomcat         </code></pre><hr><p>查看所有进程占用情况<br>​<br>​    netstat -apn                </p><hr><p>重启网络</p><pre><code>service network restart     </code></pre><hr><p>将1.repo重命名为1.repo.backup  常用作文件备份</p><pre><code>mv /etc/1.repo /etc/1.repo.backup  </code></pre><hr><p>查看网络信息</p><pre><code>ifconfig    </code></pre><hr><p>使配置生效</p><pre><code>source /etc/profile</code></pre><hr><p>查看linux内在使用情况</p><pre><code>free -m</code></pre><hr><p>清理内存</p><pre><code>echo 1 &gt; /proc/sys/vm/drop_caches      </code></pre><hr><p>杀进程。pid 为相应的进程号</p><pre><code>kill -9 pid </code></pre><h3 id="Mysql常用命令"><a href="#Mysql常用命令" class="headerlink" title="Mysql常用命令"></a>Mysql常用命令</h3><p>启动Mysql</p><pre><code>systemctl start mysqld.service      </code></pre><hr><p>停止Mysql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld.service</span><br></pre></td></tr></table></figure><h3 id="tomcat-常用命令"><a href="#tomcat-常用命令" class="headerlink" title="tomcat 常用命令"></a>tomcat 常用命令</h3><p>以下命令在tomcat目录中的bin目录下执行：</p><pre><code>./startup.sh         启动tomcat ./shutdown.sh        停止tomcat</code></pre><hr><p>看tomcat的控制台输出</p><pre><code>tail -f logs/catalina.out   </code></pre><hr><p>看是否已经有tomcat在运行了</p><pre><code>ps -ef |grep tomcat  </code></pre><hr><p>查看空间分配 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Secutity 自定义权限配置</title>
      <link href="/posts/197768c1/"/>
      <url>/posts/197768c1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Srping Security网上也有很多例子，但基本都是所资源直接配置在XML文件里，限制太大，不够灵活。我们需要的是可以在后台修改资源访问权限，实时生效，才能符合现在大多数系统的需求。</p></blockquote><a id="more"></a><h1 id="需要引入的依赖"><a href="#需要引入的依赖" class="headerlink" title="需要引入的依赖"></a>需要引入的依赖</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Spring security --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!--Spring Security end--&gt;</span><br></pre></td></tr></table></figure><h1 id="用户身份认证"><a href="#用户身份认证" class="headerlink" title="用户身份认证"></a>用户身份认证</h1><blockquote><p>我们自定义一个实现类MUserDetailsService 来实现UserDetailsService接口。<br>其中需要实现一个loadUserByUsername方法，用来读取用户的角色。<br>在这里需要从数据库中通过用户名来查询用户的信息和用户所属的角色<br>其中MGrantedAuthority实现了GrantedAuthority接口，用于构建用户权限。<br>MUserDeatils实现了UserDeatils接口，用于存放用户信息与权限</p></blockquote><h3 id="UserDetailsService在身份认证中的作用"><a href="#UserDetailsService在身份认证中的作用" class="headerlink" title="UserDetailsService在身份认证中的作用"></a>UserDetailsService在身份认证中的作用</h3><blockquote><p>Spring Security中进行身份验证的是AuthenticationManager接口，ProviderManager是它的一个默认实现，但它并不用来处理身份认证，而是委托给配置好的AuthenticationProvider，每个AuthenticationProvider会轮流检查身份认证。检查后或者返回Authentication对象或者抛出异常。验证身份就是加载响应的UserDetails，看看是否和用户输入的账号、密码、权限等信息匹配。此步骤由实现AuthenticationProvider的DaoAuthenticationProvider（它利用UserDetailsService验证用户名、密码和授权）处理。包含 GrantedAuthority 的 UserDetails对象在构建 Authentication对象时填入数据。</p></blockquote><p><img src="https://wx4.sinaimg.cn/mw690/005RGBbLly1fwv4nas9raj30xo0jeae0.jpg" alt="这里写图片描述"></p><hr><h3 id="MUserDetailsService-class中的loadUserByUsername方法"><a href="#MUserDetailsService-class中的loadUserByUsername方法" class="headerlink" title="MUserDetailsService.class中的loadUserByUsername方法"></a>MUserDetailsService.class中的loadUserByUsername方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户名加载用户密码与权限信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询用户信息</span></span><br><span class="line">    User user = userMapper.selectByName(username);</span><br><span class="line">    List&lt;Role&gt; roleList = <span class="keyword">null</span>;</span><br><span class="line">    MUserDeatils userDeatils = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//查询用户的角色</span></span><br><span class="line">        roleList = roleMapper.queryByUser(user.getId());</span><br><span class="line">        System.out.println(<span class="string">"user"</span> + user.getUsername() + <span class="string">"----"</span> + user.getPassword());</span><br><span class="line">        <span class="comment">// 构建权限</span></span><br><span class="line">        Set&lt;MGrantedAuthority&gt; authorities = <span class="keyword">new</span> HashSet&lt;MGrantedAuthority&gt;();</span><br><span class="line">        <span class="keyword">if</span> (roleList.size() != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Role role: roleList)&#123;</span><br><span class="line">                authorities.add(<span class="keyword">new</span> MGrantedAuthority(role.getName()));</span><br><span class="line">                System.out.println(role.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            userDeatils = <span class="keyword">new</span> MUserDeatils(user.getUsername(),user.getPassword(),authorities);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userDeatils;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MGrantedAuthority-class"><a href="#MGrantedAuthority-class" class="headerlink" title="MGrantedAuthority.class"></a>MGrantedAuthority.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MGrantedAuthority</span> <span class="keyword">implements</span> <span class="title">GrantedAuthority</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String authority;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MGrantedAuthority</span><span class="params">(String authority)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.authority = authority;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAuthority</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MUserDeatils-class"><a href="#MUserDeatils-class" class="headerlink" title="MUserDeatils.class"></a>MUserDeatils.class</h3><blockquote><p>实现UserDetails接口定义好变量即可</p></blockquote><h1 id="读取资源与所属角色"><a href="#读取资源与所属角色" class="headerlink" title="读取资源与所属角色"></a>读取资源与所属角色</h1><blockquote><p>需要自定义实现类实现FilterInvocationSecurityMetadataSource接口。通过loadResourceDefine方法可以实现资源与权限的对应关系。<br>要使我们自定义的MFilterInvocationSecurityMetadataSource生效，我们还需要定义一个MyFilterSecurityInterceptor类。<br>这里的数据需要从数据库中取得。另外自定义接口UrlMatcher，实现类为AntUrlPathMatcher。</p></blockquote><h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a><strong>坑</strong></h3><hr><p> 网上有教程是把loadResourceDefine方法放在了构造函数里。但我经过多次试验均出现service,mapper无法注入的问题，然后就会报一个空指针的导异常，经debug发现是service没有注入。经多次查询得知：原因是构造方法会先于注入执行，所以loadResourceDefine方法放入构造中执行时函数内的service与mapper还未执行注入，因此报 java.lang.NullPointerException的异常。解决方法是将loadResourceDefine方法放在getAttributes方法中执行。</p><hr><h3 id="MFilterInvocationSecurityMetadataSource-class"><a href="#MFilterInvocationSecurityMetadataSource-class" class="headerlink" title="MFilterInvocationSecurityMetadataSource.class"></a>MFilterInvocationSecurityMetadataSource.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Component</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MFilterInvocationSecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title">FilterInvocationSecurityMetadataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> IRescAndRoleService iRescAndRoleService ;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService iUserService ;</span><br><span class="line">    <span class="keyword">private</span> UrlMatcher urlMatcher = <span class="keyword">new</span> AntUrlPathMatcher();</span><br><span class="line">    <span class="comment">// 资源权限集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Collection&lt;ConfigAttribute&gt;&gt; resourceMap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadResourceDefine</span><span class="params">()</span></span>&#123;</span><br><span class="line">        resourceMap = <span class="keyword">new</span> HashMap&lt;String, Collection&lt;ConfigAttribute&gt;&gt;();</span><br><span class="line">        <span class="comment">//取得用户信息</span></span><br><span class="line">        List&lt;User&gt; userList = iUserService.query();</span><br><span class="line">       <span class="comment">//取得资源与角色列表</span></span><br><span class="line">        List&lt;RescAndRole&gt; resourceList = iRescAndRoleService.query();</span><br><span class="line">        System.out.println(resourceList);</span><br><span class="line">        <span class="keyword">for</span> (RescAndRole resource : resourceList) &#123;</span><br><span class="line">            Collection&lt;ConfigAttribute&gt; atts = <span class="keyword">new</span> ArrayList&lt;ConfigAttribute&gt;();</span><br><span class="line">            atts.add(<span class="keyword">new</span> SecurityConfig(resource.getRoleName() ));</span><br><span class="line">            resourceMap.put(resource.getResString(), atts);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        loadResourceDefine();<span class="comment">//防止无法注入问题</span></span><br><span class="line">        <span class="comment">// guess object is a URL.</span></span><br><span class="line">        String url = ((FilterInvocation) o).getRequestUrl();</span><br><span class="line">        Iterator&lt;String&gt; ite = resourceMap.keySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (ite.hasNext()) &#123;</span><br><span class="line">            String resURL = ite.next();</span><br><span class="line">            <span class="keyword">if</span> (urlMatcher.pathMatchesUrl(resURL, url)) &#123;</span><br><span class="line">                <span class="keyword">return</span> resourceMap.get(resURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AntUrlPathMatcher-class"><a href="#AntUrlPathMatcher-class" class="headerlink" title="AntUrlPathMatcher.class"></a>AntUrlPathMatcher.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AntUrlPathMatcher</span> <span class="keyword">implements</span> <span class="title">UrlMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> requiresLowerCaseUrl;</span><br><span class="line">    <span class="keyword">private</span> PathMatcher pathMatcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AntUrlPathMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AntUrlPathMatcher</span><span class="params">(<span class="keyword">boolean</span> requiresLowerCaseUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requiresLowerCaseUrl = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.pathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.requiresLowerCaseUrl = requiresLowerCaseUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">compile</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.requiresLowerCaseUrl) &#123;</span><br><span class="line">            <span class="keyword">return</span> path.toLowerCase();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequiresLowerCaseUrl</span><span class="params">(<span class="keyword">boolean</span> requiresLowerCaseUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requiresLowerCaseUrl = requiresLowerCaseUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">pathMatchesUrl</span><span class="params">(Object path, String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="string">"/**"</span>.equals(path)) || (<span class="string">"**"</span>.equals(path))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.pathMatcher.match((String) path, url);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUniversalMatchPattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/**"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requiresLowerCaseUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.requiresLowerCaseUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getClass().getName() + <span class="string">"[requiresLowerCase='"</span></span><br><span class="line">                + <span class="keyword">this</span>.requiresLowerCaseUrl + <span class="string">"']"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MyFilterSecurityInterceptor-class"><a href="#MyFilterSecurityInterceptor-class" class="headerlink" title="MyFilterSecurityInterceptor.class"></a>MyFilterSecurityInterceptor.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilterSecurityInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FilterInvocationSecurityMetadataSource securityMetadataSource;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                         FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">        invoke(fi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterInvocationSecurityMetadataSource <span class="title">getSecurityMetadataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.securityMetadataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;? extends Object&gt; getSecureObjectClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">            ServletException </span>&#123;</span><br><span class="line">        InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityMetadataSource <span class="title">obtainSecurityMetadataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.securityMetadataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecurityMetadataSource</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            FilterInvocationSecurityMetadataSource newSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.securityMetadataSource = newSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="决策管理器"><a href="#决策管理器" class="headerlink" title="决策管理器"></a>决策管理器</h1><blockquote><p>自定义一个决策管理器MyAccessDecisionManager实现AccessDecisionManager接口。其中的decide方法，决定某一个用户是否有权限访问某个url</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/* (non-Javadoc)</span><br><span class="line">     * @see org.springframework.security.access.AccessDecisionManager#decide(org.springframework.security.core.Authentication, java.lang.Object, java.util.Collection)</span><br><span class="line">     * 该方法决定该权限是否有权限访问该资源，其实object就是一个资源的地址，authentication是当前用户的</span><br><span class="line">     * 对应权限，如果没登陆就为游客，登陆了就是该用户对应的权限</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void decide(Authentication authentication, Object object,</span><br><span class="line">                       Collection&lt;ConfigAttribute&gt; configAttributes)</span><br><span class="line">            throws AccessDeniedException, InsufficientAuthenticationException &#123;</span><br><span class="line">        if(configAttributes == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(object.toString()); // object is a URL.</span><br><span class="line">        //所请求的资源拥有的权限(一个资源对多个权限)</span><br><span class="line">        Iterator&lt;ConfigAttribute&gt; iterator = configAttributes.iterator();</span><br><span class="line">        while(iterator.hasNext()) &#123;</span><br><span class="line">            ConfigAttribute configAttribute = iterator.next();</span><br><span class="line">            //访问所请求资源所需要的权限</span><br><span class="line">            String needPermission = configAttribute.getAttribute();</span><br><span class="line">            System.out.println(&quot;访问&quot;+object.toString()+&quot;需要的权限是：&quot; + needPermission);</span><br><span class="line">            //用户所拥有的权限authentication</span><br><span class="line">            Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities();</span><br><span class="line">            for(GrantedAuthority ga : authorities) &#123;</span><br><span class="line">                if(needPermission.equals(ga.getAuthority())) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        //没有权限</span><br><span class="line">        throw new AccessDeniedException(&quot; 没有权限访问！ &quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(ConfigAttribute attribute) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        // TODO Auto-generated method stub</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="配置XML"><a href="#配置XML" class="headerlink" title="配置XML"></a>配置XML</h1><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><blockquote><p>添加Seucrity的过滤器，将拦截所有资源访问</p></blockquote><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a><strong>注意</strong></h3><pre><code>只能配置成 /*</code></pre><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--加载Security配置文件与mybatis配置文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">        WEB-INF/config/security.xml</span><br><span class="line">        WEB-INF/config/spring-mybatis.xml</span><br><span class="line">    <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring security 的过滤器配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="spring-security-xml"><a href="#spring-security-xml" class="headerlink" title="spring-security.xml"></a>spring-security.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">b:beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/security"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:b</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--登陆页面不验证--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/userLogin.html"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--静态文件请求不验证--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/js/**"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/css/**"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--restful请求--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/login"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/getGrid"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--浏览器会自动请求网站图标：favicon.ico -不验证  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> <span class="attr">pattern</span>=<span class="string">"/favicon.ico"</span> <span class="attr">security</span>=<span class="string">"none"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http</span> &gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--自定义权限不足时显示的页面--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">access-denied-handler</span> <span class="attr">error-page</span>=<span class="string">"/accessHint.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">access-denied-handler</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 自定义登录界面 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form-login</span></span></span><br><span class="line"><span class="tag">                <span class="attr">authentication-failure-url</span>=<span class="string">"/userLogin.html?error=true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">login-page</span>=<span class="string">"/userLogin.html"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">default-target-url</span>=<span class="string">"/index.html"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">login-processing-url</span>=<span class="string">"/j_spring_security_check"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logout</span> <span class="attr">invalidate-session</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">logout-success-url</span>=<span class="string">"/userLogin.html"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">logout-url</span>=<span class="string">"/j_spring_security_logout"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 通过配置custom-filter来增加过滤器，before="FILTER_SECURITY_INTERCEPTOR"表示在SpringSecurity默认的过滤器之前执行。 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">custom-filter</span> <span class="attr">ref</span>=<span class="string">"filterSecurityInterceptor"</span> <span class="attr">before</span>=<span class="string">"FILTER_SECURITY_INTERCEPTOR"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">csrf</span> <span class="attr">disabled</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">http</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 认证过滤器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b:bean</span> <span class="attr">id</span>=<span class="string">"filterSecurityInterceptor"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">"com.hand.security.utils.MyFilterSecurityInterceptor"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">b:property</span> <span class="attr">name</span>=<span class="string">"rejectPublicInvocations"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 用户拥有的权限 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">b:property</span> <span class="attr">name</span>=<span class="string">"accessDecisionManager"</span> <span class="attr">ref</span>=<span class="string">"accessDecisionManager"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 用户是否拥有所请求资源的权限 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">b:property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 资源与权限对应关系 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">b:property</span> <span class="attr">name</span>=<span class="string">"securityMetadataSource"</span> <span class="attr">ref</span>=<span class="string">"securityMetadataSource"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">b:bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2、更改验证信息加载方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">authentication-provider</span></span></span><br><span class="line"><span class="tag">                <span class="attr">user-service-ref</span>=<span class="string">"mUserDetailsService"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--如果用户的密码采用加密的话 &lt;password-encoder hash="md5" /&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">authentication-provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">authentication-manager</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 1、配置自定义类MUserDetailsService --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b:bean</span> <span class="attr">id</span>=<span class="string">"mUserDetailsService"</span> <span class="attr">class</span>=<span class="string">"com.hand.security.service.impl.MUserDetailsService"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--访问决策器，决定某个用户具有的角色，是否有足够的权限去访问某个资源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b:bean</span> <span class="attr">id</span>=<span class="string">"accessDecisionManager"</span> <span class="attr">class</span>=<span class="string">"com.hand.security.utils.MyAccessDecisionManager"</span>&gt;</span><span class="tag">&lt;/<span class="name">b:bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--资源源数据定义，将所有的资源和权限对应关系建立起来，即定义某一资源可以被哪些角色访问 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b:bean</span> <span class="attr">id</span>=<span class="string">"securityMetadataSource"</span> <span class="attr">class</span>=<span class="string">"com.hand.security.utils.MFilterInvocationSecurityMetadataSource"</span> &gt;</span><span class="tag">&lt;/<span class="name">b:bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">b:beans</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
            <tag> security </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
