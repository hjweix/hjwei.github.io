<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用Maven构建微服务的Docker镜像"><meta name="keywords" content="微服务镜像,dockerfile"><meta name="author" content="HJW"><meta name="copyright" content="HJW"><title>使用Maven构建微服务的Docker镜像 | HJW</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3a101c3aa7d1cde834d9d6b197500902";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-139524382-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#添加属性"><span class="toc-number">1.</span> <span class="toc-text">添加属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加插件"><span class="toc-number">2.</span> <span class="toc-text">添加插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加Dockerfile"><span class="toc-number">3.</span> <span class="toc-text">添加Dockerfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启Docker远程"><span class="toc-number">4.</span> <span class="toc-text">开启Docker远程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建image"><span class="toc-number">5.</span> <span class="toc-text">构建image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#镜像tag"><span class="toc-number">6.</span> <span class="toc-text">镜像tag</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/17232182?s=460&amp;v=4"></div><div class="author-info__name text-center">HJW</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/hjwjw">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">60</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">21</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">HJW</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">使用Maven构建微服务的Docker镜像</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-11-29</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/微服务/">微服务</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>在预习了Docker的知识后，开始对微服务进行Docker容器化改造。</p>
<a id="more"></a>
<p>本篇内容前提：</p>
<ul>
<li>已安装 Docker 的服务器环境</li>
<li>Docker 基础操作</li>
</ul>
<p>Docker 的基础学习笔记可以在本博客 Docker 分类中查看。</p>
<hr>
<p>我使用 Maven 来构建 Docker 镜像。Maven 有几个Docker 插件可以使用，这里使用的是 由<code>Spotify</code> 公司开发的 Maven 插件。</p>
<blockquote>
<p>插件名称：dockerfile-maven  地址：<a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener">https://github.com/spotify/dockerfile-maven</a></p>
</blockquote>
<p>在它前面还有一个”哥哥” <code>docker-maven-plugin</code>  这个插件已经不推荐使用了。<code>docker-maven-plugin</code>插件可以不使用<code>Dockerfile</code> 而直接在<code>pom.xml</code>中来构建镜像，但随着时间的推移<code>Spotify</code>公司也意识到这种方式可能导致很多不必要的混淆，使用<code>Dockerfile</code>构建镜像是最简单的方法，因此但这种方式不推荐,这个项目也不会再增加新功能，仅限错误修复。所以我一开始就学习的<code>dockerfile-maven</code> 插件。它会连接远程Docker，只要一个命令就能把本地的jar包打成Docker镜像，命令执行完毕后，服务器上就会有刚打包好的镜像，此时再执行该镜像即可。</p>
<p>下面使用<code>dockerfil-maven</code>来构建镜像，以前面的 <code>microservice-consumer-movie</code> 项目为例。</p>
<h2 id="添加属性"><a href="#添加属性" class="headerlink" title="添加属性"></a>添加属性</h2><p>在添加插件前先在<code>pom.xml</code>中添加一些属性，方便配置，在<code>pom</code>中添加如下<code>properties</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>hjwjw<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">docker.plugin.version</span>&gt;</span>1.4.9<span class="tag">&lt;/<span class="name">docker.plugin.version</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="添加插件"><a href="#添加插件" class="headerlink" title="添加插件"></a>添加插件</h2><p>在项目的pom.xml中添加<code>dockerfile-maven</code>插件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;docker.plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                 <span class="comment">&lt;!--&lt;goal&gt;push&lt;/goal&gt;--&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>插件配置说明</strong></p>
<ul>
<li>repository : 用于命名构建镜像的存储库，生成的镜像名如：<code>hjwjw/microservice-discovery-eureka</code>。</li>
<li>tag : 是标签名称，这里指定标签名为pom中的<code>${project.version}</code> ，这里即是：0.0.1-SNAPSHOT</li>
<li>buildArgs : 为构建参数，可以在构建里将参数传到Dockerfile中，<code>${project.build.finalName}</code> 表示打包后jar包的名称。这里是将jar的路径传递到Dockerfile中。</li>
<li>executions : 这里设置把插件的<code>goal</code> 绑定到某个<code>phase</code> 上，实现打包完成后自动构建镜像并推送，这里没有配置远程仓库因此不推送到远程仓库。</li>
</ul>
<blockquote>
<p>phase 和 goal 可以这样理解：maven 命令格式是：mvn phase:goal ,例如mvn package dockerfile:build .那么，package 和 dockerfile 都是 phase ,build则是 goal 。</p>
</blockquote>
<h2 id="添加Dockerfile"><a href="#添加Dockerfile" class="headerlink" title="添加Dockerfile"></a>添加Dockerfile</h2><p>在项目根目录添加<code>Dockerfile</code> 文件，内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">FROM livingobjects/jre8</span><br><span class="line">VOLUME /tmp</span><br><span class="line">ARG JAR_FILE</span><br><span class="line">ADD <span class="variable">$&#123;JAR_FILE&#125;</span> app.jar</span><br><span class="line">RUN bash -c <span class="string">'touch /app.jar'</span></span><br><span class="line">EXPOSE 8010</span><br><span class="line">ENTRYPOINT [<span class="string">"java"</span>,<span class="string">"-Djava.security.egd=file:dev/./urandom"</span>,<span class="string">"-jar"</span>,<span class="string">"/app.jar"</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>livingobjects/jre8 是一个比较小的jre8的基础镜像，构建镜像时会快些。</p>
</blockquote>
<p>Dockerfile 的参数在 <a href="https://hjwjw.gitee.io/posts/1ef71e38/">Dockerfile实践</a> 中已经写过，可以在本博客搜索查看。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ARG JAR_FILE</span><br><span class="line">ADD $&#123;JAR_FILE&#125; app.jar</span><br></pre></td></tr></table></figure>
<p>表示接收构建参数<code>JAR_FILE</code> 这个参数在前面的<code>pom.xml</code>中配置插件时已经添加。参数内容为jar 的的路径，<code>${JAR_FILE}</code>则是使用传递进来的参数。</p>
<h2 id="开启Docker远程"><a href="#开启Docker远程" class="headerlink" title="开启Docker远程"></a>开启Docker远程</h2><p>开启Docker远程方法可参考博客：<a href="https://hjwjw.gitee.io/posts/b035bcd6/#%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE">Docker安装配置</a></p>
<p>开启后在本机上配置一个环境变量：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DOCKER_HOST=tcp://ip:2375</span><br></pre></td></tr></table></figure>
<p>IP 为Docker 所安装的服务器IP ，端口一般没有修改过默认会是<code>2375</code></p>
<p><code>dockerfile-maven</code> 插件就是通过在本机操作 Docker api 构建镜像的，因此本机上不需要安装Docker，能够访问到Docker服务器即可。</p>
<h2 id="构建image"><a href="#构建image" class="headerlink" title="构建image"></a>构建image</h2><p>前面的配置都完成后，在IDE的命令窗口只需要一个命令即可实现对项目的打包及构建镜像到Docker服务器。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure>
<p>执行命令过程如图：</p>
<p><img src="https://ws1.sinaimg.cn/large/005RGBbLly1fxn1bw5kwlj310w0ic75f.jpg" alt="打包并构建image"></p>
<p>可以看到按Dockerfile一步步构建镜像了，执行完成后我们就可以在Docker服务器上查看新的image，如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/005RGBbLly1fxn1j5kvy7j30kf04awf8.jpg" alt="docker imges"></p>
<p>至此，Docker 构建微服务镜像完成。源码： <a href="https://github.com/hjwjw/Spring-Cloud-With-Docker-Practice-Demo/tree/master/microservice-consumer-movie" target="_blank" rel="noopener">microservice-customer-movie</a></p>
<p>镜像运行可以参考本博客分类：<a href="https://hjwjw.gitee.io/categories/Docker/">Docker</a></p>
<h2 id="镜像tag"><a href="#镜像tag" class="headerlink" title="镜像tag"></a>镜像tag</h2><p>在使用上面的方式生成镜像时，我们前面在<code>pom.xml</code> 中已经配置了构建时的<code>tag</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果不配置这个参数，默认生成的<code>tag</code> 是 <code>latest</code>。</p>
<p>有时我们想修改成自己的<code>tag</code> ，可以通过<code>dockerfile:tag</code> 修改，但需要先把 <code>pom.xml</code> 中指定的<code>tag</code> 配置去掉。在<code>pom.xml</code>中删除如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着使用如下<code>maven</code> 命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn dockerfile:tag -Ddockerfile.tag=config</span><br></pre></td></tr></table></figure>
<p>执行完成后Docker 服务器上会出现一个基于<code>hjwjw/microservice-consumer-movie:0.0.1-SNAPSHOT</code>镜像的<code>tag</code> 为<code>config</code> 的新镜像。</p>
<p>同样的，如果在<code>pom</code>中没有指定<code>tag</code>，在使用<code>dockerfile:build</code> 构建新镜像时也可以指定<code>tag</code>名：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn dockerfile:build -Ddockerfile.tag=consumer</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">HJW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hjwjw.gitee.io/posts/719142df/">https://hjwjw.gitee.io/posts/719142df/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hjwjw.gitee.io">HJW</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/微服务镜像/">微服务镜像</a><a class="post-meta__tags" href="/tags/dockerfile/">dockerfile</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/posts/625295f9/"><i class="fa fa-chevron-left">  </i><span>使用docker-compose编排微服务</span></a></div><div class="next-post pull-right"><a href="/posts/ad970cda/"><span>git常用操作集合</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By HJW</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>